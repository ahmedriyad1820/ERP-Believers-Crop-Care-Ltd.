import { useState, useEffect, useMemo } from 'react'
import { createPortal } from 'react-dom'
import * as XLSX from 'xlsx'

// Resolve API base so mobile devices on the LAN can reach the backend.
// If VITE_API_BASE is unset or set to 0.0.0.0/localhost, fall back to the current host.
const resolveApiBase = () => {
  const envBase = import.meta.env.VITE_API_BASE

  // Prefer an explicitly configured base unless it's the non-routable placeholder.
  if (envBase && !['http://0.0.0.0:5000', 'http://localhost:5000'].includes(envBase)) {
    return envBase
  }

  // Derive from the page origin (works for mobile testing on the same network).
  if (typeof window !== 'undefined' && window.location?.hostname) {
    const { protocol, hostname } = window.location
    return `${protocol}//${hostname}:5000`
  }

  // Safe fallback for SSR/unknown contexts.
  return 'http://localhost:5000'
}

const API_BASE = resolveApiBase()
import { useNavigate } from 'react-router-dom'
import logoImage from '../assets/logo.png'

function AdminPage({ language, toggleLanguage, t }) {
  const [isAuthenticated, setIsAuthenticated] = useState(false)
  const [activeTab, setActiveTab] = useState(() => localStorage.getItem('adminActiveTab') || 'dashboard')
  const [username, setUsername] = useState('')
  const [password, setPassword] = useState('')
  const [loginError, setLoginError] = useState('')
  const [userRole, setUserRole] = useState(() => {
    try {
      const savedAuth = localStorage.getItem('adminAuth')
      if (savedAuth) {
        const parsed = JSON.parse(savedAuth)
        return parsed?.userRole || 'Admin'
      }
    } catch (err) {
      console.error('Failed to parse saved auth', err)
    }
    return 'Admin'
  })
  const [sidebarOpen, setSidebarOpen] = useState(false)
  const [adminPassword, setAdminPassword] = useState(() => localStorage.getItem('adminPassword') || 'admin123')
  const [loggedInUser, setLoggedInUser] = useState(() => {
    try {
      const savedAuth = localStorage.getItem('adminAuth')
      if (savedAuth) {
        const parsed = JSON.parse(savedAuth)
        return parsed?.loggedInUser || ''
      }
    } catch (err) {
      console.error('Failed to parse saved auth', err)
    }
    return ''
  })
  const [loggedInUserId, setLoggedInUserId] = useState(() => {
    try {
      const savedAuth = localStorage.getItem('adminAuth')
      if (savedAuth) {
        const parsed = JSON.parse(savedAuth)
        return parsed?.loggedInUserId ?? null
      }
    } catch (err) {
      console.error('Failed to parse saved auth', err)
    }
    return null
  }) // Store employee ID if employee logged in
  const [isEmployee, setIsEmployee] = useState(() => {
    try {
      const savedAuth = localStorage.getItem('adminAuth')
      if (savedAuth) {
        const parsed = JSON.parse(savedAuth)
        return !!parsed?.isEmployee
      }
    } catch (err) {
      console.error('Failed to parse saved auth', err)
    }
    return false
  }) // Track if logged in as employee
  const [editingSection, setEditingSection] = useState(null)
  const defaultPageImages = {
    homeHero: '/hero-image.jpg',
    homeHeroImages: ['/hero-image.jpg'],
    homeHeroVideo: '',
    homeHeroMediaType: 'photos',
    aboutHero: '/hero-image.jpg',
    productHero: '/hero-image.jpg',
    noticeHero: '/hero-image.jpg',
    careerHero: '/hero-image.jpg',
    blogHero: '/hero-image.jpg',
    aboutSectionImage1: '/hero-image.jpg',
    aboutSectionImage2: '/hero-image.jpg',
    aboutSectionImage3: '/hero-image.jpg',
    visionImage: '/hero-image.jpg',
    missionImage: '/hero-image.jpg',
    aboutValuesBackground: 'https://images.stockcake.com/public/e/6/e/e6e4865c-08b7-4633-b428-f5658462485e_large/farmers-tending-crops-stockcake.jpg',
    careerValuesBackground: 'https://images.stockcake.com/public/e/6/e/e6e4865c-08b7-4633-b428-f5658462485e_large/farmers-tending-crops-stockcake.jpg'
  }
  const [heroImage, setHeroImage] = useState('/hero-image.jpg')
  const [profileData, setProfileData] = useState({
    name: 'Admin',
    email: 'admin@example.com',
    phone: '+880 1234 567890',
    address: 'Dhaka, Bangladesh',
    photo: '',
    role: 'Admin',
    designation: '',
    department: ''
  })
  const [profileStatus, setProfileStatus] = useState('')
  const [showEditProfile, setShowEditProfile] = useState(false)
  const [passwordForm, setPasswordForm] = useState({
    current: '',
    next: '',
    confirm: '',
    status: ''
  })
  const [pageImages, setPageImages] = useState(() => {
    const saved = localStorage.getItem('pageImages')
    return saved ? JSON.parse(saved) : {
      homeHero: '/hero-image.jpg',
      homeHeroImages: ['/hero-image.jpg'],
      homeHeroVideo: '',
      homeHeroMediaType: 'photos', // 'photos' or 'video'
      aboutHero: '/hero-image.jpg',
      productHero: '/hero-image.jpg',
      noticeHero: '/hero-image.jpg',
      careerHero: '/hero-image.jpg',
      blogHero: '/hero-image.jpg',
      aboutSectionImage1: '/hero-image.jpg',
      aboutSectionImage2: '/hero-image.jpg',
      aboutSectionImage3: '/hero-image.jpg',
      visionImage: '/hero-image.jpg',
      missionImage: '/hero-image.jpg',
      aboutValuesBackground: 'https://images.stockcake.com/public/e/6/e/e6e4865c-08b7-4633-b428-f5658462485e_large/farmers-tending-crops-stockcake.jpg',
      careerValuesBackground: 'https://images.stockcake.com/public/e/6/e/e6e4865c-08b7-4633-b428-f5658462485e_large/farmers-tending-crops-stockcake.jpg'
    }
  })
  const [editedContent, setEditedContent] = useState(() => {
    const saved = localStorage.getItem('editedContent')
    return saved ? JSON.parse(saved) : {}
  })
  const [showPreview, setShowPreview] = useState(false)
  const [previewUrl, setPreviewUrl] = useState('/')
  const [editMode, setEditMode] = useState(false)
  const navigate = useNavigate()
  const [employees, setEmployees] = useState([])
  const [showEmployeeForm, setShowEmployeeForm] = useState(false)
  const [dealers, setDealers] = useState([])
  const [products, setProducts] = useState([])
  const [orders, setOrders] = useState([])
  const [orderRequests, setOrderRequests] = useState([])
  const [showOrderRequests, setShowOrderRequests] = useState(false)
  const [viewingOrder, setViewingOrder] = useState(null)
  const [isEditingOrderDetails, setIsEditingOrderDetails] = useState(false)
  const [editingOrderDetails, setEditingOrderDetails] = useState(null)
  const [viewingProduct, setViewingProduct] = useState(null)
  const [printingOrder, setPrintingOrder] = useState(null)
  const [dealerOrders, setDealerOrders] = useState([])
  const [dealerOrdersLoading, setDealerOrdersLoading] = useState(false)
  const [dealerOrdersStatus, setDealerOrdersStatus] = useState('')
  const [showDealerOrders, setShowDealerOrders] = useState(false)
  const [dealerFilterHalf, setDealerFilterHalf] = useState(() => new Date().getMonth() < 6 ? 'H1' : 'H2')
  const [dealerFilterYear, setDealerFilterYear] = useState(() => new Date().getFullYear())

  // Filter dealerOrders specific to the View Dealer modal
  const filteredDealerOrders = useMemo(() => {
    if (!dealerOrders || dealerOrders.length === 0) return []
    return dealerOrders.filter(order => {
      const orderYear = order.targetYear || new Date(order.createdAt).getFullYear()
      const orderHalf = order.targetHalf || (new Date(order.createdAt).getMonth() < 6 ? 'H1' : 'H2')
      // Ensure vague comparison handles string/number mismatch if any
      // eslint-disable-next-line eqeqeq
      return (orderYear == dealerFilterYear) && (orderHalf === dealerFilterHalf)
    })
  }, [dealerOrders, dealerFilterHalf, dealerFilterYear])

  const customOrderIds = useMemo(() => {
    const ids = {}
    const combined = [...(orders || []), ...(dealerOrders || [])]
    if (combined.length === 0) return ids

    // dedupe by _id
    const seenIds = new Set()
    const uniqueOrders = combined.filter(o => {
      if (seenIds.has(o._id)) return false
      seenIds.add(o._id)
      return true
    })

    // Grouping by dealer and period
    const groups = {}
    uniqueOrders.forEach(order => {
      const dealer = dealers.find(d => d._id === (order.dealer?._id || order.dealer)) || order.dealer;
      const dealerId = dealer?._id || order.dealerId || 'unknown'
      const year = order.targetYear || new Date(order.createdAt).getFullYear()
      const half = order.targetHalf || (new Date(order.createdAt).getMonth() < 6 ? 'H1' : 'H2')
      const groupKey = `${dealerId}-${year}-${half}`

      if (!groups[groupKey]) groups[groupKey] = []
      groups[groupKey].push(order)
    })

    // Sorting each group and assigning IDs
    Object.values(groups).forEach(group => {
      group.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))
      group.forEach((order, index) => {
        const year = order.targetYear || new Date(order.createdAt).getFullYear()
        const half = order.targetHalf || (new Date(order.createdAt).getMonth() < 6 ? 'H1' : 'H2')
        const halfLabel = half === 'H1' ? '1s' : '2s'
        ids[order._id] = `${year} ${halfLabel} ${index + 1}`
      })
    })

    return ids
  }, [orders, dealerOrders, dealers])

  const [expandedOrderRows, setExpandedOrderRows] = useState([])

  const toggleOrderRow = (orderId) => {
    setExpandedOrderRows(prev =>
      prev.includes(orderId) ? prev.filter(id => id !== orderId) : [...prev, orderId]
    )
  }
  const [editingDealerOrderPaidAmount, setEditingDealerOrderPaidAmount] = useState(null)
  const [savingDealerOrderPaidAmount, setSavingDealerOrderPaidAmount] = useState(false)
  const [editingTotalPaid, setEditingTotalPaid] = useState(false)
  const [savingTotalPaid, setSavingTotalPaid] = useState(false)
  const [addCollectionAmount, setAddCollectionAmount] = useState('')
  const [addCollectionCommission, setAddCollectionCommission] = useState('')
  const [commissionRates, setCommissionRates] = useState(['7%', '8%', '9%', '10%', '11%']) // Default fallback
  const [showManageCommissions, setShowManageCommissions] = useState(false)
  const [newCommissionRate, setNewCommissionRate] = useState('')
  const [productSortConfig, setProductSortConfig] = useState({ key: 'productId', direction: 'asc' })
  const [showManageDiscount, setShowManageDiscount] = useState(false)
  const [discountAmount, setDiscountAmount] = useState(0)
  const [discountEnabled, setDiscountEnabled] = useState(false)
  const [savingDiscount, setSavingDiscount] = useState(false)

  // State for expandable mobile cards
  const [expandedDealerId, setExpandedDealerId] = useState(null)
  const [expandedEmployeeId, setExpandedEmployeeId] = useState(null)
  const [expandedProductId, setExpandedProductId] = useState(null)
  const [expandedOrderId, setExpandedOrderId] = useState(null)
  const [expandedRequestId, setExpandedRequestId] = useState(null)

  const toggleDealerExpansion = (id) => {
    setExpandedDealerId(prev => (prev === id ? null : id))
  }
  const [savingCollection, setSavingCollection] = useState(false)
  const [showReturnForm, setShowReturnForm] = useState(false)
  const [returnForm, setReturnForm] = useState({
    productId: '',
    variant: null,
    packQuantity: '',
    cartonQuantity: '',
    returnPlace: ''
  })
  const [savingReturn, setSavingReturn] = useState(false)

  // Revenue Filtering State
  const [revenueFilterType, setRevenueFilterType] = useState('monthly') // Default to 'monthly'
  const [revenueSelectedDate, setRevenueSelectedDate] = useState(new Date().toISOString().split('T')[0])
  const [revenueSelectedMonth, setRevenueSelectedMonth] = useState(new Date().getMonth()) // 0-11
  const [revenueSelectedYear, setRevenueSelectedYear] = useState(new Date().getFullYear())
  const [revenueSelectedHalf, setRevenueSelectedHalf] = useState('H1') // 'H1' or 'H2'
  const [revenueSelectedRegion, setRevenueSelectedRegion] = useState('')
  const [revenueSelectedArea, setRevenueSelectedArea] = useState('')
  const [revenueSelectedTerritory, setRevenueSelectedTerritory] = useState('')

  // Manage Target State
  const [salesTargets, setSalesTargets] = useState([])
  const [showManageTarget, setShowManageTarget] = useState(false)
  const [targetMode, setTargetMode] = useState('half-yearly') // 'half-yearly' | 'monthly'
  const [targetYear, setTargetYear] = useState(new Date().getFullYear())
  const [targetPeriod, setTargetPeriod] = useState('H1') // 'H1' | 'H2'
  const [targetMonth, setTargetMonth] = useState(0) // 0-11
  const [targetAmount, setTargetAmount] = useState('')
  const [savingTarget, setSavingTarget] = useState(false)

  // Loading States
  const [loadingOrders, setLoadingOrders] = useState(false)
  const [loadingDealers, setLoadingDealers] = useState(false)
  const [loadingProducts, setLoadingProducts] = useState(false)
  const [loadingEmployees, setLoadingEmployees] = useState(false)
  const [loadingInventory, setLoadingInventory] = useState(false)
  const [loadingOrderRequests, setLoadingOrderRequests] = useState(false)
  const [loadingProfile, setLoadingProfile] = useState(false)

  // Inventory States
  const [inventory, setInventory] = useState([])
  const [showInventoryForm, setShowInventoryForm] = useState(false)
  const [inventoryForm, setInventoryForm] = useState({
    product: '',
    variant: null,
    quantity: '',
    minStockLevel: 5,
    notes: ''
  })
  const [savingInventory, setSavingInventory] = useState(false)
  const [inventoryStatus, setInventoryStatus] = useState('')
  const [expandedInventoryId, setExpandedInventoryId] = useState(null)
  const [inventoryFilter, setInventoryFilter] = useState('monthly') // all, monthly, yearly, half
  const [inventorySelectedMonth, setInventorySelectedMonth] = useState(new Date().getMonth())
  const [inventorySelectedYear, setInventorySelectedYear] = useState(new Date().getFullYear())
  const [inventorySelectedHalf, setInventorySelectedHalf] = useState(new Date().getMonth() < 6 ? 'H1' : 'H2')
  const [inventorySortField, setInventorySortField] = useState('productCode')
  const [inventorySortDirection, setInventorySortDirection] = useState('asc')

  const [territories, setTerritories] = useState([])
  const [loadingTerritories, setLoadingTerritories] = useState(false)
  const [showTerritoryForm, setShowTerritoryForm] = useState(false)
  const [territoryForm, setTerritoryForm] = useState({ territoryId: '', regionId: '', areaId: '', division: '', zilla: '', area: '' })
  const [savingTerritory, setSavingTerritory] = useState(false)
  const [territoryStatus, setTerritoryStatus] = useState('')
  const [territorySortField, setTerritorySortField] = useState('regionId')
  const [territorySortDirection, setTerritorySortDirection] = useState('asc')


  // Fetch settings on mount
  useEffect(() => {
    fetchSettings()
  }, [])

  const fetchSettings = async () => {
    try {
      const res = await fetch(`${API_BASE}/api/settings`)
      const data = await res.json()
      if (data.success && data.data) {
        setCommissionRates(data.data.commissionRates || ['7%', '8%', '9%', '10%', '11%'])
        setSalesTargets(data.data.salesTargets || [])
        setDiscountAmount(data.data.discountAmount || 0)
        setDiscountEnabled(data.data.discountEnabled || false)
      }
    } catch (err) {
      console.error('Error fetching settings:', err)
    }
  }

  // Pre-fill target amount when selection changes
  useEffect(() => {
    if (!showManageTarget) return

    let foundAmount = ''
    if (targetMode === 'monthly') {
      const t = (salesTargets || []).find(t => t.year === targetYear && t.month === targetMonth)
      if (t) foundAmount = t.amount
    } else {
      // Half Yearly: Check if all months in the period have the same amount (approx)
      const startMonth = targetPeriod === 'H1' ? 0 : 6
      const endMonth = startMonth + 6
      // Just check the first month for now, or sum? The user sets it as a "Period" target but we store monthly.
      // Logic: If user set 600,000 for H1 (100k/month), we show 600,000.
      // We check if targets exist for this range.
      const targetsInRange = (salesTargets || []).filter(t => t.year === targetYear && t.month >= startMonth && t.month < endMonth)

      if (targetsInRange.length > 0) {
        // Sum them up to show the "Half Yearly" total
        const total = targetsInRange.reduce((sum, t) => sum + t.amount, 0)
        foundAmount = total
      }
    }
    setTargetAmount(foundAmount)
  }, [showManageTarget, targetMode, targetYear, targetMonth, targetPeriod, salesTargets])

  const handleSaveTarget = async () => {
    if (!targetAmount || isNaN(targetAmount)) {
      alert(language === 'en' ? 'Please enter a valid amount' : 'একটি বৈধ পরিমাণ লিখুন')
      return
    }

    setSavingTarget(true)
    const amount = parseFloat(targetAmount)
    let newTargets = [...(salesTargets || [])]



    if (targetMode === 'half-yearly') {
      const monthlyAmount = amount / 6
      const startMonth = targetPeriod === 'H1' ? 0 : 6
      const endMonth = startMonth + 6

      for (let m = startMonth; m < endMonth; m++) {
        // Remove existing for this month/year
        newTargets = newTargets.filter(t => !(t.year === targetYear && t.month === m))
        // Add new
        newTargets.push({ year: targetYear, month: m, amount: monthlyAmount })
      }
    } else {
      // Monthly
      newTargets = newTargets.filter(t => !(t.year === targetYear && t.month === targetMonth))
      newTargets.push({ year: targetYear, month: targetMonth, amount: amount })
    }

    try {
      const res = await fetch(`${API_BASE}/api/settings`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ salesTargets: newTargets, commissionRates }) // Keep rates
      })
      const data = await res.json()
      if (data.success) {
        setSalesTargets(data.data.salesTargets)
        setShowManageTarget(false)
        setTargetAmount('')

        // Sync with RSM logic: Find RSM and update their salesTarget
        // Only if setting a Monthly target for the CURRENT month/year or future?
        // User requested: "monthly setted target will set as the target of RSM"
        // We'll update RSMs with the monthly amount. 
        // If half-yearly, we divide by 6.

        const syncAmount = targetMode === 'half-yearly' ? (amount / 6) : amount
        // Note: For half-yearly, this sets the *monthly* target value on the employee record, 
        // which matches the single "salesTarget" field in Employee schema which usually means "Monthly Target".

        const rsms = employees.filter(e => (e.role || '').toUpperCase() === 'RSM')
        if (rsms.length > 0) {
          await Promise.all(rsms.map(rsm =>
            fetch(`${API_BASE}/api/employees/${rsm._id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ...rsm, salesTarget: syncAmount })
            })
          ))
          // Refresh employees locally to show updated target in HR tab
          loadEmployees()
          alert(language === 'en' ? 'Target saved and synced with RSM!' : 'লক্ষ্য সংরক্ষিত এবং RSM এর সাথে সিঙ্ক হয়েছে!')
        } else {
          // Provide feedback even if no RSM found, just for target save
          // Or stay silent? The modal closes, maybe that's enough.
        }
      }
    } catch (err) {
      console.error('Error saving targets:', err)
    } finally {
      setSavingTarget(false)
    }
  }

  const handleAddCommissionRate = async () => {
    if (!newCommissionRate) return
    const rate = newCommissionRate.includes('%') ? newCommissionRate : `${newCommissionRate}%`
    if (commissionRates.includes(rate)) return

    const newRates = [...commissionRates, rate].sort((a, b) => parseFloat(a) - parseFloat(b))

    try {
      const res = await fetch(`${API_BASE}/api/settings`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ commissionRates: newRates })
      })
      const data = await res.json()
      if (data.success) {
        setCommissionRates(data.data.commissionRates)
        setNewCommissionRate('')
      }
    } catch (err) {
      console.error('Error saving settings:', err)
    }
  }

  const handleRemoveCommissionRate = async (rateToRemove) => {
    const newRates = commissionRates.filter(r => r !== rateToRemove)
    try {
      const res = await fetch(`${API_BASE}/api/settings`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ commissionRates: newRates })
      })
      const data = await res.json()
      if (data.success) {
        setCommissionRates(data.data.commissionRates)
      }
    } catch (err) {
      console.error('Error saving settings:', err)
    }
  }

  const handleSaveDiscount = async () => {
    setSavingDiscount(true)
    try {
      const payload = {
        commissionRates,
        salesTargets,
        discountAmount: parseFloat(discountAmount) || 0,
        discountEnabled
      }
      console.log('Saving discount settings:', payload)
      const res = await fetch(`${API_BASE}/api/settings`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      console.log('Response status:', res.status)
      const data = await res.json()
      console.log('Response data:', data)
      if (data.success) {
        setDiscountAmount(data.data.discountAmount)
        setDiscountEnabled(data.data.discountEnabled)
        setShowManageDiscount(false)
        alert(language === 'en' ? 'Discount settings saved!' : 'ডিসকাউন্ট সেটিংস সংরক্ষিত হয়েছে!')
      }
    } catch (err) {
      console.error('Error saving discount settings:', err)
      alert(language === 'en' ? 'Failed to save settings' : 'সেটিংস সংরক্ষণ করতে ব্যর্থ হয়েছে')
    } finally {
      setSavingDiscount(false)
    }
  }

  const [orderCart, setOrderCart] = useState([])
  const [showOrderCart, setShowOrderCart] = useState(false)
  const [showOrderForm, setShowOrderForm] = useState(false)
  const [editingOrderId, setEditingOrderId] = useState(null)
  const [savingOrder, setSavingOrder] = useState(false)
  const [orderStatus, setOrderStatus] = useState('')
  const [orderSearch, setOrderSearch] = useState('')
  const [orderFilter, setOrderFilter] = useState('all') // 'all', 'rejected', 'cancelled'
  const [orderTimeFilter, setOrderTimeFilter] = useState('monthly') // 'monthly', 'yearly', 'all'
  const [orderSelectedMonth, setOrderSelectedMonth] = useState(new Date().getMonth()) // 0-11
  const [orderSelectedYear, setOrderSelectedYear] = useState(new Date().getFullYear())
  const [showOrderFilterDropdown, setShowOrderFilterDropdown] = useState(false)
  const [orderSortField, setOrderSortField] = useState(null) // null, 'date', 'orderId', 'dealer', 'totalPrice', etc.
  const [orderSortDirection, setOrderSortDirection] = useState('asc') // 'asc' or 'desc'
  const [orderForm, setOrderForm] = useState({
    dealer: '',
    product: '',
    variant: { productCode: '', packSize: '', packUnit: 'ml', cartoonSize: 1, cartoonUnit: 'Pcs', price: 0 },
    quantity: 1,
    notes: '',
    status: (userRole || '').toLowerCase() === 'admin' ? 'Processing' : 'Pending',
    paidAmount: 0,
    targetHalf: new Date().getMonth() < 6 ? 'H1' : 'H2', // Current half
    targetYear: new Date().getFullYear(), // Current year
    targetMonth: new Date().getMonth() // Current month (0-11)
  })
  const [selectedProductVariants, setSelectedProductVariants] = useState([])
  const [productSearch, setProductSearch] = useState('')
  const productList = products.length ? products : t.products.items
  const filteredProducts = useMemo(() => {
    let list = [...productList].filter((product) => {
      if (!productSearch.trim()) return true
      const query = productSearch.toLowerCase().trim()
      return (
        (product.productId || '').toLowerCase().includes(query) ||
        (product.name || '').toLowerCase().includes(query) ||
        (product.genericName || '').toLowerCase().includes(query) ||
        (product.description || '').toLowerCase().includes(query) ||
        (product.usage || '').toLowerCase().includes(query) ||
        (product.category || '').toLowerCase().includes(query)
      )
    })

    if (productSortConfig.key) {
      list.sort((a, b) => {
        let valA = a[productSortConfig.key] || ''
        let valB = b[productSortConfig.key] || ''

        // Special handling for Product ID (e.g., BP001)
        if (productSortConfig.key === 'productId') {
          const numA = parseInt((valA.match(/\d+/) || [0])[0], 10)
          const numB = parseInt((valB.match(/\d+/) || [0])[0], 10)
          if (numA !== numB) return productSortConfig.direction === 'asc' ? numA - numB : numB - numA
        }

        // Special handling for Price
        if (productSortConfig.key === 'price') {
          const priceA = a.priceCategory === 'per_variant'
            ? Math.min(...(a.variants || []).map(v => v.price || 0))
            : (a.price || 0)
          const priceB = b.priceCategory === 'per_variant'
            ? Math.min(...(b.variants || []).map(v => v.price || 0))
            : (b.price || 0)
          return productSortConfig.direction === 'asc' ? priceA - priceB : priceB - priceA
        }

        if (valA < valB) return productSortConfig.direction === 'asc' ? -1 : 1
        if (valA > valB) return productSortConfig.direction === 'asc' ? 1 : -1
        return 0
      })
    }

    return list
  }, [productList, productSearch, productSortConfig])
  const [productStatus, setProductStatus] = useState('')
  const [productForm, setProductForm] = useState({
    productId: '',
    variants: [],
    price: '',
    priceCategory: 'single',
    name: '',
    nameBn: '',
    genericName: '',
    genericNameBn: '',
    category: 'Herbicide',
    categoryBn: '',
    description: '',
    descriptionBn: '',
    usage: '',
    usageBn: '',
    benefits: '',
    benefitsBn: '',
    application: '',
    applicationBn: '',
    safety: '',
    safetyBn: '',
    image: '',
    hasOffer: false,
    buyQuantity: '',
    freeQuantity: ''
  })
  const [showProductForm, setShowProductForm] = useState(false)
  const [editingProductId, setEditingProductId] = useState(null)
  const [savingProduct, setSavingProduct] = useState(false)
  const [showDealerForm, setShowDealerForm] = useState(false)
  const [viewingDealer, setViewingDealer] = useState(null)
  const [dealerSearch, setDealerSearch] = useState('')
  const [dealerSortField, setDealerSortField] = useState(null) // null, 'dealerId', 'name', 'phone', etc.
  const [dealerSortDirection, setDealerSortDirection] = useState('asc') // 'asc' or 'desc'
  const [newEmployee, setNewEmployee] = useState({
    name: '',
    email: '',
    phone: '',
    address: '',
    nid: '',
    document: '',
    emergencyContactName: '',
    emergencyContact: '',
    salary: '',
    salesTarget: '',
    bankName: '',
    bankBranch: '',
    accountNumber: '',
    department: '',
    regionId: '',
    areaId: '',
    territoryId: '',
    postingArea: '',
    role: '',
    designation: '',
    photo: '',
    status: 'Unpaid'
  })
  const [employeeStatus, setEmployeeStatus] = useState('')
  const [employeeSearch, setEmployeeSearch] = useState('')
  const [employeeSortField, setEmployeeSortField] = useState(null) // null, 'employeeId', 'name', 'phone', etc.
  const [employeeSortDirection, setEmployeeSortDirection] = useState('asc') // 'asc' or 'desc'
  const [newDealer, setNewDealer] = useState({
    dealerId: '',
    name: '',
    shopName: '',
    phone: '',
    email: '',
    address: '',
    photo: '',
    nid: '',
    tradeLicense: '',
    pesticideLicense: '',

    regionId: '',
    areaId: '',
    territoryId: '',
    area: '',
    agreement: '',
    assignedTo: '',
    assignedToName: '',
    assignedToId: ''
  })
  const [dealerStatus, setDealerStatus] = useState('')
  const [isEditingDealer, setIsEditingDealer] = useState(false)
  const [editingDealerData, setEditingDealerData] = useState(null)
  const [savingDealer, setSavingDealer] = useState(false)

  // Persist minimal auth state so refresh keeps the user signed in
  const persistAuthState = (state) => {
    try {
      localStorage.setItem('adminAuth', JSON.stringify({
        isAuthenticated: true,
        isEmployee: !!state.isEmployee,
        userRole: state.userRole || 'Admin',
        loggedInUser: state.loggedInUser || '',
        loggedInUserId: state.loggedInUserId ?? null
      }))
    } catch (err) {
      console.error('Failed to persist auth state', err)
    }
  }

  // Persist navigation and view state
  useEffect(() => {
    if (!isAuthenticated) return

    localStorage.setItem('adminActiveTab', activeTab)

    if (viewingDealer) {
      localStorage.setItem('adminViewingDealerId', viewingDealer._id)
      localStorage.setItem('adminShowDealerOrders', showDealerOrders ? 'true' : 'false')
    } else {
      localStorage.removeItem('adminViewingDealerId')
      localStorage.removeItem('adminShowDealerOrders')
    }

    if (viewingOrder) {
      localStorage.setItem('adminViewingOrderId', viewingOrder._id)
    } else {
      localStorage.removeItem('adminViewingOrderId')
    }
  }, [activeTab, viewingDealer, showDealerOrders, viewingOrder, isAuthenticated])

  const getNextDealerId = () => {
    const nums = dealers
      .map((d) => parseInt(String(d.dealerId || '').replace(/^C/i, ''), 10))
      .filter((n) => !isNaN(n))
    const next = (nums.length ? Math.max(...nums) + 1 : 1)
    return `C${String(next).padStart(3, '0')}`
  }
  const [generatedCredentials, setGeneratedCredentials] = useState(null)
  const [viewingEmployee, setViewingEmployee] = useState(null)
  const [isEditingEmployee, setIsEditingEmployee] = useState(false)
  const [editingEmployeeData, setEditingEmployeeData] = useState(null)
  const [savingEmployee, setSavingEmployee] = useState(false)



  const [lastGeneratedPassword, setLastGeneratedPassword] = useState('')
  const [showChangePassword, setShowChangePassword] = useState(false)
  const [showSalesHistory, setShowSalesHistory] = useState(false)
  const [showAssignedDealers, setShowAssignedDealers] = useState(false)
  const salesEmployees = useMemo(() => {
    return (employees || []).filter((emp) => {
      const role = (emp.role || '').toLowerCase()
      return role.includes('sales')
    })
  }, [employees])

  // Derived state for Add Dealer form territory dropdowns
  const uniqueRegionIds = useMemo(() => {
    if (!territories) return []
    return [...new Set(territories.map(t => t.regionId))].filter(Boolean).sort()
  }, [territories])

  const availableAreaIds = useMemo(() => {
    if (!newDealer.regionId || !territories) return []
    return [...new Set(territories
      .filter(t => t.regionId === newDealer.regionId)
      .map(t => t.areaId))].filter(Boolean).sort()
  }, [territories, newDealer.regionId])

  const availableTerritoryIds = useMemo(() => {
    if (!newDealer.regionId || !newDealer.areaId || !territories) return []
    return [...new Set(territories
      .filter(t => t.regionId === newDealer.regionId && t.areaId === newDealer.areaId)
      .map(t => t.territoryId))].filter(Boolean).sort()
  }, [territories, newDealer.regionId, newDealer.areaId])

  // Employee Form Location Options
  const employeeAvailableAreaIds = useMemo(() => {
    if (!newEmployee.regionId || !territories) return []
    return [...new Set(territories
      .filter(t => t.regionId === newEmployee.regionId)
      .map(t => t.areaId))].filter(Boolean).sort()
  }, [territories, newEmployee.regionId])

  const employeeAvailableTerritoryIds = useMemo(() => {
    if (!newEmployee.regionId || !newEmployee.areaId || !territories) return []
    return [...new Set(territories
      .filter(t => t.regionId === newEmployee.regionId && t.areaId === newEmployee.areaId)
      .map(t => t.territoryId))].filter(Boolean).sort()
  }, [territories, newEmployee.regionId, newEmployee.areaId])

  const editEmployeeAvailableAreaIds = useMemo(() => {
    if (!editingEmployeeData?.regionId || !territories) return []
    return [...new Set(territories
      .filter(t => t.regionId === editingEmployeeData.regionId)
      .map(t => t.areaId))].filter(Boolean).sort()
  }, [territories, editingEmployeeData?.regionId])

  const editEmployeeAvailableTerritoryIds = useMemo(() => {
    if (!editingEmployeeData?.regionId || !editingEmployeeData?.areaId || !territories) return []
    return [...new Set(territories
      .filter(t => t.regionId === editingEmployeeData.regionId && t.areaId === editingEmployeeData.areaId)
      .map(t => t.territoryId))].filter(Boolean).sort()
  }, [territories, editingEmployeeData?.regionId, editingEmployeeData?.areaId])

  // Revenue Location Filter Options
  const revenueUniqueRegionIds = useMemo(() => {
    if (!territories) return []
    return [...new Set(territories.map(t => t.regionId))].filter(Boolean).sort()
  }, [territories])

  const revenueAvailableAreaIds = useMemo(() => {
    if (!revenueSelectedRegion || !territories) return []
    return [...new Set(territories
      .filter(t => t.regionId === revenueSelectedRegion)
      .map(t => t.areaId))].filter(Boolean).sort()
  }, [revenueSelectedRegion, territories])

  const revenueAvailableTerritoryIds = useMemo(() => {
    if (!revenueSelectedRegion || !revenueSelectedArea || !territories) return []
    return [...new Set(territories
      .filter(t => t.regionId === revenueSelectedRegion && t.areaId === revenueSelectedArea)
      .map(t => t.territoryId))].filter(Boolean).sort()
  }, [revenueSelectedRegion, revenueSelectedArea, territories])
  // Body Scroll Locking for Modals
  // Body Scroll Locking for Modals
  useEffect(() => {
    const isAnyModalOpen = viewingEmployee || showEmployeeForm || viewingDealer || showDealerForm || showDealerOrders || viewingProduct || showProductForm || viewingOrder || showOrderForm || showOrderRequests || showOrderCart || showEditProfile || showManageTarget || showManageCommissions || showChangePassword || showSalesHistory || showAssignedDealers || showPreview || sidebarOpen

    if (isAnyModalOpen) {
      document.body.style.overflow = 'hidden'
    } else {
      document.body.style.overflow = ''
    }

    // Cleanup
    return () => {
      document.body.style.overflow = ''
    }
  }, [viewingEmployee, showEmployeeForm, viewingDealer, showDealerForm, showDealerOrders, viewingProduct, showProductForm, viewingOrder, showOrderForm, showOrderRequests, showOrderCart, showEditProfile, showManageTarget, showManageCommissions, showChangePassword, showSalesHistory, showAssignedDealers, showPreview, sidebarOpen])


  const filteredDealers = useMemo(() => {
    const isAdmin = (userRole || '').toLowerCase() === 'admin'
    let list = isAdmin ? dealers : (dealers || []).filter((d) => {
      const assignedId = d.assignedTo?._id || d.assignedTo
      const assignedName = d.assignedToName
      return (
        (loggedInUserId && assignedId && String(assignedId) === String(loggedInUserId)) ||
        (loggedInUser && assignedName && assignedName === loggedInUser)
      )
    })
    if (dealerSearch && dealerSearch.trim()) {
      const q = dealerSearch.trim().toLowerCase()
      list = list.filter((d) =>
        (d.name || '').toLowerCase().includes(q) ||
        (d.dealerId || '').toLowerCase().includes(q) ||
        (d.phone || '').toLowerCase().includes(q) ||
        (d.email || '').toLowerCase().includes(q)
      )
    }
    return list
  }, [dealers, userRole, loggedInUserId, loggedInUser, dealerSearch])

  // Sorted dealers
  const sortedDealers = useMemo(() => {
    if (!dealerSortField) return filteredDealers

    const sorted = [...filteredDealers].sort((a, b) => {
      let aValue, bValue

      switch (dealerSortField) {
        case 'dealerId':
          aValue = (a.dealerId || '').toLowerCase()
          bValue = (b.dealerId || '').toLowerCase()
          break
        case 'name':
          aValue = (a.name || '').toLowerCase()
          bValue = (b.name || '').toLowerCase()
          break
        case 'phone':
          aValue = (a.phone || '').toLowerCase()
          bValue = (b.phone || '').toLowerCase()
          break
        case 'email':
          aValue = (a.email || '').toLowerCase()
          bValue = (b.email || '').toLowerCase()
          break
        case 'area':
          aValue = (a.area || '').toLowerCase()
          bValue = (b.area || '').toLowerCase()
          break
        case 'salesman':
          aValue = (a.assignedToName || a.assignedToId || '').toLowerCase()
          bValue = (b.assignedToName || b.assignedToId || '').toLowerCase()
          break
        case 'dueAmount':
          // Calculate due amount for sorting
          const aDealerOrders = (orders || []).filter(order =>
            order.dealerId === a.dealerId && order.status !== 'Cancelled'
          )
          const bDealerOrders = (orders || []).filter(order =>
            order.dealerId === b.dealerId && order.status !== 'Cancelled'
          )
          aValue = aDealerOrders.reduce((sum, order) => {
            const due = order.dueAmount !== undefined
              ? parseFloat(order.dueAmount)
              : Math.max(0, parseFloat(order.totalPrice || 0) - parseFloat(order.paidAmount || 0))
            return sum + due
          }, 0)
          bValue = bDealerOrders.reduce((sum, order) => {
            const due = order.dueAmount !== undefined
              ? parseFloat(order.dueAmount)
              : Math.max(0, parseFloat(order.totalPrice || 0) - parseFloat(order.paidAmount || 0))
            return sum + due
          }, 0)
          break
        default:
          return 0
      }

      if (typeof aValue === 'string' && typeof bValue === 'string') {
        return dealerSortDirection === 'asc'
          ? aValue.localeCompare(bValue)
          : bValue.localeCompare(aValue)
      } else {
        return dealerSortDirection === 'asc'
          ? aValue - bValue
          : bValue - aValue
      }
    })

    return sorted
  }, [filteredDealers, dealerSortField, dealerSortDirection, orders])

  // Handle sort column click for dealers
  const handleSortDealers = (field) => {
    if (dealerSortField === field) {
      // Toggle direction if clicking the same field
      setDealerSortDirection(dealerSortDirection === 'asc' ? 'desc' : 'asc')
    } else {
      // Set new field and default to ascending
      setDealerSortField(field)
      setDealerSortDirection('asc')
    }
  }

  const filteredEmployees = useMemo(() => {
    let list = employees || []
    if (employeeSearch && employeeSearch.trim()) {
      const q = employeeSearch.trim().toLowerCase()
      list = list.filter((e) =>
        (e.name || '').toLowerCase().includes(q) ||
        (e.employeeId || '').toLowerCase().includes(q) ||
        (e.phone || '').toLowerCase().includes(q) ||
        (e.email || '').toLowerCase().includes(q) ||
        (e.designation || '').toLowerCase().includes(q)
      )
    }
    return list
  }, [employees, employeeSearch])

  // Sorted employees
  const sortedEmployees = useMemo(() => {
    if (!employeeSortField) return filteredEmployees

    const sorted = [...filteredEmployees].sort((a, b) => {
      let aValue, bValue

      switch (employeeSortField) {
        case 'employeeId':
          aValue = (a.employeeId || '').toLowerCase()
          bValue = (b.employeeId || '').toLowerCase()
          break
        case 'name':
          aValue = (a.name || '').toLowerCase()
          bValue = (b.name || '').toLowerCase()
          break
        case 'phone':
          aValue = (a.phone || '').toLowerCase()
          bValue = (b.phone || '').toLowerCase()
          break
        case 'designation':
          aValue = (a.designation || '').toLowerCase()
          bValue = (b.designation || '').toLowerCase()
          break
        case 'postingArea':
          aValue = ((a.postingArea || a.area) || '').toLowerCase()
          bValue = ((b.postingArea || b.area) || '').toLowerCase()
          break
        case 'salary':
          aValue = parseFloat(a.salary || 0)
          bValue = parseFloat(b.salary || 0)
          break
        case 'salesTarget':
          aValue = parseFloat(a.salesTarget || 0)
          bValue = parseFloat(b.salesTarget || 0)
          break
        case 'salaryStatus':
          aValue = (normalizeSalaryStatus(a.status) || '').toLowerCase()
          bValue = (normalizeSalaryStatus(b.status) || '').toLowerCase()
          break
        default:
          return 0
      }

      if (typeof aValue === 'string' && typeof bValue === 'string') {
        return employeeSortDirection === 'asc'
          ? aValue.localeCompare(bValue)
          : bValue.localeCompare(aValue)
      } else {
        return employeeSortDirection === 'asc'
          ? aValue - bValue
          : bValue - aValue
      }
    })

    return sorted
  }, [filteredEmployees, employeeSortField, employeeSortDirection])

  // Handle sort column click for employees
  const handleSortEmployees = (field) => {
    if (employeeSortField === field) {
      // Toggle direction if clicking the same field
      setEmployeeSortDirection(employeeSortDirection === 'asc' ? 'desc' : 'asc')
    } else {
      // Set new field and default to ascending
      setEmployeeSortField(field)
      setEmployeeSortDirection('asc')
    }
  }

  // Totals across all dealers/orders
  const { totalCollection, totalDue } = useMemo(() => {
    const totals = (orders || []).reduce((acc, order) => {
      // Exclude cancelled and rejected orders from calculations
      if (order.status === 'Cancelled' || order.approvalStatus === 'Rejected') {
        return acc
      }

      // Total Collection: sum of all paidAmount (default to 0 if not set)
      const paid = order?.paidAmount !== undefined && order?.paidAmount !== null
        ? Number(order.paidAmount)
        : 0

      // Total Due: use dueAmount if set, otherwise calculate as totalPrice - paidAmount
      const due = order?.dueAmount !== undefined && order?.dueAmount !== null
        ? Number(order.dueAmount)
        : Math.max(0, Number(order.totalPrice || 0) - Number(paid || 0))

      acc.totalCollection += Number(paid || 0)
      acc.totalDue += Number(due || 0)
      return acc
    }, { totalCollection: 0, totalDue: 0 })
    return totals
  }, [orders])

  const filteredOrders = useMemo(() => {
    let list = orders || []

    // Always exclude pending orders - only show approved orders
    list = list.filter((o) => o.approvalStatus !== 'Pending')

    // Filter by order filter (rejected, cancelled, or all)
    if (orderFilter === 'rejected') {
      list = list.filter((o) => o.approvalStatus === 'Rejected')
    } else if (orderFilter === 'cancelled') {
      list = list.filter((o) => o.status === 'Cancelled')
    } else {
      // For 'all', exclude rejected and cancelled from default view (they can be viewed via buttons)
      list = list.filter((o) =>
        o.approvalStatus !== 'Rejected' && o.status !== 'Cancelled'
      )
    }

    // Apply search filter
    if (orderSearch && orderSearch.trim()) {
      const q = orderSearch.trim().toLowerCase()
      list = list.filter((o) =>
        (o.orderId || '').toLowerCase().includes(q) ||
        (o.dealerName || '').toLowerCase().includes(q) ||
        (o.dealerId || '').toLowerCase().includes(q) ||
        (o.requestedByName || '').toLowerCase().includes(q) ||
        (o.status || '').toLowerCase().includes(q) ||
        (o.approvalStatus || '').toLowerCase().includes(q) ||
        (o.createdAt && new Date(o.createdAt).toLocaleDateString().toLowerCase().includes(q))
      )
    }

    // Apply time-based filter
    if (orderTimeFilter === 'monthly') {
      list = list.filter((o) => {
        const orderTargetMonth = o.targetMonth !== undefined ? o.targetMonth : new Date(o.createdAt).getMonth()
        const orderTargetYear = o.targetYear || new Date(o.createdAt).getFullYear()
        return orderTargetMonth === orderSelectedMonth && orderTargetYear === orderSelectedYear
      })
    } else if (orderTimeFilter === 'yearly') {
      list = list.filter((o) => {
        const orderTargetYear = o.targetYear || new Date(o.createdAt).getFullYear()
        return orderTargetYear === orderSelectedYear
      })
    }
    // For 'all', no time filtering

    return list
  }, [orders, orderSearch, orderFilter, orderTimeFilter, orderSelectedMonth, orderSelectedYear])

  // Sorted orders
  const sortedOrders = useMemo(() => {
    if (!orderSortField) return filteredOrders

    const sorted = [...filteredOrders].sort((a, b) => {
      let aValue, bValue

      switch (orderSortField) {
        case 'date':
          aValue = a.createdAt ? new Date(a.createdAt).getTime() : 0
          bValue = b.createdAt ? new Date(b.createdAt).getTime() : 0
          break
        case 'orderId':
          aValue = (a.orderId || '').toLowerCase()
          bValue = (b.orderId || '').toLowerCase()
          break
        case 'dealer':
          aValue = (a.dealerName || a.dealer?.name || '').toLowerCase()
          bValue = (b.dealerName || b.dealer?.name || '').toLowerCase()
          break
        case 'dealerId':
          aValue = (a.dealerId || a.dealer?.dealerId || '').toLowerCase()
          bValue = (b.dealerId || b.dealer?.dealerId || '').toLowerCase()
          break
        case 'product':
          aValue = (a.productName || a.product?.name || '').toLowerCase()
          bValue = (b.productName || b.product?.name || '').toLowerCase()
          break
        case 'quantity':
          aValue = parseFloat(a.quantity || 0)
          bValue = parseFloat(b.quantity || 0)
          break
        case 'totalQuantity':
          // Calculate total quantity (purchased + free) for sorting
          const calculateTotalQty = (order) => {
            let totalPurchasedQty = 0
            let totalFreeQty = 0

            if (order.items && Array.isArray(order.items) && order.items.length > 0) {
              order.items.forEach(item => {
                const itemQty = parseFloat(item.quantity) || 0
                totalPurchasedQty += itemQty

                const itemProduct = products.find(p => p._id === item.product || p._id === item.product?._id)
                if (itemProduct && itemProduct.hasOffer && itemProduct.buyQuantity && itemProduct.freeQuantity) {
                  const buyQty = parseFloat(itemProduct.buyQuantity) || 0
                  const freeQty = parseFloat(itemProduct.freeQuantity) || 0
                  if (buyQty > 0) {
                    const eligibleOffers = Math.floor(itemQty / buyQty)
                    totalFreeQty += eligibleOffers * freeQty
                  }
                }
              })
            } else {
              totalPurchasedQty = parseFloat(order.quantity) || 0

              const orderProduct = products.find(p => p._id === order.product || p._id === order.product?._id)
              if (orderProduct && orderProduct.hasOffer && orderProduct.buyQuantity && orderProduct.freeQuantity) {
                const buyQty = parseFloat(orderProduct.buyQuantity) || 0
                const freeQty = parseFloat(orderProduct.freeQuantity) || 0
                if (buyQty > 0) {
                  const eligibleOffers = Math.floor(totalPurchasedQty / buyQty)
                  totalFreeQty = eligibleOffers * freeQty
                }
              }
            }

            return totalPurchasedQty + totalFreeQty
          }
          aValue = calculateTotalQty(a)
          bValue = calculateTotalQty(b)
          break
        case 'createdBy':
          aValue = (a.requestedByName || a.requestedByRole || '').toLowerCase()
          bValue = (b.requestedByName || b.requestedByRole || '').toLowerCase()
          break
        case 'totalPrice':
          aValue = parseFloat(a.totalPrice || 0)
          bValue = parseFloat(b.totalPrice || 0)
          break
        case 'paidAmount':
          aValue = parseFloat(a.paidAmount || 0)
          bValue = parseFloat(b.paidAmount || 0)
          break
        case 'dueAmount':
          aValue = a.dueAmount !== undefined && a.dueAmount !== null
            ? parseFloat(a.dueAmount)
            : Math.max(0, parseFloat(a.totalPrice || 0) - parseFloat(a.paidAmount || 0))
          bValue = b.dueAmount !== undefined && b.dueAmount !== null
            ? parseFloat(b.dueAmount)
            : Math.max(0, parseFloat(b.totalPrice || 0) - parseFloat(b.paidAmount || 0))
          break
        case 'status':
          aValue = (a.status || 'Pending').toLowerCase()
          bValue = (b.status || 'Pending').toLowerCase()
          break
        default:
          return 0
      }

      if (typeof aValue === 'string' && typeof bValue === 'string') {
        return orderSortDirection === 'asc'
          ? aValue.localeCompare(bValue)
          : bValue.localeCompare(aValue)
      } else {
        return orderSortDirection === 'asc'
          ? aValue - bValue
          : bValue - aValue
      }
    })

    return sorted
  }, [filteredOrders, orderSortField, orderSortDirection, products])

  // Handle sort column click
  const handleSortOrders = (field) => {
    if (orderSortField === field) {
      // Toggle direction if clicking the same field
      setOrderSortDirection(orderSortDirection === 'asc' ? 'desc' : 'asc')
    } else {
      // Set new field and default to ascending
      setOrderSortField(field)
      setOrderSortDirection('asc')
    }
  }

  // Restore persisted auth state on first load
  useEffect(() => {
    const savedAuth = localStorage.getItem('adminAuth')
    if (!savedAuth) return

    try {
      const parsed = JSON.parse(savedAuth)
      if (parsed?.isAuthenticated) {
        setIsAuthenticated(true)
        setIsEmployee(!!parsed.isEmployee)
        setUserRole(parsed.userRole || 'Admin')
        setLoggedInUser(parsed.loggedInUser || '')
        setLoggedInUserId(parsed.loggedInUserId ?? null)
      }
    } catch (err) {
      console.error('Failed to restore auth state', err)
      localStorage.removeItem('adminAuth')
      localStorage.removeItem('adminActiveTab')
      localStorage.removeItem('adminViewingDealerId')
      localStorage.removeItem('adminShowDealerOrders')
      localStorage.removeItem('adminViewingOrderId')
    }
  }, [])

  const loadDealers = async () => {
    setLoadingDealers(true)
    try {
      const res = await fetch(`${API_BASE}/api/dealers`)
      if (res.ok) {
        const data = await res.json()
        setDealers(data.data || [])
      }
    } catch (err) {
      console.error('Failed to load dealers', err)
    } finally {
      setLoadingDealers(false)
    }
  }

  useEffect(() => {
    loadDealers()
    // Load territories for Admin/RSM/Incharge to ensure filters work
    const role = (userRole || '').toLowerCase()
    if (role === 'admin' || role === 'rsm' || role === 'incharge') {
      loadTerritories()
    }
  }, [activeTab, userRole, loggedInUserId, loggedInUser])

  // Restore sub-views once data is loaded
  useEffect(() => {
    if (!dealers.length || viewingDealer || !isAuthenticated) return

    const savedDealerId = localStorage.getItem('adminViewingDealerId')
    const shouldShowDealerOrders = localStorage.getItem('adminShowDealerOrders') === 'true'

    if (savedDealerId) {
      const dealer = dealers.find(d => d._id === savedDealerId)
      if (dealer) {
        setViewingDealer(dealer)
        if (shouldShowDealerOrders) {
          handleShowDealerOrders(dealer)
        }
      }
    }
  }, [dealers.length, isAuthenticated])

  useEffect(() => {
    if (!orders.length || viewingOrder || !isAuthenticated) return

    const savedOrderId = localStorage.getItem('adminViewingOrderId')
    if (savedOrderId) {
      const order = orders.find(o => o._id === savedOrderId)
      if (order) {
        setViewingOrder(order)
      }
    }
  }, [orders.length, isAuthenticated])

  const loadProducts = async () => {
    setLoadingProducts(true)
    try {
      setProductStatus('')
      const res = await fetch(`${API_BASE}/api/products`)
      if (!res.ok) {
        throw new Error('Failed to load products')
      }
      const data = await res.json()
      setProducts(data.data || [])
    } catch (err) {
      console.error('Failed to load products', err)
      setProducts(Array.isArray(t?.products?.items) ? [...t.products.items] : [])
      setProductStatus(language === 'en'
        ? 'Showing static products while API is unavailable.'
        : 'এপিআই অনুপলব্ধ থাকায় ডিফল্ট পণ্য দেখানো হচ্ছে।')
    } finally {
      setLoadingProducts(false)
    }
  }

  useEffect(() => {
    loadProducts()
  }, [])

  const loadOrderRequests = async () => {
    setLoadingOrderRequests(true)
    try {
      const res = await fetch(`${API_BASE}/api/orders?approvalStatus=Pending`)
      if (res.ok) {
        const data = await res.json()
        const pending = data.data || []
        const isAdmin = (userRole || '').toLowerCase() === 'admin'
        if (isAdmin) {
          setOrderRequests(pending)
        } else {
          const filtered = pending.filter((o) => {
            const requesterId = o.requestedBy?._id || o.requestedBy
            const requesterName = o.requestedByName
            return (
              (loggedInUserId && requesterId && String(requesterId) === String(loggedInUserId)) ||
              (loggedInUser && requesterName && requesterName === loggedInUser)
            )
          })
          setOrderRequests(filtered)
        }
      }
    } catch (err) {
      console.error('Failed to load order requests', err)
    } finally {
      setLoadingOrderRequests(false)
    }
  }

  const loadOrders = async () => {
    setLoadingOrders(true)
    try {
      // Load dealers if not already loaded (needed for employee order filtering)
      const isAdmin = (userRole || '').toLowerCase() === 'admin'
      if (!isAdmin && (!dealers || dealers.length === 0)) {
        await loadDealers()
      }

      const res = await fetch(`${API_BASE}/api/orders`)
      if (res.ok) {
        const data = await res.json()
        // Exclude pending orders - only show approved orders (and rejected/cancelled if viewing those filters)
        const allOrders = (data.data || []).filter((o) => o.approvalStatus !== 'Pending')
        const filtered = isAdmin
          ? allOrders
          : allOrders.filter((o) => {
            // Show orders created by this employee
            const requesterId = o.requestedBy?._id || o.requestedBy
            const requesterName = o.requestedByName
            const isEmployeeOrder = (
              (loggedInUserId && requesterId && String(requesterId) === String(loggedInUserId)) ||
              (loggedInUser && requesterName && requesterName === loggedInUser)
            )

            // Also show orders created by admin where the dealer is assigned to this employee
            const isAdminCreated = o.requestedByRole && o.requestedByRole.toLowerCase() === 'admin'
            let isAssignedToEmployee = false

            if (isAdminCreated && loggedInUserId) {
              // Check if the order's dealer is assigned to this employee
              const dealerId = o.dealerId
              const dealer = (dealers || []).find(d => d.dealerId === dealerId)
              if (dealer) {
                const assignedToId = dealer.assignedTo?._id || dealer.assignedTo
                isAssignedToEmployee = assignedToId && String(assignedToId) === String(loggedInUserId)
              }
            }

            return isEmployeeOrder || isAssignedToEmployee
          })
        setOrders(filtered)
      }
    } catch (err) {
      console.error('Failed to load orders', err)
    } finally {
      setLoadingOrders(false)
    }
  }

  const toggleInventoryExpansion = (id) => {
    setExpandedInventoryId(expandedInventoryId === id ? null : id);
  };

  const loadInventory = async () => {
    setLoadingInventory(true)
    try {
      const params = new URLSearchParams({
        period: inventoryFilter,
        selectedMonth: inventorySelectedMonth,
        selectedYear: inventorySelectedYear,
        selectedHalf: inventorySelectedHalf
      })
      const res = await fetch(`${API_BASE}/api/inventory?${params}`)
      if (res.ok) {
        const data = await res.json()
        setInventory(data.data || [])
      }
    } catch (err) {
      console.error('Failed to load inventory', err)
    } finally {
      setLoadingInventory(false)
    }
  }

  const loadEmployees = async () => {
    setLoadingEmployees(true)
    try {
      const res = await fetch(`${API_BASE}/api/employees`)
      if (res.ok) {
        const empData = await res.json()
        setEmployees((empData.data || []).map((e) => ({
          ...e,
          status: normalizeSalaryStatus(e.status)
        })))
      }
    } catch (err) {
      console.error('Failed to load employees', err)
    } finally {
      setLoadingEmployees(false)
    }
  }

  const loadTerritories = async () => {
    setLoadingTerritories(true)
    try {
      const res = await fetch(`${API_BASE}/api/territories`)
      if (res.ok) {
        const data = await res.json()
        setTerritories(data.data || [])
      }
    } catch (err) {
      console.error('Failed to load territories', err)
    } finally {
      setLoadingTerritories(false)
    }
  }

  const resetTerritoryForm = () => {
    setTerritoryForm({ territoryId: '', regionId: '', areaId: '', division: '', zilla: '', area: '' })
    setTerritoryStatus('')
  }

  const handleSaveTerritory = async (e) => {
    e.preventDefault()
    setSavingTerritory(true)
    setTerritoryStatus('')
    try {
      const method = territoryForm._id ? 'PUT' : 'POST'
      const url = territoryForm._id ? `${API_BASE}/api/territories/${territoryForm._id}` : `${API_BASE}/api/territories`
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(territoryForm)
      })
      if (res.ok) {
        setTerritoryStatus(language === 'en' ? 'Territory saved successfully!' : 'টেরিটরি সফলভাবে সংরক্ষিত হয়েছে!')
        setTimeout(() => {
          setShowTerritoryForm(false)
          resetTerritoryForm()
          loadTerritories()
        }, 1500)
      } else {
        const error = await res.json()
        setTerritoryStatus(`Error: ${error.message}`)
      }
    } catch (err) {
      setTerritoryStatus(`Error: ${err.message}`)
    } finally {
      setSavingTerritory(false)
    }
  }

  const handleDeleteTerritory = async (id) => {
    if (!window.confirm(language === 'en' ? 'Are you sure you want to delete this territory?' : 'আপনি কি নিশ্চিত যে আপনি এই টেরিটরি মুছে ফেলতে চান?')) return
    try {
      const res = await fetch(`${API_BASE}/api/territories/${id}`, { method: 'DELETE' })
      if (res.ok) {
        loadTerritories()
      }
    } catch (err) {
      console.error('Failed to delete territory', err)
    }
  }

  const handleSaveInventory = async (e) => {
    e.preventDefault()
    setSavingInventory(true)
    setInventoryStatus(language === 'en' ? 'Saving...' : 'সংরক্ষণ হচ্ছে...')

    try {
      const url = inventoryForm.id
        ? `${API_BASE}/api/inventory/${inventoryForm.id}`
        : `${API_BASE}/api/inventory`
      const method = inventoryForm.id ? 'PUT' : 'POST'

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(inventoryForm)
      })

      if (res.ok) {
        setInventoryStatus(language === 'en' ? 'Saved successfully!' : 'সফলভাবে সংরক্ষিত হয়েছে!')
        setTimeout(() => {
          setShowInventoryForm(false)
          resetInventoryForm()
          loadInventory()
        }, 1500)
      } else {
        const error = await res.json()
        setInventoryStatus(`Error: ${error.message}`)
      }
    } catch (err) {
      setInventoryStatus(`Failed to save: ${err.message}`)
    } finally {
      setSavingInventory(false)
    }
  }

  const handleDeleteInventory = async (id) => {
    if (!window.confirm(language === 'en' ? 'Are you sure you want to delete this inventory item?' : 'আপনি কি নিশ্চিত যে আপনি এই ইনভেন্টরি আইটেমটি মুছতে চান?')) return

    try {
      const res = await fetch(`${API_BASE}/api/inventory/${id}`, {
        method: 'DELETE'
      })
      if (res.ok) {
        loadInventory()
      }
    } catch (err) {
      console.error('Failed to delete inventory item', err)
    }
  }

  const resetInventoryForm = () => {
    setInventoryForm({
      product: '',
      variant: null,
      quantity: '',
      minStockLevel: 5,
      notes: ''
    })
    setInventoryStatus('')
  }

  useEffect(() => {
    if (activeTab === 'orders') {
      loadOrders()
      if (showOrderRequests) {
        loadOrderRequests()
      }
    }
  }, [activeTab, userRole, showOrderRequests])

  // Load orders and employees when Revenue tab is active
  useEffect(() => {
    if (activeTab === 'revenue') {
      loadOrders()
      loadEmployees()
      loadTerritories()
    }
  }, [activeTab])

  // Load orders when CRM tab is active (needed for Due Amount calculations in dealers table)
  useEffect(() => {
    if (activeTab === 'crm') {
      loadOrders()
    }
  }, [activeTab])

  // Load inventory when Inventory tab is active or filters change
  useEffect(() => {
    if (activeTab === 'inventory') {
      loadInventory()
    }
  }, [activeTab, inventoryFilter, inventorySelectedMonth, inventorySelectedYear, inventorySelectedHalf])

  // Load territories when territory tab is active, Revenue tab is active, or Dealer form is open
  useEffect(() => {
    if (activeTab === 'territory' || activeTab === 'revenue' || showDealerForm) {
      loadTerritories()
    }
  }, [activeTab, showDealerForm])

  // Ensure orders are loaded when viewing sales history (even outside Orders tab)
  useEffect(() => {
    if (showSalesHistory && (!orders || orders.length === 0)) {
      loadOrders()
    }
  }, [showSalesHistory])

  // Update variants when product changes
  useEffect(() => {
    if (orderForm.product) {
      const selectedProduct = products.find(p => p._id === orderForm.product)
      if (selectedProduct && selectedProduct.variants && selectedProduct.variants.length > 0) {
        setSelectedProductVariants(selectedProduct.variants)
        // Reset variant if product changed
        setOrderForm(prev => ({ ...prev, variant: { productCode: '', packSize: '', packUnit: 'ml', cartoonSize: 1, cartoonUnit: 'Pcs', price: 0 } }))
      } else {
        setSelectedProductVariants([])
        setOrderForm(prev => ({ ...prev, variant: { productCode: '', packSize: '', packUnit: 'ml', cartoonSize: 1, cartoonUnit: 'Pcs', price: 0 } }))
      }
    } else {
      setSelectedProductVariants([])
    }
  }, [orderForm.product, products])

  const resetOrderForm = () => {
    setOrderForm({
      dealer: '',
      product: '',
      variant: { productCode: '', packSize: '', packUnit: 'ml', cartoonSize: 1, cartoonUnit: 'Pcs', price: 0 },
      quantity: 1,
      notes: '',
      status: (userRole || '').toLowerCase() === 'admin' ? 'Processing' : 'Pending',
      paidAmount: 0,
      targetHalf: new Date().getMonth() < 6 ? 'H1' : 'H2', // Reset to current half
      targetYear: new Date().getFullYear(), // Reset to current year
      targetMonth: new Date().getMonth() // Reset to current month
    })
    setSelectedProductVariants([])
    setEditingOrderId(null)
  }

  // Helper to get date range for revenue filtering
  const getRevenueDateRange = (type, dateStr, month, year, half = 'H1') => {
    if (type === 'all') return { start: null, end: null }

    const start = new Date()
    const end = new Date()

    if (type === 'monthly') {
      start.setFullYear(year, month, 1)
      start.setHours(0, 0, 0, 0)
      end.setFullYear(year, month + 1, 0)
      end.setHours(23, 59, 59, 999)
    } else if (type === 'yearly') {
      start.setFullYear(year, 0, 1)
      start.setHours(0, 0, 0, 0)
      end.setFullYear(year, 11, 31)
      end.setHours(23, 59, 59, 999)
    } else if (type === 'half-yearly') {
      if (half === 'H1') {
        // 1st Half: January to June
        start.setFullYear(year, 0, 1)
        start.setHours(0, 0, 0, 0)
        end.setFullYear(year, 5, 30)
        end.setHours(23, 59, 59, 999)
      } else {
        // 2nd Half: July to December
        start.setFullYear(year, 6, 1)
        start.setHours(0, 0, 0, 0)
        end.setFullYear(year, 11, 31)
        end.setHours(23, 59, 59, 999)
      }
    }

    return { start, end }
  }

  // Calculate Revenue Stats based on filters
  // Calculate Filtered Orders for Revenue once to be shared across widgets
  const filteredOrdersForRevenue = useMemo(() => {
    const { start, end } = getRevenueDateRange(revenueFilterType, revenueSelectedDate, revenueSelectedMonth, revenueSelectedYear, revenueSelectedHalf)

    let relevantOrders = orders || []

    // 1. Filter out Cancelled/Rejected orders globally for these stats
    relevantOrders = relevantOrders.filter(o =>
      o.status !== 'Cancelled' &&
      o.approvalStatus !== 'Rejected'
    )

    let filtered = [...relevantOrders]

    // Filter by target period fields instead of createdAt
    filtered = filtered.filter(o => {
      if (revenueFilterType === 'half-yearly') {
        // Check targetHalf and targetYear
        return o.targetHalf === revenueSelectedHalf && o.targetYear === revenueSelectedYear
      } else if (revenueFilterType === 'monthly') {
        // Check targetMonth and targetYear
        const orderTargetMonth = o.targetMonth !== undefined ? o.targetMonth : new Date(o.createdAt).getMonth()
        const orderTargetYear = o.targetYear || new Date(o.createdAt).getFullYear()
        return orderTargetMonth === revenueSelectedMonth && orderTargetYear === revenueSelectedYear
      } else if (revenueFilterType === 'yearly') {
        // Check targetYear
        const orderTargetYear = o.targetYear || new Date(o.createdAt).getFullYear()
        return orderTargetYear === revenueSelectedYear
      } else if (start && end) {
        // For 'all' or date-based filtering, use createdAt
        const d = new Date(o.createdAt)
        return d >= start && d <= end
      }
      return true // No filtering for 'all' without date range
    })

    // Location Filtering
    if (revenueSelectedRegion || revenueSelectedArea || revenueSelectedTerritory) {
      filtered = filtered.filter(o => {
        const dealerId = o.dealer?._id || o.dealer
        const dealer = dealers.find(d => d._id === dealerId)
        if (!dealer) return false

        if (revenueSelectedTerritory) {
          return dealer.territoryId === revenueSelectedTerritory
        }
        if (revenueSelectedArea) {
          return dealer.areaId === revenueSelectedArea
        }
        if (revenueSelectedRegion) {
          return dealer.regionId === revenueSelectedRegion
        }
        return true
      })
    }

    return filtered
  }, [orders, dealers, revenueFilterType, revenueSelectedDate, revenueSelectedMonth, revenueSelectedYear, revenueSelectedHalf, revenueSelectedRegion, revenueSelectedArea, revenueSelectedTerritory])

  // Calculate Revenue Stats based on filtered orders
  const revenueStats = useMemo(() => {
    const totalRev = filteredOrdersForRevenue.reduce((sum, o) => {
      const total = Number(o.totalPrice || 0)
      const discount = o.discountEnabled && o.discountAmount > 0 ? o.discountAmount : 1
      return sum + (total * discount)
    }, 0)

    // 2. Calculate Due (for the filtered Revenue orders)
    // Due = Grand Total - (Paid + Commission)
    const totalDueForPeriod = filteredOrdersForRevenue.reduce((sum, o) => {
      const paid = Number(o.paidAmount || 0)
      const commission = (o.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
      const total = Number(o.totalPrice || 0)
      const discount = o.discountEnabled && o.discountAmount > 0 ? o.discountAmount : 1
      const grandTotal = total * discount
      return sum + Math.max(0, grandTotal - (paid + commission))
    }, 0)

    // 3. Calculate Collection & Commission (based on Filtered Orders - Cohort View)
    // This allows Revenue = Collection + Due to hold true (Revenue of orders in period = Collection for those orders + Due for those orders)
    let totalCol = 0
    let totalComm = 0

    filteredOrdersForRevenue.forEach(o => {
      const paid = Number(o.paidAmount || 0)
      const commission = (o.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)

      totalCol += (paid + commission)
      totalComm += commission
    })

    return {
      totalRevenue: totalRev,
      totalCollection: totalCol,
      totalCommission: totalComm,
      totalDue: totalDueForPeriod,
      grossCollection: totalCol, // Total Paid (Cash + Comm)
      cashCollection: totalCol - totalComm // Net Cash Received
    }
  }, [orders, revenueFilterType, revenueSelectedDate, revenueSelectedMonth, revenueSelectedYear, revenueSelectedHalf])

  // Calculate Product Wise Sale Summary
  const productSalesSummary = useMemo(() => {
    const summary = {}

    filteredOrdersForRevenue.forEach(order => {
      const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1

      // 1. Identify all "sale items" from the order
      let saleItems = []
      if (order.items && order.items.length > 0) {
        saleItems = order.items
      } else {
        // Fallback for single-item order format
        saleItems = [{
          product: order.product?._id || order.product,
          productId: order.productId,
          productName: order.productName,
          variant: order.variant,
          quantity: order.quantity,
          unitPrice: order.unitPrice || order.variant?.price || 0,
          totalPrice: order.totalPrice,
          hasOffer: order.hasOffer,
          buyQuantity: order.buyQuantity,
          freeQuantity: order.freeQuantity
        }]
      }

      saleItems.forEach(item => {
        const productId = item.product?._id || item.product
        if (!productId) return

        const v = item.variant || {}
        const packDisplay = v.packSize ? `${v.packSize} ${v.packUnit || ''}`.trim() : ''
        const cartoonDisplay = v.cartoonSize ? `(${v.cartoonSize} ${v.cartoonUnit || 'Pcs'})` : ''
        const variantDisplay = `${packDisplay} ${cartoonDisplay}`.trim()
        const variantKey = v.productCode || variantDisplay || 'Standard'
        const groupKey = `${productId}-${variantKey}`

        if (!summary[groupKey]) {
          const product = products.find(p => p._id === productId) || {}
          summary[groupKey] = {
            productId,
            productName: item.productName || product.name || 'Unknown',
            variant: v,
            variantDisplay,
            unitPrice: parseFloat(item.unitPrice || item.price || v.price || 0),
            quantity: 0,
            freeQuantity: 0,
            totalValue: 0
          }
        }

        const itemQty = parseFloat(item.quantity) || 0
        let freeQty = 0
        if (item.hasOffer && item.buyQuantity && item.freeQuantity) {
          const buyQty = parseFloat(item.buyQuantity) || 0
          const offerFreeQty = parseFloat(item.freeQuantity) || 0
          if (buyQty > 0) {
            const eligibleOffers = Math.floor(itemQty / buyQty)
            freeQty = eligibleOffers * offerFreeQty
          }
        }

        const value = (parseFloat(item.totalPrice) || 0) * discount

        summary[groupKey].quantity += itemQty
        summary[groupKey].freeQuantity += freeQty
        summary[groupKey].totalValue += value
      })
    })

    const summaryArray = Object.values(summary).sort((a, b) => {
      const codeA = parseInt(a.variant?.productCode) || 0
      const codeB = parseInt(b.variant?.productCode) || 0
      return codeA - codeB
    })

    // Calculate Totals
    const totals = summaryArray.reduce((acc, curr) => ({
      quantity: acc.quantity + curr.quantity,
      totalValue: acc.totalValue + curr.totalValue
    }), { quantity: 0, totalValue: 0 })

    return {
      items: summaryArray,
      totals
    }
  }, [filteredOrdersForRevenue, products])

  // Calculate Customer Wise Sale Summary (Ledger)
  const customerSalesSummary = useMemo(() => {
    // Determine the view mode based on selections
    const viewMode = !revenueSelectedRegion ? 'region'
      : !revenueSelectedArea ? 'area'
        : !revenueSelectedTerritory ? 'territory'
          : 'dealer'

    const summary = {}

    // 1. Pre-populate summary with all entities for the current level (Show all even if no orders)
    if (territories) {
      if (viewMode === 'region') {
        const uniqueRegionIds = [...new Set(territories.map(t => t.regionId))].filter(Boolean)
        uniqueRegionIds.forEach(rid => {
          const t = territories.find(tObj => tObj.regionId === rid)
          summary[rid] = {
            id: rid,
            label: t?.zilla || 'N/A',
            revenue: 0,
            due: 0,
            orderCount: 0
          }
        })
      } else if (viewMode === 'area') {
        const filteredTerritories = territories.filter(t => t.regionId === revenueSelectedRegion)
        filteredTerritories.forEach(t => {
          if (t.areaId && !summary[t.areaId]) {
            summary[t.areaId] = {
              id: t.areaId,
              label: t.area || 'N/A',
              revenue: 0,
              due: 0,
              orderCount: 0
            }
          }
        })
      } else if (viewMode === 'territory') {
        const filteredTerritories = territories.filter(t =>
          t.regionId === revenueSelectedRegion && t.areaId === revenueSelectedArea
        )
        filteredTerritories.forEach(t => {
          if (t.territoryId && !summary[t.territoryId]) {
            summary[t.territoryId] = {
              id: t.territoryId,
              label: t.area || 'N/A',
              revenue: 0,
              due: 0,
              orderCount: 0
            }
          }
        })
      } else if (viewMode === 'dealer' && dealers) {
        const filteredDealers = dealers.filter(d => d.territoryId === revenueSelectedTerritory)
        filteredDealers.forEach(d => {
          summary[d._id] = {
            id: d.dealerId || 'N/A',
            label: d.name || 'Unknown',
            shopName: d.shopName || 'N/A',
            revenue: 0,
            due: 0,
            orderCount: 0
          }
        })
      }
    }

    // 2. Aggregate actual order data
    filteredOrdersForRevenue.forEach(order => {
      let groupKey
      const dealerId = order.dealer?._id || order.dealer
      const d = (dealers || []).find(del => del._id === dealerId)

      if (viewMode === 'region') {
        groupKey = d?.regionId || 'Unknown'
      } else if (viewMode === 'area') {
        groupKey = d?.areaId || 'Unknown'
      } else if (viewMode === 'territory') {
        groupKey = d?.territoryId || 'Unknown'
      } else {
        groupKey = dealerId
      }

      if (!groupKey) return

      if (!summary[groupKey]) {
        // Fallback for data that wasn't pre-populated (e.g. data inconsistencies)
        if (viewMode === 'dealer') {
          summary[groupKey] = {
            id: d?.dealerId || order.dealerId || 'N/A',
            label: d?.name || order.dealerName || 'Unknown',
            shopName: d?.shopName || 'N/A',
            revenue: 0,
            due: 0,
            orderCount: 0
          }
        } else {
          summary[groupKey] = {
            id: groupKey,
            label: 'N/A',
            revenue: 0,
            due: 0,
            orderCount: 0
          }
        }
      }

      const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
      const total = Number(order.totalPrice || 0)
      const grandTotal = total * discount

      summary[groupKey].revenue += grandTotal
      summary[groupKey].due += Number(order.dueAmount || 0)
      summary[groupKey].orderCount += 1
    })

    const summaryArray = Object.values(summary).sort((a, b) => b.revenue - a.revenue)

    const totals = summaryArray.reduce((acc, curr) => ({
      revenue: acc.revenue + curr.revenue,
      due: acc.due + curr.due
    }), { revenue: 0, due: 0 })

    return {
      items: summaryArray,
      totals,
      viewMode
    }
  }, [filteredOrdersForRevenue, dealers, territories, revenueSelectedRegion, revenueSelectedArea, revenueSelectedTerritory])

  // Find Employee for the selected Territory in Revenue Dashboard
  const ledgerEmployeeInfo = useMemo(() => {
    if (!revenueSelectedTerritory || !employees || !territories) return null

    // Find territory name to help matching if territoryId isn't enough
    const currentTerritory = territories.find(t => String(t.territoryId) === String(revenueSelectedTerritory))
    const territoryName = currentTerritory?.area

    const emp = employees.find(e => {
      const matchId = e.territoryId && String(e.territoryId) === String(revenueSelectedTerritory)
      const matchPosting = e.postingArea && (
        e.postingArea.includes(revenueSelectedTerritory) ||
        (territoryName && e.postingArea.includes(territoryName))
      )
      return matchId || matchPosting
    })

    if (!emp) return null

    return {
      name: emp.name || 'N/A',
      phone: emp.phone || 'N/A',
      postingArea: emp.postingArea || emp.area || 'N/A'
    }
  }, [revenueSelectedTerritory, employees, territories])

  const inventoryStats = useMemo(() => {
    return {
      totalItems: (inventory || []).length,
      lowStock: (inventory || []).filter(item => (item.requiredQuantity > item.quantity) || (item.quantity <= (item.minStockLevel || 10))).length,
      totalValue: (inventory || []).reduce((sum, item) => sum + (item.quantity * (item.variant?.agentPrice || 0)), 0)
    }
  }, [inventory])

  const sortedInventory = useMemo(() => {
    let list = [...(inventory || [])]
    if (!inventorySortField) return list

    return list.sort((a, b) => {
      let aValue, bValue

      switch (inventorySortField) {
        case 'productName':
          aValue = (a.product?.name || '').toLowerCase()
          bValue = (b.product?.name || '').toLowerCase()
          break
        case 'productCode':
          aValue = (a.variant?.productCode || '').toLowerCase()
          bValue = (b.variant?.productCode || '').toLowerCase()
          break
        case 'quantity':
          aValue = parseFloat(a.quantity) || 0
          bValue = parseFloat(b.quantity) || 0
          break
        case 'required':
          aValue = parseFloat(a.requiredQuantity) || 0
          bValue = parseFloat(b.requiredQuantity) || 0
          break
        case 'delivered':
          aValue = parseFloat(a.deliveredQuantity) || 0
          bValue = parseFloat(b.deliveredQuantity) || 0
          break
        default:
          return 0
      }

      if (typeof aValue === 'string') {
        return inventorySortDirection === 'asc'
          ? aValue.localeCompare(bValue, undefined, { numeric: true, sensitivity: 'base' })
          : bValue.localeCompare(aValue, undefined, { numeric: true, sensitivity: 'base' })
      } else {
        return inventorySortDirection === 'asc'
          ? aValue - bValue
          : bValue - aValue
      }
    })
  }, [inventory, inventorySortField, inventorySortDirection])

  const sortedTerritories = useMemo(() => {
    let list = [...(territories || [])]
    if (!territorySortField) return list

    return list.sort((a, b) => {
      let aValue, bValue

      switch (territorySortField) {
        case 'territoryId':
          aValue = a.territoryId || ''
          bValue = b.territoryId || ''
          break
        case 'regionId':
          aValue = a.regionId || ''
          bValue = b.regionId || ''
          break
        case 'areaId':
          aValue = a.areaId || ''
          bValue = b.areaId || ''
          break
        case 'division':
          aValue = (a.division || '').toLowerCase()
          bValue = (b.division || '').toLowerCase()
          break
        case 'zilla':
          aValue = (a.zilla || '').toLowerCase()
          bValue = (b.zilla || '').toLowerCase()
          break
        case 'area':
          aValue = (a.area || '').toLowerCase()
          bValue = (b.area || '').toLowerCase()
          break
        default:
          return 0
      }

      if (typeof aValue === 'string' && (territorySortField === 'territoryId' || territorySortField === 'regionId' || territorySortField === 'areaId')) {
        return territorySortDirection === 'asc'
          ? aValue.localeCompare(bValue, undefined, { numeric: true, sensitivity: 'base' })
          : bValue.localeCompare(aValue, undefined, { numeric: true, sensitivity: 'base' })
      } else if (typeof aValue === 'string') {
        return territorySortDirection === 'asc'
          ? aValue.localeCompare(bValue)
          : bValue.localeCompare(aValue)
      } else {
        return territorySortDirection === 'asc'
          ? aValue - bValue
          : bValue - aValue
      }
    })
  }, [territories, territorySortField, territorySortDirection])

  const handleSortTerritory = (field) => {
    if (territorySortField === field) {
      setTerritorySortDirection(territorySortDirection === 'asc' ? 'desc' : 'asc')
    } else {
      setTerritorySortField(field)
      setTerritorySortDirection('asc')
    }
  }

  const handleSortInventory = (field) => {
    if (inventorySortField === field) {
      setInventorySortDirection(inventorySortDirection === 'asc' ? 'desc' : 'asc')
    } else {
      setInventorySortField(field)
      setInventorySortDirection('asc')
    }
  }

  const handleSaveOrder = async (e) => {
    e.preventDefault()
    if (!orderForm.dealer || !orderForm.product || !orderForm.quantity) {
      setOrderStatus(language === 'en' ? 'Please fill all required fields' : 'প্রয়োজনীয় সব ঘর পূরণ করুন')
      return
    }

    try {
      setSavingOrder(true)
      setOrderStatus('')

      const selectedProduct = products.find(p => p._id === orderForm.product)
      const orderData = {
        dealer: orderForm.dealer,
        product: orderForm.product,
        quantity: parseFloat(orderForm.quantity) || 1,
        notes: orderForm.notes || '',
        status: orderForm.status || 'Pending',
        approvalStatus: userRole === 'Admin' ? 'Approved' : 'Pending',
        requestedBy: loggedInUserId || null,
        requestedByName: loggedInUser || '',
        requestedByRole: userRole || '',
        discountAmount: parseFloat(discountAmount) || 0,
        discountEnabled: !!discountEnabled
      }

      // Add variant if product has variants and one is selected
      if (selectedProduct && selectedProduct.priceCategory === 'per_variant' && orderForm.variant && orderForm.variant.productCode) {
        orderData.variant = orderForm.variant
      }

      const method = editingOrderId ? 'PUT' : 'POST'
      const url = editingOrderId
        ? `${API_BASE}/api/orders/${editingOrderId}`
        : `${API_BASE}/api/orders`

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderData)
      })

      const data = await res.json().catch(() => ({}))

      if (!res.ok) {
        throw new Error(data.message || data.error || 'Failed to save order')
      }

      await loadOrders()
      setOrderStatus(language === 'en' ? (editingOrderId ? 'Order updated' : 'Order created') : (editingOrderId ? 'অর্ডার আপডেট হয়েছে' : 'অর্ডার তৈরি হয়েছে'))
      resetOrderForm()
      setShowOrderForm(false)

      // Dispatch event to refresh other pages if needed
      window.dispatchEvent(new Event('contentUpdated'))
    } catch (err) {
      console.error('Order save error:', err)
      setOrderStatus(language === 'en' ? err.message : err.message)
    } finally {
      setSavingOrder(false)
    }
  }

  const handleEditOrder = (order) => {
    if (!order) return
    const existingItems = Array.isArray(order.items) && order.items.length
      ? order.items
      : [{
        product: order.product?._id || order.product || '',
        productName: order.productName || '',
        productId: order.productId || '',
        variant: order.variant || { productCode: '', packSize: '', packUnit: 'ml', cartoonSize: 1, cartoonUnit: 'Pcs', price: 0 },
        quantity: order.quantity || 1,
        notes: order.notes || '',
        status: order.status || 'Pending'
      }]
    setOrderCart(existingItems.map((it) => ({
      product: it.product,
      productName: it.productName,
      productId: it.productId,
      variant: it.variant,
      quantity: it.quantity,
      notes: it.notes,
      status: it.status || 'Pending'
    })))
    setShowOrderCart(true)
    setOrderForm({
      dealer: order.dealer?._id || order.dealer || '',
      product: existingItems[0]?.product || '',
      variant: existingItems[0]?.variant || { productCode: '', packSize: '', packUnit: 'ml', cartoonSize: 1, cartoonUnit: 'Pcs', price: 0 },
      quantity: existingItems[0]?.quantity || 1,
      notes: order.notes || '',
      status: order.status || 'Pending',
      paidAmount: order.paidAmount || 0
    })
    setEditingOrderId(order._id)
    setShowOrderForm(true)
    setOrderStatus('')
  }

  const handleDeleteOrder = async (id) => {
    if (!window.confirm(language === 'en' ? 'Are you sure you want to delete this order?' : 'আপনি কি এই অর্ডারটি মুছতে চান?')) {
      return
    }

    try {
      const res = await fetch(`${API_BASE}/api/orders/${id}`, {
        method: 'DELETE'
      })

      if (!res.ok) {
        throw new Error('Failed to delete order')
      }

      // Reload orders and employees to reflect the deletion
      await loadOrders()
      await loadEmployees()

      // If viewing an employee, refresh their data
      if (viewingEmployee) {
        const empRes = await fetch(`${API_BASE}/api/employees/${viewingEmployee._id}`)
        if (empRes.ok) {
          const empData = await empRes.json()
          if (empData.success && empData.data) {
            setViewingEmployee({ ...empData.data, status: normalizeSalaryStatus(empData.data.status) })
          }
        }
      }

      window.dispatchEvent(new Event('contentUpdated'))
    } catch (err) {
      console.error('Order delete error:', err)
      alert(language === 'en' ? 'Failed to delete order' : 'অর্ডার মুছতে ব্যর্থ')
    }
  }

  const handleExportOrders = () => {
    try {
      // Prepare data for export
      const exportData = (sortedOrders || []).map((order) => {
        const totalPrice = parseFloat(order.totalPrice || 0)
        const paid = parseFloat(order.paidAmount || 0)
        const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)

        const paidWithCommission = paid + commission
        const dueAmount = Math.max(0, totalPrice - paidWithCommission)

        return {
          'Date': order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '-',
          'Order ID': customOrderIds[order._id] || order.orderId || '-',
          'Customer': order.dealerName || order.dealer?.name || '-',
          'CID': order.dealerId || order.dealer?.dealerId || '-',
          'Product': order.productName || order.product?.name || '-',
          'Variant': (order.variant?.productCode && order.variant?.packSize) ? `${order.variant.productCode} (${order.variant.packSize} ${order.variant.packUnit || 'ml'})` : '-',
          'Quantity': order.quantity || 0,
          'Created By': order.requestedByName || order.requestedByRole || '-',
          'Total Price': Math.round(totalPrice),
          'Paid Amount': Math.round(paidWithCommission),
          'Due Amount': Math.round(dueAmount),
          'Status': order.status || 'Pending',
          'Approval Status': order.approvalStatus || '-'
        }
      })

      // Create workbook and worksheet
      const ws = XLSX.utils.json_to_sheet(exportData)
      const wb = XLSX.utils.book_new()
      XLSX.utils.book_append_sheet(wb, ws, 'Orders')

      // Generate filename with current date
      const dateStr = new Date().toISOString().split('T')[0]
      const filename = `Orders_${dateStr}.xlsx`

      // Write file and trigger download
      XLSX.writeFile(wb, filename)
    } catch (err) {
      console.error('Export error:', err)
      alert(language === 'en' ? 'Failed to export orders' : 'অর্ডার রপ্তানি করতে ব্যর্থ')
    }
  }

  const handlePrintOrder = (order) => {
    setPrintingOrder(order)
    setTimeout(() => {
      window.print()
      setTimeout(() => {
        setPrintingOrder(null)
      }, 500)
    }, 500)
  }

  const handleShowDealerOrders = async (dealer = null) => {
    const targetDealer = dealer || viewingDealer
    if (!targetDealer?._id && !targetDealer?.dealerId) return
    try {
      setDealerOrdersLoading(true)
      setDealerOrdersStatus('')
      const res = await fetch(`${API_BASE}/api/orders`)
      if (!res.ok) {
        throw new Error('Failed to fetch orders')
      }
      const data = await res.json()

      // Filter orders to show ONLY this specific dealer's orders - match strictly by dealerId
      const targetDealerId = targetDealer.dealerId
      if (!targetDealerId) {
        setDealerOrdersStatus(language === 'en' ? 'Dealer ID not found.' : 'ডিলার আইডি পাওয়া যায়নি।')
        setDealerOrders([])
        setShowDealerOrders(true)
        setDealerOrdersLoading(false)
        return
      }

      const filtered = (data.data || []).filter((order) => {
        // Exclude cancelled orders
        if (order.status === 'Cancelled') {
          return false
        }

        // STRICT MATCH: Prioritize dealerId string match
        const orderDealerId = order.dealerId

        // First try: Match by dealerId string (most reliable)
        if (orderDealerId && orderDealerId === targetDealerId) {
          return true
        }

        // Second try: If dealerId doesn't exist or doesn't match, try dealer._id
        // This handles cases where orders might reference dealer by ObjectId
        if (targetDealer._id) {
          const orderDealerObjectId = order.dealer?._id || order.dealer
          if (orderDealerObjectId && String(orderDealerObjectId) === String(targetDealer._id)) {
            return true
          }
        }

        // No match found - exclude this order
        return false
      })

      console.log('Dealer Orders Filter (STRICT):', {
        targetDealerId: targetDealerId,
        viewingDealer: { dealerId: targetDealer.dealerId, _id: targetDealer._id, name: targetDealer.name },
        totalOrders: (data.data || []).length,
        filteredOrders: filtered.length,
        filteredOrderDetails: filtered.map(o => ({
          orderId: o.orderId,
          dealerId: o.dealerId,
          dealerName: o.dealerName,
          totalPrice: o.totalPrice,
          paidAmount: o.paidAmount,
          dueAmount: o.dueAmount
        }))
      })

      setDealerOrders(filtered)
      setShowDealerOrders(true)
      if (!filtered.length) {
        setDealerOrdersStatus(language === 'en' ? 'No orders for this dealer yet.' : 'এই ডিলারের কোনো অর্ডার নেই।')
      }
    } catch (err) {
      console.error('Dealer orders load error:', err)
      setDealerOrdersStatus(language === 'en' ? (err.message || 'Failed to load orders') : (err.message || 'অর্ডার লোড ব্যর্থ'))
    } finally {
      setDealerOrdersLoading(false)
    }
  }

  const handleSaveDealerOrderPaidAmount = async (orderId, newPaidAmount) => {
    if ((userRole || '').toLowerCase() !== 'admin') return

    try {
      setSavingDealerOrderPaidAmount(true)
      const paidAmount = parseFloat(newPaidAmount) || 0
      const order = dealerOrders.find(o => o._id === orderId)
      if (!order) return

      const totalPrice = parseFloat(order.totalPrice || 0)
      const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
      const grandTotal = totalPrice * discount
      const existingComm = (order.paymentHistory || []).reduce((sum, p) => sum + (parseFloat(p.commission) || 0), 0)
      const dueAmount = Math.max(0, grandTotal - (paidAmount + existingComm))

      const res = await fetch(`${API_BASE}/api/orders/${orderId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          paidAmount: paidAmount,
          dueAmount: dueAmount
        })
      })

      if (!res.ok) {
        throw new Error('Failed to update paid amount')
      }

      // Reload dealer orders to get updated data
      await handleShowDealerOrders()
      setEditingDealerOrderPaidAmount(null)

      // Also reload main orders list
      await loadOrders()
    } catch (err) {
      console.error('Failed to update paid amount:', err)
      alert(language === 'en' ? 'Failed to update paid amount' : 'পরিশোধিত পরিমাণ আপডেট ব্যর্থ')
    } finally {
      setSavingDealerOrderPaidAmount(false)
    }
  }

  const handleSaveTotalPaid = async (newTotalPaid) => {
    if ((userRole || '').toLowerCase() !== 'admin') return

    try {
      setSavingTotalPaid(true)
      const newTotalPaidValue = parseFloat(newTotalPaid) || 0
      const currentTotalPaid = dealerOrders.reduce((sum, order) => {
        return sum + (parseFloat(order.paidAmount) || 0)
      }, 0)

      const difference = newTotalPaidValue - currentTotalPaid

      if (difference === 0) {
        setEditingTotalPaid(false)
        return
      }

      // Sort orders by due amount (highest first) to reduce due amounts one by one
      const sortedOrders = [...dealerOrders].map(order => {
        const totalPrice = parseFloat(order.totalPrice || 0)
        const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
        const grandTotal = totalPrice * discount
        const paidAmount = parseFloat(order.paidAmount || 0)
        const commission = (order.paymentHistory || []).reduce((sum, p) => sum + (parseFloat(p.commission) || 0), 0)
        const dueAmount = order.dueAmount !== undefined
          ? parseFloat(order.dueAmount)
          : Math.max(0, grandTotal - (paidAmount + commission))
        return { ...order, calculatedDue: dueAmount, calculatedComm: commission }
      }).sort((a, b) => b.calculatedDue - a.calculatedDue)

      let remainingDifference = difference

      // Update orders one by one, reducing due amounts
      for (const order of sortedOrders) {
        if (remainingDifference === 0) break

        const totalPrice = parseFloat(order.totalPrice || 0)
        const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
        const grandTotal = totalPrice * discount
        const currentPaid = parseFloat(order.paidAmount || 0)
        const currentComm = order.calculatedComm
        const currentDue = order.calculatedDue

        if (remainingDifference > 0) {
          // Increase paid amount - reduce due amount
          const amountToAdd = Math.min(remainingDifference, currentDue)
          const newPaidAmount = currentPaid + amountToAdd
          const newDueAmount = Math.max(0, grandTotal - (newPaidAmount + currentComm))

          const res = await fetch(`${API_BASE}/api/orders/${order._id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              paidAmount: newPaidAmount,
              dueAmount: newDueAmount
            })
          })

          if (!res.ok) {
            throw new Error(`Failed to update order ${order.orderId}`)
          }

          remainingDifference -= amountToAdd
        } else {
          // Decrease paid amount - increase due amount
          const amountToReduce = Math.min(Math.abs(remainingDifference), currentPaid)
          const newPaidAmount = Math.max(0, currentPaid - amountToReduce)
          const newDueAmount = Math.max(0, grandTotal - (newPaidAmount + currentComm))

          const res = await fetch(`${API_BASE}/api/orders/${order._id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              paidAmount: newPaidAmount,
              dueAmount: newDueAmount
            })
          })

          if (!res.ok) {
            throw new Error(`Failed to update order ${order.orderId}`)
          }

          remainingDifference += amountToReduce
        }
      }
      // Reload dealer orders to get updated data
      await handleShowDealerOrders()
      setEditingTotalPaid(false)

      // Also reload main orders list
      await loadOrders()
    } catch (err) {
      console.error('Failed to update total paid:', err)
      alert(language === 'en' ? 'Failed to update total paid' : 'মোট পরিশোধিত আপডেট ব্যর্থ')
    } finally {
      setSavingTotalPaid(false)
    }
  }

  const handleAddCollection = async (collectionAmount) => {
    if ((userRole || '').toLowerCase() !== 'admin') return

    const amount = parseFloat(collectionAmount) || 0
    if (amount <= 0) {
      setAddCollectionAmount('')
      return
    }

    try {
      setSavingCollection(true)

      const sortedOrders = [...filteredDealerOrders].map(order => {
        const totalPrice = parseFloat(order.totalPrice || 0)
        const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
        const grandTotal = totalPrice * discount
        const paidAmount = parseFloat(order.paidAmount || 0)
        const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
        const dueAmount = order.dueAmount !== undefined
          ? parseFloat(order.dueAmount)
          : Math.max(0, grandTotal - (paidAmount + commission))
        return { ...order, calculatedDue: dueAmount }
      }).sort((a, b) => b.calculatedDue - a.calculatedDue)

      let remainingAmount = amount

      for (const order of sortedOrders) {
        if (remainingAmount <= 0) break

        const totalPrice = parseFloat(order.totalPrice) || 0
        const currentPaid = parseFloat(order.paidAmount || 0)
        const currentDue = order.calculatedDue
        const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
        const grandTotal = totalPrice * discount

        const amountToAdd = Math.min(remainingAmount, currentDue)
        if (amountToAdd <= 0) continue

        let commissionAmount = 0
        if (addCollectionCommission) {
          const rate = parseFloat(addCollectionCommission.replace('%', '')) || 0
          commissionAmount = (amountToAdd * rate) / 100
        }

        const newPaidAmount = currentPaid + amountToAdd
        const currentHistComm = (order.paymentHistory || []).reduce((sum, p) => sum + (parseFloat(p.commission) || 0), 0)
        const totalComm = currentHistComm + commissionAmount
        const newDueAmount = Math.max(0, grandTotal - (newPaidAmount + totalComm))

        const res = await fetch(`${API_BASE}/api/orders/${order._id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            paidAmount: newPaidAmount,
            dueAmount: newDueAmount,
            newPayment: {
              amount: amountToAdd,
              commission: commissionAmount,
              date: new Date()
            }
          })
        })

        if (!res.ok) {
          throw new Error(`Failed to update order ${order.orderId}`)
        }

        remainingAmount -= amountToAdd
      }

      await handleShowDealerOrders()
      await loadOrders()
      setAddCollectionAmount('')
      setAddCollectionCommission('')
      alert(language === 'en' ? 'Collection added successfully!' : 'সংগ্রহ সফলভাবে যোগ করা হয়েছে!')
    } catch (err) {
      console.error('Failed to add collection:', err)
      alert(language === 'en' ? 'Failed to add collection' : 'সংগ্রহ যোগ করতে ব্যর্থ হয়েছে')
    } finally {
      setSavingCollection(false)
    }
  }

  const handleReturnProduct = async () => {
    if ((userRole || '').toLowerCase() !== 'admin') return
    if (!returnForm.productId || (!returnForm.packQuantity && !returnForm.cartonQuantity)) {
      alert(language === 'en' ? 'Please select product and quantity' : 'পণ্য এবং পরিমাণ নির্বাচন করুন')
      return
    }

    try {
      setSavingReturn(true)
      const product = products.find(p => p._id === returnForm.productId)
      if (!product) throw new Error('Product not found')

      let unitPrice = 0
      let cartonSize = 1

      if (product.priceCategory === 'per_variant') {
        const variant = product.variants.find(v => v.productCode === returnForm.variant)
        if (!variant) throw new Error('Variant not found')
        cartonSize = parseFloat(variant.cartoonSize) || 1
        // variant.price is the carton price, divide by carton size to get unit price
        const cartonPrice = parseFloat(variant.price) || 0
        unitPrice = cartonPrice / cartonSize
      } else {
        unitPrice = parseFloat(product.price) || 0
        cartonSize = product.variants?.[0]?.cartoonSize || 1
      }

      const packQty = parseFloat(returnForm.packQuantity) || 0
      const cartonQty = parseFloat(returnForm.cartonQuantity) || 0

      console.log('Return Product Info:', {
        productName: product.name,
        priceCategory: product.priceCategory,
        variantCode: returnForm.variant,
        unitPrice: unitPrice,
        cartonSize: cartonSize,
        packQty: packQty,
        cartonQty: cartonQty
      })

      // Calculate base return amount (before discount)
      const baseReturnAmount = (packQty * unitPrice) + (cartonQty * unitPrice * cartonSize)

      if (baseReturnAmount <= 0) return

      const sortedOrders = [...filteredDealerOrders].map(order => {
        const totalPrice = parseFloat(order.totalPrice || 0)
        const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
        const grandTotal = totalPrice * discount
        const paidAmount = parseFloat(order.paidAmount || 0)
        const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
        const dueAmount = order.dueAmount !== undefined
          ? parseFloat(order.dueAmount)
          : Math.max(0, grandTotal - (paidAmount + commission))
        return { ...order, calculatedDue: dueAmount }
      }).sort((a, b) => b.calculatedDue - a.calculatedDue)

      let remainingBaseReturn = baseReturnAmount

      for (const order of sortedOrders) {
        if (remainingBaseReturn <= 0) break

        const totalPrice = parseFloat(order.totalPrice) || 0
        const currentPaid = parseFloat(order.paidAmount || 0)
        const currentDue = order.calculatedDue
        const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1

        // Calculate the discounted return amount for this order
        const discountedReturnForOrder = remainingBaseReturn * discount
        const amountToDeduct = Math.min(discountedReturnForOrder, currentDue)
        if (amountToDeduct <= 0) continue

        // Deduct from totalPrice (base price before discount)
        const baseAmountToDeduct = amountToDeduct / discount
        const newTotalPrice = totalPrice - baseAmountToDeduct
        const newGrandTotal = newTotalPrice * discount
        const currentHistComm = (order.paymentHistory || []).reduce((sum, p) => sum + (parseFloat(p.commission) || 0), 0)
        const newDueAmount = Math.max(0, newGrandTotal - (currentPaid + currentHistComm))

        console.log('Return Calculation:', {
          orderId: order.orderId,
          originalTotalPrice: totalPrice,
          discount: discount,
          baseReturnAmount: baseReturnAmount,
          discountedReturnForOrder: discountedReturnForOrder,
          amountToDeduct: amountToDeduct,
          baseAmountToDeduct: baseAmountToDeduct,
          newTotalPrice: newTotalPrice,
          newGrandTotal: newGrandTotal,
          currentPaid: currentPaid,
          newDueAmount: newDueAmount
        })

        const res = await fetch(`${API_BASE}/api/orders/${order._id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            totalPrice: newTotalPrice,
            dueAmount: newDueAmount,
            newPayment: {
              amount: amountToDeduct,
              commission: 0,
              type: 'Return',
              date: new Date(),
              note: `Product Return: ${product.name} - ${packQty} P/B, ${cartonQty} C`,
              metadata: {
                productName: product.name,
                productId: product._id,
                variantCode: returnForm.variant,
                packQuantity: packQty,
                cartonQuantity: cartonQty,
                returnPlace: returnForm.returnPlace
              }
            }
          })
        })

        if (!res.ok) throw new Error('Failed to update order for return')
        remainingBaseReturn -= baseAmountToDeduct
      }

      console.log('Return processed successfully, refreshing dealer orders...')
      await handleShowDealerOrders(viewingDealer)
      await loadOrders()
      setReturnForm({ productId: '', variant: null, packQuantity: '', cartonQuantity: '', returnPlace: '' })
      setShowReturnForm(false)
      alert(language === 'en' ? 'Product return processed successfully!' : 'পণ্য ফেরত সফলভাবে সম্পন্ন হয়েছে!')
    } catch (err) {
      console.error('Error returning product:', err)
      alert(language === 'en' ? 'Failed to process return' : 'ফেরত সম্পন্ন করতে ব্যর্থ হয়েছে')
    } finally {
      setSavingReturn(false)
    }
  }


  const handleAddOrderToCart = () => {
    if (!orderForm.dealer) {
      setOrderStatus(language === 'en' ? 'Please select a dealer' : 'দয়া করে ডিলার নির্বাচন করুন')
      return
    }
    if (!orderForm.product) {
      setOrderStatus(language === 'en' ? 'Please select a product' : 'দয়া করে পণ্য নির্বাচন করুন')
      return
    }
    const selectedProduct = products.find((p) => p._id === orderForm.product)
    if (selectedProduct && selectedProduct.priceCategory === 'per_variant' && selectedProduct.variants?.length) {
      if (!orderForm.variant?.productCode) {
        setOrderStatus(language === 'en' ? 'Please select a variant' : 'দয়া করে ভ্যারিয়েন্ট নির্বাচন করুন')
        return
      }
    }

    const qty = parseFloat(orderForm.quantity) || 1
    const item = {
      product: orderForm.product,
      productName: selectedProduct?.name || '',
      productId: selectedProduct?.productId || '',
      variant: orderForm.variant?.productCode ? { ...orderForm.variant } : null,
      quantity: qty,
      notes: orderForm.notes || '',
      status: orderForm.status || 'Pending',
      approvalStatus: userRole === 'Admin' ? 'Approved' : 'Pending',
      requestedBy: loggedInUserId || null,
      requestedByName: loggedInUser || '',
      requestedByRole: userRole || ''
    }

    setOrderCart((prev) => [...prev, item])
    setShowOrderCart(true)
    setOrderStatus(language === 'en' ? 'Added to cart' : 'কার্টে যোগ হয়েছে')

    // Reset item-specific fields but keep dealer/status
    setOrderForm((prev) => ({
      ...prev,
      product: '',
      variant: { productCode: '', packSize: '', packUnit: 'ml', cartoonSize: 1, cartoonUnit: 'Pcs', price: 0 },
      quantity: 1,
      notes: ''
    }))
    setSelectedProductVariants([])
  }

  const handleRemoveCartItem = (idx) => {
    setOrderCart((prev) => prev.filter((_, i) => i !== idx))
  }

  const getCartItemTotal = (item) => {
    const product = products.find((p) => p._id === item.product)
    const qty = parseFloat(item.quantity) || 0
    let unitPrice = 0

    if (item.variant && item.variant.price !== undefined && item.variant.price !== null) {
      unitPrice = parseFloat(item.variant.price) || 0
    }

    if (!unitPrice && product) {
      if (product.priceCategory === 'per_variant' && item.variant?.productCode) {
        const pv = product.variants?.find((v) => v.productCode === item.variant.productCode)
        if (pv) {
          unitPrice = pv.price || 0
        }
      }
      if (!unitPrice) {
        unitPrice = product.price || 0
      }
    }

    return unitPrice * qty
  }

  const getOrderCartTotal = () => {
    return orderCart.reduce((sum, item) => sum + getCartItemTotal(item), 0)
  }

  const handleConfirmOrders = async () => {
    if (!orderForm.dealer) {
      setOrderStatus(language === 'en' ? 'Please select a dealer' : 'দয়া করে ডিলার নির্বাচন করুন')
      return
    }
    if (!orderCart.length) {
      setOrderStatus(language === 'en' ? 'Cart is empty' : 'কার্ট খালি')
      return
    }

    try {
      setSavingOrder(true)
      setOrderStatus('')

      const payload = {
        dealer: orderForm.dealer,
        items: orderCart.map((item) => ({
          product: item.product,
          variant: item.variant && item.variant.productCode ? {
            productCode: item.variant.productCode,
            packSize: item.variant.packSize || '',
            packUnit: item.variant.packUnit || 'ml',
            cartoonSize: item.variant.cartoonSize || 1,
            cartoonUnit: item.variant.cartoonUnit || 'Pcs',
            price: item.variant.price || 0
          } : undefined,
          quantity: item.quantity,
          notes: item.notes || ''
        })),
        status: editingOrderId ? (orderForm.status || 'Pending') : (orderCart[0]?.status || 'Pending'),
        approvalStatus: userRole === 'Admin' ? 'Approved' : 'Pending',
        requestedBy: loggedInUserId || null,
        requestedByName: loggedInUser || '',
        requestedByRole: userRole || '',
        discountAmount: parseFloat(discountAmount) || 0,
        discountEnabled: !!discountEnabled,
        targetHalf: orderForm.targetHalf || (new Date().getMonth() < 6 ? 'H1' : 'H2'),
        targetYear: orderForm.targetYear || new Date().getFullYear(),
        targetMonth: orderForm.targetMonth !== undefined ? orderForm.targetMonth : new Date().getMonth(),
        ...(editingOrderId && {
          paidAmount: orderForm.paidAmount || 0
        })
      }

      const method = editingOrderId ? 'PUT' : 'POST'
      const url = editingOrderId
        ? `${API_BASE}/api/orders/${editingOrderId}`
        : `${API_BASE}/api/orders`

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })

      const data = await res.json().catch(() => ({}))
      if (!res.ok) {
        throw new Error(data.message || data.error || 'Failed to save order')
      }

      await loadOrders()
      await loadOrderRequests()
      setOrderStatus(language === 'en' ? (editingOrderId ? 'Order updated' : 'Order created') : (editingOrderId ? 'অর্ডার আপডেট হয়েছে' : 'অর্ডার তৈরি হয়েছে'))
      setOrderCart([])
      setShowOrderCart(false)
      resetOrderForm()
      setEditingOrderId(null)
      window.dispatchEvent(new Event('contentUpdated'))
    } catch (err) {
      console.error('Order confirm error:', err)
      setOrderStatus(language === 'en' ? err.message : err.message)
    } finally {
      setSavingOrder(false)
    }
  }

  const resetProductForm = () => {
    setProductForm({
      productId: '',
      variants: [],
      price: '',
      priceCategory: 'single',
      name: '',
      nameBn: '',
      genericName: '',
      genericNameBn: '',
      category: 'Herbicide',
      categoryBn: '',
      description: '',
      descriptionBn: '',
      usage: '',
      usageBn: '',
      benefits: '',
      benefitsBn: '',
      application: '',
      applicationBn: '',
      safety: '',
      safetyBn: '',
      image: '',
      hasOffer: false,
      buyQuantity: '',
      freeQuantity: ''
    })
    setEditingProductId(null)
  }

  const handleSaveProduct = async (e) => {
    e.preventDefault()
    if (!productForm.name || !productForm.genericName || !productForm.category || !productForm.description || !productForm.usage) {
      setProductStatus(language === 'en' ? 'Please fill all required fields' : 'প্রয়োজনীয় সব ঘর পূরণ করুন')
      return
    }
    if (productForm.hasOffer && (!productForm.buyQuantity || !productForm.freeQuantity)) {
      setProductStatus(language === 'en' ? 'Please provide buy quantity and free quantity for the offer' : 'অফারের জন্য ক্রয় পরিমাণ এবং ফ্রি পরিমাণ প্রদান করুন')
      return
    }
    try {
      setSavingProduct(true)
      setProductStatus('')
      const method = editingProductId ? 'PUT' : 'POST'
      const url = editingProductId
        ? `${API_BASE}/api/products/${editingProductId}`
        : `${API_BASE}/api/products`

      // Prepare data to send - ensure all fields are included
      const dataToSend = {
        productId: productForm.productId || '',
        variants: productForm.variants || [],
        price: productForm.price || '',
        priceCategory: productForm.priceCategory || 'single',
        name: productForm.name || '',
        nameBn: productForm.nameBn || '',
        genericName: productForm.genericName || '',
        genericNameBn: productForm.genericNameBn || '',
        category: productForm.category || 'Herbicide',
        categoryBn: productForm.categoryBn || '',
        description: productForm.description || '',
        descriptionBn: productForm.descriptionBn || '',
        usage: productForm.usage || '',
        usageBn: productForm.usageBn || '',
        benefits: productForm.benefits || '',
        benefitsBn: productForm.benefitsBn || '',
        application: productForm.application || '',
        applicationBn: productForm.applicationBn || '',
        safety: productForm.safety || '',
        safetyBn: productForm.safetyBn || '',
        image: productForm.image || '',
        hasOffer: productForm.hasOffer || false,
        buyQuantity: productForm.buyQuantity || '',
        freeQuantity: productForm.freeQuantity || ''
      }

      console.log('Saving product:', {
        method,
        url,
        productForm: {
          ...dataToSend,
          image: dataToSend.image ? (dataToSend.image.length > 100 ? '[...base64...]' : dataToSend.image) : ''
        }
      })

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataToSend)
      })

      const data = await res.json()
      console.log('Product save response:', { status: res.status, ok: res.ok, data })

      if (!res.ok) {
        const errorMsg = data.message || 'Failed to save product'
        console.error('Product save error:', errorMsg, data)
        setProductStatus(language === 'en' ? errorMsg : errorMsg)
        return
      }

      const saved = data.data
      setProducts((prev) => {
        if (editingProductId) {
          return prev.map((item) => (item._id === editingProductId ? saved : item))
        }
        return [saved, ...prev]
      })
      setProductStatus(language === 'en' ? (editingProductId ? 'Product updated' : 'Product added') : 'পণ্য সংরক্ষণ সম্পন্ন')
      resetProductForm()
      setShowProductForm(false)
      // Dispatch event to notify other pages of product update
      window.dispatchEvent(new Event('contentUpdated'))
    } catch (err) {
      console.error('Failed to save product', err)
      setProductStatus(language === 'en' ? `Failed to save product: ${err.message}` : `পণ্য সংরক্ষণ ব্যর্থ: ${err.message}`)
    } finally {
      setSavingProduct(false)
    }
  }

  const handleEditProduct = (product) => {
    if (!product) return
    setProductForm({
      productId: product.productId || '',
      variants: Array.isArray(product.variants) ? product.variants.map(v => ({ ...v, price: v.price || 0 })) : [],
      price: product.price || '',
      priceCategory: product.priceCategory || 'single',
      name: product.name || '',
      nameBn: product.nameBn || '',
      genericName: product.genericName || '',
      genericNameBn: product.genericNameBn || '',
      category: product.category || 'Herbicide',
      categoryBn: product.categoryBn || '',
      description: product.description || '',
      descriptionBn: product.descriptionBn || '',
      usage: product.usage || '',
      usageBn: product.usageBn || '',
      benefits: product.benefits || '',
      benefitsBn: product.benefitsBn || '',
      application: product.application || '',
      applicationBn: product.applicationBn || '',
      safety: product.safety || '',
      safetyBn: product.safetyBn || '',
      image: product.image || '',
      hasOffer: product.hasOffer || false,
      buyQuantity: product.buyQuantity || '',
      freeQuantity: product.freeQuantity || ''
    })
    setEditingProductId(product._id || null)
    setShowProductForm(true)
    setProductStatus('')
  }

  const addVariant = () => {
    setProductForm({
      ...productForm,
      variants: [...(productForm.variants || []), { productCode: '', packSize: '', packUnit: 'ml', cartoonSize: '', cartoonUnit: 'Pcs', price: 0 }]
    })
  }

  const removeVariant = (index) => {
    const newVariants = [...(productForm.variants || [])]
    newVariants.splice(index, 1)
    setProductForm({ ...productForm, variants: newVariants })
  }

  const updateVariant = (index, field, value) => {
    const newVariants = [...(productForm.variants || [])]
    newVariants[index] = { ...newVariants[index], [field]: value }
    setProductForm({ ...productForm, variants: newVariants })
  }

  const handleDeleteProduct = async (productId) => {
    if (!productId) return
    const confirmed = window.confirm(language === 'en' ? 'Delete this product?' : 'এই পণ্যটি মুছবেন?')
    if (!confirmed) return
    try {
      const res = await fetch(`${API_BASE}/api/products/${productId}`, { method: 'DELETE' })
      if (!res.ok) {
        throw new Error('Failed to delete product')
      }
      setProducts((prev) => prev.filter((item) => item._id !== productId))
      setProductStatus(language === 'en' ? 'Product deleted' : 'পণ্য মুছে ফেলা হয়েছে')
      // Dispatch event to notify other pages of product deletion
      window.dispatchEvent(new Event('contentUpdated'))
    } catch (err) {
      console.error('Failed to delete product', err)
      setProductStatus(language === 'en' ? 'Delete failed' : 'মুছে ফেলা ব্যর্থ')
    }
  }

  const fileToBase64 = (file) => new Promise((resolve, reject) => {
    const reader = new FileReader()
    reader.onload = () => resolve(reader.result)
    reader.onerror = (error) => reject(error)
    reader.readAsDataURL(file)
  })

  const normalizeSalaryStatus = (status) => status === 'Paid' ? 'Paid' : 'Unpaid'

  const handleSaveEmployeeEdit = async () => {
    if (!editingEmployeeData || !viewingEmployee?._id) return

    try {
      setSavingEmployee(true)
      const res = await fetch(`${API_BASE}/api/employees/${viewingEmployee._id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: editingEmployeeData.name,
          email: editingEmployeeData.email,
          phone: editingEmployeeData.phone,
          address: editingEmployeeData.address,
          nid: editingEmployeeData.nid,
          document: editingEmployeeData.document,
          emergencyContactName: editingEmployeeData.emergencyContactName,
          emergencyContact: editingEmployeeData.emergencyContact,
          salary: editingEmployeeData.salary,
          salesTarget: editingEmployeeData.salesTarget,
          bankName: editingEmployeeData.bankName,
          bankBranch: editingEmployeeData.bankBranch,
          accountNumber: editingEmployeeData.accountNumber,
          department: editingEmployeeData.department,
          regionId: editingEmployeeData.regionId,
          areaId: editingEmployeeData.areaId,
          territoryId: editingEmployeeData.territoryId,
          postingArea: editingEmployeeData.postingArea,
          designation: editingEmployeeData.designation,
          photo: editingEmployeeData.photo,
          status: editingEmployeeData.status
        })
      })

      if (!res.ok) throw new Error('Failed to update employee')

      const updatedData = await res.json()

      // Update viewing employee and employee list
      setViewingEmployee({ ...updatedData.data, status: normalizeSalaryStatus(updatedData.data.status) })

      // Refresh employee list
      const resEmployees = await fetch(`${API_BASE}/api/employees`)
      if (resEmployees.ok) {
        const empData = await resEmployees.json()
        setEmployees((empData.data || []).map((e) => ({
          ...e,
          status: normalizeSalaryStatus(e.status)
        })))
      }

      setIsEditingEmployee(false)
      setEditingEmployeeData(null)
      setSavingEmployee(false)
    } catch (err) {
      console.error('Failed to save employee', err)
      alert(language === 'en' ? 'Failed to update employee' : 'কর্মচারী আপডেট করতে ব্যর্থ')
      setSavingEmployee(false)
    }
  }

  const handleAddDealer = async (e) => {
    e.preventDefault()
    const finalDealerId = newDealer.dealerId || getNextDealerId()
    if (!newDealer.name) {
      setDealerStatus(language === 'en' ? 'Name is required' : 'নাম প্রয়োজন')
      return
    }
    try {
      setDealerStatus(language === 'en' ? 'Saving...' : 'সংরক্ষণ করা হচ্ছে...')
      const selectedEmp = employees.find((emp) => String(emp._id) === String(newDealer.assignedTo))
      const res = await fetch(`${API_BASE}/api/dealers`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          dealerId: finalDealerId,
          name: newDealer.name,
          shopName: newDealer.shopName,
          phone: newDealer.phone,
          email: newDealer.email,
          address: newDealer.address,
          photo: newDealer.photo,
          nid: newDealer.nid,
          tradeLicense: newDealer.tradeLicense,
          pesticideLicense: newDealer.pesticideLicense,
          regionId: newDealer.regionId,
          areaId: newDealer.areaId,
          territoryId: newDealer.territoryId,
          area: newDealer.area,
          agreement: newDealer.agreement,
          assignedTo: newDealer.assignedTo || undefined,
          assignedToName: selectedEmp?.name || newDealer.assignedToName || '',
          assignedToId: selectedEmp?.employeeId || newDealer.assignedToId || ''
        })
      })
      if (!res.ok) throw new Error('Failed to save dealer')
      const data = await res.json()
      const saved = data.data
      setDealers((prev) => [saved, ...prev])
      setDealerStatus(language === 'en' ? 'Dealer saved' : 'ডিলার সংরক্ষিত')
      setNewDealer({
        dealerId: getNextDealerId(),
        name: '',
        phone: '',
        email: '',
        address: '',
        photo: '',
        nid: '',
        tradeLicense: '',
        pesticideLicense: '',
        regionId: '',
        areaId: '',
        territoryId: '',
        area: '',
        agreement: '',
        assignedTo: '',
        assignedToName: '',
        assignedToId: ''
      })
      setShowDealerForm(false)
    } catch (err) {
      console.error('Dealer save failed', err)
      setDealerStatus(language === 'en' ? 'Save failed' : 'সংরক্ষণ ব্যর্থ')
    }
  }

  const handleSaveDealerEdit = async () => {
    if (!editingDealerData || !viewingDealer?._id) return
    try {
      setSavingDealer(true)
      const selectedEmp = employees.find((emp) => String(emp._id) === String(editingDealerData.assignedTo))
      const res = await fetch(`${API_BASE}/api/dealers/${viewingDealer._id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          dealerId: editingDealerData.dealerId,
          name: editingDealerData.name,
          shopName: editingDealerData.shopName,
          phone: editingDealerData.phone,
          email: editingDealerData.email,
          address: editingDealerData.address,
          photo: editingDealerData.photo,
          nid: editingDealerData.nid,
          tradeLicense: editingDealerData.tradeLicense,
          pesticideLicense: editingDealerData.pesticideLicense,
          area: editingDealerData.area,
          agreement: editingDealerData.agreement,
          assignedTo: editingDealerData.assignedTo || undefined,
          assignedToName: selectedEmp?.name || editingDealerData.assignedToName || '',
          assignedToId: selectedEmp?.employeeId || editingDealerData.assignedToId || ''
        })
      })

      if (!res.ok) throw new Error('Failed to update dealer')

      const updated = await res.json()
      setViewingDealer(updated.data)
      setDealers((prev) =>
        prev.map((d) => (d._id === viewingDealer._id ? updated.data : d))
      )
      setIsEditingDealer(false)
      setEditingDealerData(null)
      setSavingDealer(false)
    } catch (err) {
      console.error('Dealer update failed', err)
      alert(language === 'en' ? 'Failed to update dealer' : 'ডিলার আপডেট ব্যর্থ')
      setSavingDealer(false)
    }
  }

  const handleDeleteDealer = async () => {
    if (!viewingDealer?._id) return
    if (!window.confirm(language === 'en' ? 'Delete this dealer?' : 'এই ডিলারকে মুছবেন?')) return

    try {
      const res = await fetch(`${API_BASE}/api/dealers/${viewingDealer._id}`, {
        method: 'DELETE'
      })
      if (!res.ok) throw new Error('Failed to delete dealer')
      setDealers((prev) => prev.filter((d) => d._id !== viewingDealer._id))
      setViewingDealer(null)
      setIsEditingDealer(false)
      setEditingDealerData(null)
    } catch (err) {
      console.error('Dealer delete failed', err)
      alert(language === 'en' ? 'Failed to delete dealer' : 'ডিলার মুছে ফেলতে ব্যর্থ')
    }
  }

  // Check if user is already logged in
  useEffect(() => {
    const fetchInitial = async () => {
      try {
        // Only load admin profile on initial load if not authenticated yet
        // Profile will be loaded after login
        if (!isAuthenticated) {
          const resProfile = await fetch(`${API_BASE}/api/admin/profile`)
          if (resProfile.ok) {
            const data = await resProfile.json()
            setProfileData({
              name: data.name || 'Admin',
              email: data.email || 'admin@example.com',
              phone: data.phone || '+880 1234 567890',
              address: data.address || 'Dhaka, Bangladesh',
              photo: data.photo || '',
              designation: data.designation || '',
              role: 'Admin'
            })
          }
        }
        const resPassword = await fetch(`${API_BASE}/api/admin/password`)
        if (resPassword.ok) {
          const pwd = await resPassword.json()
          setAdminPassword(pwd.password || 'admin123')
        }
        const resImages = await fetch(`${API_BASE}/api/page-images`)
        if (resImages.ok) {
          const imgs = await resImages.json()
          setPageImages({ ...defaultPageImages, ...(imgs?.data || {}) })
        } else {
          setPageImages(defaultPageImages)
        }
        await loadEmployees()
      } catch (err) {
        console.error('Failed to load initial data', err)
        setPageImages(defaultPageImages)
      }
    }
    fetchInitial()
  }, [])

  // Reload profile after authentication toggles
  useEffect(() => {
    if (isAuthenticated) {
      if (isEmployee && loggedInUserId) {
        loadUserProfile('employee', loggedInUserId)
      } else {
        loadUserProfile('admin')
      }
    }
  }, [isAuthenticated, isEmployee, loggedInUserId])

  // Page images updates now come from API; no storage listener

  // Save edited content
  const saveContent = (section, data) => {
    const updated = { ...editedContent, [section]: data }
    setEditedContent(updated)
    localStorage.setItem('editedContent', JSON.stringify(updated))
    // Dispatch event to notify main app
    window.dispatchEvent(new Event('contentUpdated'))
    // Refresh preview if open
    if (showPreview) {
      refreshPreview()
    }
  }

  // Refresh preview iframe
  const refreshPreview = () => {
    const iframe = document.getElementById('admin-preview-iframe')
    if (iframe) {
      iframe.src = iframe.src
    }
  }

  // Listen for messages from iframe
  useEffect(() => {
    const handleMessage = (event) => {
      // Ignore messages that don't look like our app's messages
      if (!event.data || typeof event.data !== 'object' || !event.data.type) return

      // Only process and log specific message types we expect
      if (['admin-save-content', 'admin-save-image', 'contentUpdated'].includes(event.data.type)) {
        console.log('Received message from iframe:', event.data)

        if (event.data.type === 'admin-save-content') {
          const { section, data } = event.data
          console.log('Saving content:', section, data)
          saveContent(section, data)
        } else if (event.data.type === 'admin-save-image') {
          const { url } = event.data
          console.log('Saving image:', url)
          handleHeroImageUrlChange(url)
        } else if (event.data.type === 'contentUpdated') {
          console.log('Content updated event received')
          // Trigger refresh
          window.dispatchEvent(new Event('contentUpdated'))
        }
      }
    }

    window.addEventListener('message', handleMessage)
    return () => window.removeEventListener('message', handleMessage)
  }, [editedContent])

  // Enable/disable edit mode in preview
  useEffect(() => {
    if (!showPreview || !editMode) return

    const iframe = document.getElementById('admin-preview-iframe')
    if (!iframe) return

    const setupEditMode = () => {
      try {
        const iframeWindow = iframe.contentWindow
        const iframeDoc = iframe.contentDocument || iframeWindow?.document

        if (!iframeDoc || !iframeDoc.body) {
          // Retry after a short delay
          setTimeout(setupEditMode, 200)
          return
        }

        const enableEditMode = () => {
          // Add edit mode styles
          const style = iframeDoc.createElement('style')
          style.id = 'admin-edit-mode-styles'
          style.textContent = `
        .admin-editable {
          position: relative;
          cursor: pointer;
          outline: 2px dashed rgba(34, 197, 94, 0.5) !important;
          outline-offset: 2px;
          transition: all 0.2s ease;
        }
        .admin-editable:hover {
          outline-color: rgba(34, 197, 94, 0.8) !important;
          background: rgba(34, 197, 94, 0.1) !important;
        }
        .admin-editing {
          outline: 3px solid #22c55e !important;
          background: rgba(34, 197, 94, 0.15) !important;
        }
        .admin-edit-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 999999;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .admin-edit-popup {
          background: white;
          padding: 2rem;
          border-radius: 12px;
          max-width: 600px;
          width: 90%;
          z-index: 1000000;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .admin-edit-popup h3 {
          margin: 0 0 1rem 0;
          color: #0f172a;
        }
        .admin-edit-popup textarea {
          width: 100%;
          min-height: 100px;
          padding: 0.75rem;
          border: 2px solid #e2e8f0;
          border-radius: 8px;
          font-size: 1rem;
          font-family: inherit;
          resize: vertical;
        }
        .admin-edit-popup-buttons {
          display: flex;
          gap: 0.75rem;
          margin-top: 1rem;
        }
        .admin-edit-popup-btn {
          padding: 0.75rem 1.5rem;
          border: none;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s ease;
        }
        .admin-edit-popup-btn.save {
          background: #22c55e;
          color: white;
        }
        .admin-edit-popup-btn.save:hover {
          background: #16a34a;
        }
        .admin-edit-popup-btn.cancel {
          background: #e2e8f0;
          color: #475467;
        }
        .admin-edit-popup-btn.cancel:hover {
          background: #cbd5e1;
        }
      `
          if (!iframeDoc.getElementById('admin-edit-mode-styles')) {
            iframeDoc.head.appendChild(style)
          }

          // Add editable class to elements - wait a bit for elements to render
          setTimeout(() => {
            // Hero Section
            const heroTitle = iframeDoc.querySelector('.hero-title')
            const heroDescription = iframeDoc.querySelector('.hero-description')
            const heroButton = iframeDoc.querySelector('.learn-more-btn')
            const heroImage = iframeDoc.querySelector('.hero-background-image')

            // Review Section
            const ratingNumber = iframeDoc.querySelector('.rating-number')
            const reviewCount = iframeDoc.querySelector('.review-count')

            // About Page Hero Section
            const aboutHeroHeading = iframeDoc.querySelector('.about-hero-heading')
            const aboutHeroSubtitle = iframeDoc.querySelector('.about-hero-subtitle')

            // About Section
            const aboutTagline = iframeDoc.querySelector('.about-tagline, .about-eyebrow')
            const aboutTitle = iframeDoc.querySelector('.about-title, .about-header h2')
            const aboutDescription = iframeDoc.querySelector('.about-description, .about-intro')
            const aboutDetailsParagraphs = iframeDoc.querySelectorAll('.about-details p')
            const visionTitle = iframeDoc.querySelector('.vision-title, .about-extended-title, .about-values-header h2')
            const visionContentParagraphs = iframeDoc.querySelectorAll('.vision-extended-description p, .about-extended-description p')
            const missionTitle = iframeDoc.querySelector('.mission-title, .mission-extended-content .about-extended-title')
            const missionContentParagraphs = iframeDoc.querySelectorAll('.mission-extended-description p, .mission-text .about-extended-description p')
            const visionButton = iframeDoc.querySelector('.about-more-btn:first-of-type')
            const missionButton = iframeDoc.querySelector('.about-more-btn:last-of-type')

            // Products Section (Homepage)
            const productNames = iframeDoc.querySelectorAll('.product-name, .product-grid-name')
            const productDescriptions = iframeDoc.querySelectorAll('.product-description, .product-grid-description-text')
            const productUsages = iframeDoc.querySelectorAll('.product-usage, .product-grid-usage')

            // Products Page Elements
            const productPageHeading = iframeDoc.querySelector('.product-hero-heading')
            const productPageSubtitle = iframeDoc.querySelector('.product-hero-subtitle')
            const productsTagline = iframeDoc.querySelector('.products-tagline')
            const productsTitle = iframeDoc.querySelector('.products-title')
            const productsDescription = iframeDoc.querySelector('.products-description')

            // Product Grid Items (on Products page)
            const productGridNames = iframeDoc.querySelectorAll('.product-grid-name')
            const productGridGenericNames = iframeDoc.querySelectorAll('.product-grid-generic-name')
            const productGridCategories = iframeDoc.querySelectorAll('.product-grid-category')
            const productGridDescriptions = iframeDoc.querySelectorAll('.product-grid-description-text')
            const productGridUsages = iframeDoc.querySelectorAll('.product-grid-usage')

            // Why Choose Us Section
            const whyChooseUsTitle = iframeDoc.querySelector('.why-choose-us-title')
            const whyChooseUsFeatures = iframeDoc.querySelectorAll('.why-choose-us-card-title, .why-choose-us-card-description')

            // Testimonials
            const testimonialTagline = iframeDoc.querySelector('.testimonial-tagline')
            const testimonialTitle = iframeDoc.querySelector('.testimonial-title')
            const testimonialQuotes = iframeDoc.querySelectorAll('.testimonial-quote')
            const testimonialNames = iframeDoc.querySelectorAll('.testimonial-name')
            const testimonialRoles = iframeDoc.querySelectorAll('.testimonial-role')

            // Blog Section
            const blogTagline = iframeDoc.querySelector('.blog-tagline')
            const blogTitle = iframeDoc.querySelector('.blog-title')
            const blogCta = iframeDoc.querySelector('.blog-cta')
            const blogTitles = iframeDoc.querySelectorAll('.blog-featured-title, .blog-list-title')
            const blogExcerpts = iframeDoc.querySelectorAll('.blog-featured-excerpt')

            // Contact Section
            const contactTitle = iframeDoc.querySelector('.contact-title')
            const contactDescription = iframeDoc.querySelector('.contact-description')
            const contactPhone = iframeDoc.querySelector('.contact-info-value[href^="tel:"]')
            const contactEmail = iframeDoc.querySelector('.contact-info-value[href^="mailto:"]')
            const contactAddress = iframeDoc.querySelector('.contact-info-value:not([href])')

            // Areas Covered Section
            const areasCoveredTagline = iframeDoc.querySelector('.areas-covered-tagline')
            const areasCoveredTitle = iframeDoc.querySelector('.areas-covered-title')
            const areasCoveredPill = iframeDoc.querySelector('.areas-covered-pill')
            const areasCoveredBriefTitle = iframeDoc.querySelector('.areas-covered-brief h3')
            const areasCoveredBriefIntro = iframeDoc.querySelector('.areas-covered-brief > p')
            const areasCoveredPoints = iframeDoc.querySelectorAll('.areas-covered-highlight p')
            const areasCoveredMapNote = iframeDoc.querySelector('.areas-covered-map-note')

            // Team Section
            const teamTagline = iframeDoc.querySelector('.team-tagline')
            const teamTitle = iframeDoc.querySelector('.team-title')
            const teamDescription = iframeDoc.querySelector('.team-description')

            // About Stats Section
            const aboutStatsEyebrow = iframeDoc.querySelector('.about-stats-eyebrow')
            const aboutStatsTitle = iframeDoc.querySelector('.about-stats-heading h2')
            const aboutStatsDescription = iframeDoc.querySelector('.about-stats-heading p')
            const aboutStatLabels = iframeDoc.querySelectorAll('.about-stat-label-block small')
            const aboutStatValues = iframeDoc.querySelectorAll('.about-stat-value')
            const aboutStatNotes = iframeDoc.querySelectorAll('.about-stat-card p')

            // About Values Section
            const aboutValuesEyebrow = iframeDoc.querySelector('.about-values-eyebrow')
            const aboutValuesTitle = iframeDoc.querySelector('.about-values-header h2')
            const aboutValuesDescription = iframeDoc.querySelector('.about-values-header p')
            const aboutValueCardTitles = iframeDoc.querySelectorAll('.about-value-card h3')
            const aboutValueCardDescriptions = iframeDoc.querySelectorAll('.about-value-card p')

            // About Gallery Section
            const aboutGalleryEyebrow = iframeDoc.querySelector('.about-gallery-eyebrow')
            const aboutGalleryTitle = iframeDoc.querySelector('.about-gallery-header h2')

            // Notice Page Hero Section
            const noticeHeroHeading = iframeDoc.querySelector('.notice-hero-heading')
            const noticeHeroSubtitle = iframeDoc.querySelector('.notice-hero-subtitle')

            // Note: Career and Blog pages use .about-hero-heading and .about-hero-subtitle
            // which are already handled above for the About page

            // Footer
            const footerCopyright = iframeDoc.querySelector('.footer-text')
            const footerTagline = iframeDoc.querySelectorAll('.footer-text')

            console.log('Edit mode - Found elements:', {
              heroTitle: !!heroTitle,
              heroDescription: !!heroDescription,
              heroButton: !!heroButton,
              heroImage: !!heroImage,
              aboutHeroHeading: !!aboutHeroHeading,
              aboutHeroSubtitle: !!aboutHeroSubtitle,
              aboutTagline: !!aboutTagline,
              aboutDescription: !!aboutDescription,
              aboutDetailsParagraphs: aboutDetailsParagraphs.length,
              visionTitle: !!visionTitle,
              visionParagraphs: visionContentParagraphs.length,
              missionTitle: !!missionTitle,
              missionParagraphs: missionContentParagraphs.length,
              products: productNames.length,
              productPageHeading: !!productPageHeading,
              productPageSubtitle: !!productPageSubtitle,
              productsTagline: !!productsTagline,
              productsTitle: !!productsTitle,
              productsDescription: !!productsDescription,
              productGridItems: productGridNames.length,
              areasCoveredTagline: !!areasCoveredTagline,
              areasCoveredTitle: !!areasCoveredTitle,
              areasCoveredPill: !!areasCoveredPill,
              areasCoveredBriefTitle: !!areasCoveredBriefTitle,
              areasCoveredBriefIntro: !!areasCoveredBriefIntro,
              areasCoveredPoints: areasCoveredPoints.length,
              areasCoveredMapNote: !!areasCoveredMapNote,
              teamTagline: !!teamTagline,
              teamTitle: !!teamTitle,
              teamDescription: !!teamDescription,
              aboutStatsEyebrow: !!aboutStatsEyebrow,
              aboutStatsTitle: !!aboutStatsTitle,
              aboutStatsDescription: !!aboutStatsDescription,
              aboutStatLabels: aboutStatLabels.length,
              aboutStatValues: aboutStatValues.length,
              aboutStatNotes: aboutStatNotes.length,
              aboutValuesEyebrow: !!aboutValuesEyebrow,
              aboutValuesTitle: !!aboutValuesTitle,
              aboutValuesDescription: !!aboutValuesDescription,
              aboutValueCardTitles: aboutValueCardTitles.length,
              aboutValueCardDescriptions: aboutValueCardDescriptions.length,
              aboutGalleryEyebrow: !!aboutGalleryEyebrow,
              aboutGalleryTitle: !!aboutGalleryTitle,
              noticeHeroHeading: !!noticeHeroHeading,
              noticeHeroSubtitle: !!noticeHeroSubtitle,
              testimonialTagline: !!testimonialTagline,
              testimonialTitle: !!testimonialTitle,
              testimonials: testimonialQuotes.length,
              blogTagline: !!blogTagline,
              blogTitle: !!blogTitle,
              blogCta: !!blogCta
            })

            // Hero Section
            if (heroTitle) {
              heroTitle.classList.add('admin-editable')
              heroTitle.setAttribute('data-edit-type', 'hero-title')
            }
            if (heroDescription) {
              heroDescription.classList.add('admin-editable')
              heroDescription.setAttribute('data-edit-type', 'hero-description')
            }
            if (heroButton) {
              heroButton.classList.add('admin-editable')
              heroButton.setAttribute('data-edit-type', 'hero-button')
            }
            if (heroImage) {
              heroImage.classList.add('admin-editable')
              heroImage.setAttribute('data-edit-type', 'hero-image')
            }

            // About Page Hero Section
            if (aboutHeroHeading) {
              aboutHeroHeading.classList.add('admin-editable')
              aboutHeroHeading.setAttribute('data-edit-type', 'about-hero-heading')
            }
            if (aboutHeroSubtitle) {
              aboutHeroSubtitle.classList.add('admin-editable')
              aboutHeroSubtitle.setAttribute('data-edit-type', 'about-hero-subtitle')
            }

            // Review Section
            if (ratingNumber) {
              ratingNumber.classList.add('admin-editable')
              ratingNumber.setAttribute('data-edit-type', 'review-rating')
            }
            if (reviewCount) {
              reviewCount.classList.add('admin-editable')
              reviewCount.setAttribute('data-edit-type', 'review-count')
            }

            // About Section
            if (aboutTagline) {
              aboutTagline.classList.add('admin-editable')
              aboutTagline.setAttribute('data-edit-type', 'about-tagline')
            }
            if (aboutTitle) {
              aboutTitle.classList.add('admin-editable')
              aboutTitle.setAttribute('data-edit-type', 'about-title')
            }
            if (aboutDescription) {
              aboutDescription.classList.add('admin-editable')
              aboutDescription.setAttribute('data-edit-type', 'about-description')
            }
            // Make each details paragraph editable
            aboutDetailsParagraphs.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `about-details-${idx}`)
              el.setAttribute('data-paragraph-index', idx.toString())
            })
            if (visionTitle) {
              visionTitle.classList.add('admin-editable')
              visionTitle.setAttribute('data-edit-type', 'vision-title')
            }
            // Make each vision paragraph editable
            visionContentParagraphs.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `vision-content-${idx}`)
              el.setAttribute('data-paragraph-index', idx.toString())
            })
            if (missionTitle) {
              missionTitle.classList.add('admin-editable')
              missionTitle.setAttribute('data-edit-type', 'mission-title')
            }
            // Make each mission paragraph editable
            missionContentParagraphs.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `mission-content-${idx}`)
              el.setAttribute('data-paragraph-index', idx.toString())
            })
            if (visionButton) {
              visionButton.classList.add('admin-editable')
              visionButton.setAttribute('data-edit-type', 'vision-button')
            }
            if (missionButton) {
              missionButton.classList.add('admin-editable')
              missionButton.setAttribute('data-edit-type', 'mission-button')
            }

            // Products Section (Homepage) - make first few editable
            productNames.forEach((el, idx) => {
              if (idx < 5) {
                el.classList.add('admin-editable')
                el.setAttribute('data-edit-type', `product-name-${idx}`)
                el.setAttribute('data-product-index', idx.toString())
              }
            })
            productDescriptions.forEach((el, idx) => {
              if (idx < 5) {
                el.classList.add('admin-editable')
                el.setAttribute('data-edit-type', `product-description-${idx}`)
                el.setAttribute('data-product-index', idx.toString())
              }
            })

            // Products Page Header
            if (productPageHeading) {
              productPageHeading.classList.add('admin-editable')
              productPageHeading.setAttribute('data-edit-type', 'product-page-heading')
            }
            if (productPageSubtitle) {
              productPageSubtitle.classList.add('admin-editable')
              productPageSubtitle.setAttribute('data-edit-type', 'product-page-subtitle')
            }
            if (productsTagline) {
              productsTagline.classList.add('admin-editable')
              productsTagline.setAttribute('data-edit-type', 'products-tagline')
            }
            if (productsTitle) {
              productsTitle.classList.add('admin-editable')
              productsTitle.setAttribute('data-edit-type', 'products-title')
            }
            if (productsDescription) {
              productsDescription.classList.add('admin-editable')
              productsDescription.setAttribute('data-edit-type', 'products-description')
            }

            // Product Grid Items (Products page) - make all editable
            productGridNames.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `product-grid-name-${idx}`)
              el.setAttribute('data-product-index', idx.toString())
            })
            productGridGenericNames.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `product-grid-generic-${idx}`)
              el.setAttribute('data-product-index', idx.toString())
            })
            productGridCategories.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `product-grid-category-${idx}`)
              el.setAttribute('data-product-index', idx.toString())
            })
            productGridDescriptions.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `product-grid-description-${idx}`)
              el.setAttribute('data-product-index', idx.toString())
            })
            productGridUsages.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `product-grid-usage-${idx}`)
              el.setAttribute('data-product-index', idx.toString())
            })

            // Why Choose Us
            if (whyChooseUsTitle) {
              whyChooseUsTitle.classList.add('admin-editable')
              whyChooseUsTitle.setAttribute('data-edit-type', 'why-choose-us-title')
            }
            whyChooseUsFeatures.forEach((el, idx) => {
              el.classList.add('admin-editable')
              const isTitle = el.classList.contains('why-choose-us-card-title')
              el.setAttribute('data-edit-type', `why-choose-us-${isTitle ? 'title' : 'description'}-${idx}`)
              el.setAttribute('data-feature-index', idx.toString())
            })

            // Testimonials
            if (testimonialTagline) {
              testimonialTagline.classList.add('admin-editable')
              testimonialTagline.setAttribute('data-edit-type', 'testimonial-tagline')
            }
            if (testimonialTitle) {
              testimonialTitle.classList.add('admin-editable')
              testimonialTitle.setAttribute('data-edit-type', 'testimonial-title')
            }
            testimonialQuotes.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `testimonial-quote-${idx}`)
              el.setAttribute('data-testimonial-index', idx.toString())
            })
            testimonialNames.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `testimonial-name-${idx}`)
              el.setAttribute('data-testimonial-index', idx.toString())
            })
            testimonialRoles.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `testimonial-role-${idx}`)
              el.setAttribute('data-testimonial-index', idx.toString())
            })

            // Blog
            if (blogTagline) {
              blogTagline.classList.add('admin-editable')
              blogTagline.setAttribute('data-edit-type', 'blog-tagline')
            }
            if (blogTitle) {
              blogTitle.classList.add('admin-editable')
              blogTitle.setAttribute('data-edit-type', 'blog-title')
            }
            if (blogCta) {
              blogCta.classList.add('admin-editable')
              blogCta.setAttribute('data-edit-type', 'blog-cta')
            }
            blogTitles.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `blog-title-${idx}`)
              el.setAttribute('data-blog-index', idx.toString())
            })

            // Contact
            if (contactTitle) {
              contactTitle.classList.add('admin-editable')
              contactTitle.setAttribute('data-edit-type', 'contact-title')
            }
            if (contactDescription) {
              contactDescription.classList.add('admin-editable')
              contactDescription.setAttribute('data-edit-type', 'contact-description')
            }
            if (contactPhone) {
              contactPhone.classList.add('admin-editable')
              contactPhone.setAttribute('data-edit-type', 'contact-phone')
            }
            if (contactEmail) {
              contactEmail.classList.add('admin-editable')
              contactEmail.setAttribute('data-edit-type', 'contact-email')
            }
            if (contactAddress) {
              contactAddress.classList.add('admin-editable')
              contactAddress.setAttribute('data-edit-type', 'contact-address')
            }

            // Areas Covered Section
            if (areasCoveredTagline) {
              areasCoveredTagline.classList.add('admin-editable')
              areasCoveredTagline.setAttribute('data-edit-type', 'areas-covered-tagline')
            }
            if (areasCoveredTitle) {
              areasCoveredTitle.classList.add('admin-editable')
              areasCoveredTitle.setAttribute('data-edit-type', 'areas-covered-title')
            }
            if (areasCoveredPill) {
              areasCoveredPill.classList.add('admin-editable')
              areasCoveredPill.setAttribute('data-edit-type', 'areas-covered-pill')
            }
            if (areasCoveredBriefTitle) {
              areasCoveredBriefTitle.classList.add('admin-editable')
              areasCoveredBriefTitle.setAttribute('data-edit-type', 'areas-covered-brief-title')
            }
            if (areasCoveredBriefIntro) {
              areasCoveredBriefIntro.classList.add('admin-editable')
              areasCoveredBriefIntro.setAttribute('data-edit-type', 'areas-covered-brief-intro')
            }
            areasCoveredPoints.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `areas-covered-point-${idx}`)
              el.setAttribute('data-point-index', idx.toString())
            })
            if (areasCoveredMapNote) {
              areasCoveredMapNote.classList.add('admin-editable')
              areasCoveredMapNote.setAttribute('data-edit-type', 'areas-covered-map-note')
            }

            // Team Section
            if (teamTagline) {
              teamTagline.classList.add('admin-editable')
              teamTagline.setAttribute('data-edit-type', 'team-tagline')
            }
            if (teamTitle) {
              teamTitle.classList.add('admin-editable')
              teamTitle.setAttribute('data-edit-type', 'team-title')
            }
            if (teamDescription) {
              teamDescription.classList.add('admin-editable')
              teamDescription.setAttribute('data-edit-type', 'team-description')
            }

            // About Stats Section
            if (aboutStatsEyebrow) {
              aboutStatsEyebrow.classList.add('admin-editable')
              aboutStatsEyebrow.setAttribute('data-edit-type', 'about-stats-eyebrow')
            }
            if (aboutStatsTitle) {
              aboutStatsTitle.classList.add('admin-editable')
              aboutStatsTitle.setAttribute('data-edit-type', 'about-stats-title')
            }
            if (aboutStatsDescription) {
              aboutStatsDescription.classList.add('admin-editable')
              aboutStatsDescription.setAttribute('data-edit-type', 'about-stats-description')
            }
            aboutStatLabels.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `about-stat-label-${idx}`)
              el.setAttribute('data-stat-index', idx.toString())
            })
            aboutStatValues.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `about-stat-value-${idx}`)
              el.setAttribute('data-stat-index', idx.toString())
            })
            aboutStatNotes.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `about-stat-note-${idx}`)
              el.setAttribute('data-stat-index', idx.toString())
            })

            // About Values Section
            if (aboutValuesEyebrow) {
              aboutValuesEyebrow.classList.add('admin-editable')
              aboutValuesEyebrow.setAttribute('data-edit-type', 'about-values-eyebrow')
            }
            if (aboutValuesTitle) {
              aboutValuesTitle.classList.add('admin-editable')
              aboutValuesTitle.setAttribute('data-edit-type', 'about-values-title')
            }
            if (aboutValuesDescription) {
              aboutValuesDescription.classList.add('admin-editable')
              aboutValuesDescription.setAttribute('data-edit-type', 'about-values-description')
            }
            aboutValueCardTitles.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `about-value-title-${idx}`)
              el.setAttribute('data-value-index', idx.toString())
            })
            aboutValueCardDescriptions.forEach((el, idx) => {
              el.classList.add('admin-editable')
              el.setAttribute('data-edit-type', `about-value-description-${idx}`)
              el.setAttribute('data-value-index', idx.toString())
            })

            // About Gallery Section
            if (aboutGalleryEyebrow) {
              aboutGalleryEyebrow.classList.add('admin-editable')
              aboutGalleryEyebrow.setAttribute('data-edit-type', 'about-gallery-eyebrow')
            }
            if (aboutGalleryTitle) {
              aboutGalleryTitle.classList.add('admin-editable')
              aboutGalleryTitle.setAttribute('data-edit-type', 'about-gallery-title')
            }

            // Notice Page Hero Section
            if (noticeHeroHeading) {
              noticeHeroHeading.classList.add('admin-editable')
              noticeHeroHeading.setAttribute('data-edit-type', 'notice-hero-heading')
            }
            if (noticeHeroSubtitle) {
              noticeHeroSubtitle.classList.add('admin-editable')
              noticeHeroSubtitle.setAttribute('data-edit-type', 'notice-hero-subtitle')
            }

            // Footer
            if (footerCopyright && footerCopyright.length > 0) {
              footerCopyright[0].classList.add('admin-editable')
              footerCopyright[0].setAttribute('data-edit-type', 'footer-copyright')
            }
          }, 500)

          // Add click handlers
          const handleEditClick = (e) => {
            e.preventDefault()
            e.stopPropagation()
            const element = e.target.closest('.admin-editable')
            if (!element) return

            const editType = element.getAttribute('data-edit-type')
            if (!editType) return

            element.classList.add('admin-editing')

            // Create unique ID for this edit session
            const editId = 'edit-' + Date.now()
            const currentEditType = editType
            const currentElement = element

            // Get initial value
            const initialValue = editType === 'hero-image'
              ? (element.getAttribute('src') || '')
              : (element.textContent || element.innerText || '').trim()

            // Create functions directly on iframe window
            iframeWindow['adminSave_' + editId] = function () {
              try {
                const inputEl = iframeDoc.getElementById(editId + '-input')
                if (!inputEl) {
                  console.error('Input not found')
                  return false
                }

                const newValue = inputEl.value.trim()
                console.log('Save button clicked! Value:', newValue, 'Type:', currentEditType)

                if (!newValue) {
                  alert('Please enter a value')
                  return false
                }

                // Get current edited content from localStorage
                const currentContent = JSON.parse(localStorage.getItem('editedContent') || '{}')

                if (currentEditType === 'hero-image') {
                  currentElement.setAttribute('src', newValue)
                  localStorage.setItem('heroImage', newValue)
                  if (iframeWindow.postMessage) {
                    iframeWindow.postMessage({ type: 'admin-save-image', url: newValue }, '*')
                  }
                } else if (currentEditType === 'hero-title') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.hero) updatedContent.hero = {}
                  updatedContent.hero.title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  if (iframeWindow.postMessage) {
                    iframeWindow.postMessage({
                      type: 'admin-save-content',
                      section: 'hero',
                      data: updatedContent.hero
                    }, '*')
                  }
                } else if (currentEditType === 'hero-description') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.hero) updatedContent.hero = {}
                  updatedContent.hero.description = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  if (iframeWindow.postMessage) {
                    iframeWindow.postMessage({
                      type: 'admin-save-content',
                      section: 'hero',
                      data: updatedContent.hero
                    }, '*')
                  }
                } else if (currentEditType === 'hero-button') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.hero) updatedContent.hero = {}
                  updatedContent.hero.viewProducts = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  if (iframeWindow.postMessage) {
                    iframeWindow.postMessage({
                      type: 'admin-save-content',
                      section: 'hero',
                      data: updatedContent.hero
                    }, '*')
                  }
                } else if (currentEditType === 'review-rating') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.review) updatedContent.review = {}
                  updatedContent.review.rating = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'review-count') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.review) updatedContent.review = {}
                  updatedContent.review.customersReview = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'about-hero-heading') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  // Check which page we're on by checking the iframe URL
                  const iframeUrl = iframeWindow.location?.pathname || ''
                  if (iframeUrl.includes('/career')) {
                    if (!updatedContent.career) updatedContent.career = {}
                    if (!updatedContent.career.hero) updatedContent.career.hero = {}
                    updatedContent.career.hero.title = newValue
                  } else if (iframeUrl.includes('/blog')) {
                    if (!updatedContent.blog) updatedContent.blog = {}
                    if (!updatedContent.blog.hero) updatedContent.blog.hero = {}
                    updatedContent.blog.hero.title = newValue
                  } else {
                    // Default to about page
                    if (!updatedContent.about) updatedContent.about = {}
                    updatedContent.about.heroTitle = newValue
                  }
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType === 'about-hero-subtitle') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  // Check which page we're on by checking the iframe URL
                  const iframeUrl = iframeWindow.location?.pathname || ''
                  if (iframeUrl.includes('/career')) {
                    if (!updatedContent.career) updatedContent.career = {}
                    if (!updatedContent.career.hero) updatedContent.career.hero = {}
                    updatedContent.career.hero.subtitle = newValue
                  } else if (iframeUrl.includes('/blog')) {
                    if (!updatedContent.blog) updatedContent.blog = {}
                    if (!updatedContent.blog.hero) updatedContent.blog.hero = {}
                    updatedContent.blog.hero.subtitle = newValue
                  } else {
                    // Default to about page
                    if (!updatedContent.about) updatedContent.about = {}
                    updatedContent.about.heroSubtitle = newValue
                  }
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType === 'about-tagline') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.about) updatedContent.about = {}
                  updatedContent.about.tagline = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'about-title') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.about) updatedContent.about = {}
                  updatedContent.about.title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'about-description') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.about) updatedContent.about = {}
                  updatedContent.about.description = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('about-details-')) {
                  const paraIndex = parseInt(currentElement.getAttribute('data-paragraph-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.about) updatedContent.about = {}
                  if (!updatedContent.about.details) updatedContent.about.details = []
                  updatedContent.about.details[paraIndex] = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'vision-title') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.about) updatedContent.about = {}
                  if (!updatedContent.about.vision) updatedContent.about.vision = {}
                  updatedContent.about.vision.title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('vision-content-')) {
                  const paraIndex = parseInt(currentElement.getAttribute('data-paragraph-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.about) updatedContent.about = {}
                  if (!updatedContent.about.vision) updatedContent.about.vision = {}
                  if (!updatedContent.about.vision.paragraphs) updatedContent.about.vision.paragraphs = []
                  updatedContent.about.vision.paragraphs[paraIndex] = newValue
                  // Also update the full content by joining paragraphs
                  const allParagraphs = [...(updatedContent.about.vision.paragraphs || [])]
                  updatedContent.about.vision.content = allParagraphs.join('\n\n')
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'mission-title') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.about) updatedContent.about = {}
                  if (!updatedContent.about.mission) updatedContent.about.mission = {}
                  updatedContent.about.mission.title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('mission-content-')) {
                  const paraIndex = parseInt(currentElement.getAttribute('data-paragraph-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.about) updatedContent.about = {}
                  if (!updatedContent.about.mission) updatedContent.about.mission = {}
                  if (!updatedContent.about.mission.paragraphs) updatedContent.about.mission.paragraphs = []
                  updatedContent.about.mission.paragraphs[paraIndex] = newValue
                  // Also update the full content by joining paragraphs
                  const allParagraphs = [...(updatedContent.about.mission.paragraphs || [])]
                  updatedContent.about.mission.content = allParagraphs.join('\n\n')
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'vision-button') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.about) updatedContent.about = {}
                  updatedContent.about.visionButton = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'mission-button') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.about) updatedContent.about = {}
                  updatedContent.about.missionButton = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('product-name-')) {
                  const productIndex = parseInt(currentElement.getAttribute('data-product-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.products) updatedContent.products = []
                  if (!updatedContent.products[productIndex]) updatedContent.products[productIndex] = {}
                  updatedContent.products[productIndex].name = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('product-description-')) {
                  const productIndex = parseInt(currentElement.getAttribute('data-product-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.products) updatedContent.products = []
                  if (!updatedContent.products[productIndex]) updatedContent.products[productIndex] = {}
                  updatedContent.products[productIndex].description = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'product-page-heading') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.products) updatedContent.products = {}
                  updatedContent.products.pageHeading = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'product-page-subtitle') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.products) updatedContent.products = {}
                  updatedContent.products.pageSubtitle = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'products-tagline') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.products) updatedContent.products = {}
                  updatedContent.products.tagline = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'products-title') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.products) updatedContent.products = {}
                  updatedContent.products.title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'products-description') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.products) updatedContent.products = {}
                  updatedContent.products.description = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('product-grid-name-')) {
                  const productIndex = parseInt(currentElement.getAttribute('data-product-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.products) updatedContent.products = {}
                  if (!updatedContent.products.items) updatedContent.products.items = []
                  if (!updatedContent.products.items[productIndex]) updatedContent.products.items[productIndex] = {}
                  updatedContent.products.items[productIndex].name = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('product-grid-generic-')) {
                  const productIndex = parseInt(currentElement.getAttribute('data-product-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.products) updatedContent.products = {}
                  if (!updatedContent.products.items) updatedContent.products.items = []
                  if (!updatedContent.products.items[productIndex]) updatedContent.products.items[productIndex] = {}
                  updatedContent.products.items[productIndex].genericName = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('product-grid-category-')) {
                  const productIndex = parseInt(currentElement.getAttribute('data-product-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.products) updatedContent.products = {}
                  if (!updatedContent.products.items) updatedContent.products.items = []
                  if (!updatedContent.products.items[productIndex]) updatedContent.products.items[productIndex] = {}
                  updatedContent.products.items[productIndex].category = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('product-grid-description-')) {
                  const productIndex = parseInt(currentElement.getAttribute('data-product-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.products) updatedContent.products = {}
                  if (!updatedContent.products.items) updatedContent.products.items = []
                  if (!updatedContent.products.items[productIndex]) updatedContent.products.items[productIndex] = {}
                  updatedContent.products.items[productIndex].description = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('product-grid-usage-')) {
                  const productIndex = parseInt(currentElement.getAttribute('data-product-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.products) updatedContent.products = {}
                  if (!updatedContent.products.items) updatedContent.products.items = []
                  if (!updatedContent.products.items[productIndex]) updatedContent.products.items[productIndex] = {}
                  updatedContent.products.items[productIndex].usage = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'why-choose-us-title') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.whyChooseUs) updatedContent.whyChooseUs = {}
                  updatedContent.whyChooseUs.title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('why-choose-us-title-')) {
                  const featureIndex = parseInt(currentElement.getAttribute('data-feature-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.whyChooseUs) updatedContent.whyChooseUs = {}
                  if (!updatedContent.whyChooseUs.features) updatedContent.whyChooseUs.features = []
                  if (!updatedContent.whyChooseUs.features[featureIndex]) updatedContent.whyChooseUs.features[featureIndex] = {}
                  updatedContent.whyChooseUs.features[featureIndex].title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('why-choose-us-description-')) {
                  const featureIndex = parseInt(currentElement.getAttribute('data-feature-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.whyChooseUs) updatedContent.whyChooseUs = {}
                  if (!updatedContent.whyChooseUs.features) updatedContent.whyChooseUs.features = []
                  if (!updatedContent.whyChooseUs.features[featureIndex]) updatedContent.whyChooseUs.features[featureIndex] = {}
                  updatedContent.whyChooseUs.features[featureIndex].description = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'testimonial-tagline') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.testimonials) updatedContent.testimonials = {}
                  updatedContent.testimonials.tagline = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'testimonial-title') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.testimonials) updatedContent.testimonials = {}
                  updatedContent.testimonials.title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('testimonial-quote-')) {
                  const testimonialIndex = parseInt(currentElement.getAttribute('data-testimonial-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.testimonials) updatedContent.testimonials = {}
                  if (!updatedContent.testimonials.cards) updatedContent.testimonials.cards = []
                  if (!updatedContent.testimonials.cards[testimonialIndex]) updatedContent.testimonials.cards[testimonialIndex] = {}
                  updatedContent.testimonials.cards[testimonialIndex].quote = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('testimonial-name-')) {
                  const testimonialIndex = parseInt(currentElement.getAttribute('data-testimonial-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.testimonials) updatedContent.testimonials = {}
                  if (!updatedContent.testimonials.cards) updatedContent.testimonials.cards = []
                  if (!updatedContent.testimonials.cards[testimonialIndex]) updatedContent.testimonials.cards[testimonialIndex] = {}
                  updatedContent.testimonials.cards[testimonialIndex].name = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('testimonial-role-')) {
                  const testimonialIndex = parseInt(currentElement.getAttribute('data-testimonial-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.testimonials) updatedContent.testimonials = {}
                  if (!updatedContent.testimonials.cards) updatedContent.testimonials.cards = []
                  if (!updatedContent.testimonials.cards[testimonialIndex]) updatedContent.testimonials.cards[testimonialIndex] = {}
                  updatedContent.testimonials.cards[testimonialIndex].role = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'blog-tagline') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.blog) updatedContent.blog = {}
                  updatedContent.blog.tagline = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'blog-title') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.blog) updatedContent.blog = {}
                  updatedContent.blog.title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'blog-cta') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.blog) updatedContent.blog = {}
                  updatedContent.blog.cta = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('blog-title-')) {
                  const blogIndex = parseInt(currentElement.getAttribute('data-blog-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.blog) updatedContent.blog = {}
                  if (!updatedContent.blog.list) updatedContent.blog.list = []
                  if (!updatedContent.blog.list[blogIndex]) updatedContent.blog.list[blogIndex] = {}
                  updatedContent.blog.list[blogIndex].title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'contact-title') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.contact) updatedContent.contact = {}
                  updatedContent.contact.title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'contact-description') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.contact) updatedContent.contact = {}
                  updatedContent.contact.description = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'contact-phone') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.contact) updatedContent.contact = {}
                  updatedContent.contact.phone = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'contact-email') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.contact) updatedContent.contact = {}
                  updatedContent.contact.email = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'contact-address') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.contact) updatedContent.contact = {}
                  updatedContent.contact.address = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'areas-covered-tagline') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.areasCovered) updatedContent.areasCovered = {}
                  updatedContent.areasCovered.tagline = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'areas-covered-title') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.areasCovered) updatedContent.areasCovered = {}
                  updatedContent.areasCovered.title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'areas-covered-pill') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.areasCovered) updatedContent.areasCovered = {}
                  updatedContent.areasCovered.pill = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'areas-covered-brief-title') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.areasCovered) updatedContent.areasCovered = {}
                  updatedContent.areasCovered.briefTitle = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'areas-covered-brief-intro') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.areasCovered) updatedContent.areasCovered = {}
                  updatedContent.areasCovered.briefIntro = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType.startsWith('areas-covered-point-')) {
                  const pointIndex = parseInt(currentElement.getAttribute('data-point-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.areasCovered) updatedContent.areasCovered = {}
                  if (!updatedContent.areasCovered.briefPoints) updatedContent.areasCovered.briefPoints = []
                  updatedContent.areasCovered.briefPoints[pointIndex] = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'areas-covered-map-note') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.areasCovered) updatedContent.areasCovered = {}
                  updatedContent.areasCovered.mapAlt = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'team-tagline') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.team) updatedContent.team = {}
                  updatedContent.team.tagline = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'team-title') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.team) updatedContent.team = {}
                  updatedContent.team.title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'team-description') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.team) updatedContent.team = {}
                  updatedContent.team.description = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else if (currentEditType === 'about-stats-eyebrow') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.aboutStats) updatedContent.aboutStats = {}
                  updatedContent.aboutStats.eyebrow = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType === 'about-stats-title') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.aboutStats) updatedContent.aboutStats = {}
                  updatedContent.aboutStats.title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType === 'about-stats-description') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.aboutStats) updatedContent.aboutStats = {}
                  updatedContent.aboutStats.description = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType.startsWith('about-stat-label-')) {
                  const statIndex = parseInt(currentElement.getAttribute('data-stat-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.aboutStats) updatedContent.aboutStats = {}
                  if (!updatedContent.aboutStats.stats) updatedContent.aboutStats.stats = []
                  if (!updatedContent.aboutStats.stats[statIndex]) updatedContent.aboutStats.stats[statIndex] = {}
                  updatedContent.aboutStats.stats[statIndex].label = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType.startsWith('about-stat-value-')) {
                  const statIndex = parseInt(currentElement.getAttribute('data-stat-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.aboutStats) updatedContent.aboutStats = {}
                  if (!updatedContent.aboutStats.stats) updatedContent.aboutStats.stats = []
                  if (!updatedContent.aboutStats.stats[statIndex]) updatedContent.aboutStats.stats[statIndex] = {}
                  updatedContent.aboutStats.stats[statIndex].value = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType.startsWith('about-stat-note-')) {
                  const statIndex = parseInt(currentElement.getAttribute('data-stat-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.aboutStats) updatedContent.aboutStats = {}
                  if (!updatedContent.aboutStats.stats) updatedContent.aboutStats.stats = []
                  if (!updatedContent.aboutStats.stats[statIndex]) updatedContent.aboutStats.stats[statIndex] = {}
                  updatedContent.aboutStats.stats[statIndex].note = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType === 'about-values-eyebrow') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.aboutValues) updatedContent.aboutValues = {}
                  updatedContent.aboutValues.eyebrow = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType === 'about-values-title') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.aboutValues) updatedContent.aboutValues = {}
                  updatedContent.aboutValues.title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType === 'about-values-description') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.aboutValues) updatedContent.aboutValues = {}
                  updatedContent.aboutValues.description = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType.startsWith('about-value-title-')) {
                  const valueIndex = parseInt(currentElement.getAttribute('data-value-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.aboutValues) updatedContent.aboutValues = {}
                  if (!updatedContent.aboutValues.values) updatedContent.aboutValues.values = []
                  if (!updatedContent.aboutValues.values[valueIndex]) updatedContent.aboutValues.values[valueIndex] = {}
                  updatedContent.aboutValues.values[valueIndex].title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType.startsWith('about-value-description-')) {
                  const valueIndex = parseInt(currentElement.getAttribute('data-value-index') || '0')
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.aboutValues) updatedContent.aboutValues = {}
                  if (!updatedContent.aboutValues.values) updatedContent.aboutValues.values = []
                  if (!updatedContent.aboutValues.values[valueIndex]) updatedContent.aboutValues.values[valueIndex] = {}
                  updatedContent.aboutValues.values[valueIndex].description = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType === 'about-gallery-eyebrow') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.aboutGallery) updatedContent.aboutGallery = {}
                  updatedContent.aboutGallery.eyebrow = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType === 'about-gallery-title') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.aboutGallery) updatedContent.aboutGallery = {}
                  updatedContent.aboutGallery.title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType === 'notice-hero-heading') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.notice) updatedContent.notice = {}
                  if (!updatedContent.notice.hero) updatedContent.notice.hero = {}
                  updatedContent.notice.hero.title = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType === 'notice-hero-subtitle') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.notice) updatedContent.notice = {}
                  if (!updatedContent.notice.hero) updatedContent.notice.hero = {}
                  updatedContent.notice.hero.subtitle = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                  window.dispatchEvent(new Event('contentUpdated'))
                } else if (currentEditType === 'footer-copyright') {
                  currentElement.textContent = newValue
                  const updatedContent = { ...currentContent }
                  if (!updatedContent.footer) updatedContent.footer = {}
                  updatedContent.footer.copyright = newValue
                  localStorage.setItem('editedContent', JSON.stringify(updatedContent))
                } else {
                  // Generic fallback - just update the element text
                  currentElement.textContent = newValue
                  console.log('Generic save for:', currentEditType)
                }

                // Dispatch event
                if (iframeWindow.parent) {
                  iframeWindow.parent.postMessage({ type: 'contentUpdated' }, '*')
                }

                // Remove overlay
                currentElement.classList.remove('admin-editing')
                const overlayEl = iframeDoc.getElementById(editId + '-overlay')
                if (overlayEl) {
                  // Run cleanup if exists
                  if (overlayEl._cleanup) overlayEl._cleanup()
                  overlayEl.remove()
                }

                // Clean up
                delete iframeWindow['adminSave_' + editId]
                delete iframeWindow['adminCancel_' + editId]

                // Refresh preview
                setTimeout(() => {
                  const iframe = document.getElementById('admin-preview-iframe')
                  if (iframe) iframe.src = iframe.src
                }, 500)

                console.log('Content saved successfully!')
                return false
              } catch (error) {
                console.error('Error in save handler:', error)
                alert('Error saving: ' + error.message)
                return false
              }
            }

            iframeWindow['adminCancel_' + editId] = function () {
              try {
                console.log('Cancel button clicked for:', editId)
                currentElement.classList.remove('admin-editing')
                const overlayEl = iframeDoc.getElementById(editId + '-overlay')
                if (overlayEl) {
                  // Run cleanup if exists
                  if (overlayEl._cleanup) overlayEl._cleanup()
                  overlayEl.remove()
                }

                // Clean up
                delete iframeWindow['adminSave_' + editId]
                delete iframeWindow['adminCancel_' + editId]
                return false
              } catch (error) {
                console.error('Error in cancel handler:', error)
                return false
              }
            }

            // Create popup using DOM methods
            const overlay = iframeDoc.createElement('div')
            overlay.className = 'admin-edit-overlay'
            overlay.id = editId + '-overlay'

            const popup = iframeDoc.createElement('div')
            popup.className = 'admin-edit-popup'

            const title = iframeDoc.createElement('h3')
            title.textContent = language === 'en' ? 'Edit Content' : 'কন্টেন্ট সম্পাদনা'
            popup.appendChild(title)

            const input = editType === 'hero-image'
              ? iframeDoc.createElement('input')
              : iframeDoc.createElement('textarea')

            input.id = editId + '-input'
            input.style.cssText = 'width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; font-family: inherit; resize: vertical; box-sizing: border-box;'

            if (editType === 'hero-image') {
              input.type = 'text'
              input.placeholder = '/hero-image.jpg or URL'
              input.value = initialValue
            } else {
              input.style.minHeight = '100px'
              input.value = initialValue
            }

            popup.appendChild(input)

            const buttonsDiv = iframeDoc.createElement('div')
            buttonsDiv.className = 'admin-edit-popup-buttons'

            const saveBtn = iframeDoc.createElement('button')
            saveBtn.className = 'admin-edit-popup-btn save'
            saveBtn.textContent = language === 'en' ? 'Save' : 'সংরক্ষণ'
            saveBtn.type = 'button'
            saveBtn.setAttribute('data-action', 'save')
            saveBtn.setAttribute('data-edit-id', editId)

            const cancelBtn = iframeDoc.createElement('button')
            cancelBtn.className = 'admin-edit-popup-btn cancel'
            cancelBtn.textContent = language === 'en' ? 'Cancel' : 'বাতিল'
            cancelBtn.type = 'button'
            cancelBtn.setAttribute('data-action', 'cancel')
            cancelBtn.setAttribute('data-edit-id', editId)

            buttonsDiv.appendChild(saveBtn)
            buttonsDiv.appendChild(cancelBtn)
            popup.appendChild(buttonsDiv)
            overlay.appendChild(popup)
            iframeDoc.body.appendChild(overlay)

            // Use event delegation on document body
            const handleButtonClick = function (e) {
              const target = e.target
              if (!target || !target.hasAttribute('data-edit-id')) return

              const buttonEditId = target.getAttribute('data-edit-id')
              if (buttonEditId !== editId) return

              const action = target.getAttribute('data-action')
              e.preventDefault()
              e.stopPropagation()
              e.stopImmediatePropagation()

              console.log('Button clicked:', action, 'for editId:', buttonEditId)

              if (action === 'save') {
                iframeWindow['adminSave_' + editId]()
              } else if (action === 'cancel') {
                iframeWindow['adminCancel_' + editId]()
              }
            }

            // Attach to document with capture phase
            iframeDoc.addEventListener('click', handleButtonClick, true)

            // Also attach directly to buttons as backup
            saveBtn.addEventListener('click', function (e) {
              e.preventDefault()
              e.stopPropagation()
              console.log('Direct save click handler')
              iframeWindow['adminSave_' + editId]()
            }, true)

            cancelBtn.addEventListener('click', function (e) {
              e.preventDefault()
              e.stopPropagation()
              console.log('Direct cancel click handler')
              iframeWindow['adminCancel_' + editId]()
            }, true)

            // Store cleanup function
            overlay._cleanup = function () {
              iframeDoc.removeEventListener('click', handleButtonClick, true)
            }

            // Close on overlay click
            overlay.addEventListener('click', function (e) {
              if (e.target === overlay) {
                iframeWindow['adminCancel_' + editId]()
              }
            })

            // Prevent popup clicks from closing
            popup.addEventListener('click', function (e) {
              e.stopPropagation()
            })

            // Focus input
            setTimeout(() => {
              input.focus()
            }, 100)

            // Close on Escape key
            const escapeHandler = function (e) {
              if (e.key === 'Escape') {
                iframeWindow['adminCancel_' + editId]()
                iframeDoc.removeEventListener('keydown', escapeHandler)
              }
            }
            iframeDoc.addEventListener('keydown', escapeHandler)

            console.log('Edit popup created with event delegation:', editId, {
              saveBtn: saveBtn,
              cancelBtn: cancelBtn,
              functionsExist: {
                save: typeof iframeWindow['adminSave_' + editId] === 'function',
                cancel: typeof iframeWindow['adminCancel_' + editId] === 'function'
              }
            })
          }

          // Remove old listeners
          iframeDoc.removeEventListener('click', handleEditClick)
          iframeDoc.addEventListener('click', handleEditClick, true)
        }

        enableEditMode()
      } catch (error) {
        console.error('Error setting up edit mode:', error)
        // Retry after a short delay
        setTimeout(setupEditMode, 500)
      }
    }

    // Wait for iframe to load
    const handleIframeLoad = () => {
      setTimeout(setupEditMode, 300)
    }

    iframe.addEventListener('load', handleIframeLoad)

    // Also try immediately in case iframe is already loaded
    if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
      setTimeout(setupEditMode, 300)
    }

    return () => {
      iframe.removeEventListener('load', handleIframeLoad)
    }
  }, [showPreview, editMode, language])

  // Disable edit mode when editMode is false
  useEffect(() => {
    if (!showPreview || editMode) return

    const iframe = document.getElementById('admin-preview-iframe')
    if (!iframe) return

    try {
      const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document
      if (!iframeDoc) return

      const style = iframeDoc.getElementById('admin-edit-mode-styles')
      if (style) style.remove()

      const editables = iframeDoc.querySelectorAll('.admin-editable')
      editables.forEach(el => {
        el.classList.remove('admin-editable', 'admin-editing')
        el.removeAttribute('data-edit-type')
      })
    } catch (error) {
      console.error('Error disabling edit mode:', error)
    }
  }, [showPreview, editMode])


  // Handle hero image URL change
  const handleHeroImageUrlChange = (url) => {
    setHeroImage(url)
    // Refresh preview if open
    if (showPreview) {
      setTimeout(refreshPreview, 100)
    }
  }

  // Handle page image changes
  const handleImageChange = (key, value) => {
    const updated = { ...pageImages, [key]: value }
    savePageImages(updated)
  }

  const handleImageFileChange = (key, e) => {
    const file = e.target.files[0]
    if (file) {
      const reader = new FileReader()
      reader.onloadend = () => {
        const imageUrl = reader.result
        handleImageChange(key, imageUrl)
      }
      reader.readAsDataURL(file)
    }
  }

  const handleAddHeroImage = () => {
    const currentImages = pageImages.homeHeroImages || ['/hero-image.jpg']
    const updated = { ...pageImages, homeHeroImages: [...currentImages, '/hero-image.jpg'] }
    savePageImages(updated)
  }

  const handleRemoveHeroImage = (index) => {
    const currentImages = pageImages.homeHeroImages || ['/hero-image.jpg']
    if (currentImages.length <= 1) return // Keep at least one image
    const updated = { ...pageImages, homeHeroImages: currentImages.filter((_, i) => i !== index) }
    savePageImages(updated)
  }

  const handleHeroImageChange = (index, value) => {
    const currentImages = pageImages.homeHeroImages || ['/hero-image.jpg']
    const updatedImages = [...currentImages]
    updatedImages[index] = value
    const updated = { ...pageImages, homeHeroImages: updatedImages }
    savePageImages(updated)
  }

  const handleHeroImageFileChange = (index, e) => {
    const file = e.target.files[0]
    if (file) {
      const reader = new FileReader()
      reader.onloadend = () => {
        const imageUrl = reader.result
        handleHeroImageChange(index, imageUrl)
      }
      reader.readAsDataURL(file)
    }
  }

  const handleHeroVideoChange = (value) => {
    const updated = { ...pageImages, homeHeroVideo: value }
    savePageImages(updated)
  }

  const handleHeroMediaTypeChange = (type) => {
    const updated = { ...pageImages, homeHeroMediaType: type }
    savePageImages(updated)
  }

  const handleHeroVideoFileChange = (e) => {
    const file = e.target.files[0]
    if (file) {
      const reader = new FileReader()
      reader.onloadend = () => {
        const videoUrl = reader.result
        handleHeroVideoChange(videoUrl)
      }
      reader.readAsDataURL(file)
    }
  }

  const handleProfileFieldChange = (field, value) => {
    const updated = { ...profileData, [field]: value }
    setProfileData(updated)
  }

  const handleProfilePhotoFileChange = (e) => {
    const file = e.target.files?.[0]
    if (file) {
      const reader = new FileReader()
      reader.onloadend = () => {
        const imageUrl = reader.result
        const updated = { ...profileData, photo: imageUrl }
        setProfileData(updated)
        localStorage.setItem('adminProfile', JSON.stringify(updated))
      }
      reader.readAsDataURL(file)
    }
  }

  const savePageImages = (updated) => {
    setPageImages(updated)
    fetch(`${API_BASE}/api/page-images`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data: updated })
    }).catch((err) => console.error('Save images failed', err))
    if (showPreview) {
      setTimeout(refreshPreview, 100)
    }
  }

  const handleSaveProfile = async () => {
    try {
      setProfileStatus(language === 'en' ? 'Saving...' : 'সংরক্ষণ করা হচ্ছে...')

      if (isEmployee && loggedInUserId) {
        // Save employee profile
        const res = await fetch(`${API_BASE}/api/employees/${loggedInUserId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: profileData.name,
            email: profileData.email,
            phone: profileData.phone,
            address: profileData.address,
            photo: profileData.photo
          })
        })
        if (!res.ok) throw new Error('Failed to save profile')
        setProfileStatus(language === 'en' ? 'Saved to database' : 'ডাটাবেজে সংরক্ষিত')
        if (profileData.name) {
          setLoggedInUser(profileData.name)
        }
        // Reload employee profile
        loadUserProfile('employee', loggedInUserId)
      } else {
        // Save admin profile
        const res = await fetch(`${API_BASE}/api/admin/profile`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(profileData)
        })
        if (!res.ok) throw new Error('Failed to save profile')
        setProfileStatus(language === 'en' ? 'Saved to database' : 'ডাটাবেজে সংরক্ষিত')
        if (profileData.name) {
          setLoggedInUser(profileData.name)
        }
        // Always set Admin role for admin profile
        setUserRole('Admin')
        // Reload admin profile
        loadUserProfile('admin')
      }
    } catch (err) {
      console.error('Save profile failed', err)
      setProfileStatus(language === 'en' ? 'Save failed' : 'সংরক্ষণ ব্যর্থ')
    }
  }

  const handleChangePassword = () => {
    const { current, next, confirm } = passwordForm
    if (!next || next.length < 6) {
      setPasswordForm({ ...passwordForm, status: language === 'en' ? 'Password must be at least 6 characters' : 'পাসওয়ার্ড ন্যূনতম ৬ অক্ষরের হতে হবে' })
      return
    }
    if (next !== confirm) {
      setPasswordForm({ ...passwordForm, status: adminContent.passwordMismatch })
      return
    }

    // Determine which endpoint to use based on user type
    if (isEmployee && !loggedInUserId) {
      setPasswordForm({ ...passwordForm, status: language === 'en' ? 'Employee ID not found. Please log in again.' : 'কর্মচারী আইডি পাওয়া যায়নি। অনুগ্রহ করে আবার লগইন করুন।' })
      return
    }

    const endpoint = isEmployee && loggedInUserId
      ? `${API_BASE}/api/employees/change-password`
      : `${API_BASE}/api/admin/change-password`

    // Include employee ID in request body for employee password change
    const requestBody = isEmployee && loggedInUserId
      ? { id: loggedInUserId, current, next }
      : { current, next }

    fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody)
    }).then(async (res) => {
      if (!res.ok) {
        const errorData = await res.json().catch(() => ({}))
        const errorMessage = errorData.message || (res.status === 404 ? (language === 'en' ? 'Route not found' : 'রুট পাওয়া যায়নি') : adminContent.passwordIncorrect)
        throw new Error(errorMessage)
      }
      if (!isEmployee) {
        setAdminPassword(next)
      } else {
        // If employee changed password, refresh employee list to show updated password
        try {
          const resEmployees = await fetch(`${API_BASE}/api/employees`)
          if (resEmployees.ok) {
            const empData = await resEmployees.json()
            const updatedEmployees = empData.data || []
            setEmployees(updatedEmployees)

            // Update viewingEmployee if modal is open and showing this employee
            if (viewingEmployee && viewingEmployee._id === loggedInUserId) {
              const updatedEmployee = updatedEmployees.find((e) => e._id === loggedInUserId)
              if (updatedEmployee) {
                setViewingEmployee(updatedEmployee)
              }
            }
          }
        } catch (err) {
          console.error('Failed to refresh employee list after password change', err)
        }
      }
      setPasswordForm({ current: '', next: '', confirm: '', status: adminContent.passwordUpdated })
    }).catch((err) => {
      setPasswordForm({ ...passwordForm, status: err.message })
    })
  }

  const handleLogin = (e) => {
    e.preventDefault()
    setLoginError('')

    // Try admin login first
    fetch(`${API_BASE}/api/admin/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    })
      .then(async (res) => {
        if (res.ok) {
          const data = await res.json()
          // Always set role to 'Admin' for admin login
          setUserRole('Admin')
          setIsEmployee(false)
          setLoggedInUserId(null)
          if (data.name) setLoggedInUser(data.name)
          // Sync profile data immediately on login, preserving designation if present
          setProfileData((prev) => ({
            ...prev,
            name: data.name || prev.name || 'Admin',
            email: data.email || prev.email || 'admin@example.com',
            phone: data.phone || prev.phone || '+880 1234 567890',
            address: data.address || prev.address || 'Dhaka, Bangladesh',
            photo: data.photo || prev.photo || '',
            role: 'Admin',
            designation: data.designation ?? prev.designation ?? '',
            department: ''
          }))
          // Load admin profile
          loadUserProfile('admin')
          setIsAuthenticated(true)
          persistAuthState({
            isEmployee: false,
            userRole: 'Admin',
            loggedInUser: data.name || '',
            loggedInUserId: null
          })
          return Promise.resolve(null) // Return resolved promise to skip employee login
        }
        // If admin login fails, try employee login
        return fetch(`${API_BASE}/api/employees/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        })
      })
      .then(async (res) => {
        if (!res) return // Admin login succeeded
        if (!res.ok) {
          throw new Error(language === 'en' ? 'Invalid username or password' : 'ব্যবহারকারীর নাম বা পাসওয়ার্ড ভুল')
        }
        const data = await res.json()
        if (data.role) setUserRole(data.role)
        if (data.name) setLoggedInUser(data.name)
        if (data.id) setLoggedInUserId(data.id)
        setIsEmployee(true)
        // Load employee profile
        loadUserProfile('employee', data.id)
        setIsAuthenticated(true)
        persistAuthState({
          isEmployee: true,
          userRole: data.role,
          loggedInUser: data.name || '',
          loggedInUserId: data.id || null
        })
      })
      .catch((err) => {
        setLoginError(err.message)
      })
  }

  const handleLogout = () => {
    setIsAuthenticated(false)
    setLoggedInUser('')
    setLoggedInUserId(null)
    setIsEmployee(false)
    setUserRole('Admin')
    localStorage.removeItem('adminAuth')
    localStorage.removeItem('adminUsername')
    localStorage.removeItem('adminActiveTab')
    localStorage.removeItem('adminViewingDealerId')
    localStorage.removeItem('adminShowDealerOrders')
    localStorage.removeItem('adminViewingOrderId')
    setActiveTab('dashboard')
  }

  // Load user profile (admin or employee)
  const loadUserProfile = async (userType, employeeId = null) => {
    setLoadingProfile(true)
    try {
      if (userType === 'admin') {
        const resProfile = await fetch(`${API_BASE}/api/admin/profile`)
        if (resProfile.ok) {
          const data = await resProfile.json()
          setProfileData((prev) => ({
            ...prev,
            name: data.name || prev.name || 'Admin',
            email: data.email || prev.email || 'admin@example.com',
            phone: data.phone || prev.phone || '+880 1234 567890',
            address: data.address || prev.address || 'Dhaka, Bangladesh',
            photo: data.photo || prev.photo || '',
            role: 'Admin',
            designation: data.designation ?? prev.designation ?? '',
            department: ''
          }))
          if (data.name) setLoggedInUser(data.name)
          setUserRole('Admin')
        }
      } else if (userType === 'employee' && employeeId) {
        const resEmployee = await fetch(`${API_BASE}/api/employees/${employeeId}`)
        if (resEmployee.ok) {
          const data = await resEmployee.json()
          if (data.data) {
            const emp = data.data
            setProfileData({
              name: emp.name || '',
              email: emp.email || '',
              phone: emp.phone || '',
              address: emp.address || '',
              photo: emp.photo || '',
              role: emp.role || '',
              designation: emp.designation || '',
              department: emp.department || ''
            })
            if (emp.name) setLoggedInUser(emp.name)
            if (emp.role) setUserRole(emp.role)
          }
        }
      }
    } catch (err) {
      console.error('Failed to load profile', err)
    } finally {
      setLoadingProfile(false)
    }
  }

  // Role-based access control
  const canAccessTab = (tabName) => {
    if (userRole === 'Admin') return true

    // Admin-only tabs
    const adminOnlyTabs = ['settings', 'hr', 'contacts', 'blogs', 'content', 'career', 'manageAsset']
    if (adminOnlyTabs.includes(tabName)) return false

    const roleAccess = {
      'RSM': ['dashboard', 'profile', 'crm', 'products', 'orders', 'revenue'],
      'Incharge': ['dashboard', 'profile', 'products', 'orders', 'inventory', 'territory'],
      'SalesMan': ['dashboard', 'profile', 'products', 'orders']
    }

    return roleAccess[userRole]?.includes(tabName) || false
  }

  // Redirect to dashboard if user doesn't have access to current tab
  useEffect(() => {
    if (isAuthenticated && !canAccessTab(activeTab)) {
      setActiveTab('dashboard')
    }
  }, [isAuthenticated, userRole, activeTab])

  // Login Form
  if (!isAuthenticated) {
    return (
      <div className="app admin-page">
        <main className="admin-login-container">
          <div className="admin-login-card">
            <div className="admin-login-header">
              <img src={logoImage} alt="BCC Logo" className="admin-login-logo" />
              <h1>{language === 'en' ? 'Login' : 'লগইন'}</h1>
              <p>{language === 'en' ? 'Enter your credentials to access the system' : 'সিস্টেমে অ্যাক্সেস করতে আপনার পরিচয়পত্র লিখুন'}</p>
            </div>
            <form onSubmit={handleLogin} className="admin-login-form">
              {loginError && (
                <div className="admin-login-error">
                  {loginError}
                </div>
              )}
              <div className="admin-form-group">
                <label>{language === 'en' ? 'Username' : 'ব্যবহারকারীর নাম'}</label>
                <input
                  type="text"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  placeholder={language === 'en' ? 'Enter username' : 'ব্যবহারকারীর নাম লিখুন'}
                  required
                />
              </div>
              <div className="admin-form-group">
                <label>{language === 'en' ? 'Password' : 'পাসওয়ার্ড'}</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  placeholder={language === 'en' ? 'Enter password' : 'পাসওয়ার্ড লিখুন'}
                  required
                />
              </div>
              <button type="submit" className="admin-login-btn">
                {language === 'en' ? 'Login' : 'লগইন'}
              </button>
            </form>
            <div className="admin-login-note">
              <p>{language === 'en' ? 'Admin default: admin / admin123' : 'অ্যাডমিন ডিফল্ট: admin / admin123'}</p>
              <p style={{ marginTop: '0.5rem', fontSize: '0.875rem' }}>
                {language === 'en' ? 'Employees: Use your username/email and password provided by admin' : 'কর্মচারী: আপনার ব্যবহারকারীর নাম/ইমেইল এবং অ্যাডমিন প্রদত্ত পাসওয়ার্ড ব্যবহার করুন'}
              </p>
            </div>
          </div>
        </main>
      </div>
    )
  }

  // Admin Dashboard
  const adminContent = language === 'en' ? {
    dashboard: 'Dashboard',
    products: 'Products',
    blogs: 'Blogs',
    contacts: 'Contact Messages',
    profile: 'Profile',
    crm: 'Customers',
    hr: 'HR',
    orders: 'Orders',
    inventory: 'Inventory',
    revenue: 'Revenue',
    manageAsset: 'Manage Asset',
    territory: 'Territory Management',
    territoryId: 'Territory ID',
    settings: 'Settings',
    logout: 'Logout',
    overview: 'Overview',
    totalProducts: 'Total Products',
    totalBlogs: 'Total Blogs',
    totalContacts: 'Contact Messages',
    recentActivity: 'Recent Activity',
    manageProducts: 'Manage Products',
    manageBlogs: 'Manage Blogs',
    viewMessages: 'View Messages',
    contentManagement: 'Content Management',
    careerManagement: 'Career Management',
    systemSettings: 'System Settings',
    editContent: 'Edit Content',
    heroSection: 'Hero Section',
    pageContent: 'Page Content',
    livePreview: 'Live Preview',
    closePreview: 'Close Preview',
    viewLivePage: 'View Live Page',
    editMode: 'Edit Mode',
    enableEdit: 'Enable Edit Mode',
    disableEdit: 'Disable Edit Mode',
    addNew: 'Add New',
    edit: 'Edit',
    delete: 'Delete',
    view: 'View',
    search: 'Search...',
    noData: 'No data available',
    save: 'Save',
    cancel: 'Cancel',
    address: 'Address',
    photo: 'Photo',
    changePassword: 'Change Password',
    currentPassword: 'Current Password',
    newPassword: 'New Password',
    confirmPassword: 'Confirm Password',
    updatePassword: 'Update Password',
    passwordUpdated: 'Password updated',
    passwordMismatch: 'Passwords do not match',
    passwordIncorrect: 'Current password is incorrect',
    productName: 'Product Name',
    category: 'Category',
    description: 'Description',
    blogTitle: 'Blog Title',
    author: 'Author',
    date: 'Date',
    message: 'Message',
    name: 'Name',
    email: 'Email',
    phone: 'Phone',
    shopName: 'Shop Name',
    customer: 'Customer',
    cid: 'CID',
    customerName: 'Customer Name'
  } : {
    dashboard: 'ড্যাশবোর্ড',
    products: 'পণ্য',
    blogs: 'ব্লগ',
    contacts: 'যোগাযোগ বার্তা',
    profile: 'প্রোফাইল',
    crm: 'কাস্টমার',
    hr: 'এইচআর',
    orders: 'অর্ডার',
    inventory: 'ইনভেন্টরি',
    revenue: 'রাজস্ব',
    manageAsset: 'সম্পদ ব্যবস্থাপনা',
    territory: 'টেরিটরি ম্যানেজমেন্ট',
    territoryId: 'টেরিটরি আইডি',
    settings: 'সেটিংস',
    logout: 'লগআউট',
    overview: 'ওভারভিউ',
    totalProducts: 'মোট পণ্য',
    totalBlogs: 'মোট ব্লগ',
    totalContacts: 'যোগাযোগ বার্তা',
    recentActivity: 'সাম্প্রতিক কার্যক্রম',
    manageProducts: 'পণ্য পরিচালনা',
    manageBlogs: 'ব্লগ পরিচালনা',
    viewMessages: 'বার্তা দেখুন',
    contentManagement: 'কন্টেন্ট ম্যানেজমেন্ট',
    careerManagement: 'ক্যারিয়ার ম্যানেজমেন্ট',
    systemSettings: 'সিস্টেম সেটিংস',
    editContent: 'কন্টেন্ট সম্পাদনা',
    heroSection: 'হিরো সেকশন',
    pageContent: 'পেজ কন্টেন্ট',
    livePreview: 'লাইভ প্রিভিউ',
    closePreview: 'প্রিভিউ বন্ধ করুন',
    viewLivePage: 'লাইভ পেজ দেখুন',
    editMode: 'এডিট মোড',
    enableEdit: 'এডিট মোড চালু করুন',
    disableEdit: 'এডিট মোড বন্ধ করুন',
    addNew: 'নতুন যোগ করুন',
    edit: 'সম্পাদনা',
    delete: 'মুছুন',
    view: 'দেখুন',
    search: 'খুঁজুন...',
    noData: 'কোন ডেটা নেই',
    save: 'সংরক্ষণ',
    cancel: 'বাতিল',
    address: 'ঠিকানা',
    photo: 'ছবি',
    changePassword: 'পাসওয়ার্ড পরিবর্তন করুন',
    currentPassword: 'বর্তমান পাসওয়ার্ড',
    newPassword: 'নতুন পাসওয়ার্ড',
    confirmPassword: 'পাসওয়ার্ড নিশ্চিত করুন',
    updatePassword: 'পাসওয়ার্ড আপডেট করুন',
    passwordUpdated: 'পাসওয়ার্ড আপডেট হয়েছে',
    passwordMismatch: 'পাসওয়ার্ড মিলছে না',
    passwordIncorrect: 'বর্তমান পাসওয়ার্ড সঠিক নয়',
    productName: 'পণ্যের নাম',
    category: 'ক্যাটাগরি',
    description: 'বিবরণ',
    blogTitle: 'ব্লগ শিরোনাম',
    author: 'লেখক',
    date: 'তারিখ',
    message: 'বার্তা',
    name: 'নাম',
    email: 'ইমেইল',
    phone: 'ফোন'
  }

  // Mock data for demonstration
  const productCount = products.length || t.products.items.length
  const stats = {
    totalProducts: productCount,
    totalBlogs: t.blog.featured.length + t.blog.list.length,
    totalContacts: 24,
    recentActivity: [
      { type: 'product', action: 'Updated', item: 'Herbicide Pro', time: '2 hours ago' },
      { type: 'blog', action: 'Published', item: 'Expert Tips for Maximizing Crop Yields', time: '1 day ago' },
      { type: 'contact', action: 'New message from', item: 'Md. Rafiq Hasan', time: '2 days ago' }
    ]
  }

  // Helper function to handle tab change and close sidebar on mobile
  const handleTabChange = (tab) => {
    setActiveTab(tab)
    setSidebarOpen(false)
    if (tab === 'revenue' || tab === 'territory') {
      loadTerritories()
    }
  }

  // Loading Spinner Component
  const LoadingSpinner = ({ text = language === 'en' ? 'Loading...' : 'লোড হচ্ছে...' }) => (
    <div style={{
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      justifyContent: 'center',
      padding: '3rem',
      minHeight: '300px'
    }}>
      <div style={{
        width: '50px',
        height: '50px',
        border: '4px solid #e5e7eb',
        borderTop: '4px solid #10b981',
        borderRadius: '50%',
        animation: 'spin 1s linear infinite'
      }} />
      <p style={{
        marginTop: '1rem',
        color: '#6b7280',
        fontSize: '0.95rem',
        fontWeight: 500
      }}>{text}</p>
      <style>{`
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      `}</style>
    </div>
  )

  return (
    <div className="app admin-page">
      <main className="admin-main">
        {/* Mobile Menu Toggle and Logo */}
        <div className="admin-mobile-header">
          <button
            className="admin-mobile-menu-toggle"
            onClick={() => setSidebarOpen(!sidebarOpen)}
            aria-label="Toggle menu"
          >
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              {sidebarOpen ? (
                <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
              ) : (
                <path d="M3 12h18M3 6h18M3 18h18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
              )}
            </svg>
          </button>
          <img src={logoImage} alt="BCC Logo" className="admin-mobile-logo" />
        </div>

        {/* Mobile Overlay */}
        {sidebarOpen && (
          <div
            className="admin-sidebar-overlay"
            onClick={() => setSidebarOpen(false)}
          />
        )}

        <div className={`admin-sidebar ${sidebarOpen ? 'open' : ''}`}>
          <div className="admin-sidebar-header">
            <h2>
              {language === 'en'
                ? `${userRole || 'Admin'} Portal`
                : userRole === 'Admin' ? 'অ্যাডমিন প্যানেল'
                  : userRole === 'RSM' ? 'আরএসএম পোর্টাল'
                    : userRole === 'Incharge' ? 'ইনচার্জ পোর্টাল'
                      : userRole === 'SalesMan' ? 'সেলসম্যান পোর্টাল'
                        : 'পোর্টাল'
              }
            </h2>
          </div>
          <nav className="admin-nav">
            <button
              className={`admin-nav-item ${activeTab === 'dashboard' ? 'active' : ''}`}
              onClick={() => handleTabChange('dashboard')}
            >
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="3" y="3" width="7" height="7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                <rect x="14" y="3" width="7" height="7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                <rect x="3" y="14" width="7" height="7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                <rect x="14" y="14" width="7" height="7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
              </svg>
              {adminContent.dashboard}
            </button>
            <button
              className={`admin-nav-item ${activeTab === 'profile' ? 'active' : ''}`}
              onClick={() => handleTabChange('profile')}
            >
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                <circle cx="12" cy="7" r="4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
              </svg>
              {adminContent.profile}
            </button>
            {canAccessTab('crm') && (
              <button
                className={`admin-nav-item ${activeTab === 'crm' ? 'active' : ''}`}
                onClick={() => handleTabChange('crm')}
              >
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <circle cx="9" cy="7" r="4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                {adminContent.crm}
              </button>
            )}
            {canAccessTab('hr') && (
              <button
                className={`admin-nav-item ${activeTab === 'hr' ? 'active' : ''}`}
                onClick={() => handleTabChange('hr')}
              >
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <circle cx="9" cy="7" r="4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                {adminContent.hr}
              </button>
            )}
            {canAccessTab('products') && (
              <button
                className={`admin-nav-item ${activeTab === 'products' ? 'active' : ''}`}
                onClick={() => handleTabChange('products')}
              >
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4H6z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M3 6h18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M16 10a4 4 0 0 1-8 0" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                {adminContent.products}
              </button>
            )}
            {canAccessTab('orders') && (
              <button
                className={`admin-nav-item ${activeTab === 'orders' ? 'active' : ''}`}
                onClick={() => handleTabChange('orders')}
              >
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4H6z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M3 6h18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M16 10a4 4 0 0 1-8 0" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                {adminContent.orders}
              </button>
            )}
            {canAccessTab('revenue') && (
              <button
                className={`admin-nav-item ${activeTab === 'revenue' ? 'active' : ''}`}
                onClick={() => handleTabChange('revenue')}
              >
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <line x1="12" y1="1" x2="12" y2="23" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                {adminContent.revenue}
              </button>
            )}
            {canAccessTab('inventory') && (
              <button
                className={`admin-nav-item ${activeTab === 'inventory' ? 'active' : ''}`}
                onClick={() => handleTabChange('inventory')}
              >
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4H6z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M3 6h18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M8 10h8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M8 14h8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                {adminContent.inventory}
              </button>
            )}
            {canAccessTab('territory') && (
              <button
                className={`admin-nav-item ${activeTab === 'territory' ? 'active' : ''}`}
                onClick={() => handleTabChange('territory')}
              >
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <circle cx="12" cy="10" r="3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                {adminContent.territory}
              </button>
            )}
            {canAccessTab('manageAsset') && (
              <button
                className={`admin-nav-item ${activeTab === 'manageAsset' ? 'active' : ''}`}
                onClick={() => handleTabChange('manageAsset')}
              >
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M3 9h18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M9 21V9" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                {adminContent.manageAsset}
              </button>
            )}
            {canAccessTab('contacts') && (
              <button
                className={`admin-nav-item ${activeTab === 'contacts' ? 'active' : ''}`}
                onClick={() => handleTabChange('contacts')}
              >
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                {adminContent.contacts}
              </button>
            )}
            {canAccessTab('blogs') && (
              <button
                className={`admin-nav-item ${activeTab === 'blogs' ? 'active' : ''}`}
                onClick={() => handleTabChange('blogs')}
              >
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M14 2v6h6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M16 13H8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M16 17H8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M10 9H9" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                {adminContent.blogs}
              </button>
            )}
            {canAccessTab('content') && (
              <button
                className={`admin-nav-item ${activeTab === 'content' ? 'active' : ''}`}
                onClick={() => handleTabChange('content')}
              >
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                {adminContent.contentManagement}
              </button>
            )}
            {canAccessTab('career') && (
              <button
                className={`admin-nav-item ${activeTab === 'career' ? 'active' : ''}`}
                onClick={() => handleTabChange('career')}
              >
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 7V5a3 3 0 0 1 3-3h6a3 3 0 0 1 3 3v2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <rect x="3" y="7" width="18" height="13" rx="2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M9 12h6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                {adminContent.careerManagement}
              </button>
            )}
            {canAccessTab('settings') && (
              <button
                className={`admin-nav-item ${activeTab === 'settings' ? 'active' : ''}`}
                onClick={() => handleTabChange('settings')}
              >
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="12" cy="12" r="3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  <path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                {adminContent.settings}
              </button>
            )}
          </nav>
          <button className="admin-logout-btn" onClick={handleLogout}>
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
              <polyline points="16 17 21 12 16 7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
              <line x1="21" y1="12" x2="9" y2="12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
            </svg>
            {adminContent.logout}
          </button>
        </div>

        <div className="admin-content">
          {/* Dashboard Tab */}
          {activeTab === 'dashboard' && (
            <div className="admin-tab-content">
              <div className="admin-welcome-section">
                <img src={logoImage} alt="Company Logo" className="admin-company-logo" />
                <div className="admin-welcome-content">
                  <h2 className="admin-welcome-text">
                    {language === 'en' ? 'Welcome' : 'স্বাগতম'}, {loggedInUser || 'Admin'}
                  </h2>
                  {profileData.photo ? (
                    <img
                      src={profileData.photo}
                      alt="Profile"
                      className="admin-profile-photo"
                    />
                  ) : (
                    <div className="admin-profile-placeholder">
                      {(profileData.name || 'A').charAt(0)}
                    </div>
                  )}
                </div>
              </div>
              <h1 className="admin-page-title">{adminContent.overview}</h1>
              <div className="admin-stats-grid">
                <div className="admin-stat-card">
                  <div className="admin-stat-icon products">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4H6z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                    </svg>
                  </div>
                  <div className="admin-stat-info">
                    <h3>{adminContent.totalProducts}</h3>
                    <p>{stats.totalProducts}</p>
                  </div>
                </div>
                <div className="admin-stat-card">
                  <div className="admin-stat-icon blogs">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                    </svg>
                  </div>
                  <div className="admin-stat-info">
                    <h3>{adminContent.totalBlogs}</h3>
                    <p>{stats.totalBlogs}</p>
                  </div>
                </div>
                <div className="admin-stat-card">
                  <div className="admin-stat-icon contacts">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                    </svg>
                  </div>
                  <div className="admin-stat-info">
                    <h3>{adminContent.totalContacts}</h3>
                    <p>{stats.totalContacts}</p>
                  </div>
                </div>
              </div>
              <div className="admin-activity-section">
                <h2>{adminContent.recentActivity}</h2>
                <div className="admin-activity-list">
                  {stats.recentActivity.map((activity, index) => (
                    <div key={index} className="admin-activity-item">
                      <div className="admin-activity-icon">
                        {activity.type === 'product' && '📦'}
                        {activity.type === 'blog' && '📝'}
                        {activity.type === 'contact' && '✉️'}
                      </div>
                      <div className="admin-activity-content">
                        <p><strong>{activity.action}</strong> {activity.item}</p>
                        <span>{activity.time}</span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Products Tab */}
          {activeTab === 'products' && (
            <div className="admin-tab-content">
              <div className="admin-tab-header" style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', flexWrap: 'wrap' }}>
                <h1 className="admin-page-title" style={{ flex: 1 }}>{adminContent.manageProducts}</h1>
                {(userRole || '').toLowerCase() === 'admin' && (
                  <button
                    className="admin-add-btn"
                    onClick={() => {
                      resetProductForm()
                      setShowProductForm(true)
                      setProductStatus('')
                    }}
                  >
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                      <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                    </svg>
                    {adminContent.addNew}
                  </button>
                )}
              </div>
              {productStatus && (
                <div
                  style={{
                    marginBottom: '1rem',
                    padding: '0.75rem 1rem',
                    borderRadius: '0.5rem',
                    backgroundColor: productStatus.toLowerCase().includes('fail') || productStatus.toLowerCase().includes('ব্যর্থ')
                      ? '#fef2f2'
                      : '#ecfdf3',
                    color: productStatus.toLowerCase().includes('fail') || productStatus.toLowerCase().includes('ব্যর্থ')
                      ? '#b91c1c'
                      : '#166534',
                    border: productStatus.toLowerCase().includes('fail') || productStatus.toLowerCase().includes('ব্যর্থ')
                      ? '1px solid #fecaca'
                      : '1px solid #bbf7d0',
                    fontWeight: 600
                  }}
                >
                  {productStatus}
                </div>
              )}
              {showProductForm && (
                <div className="admin-product-form-overlay" style={{
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  backgroundColor: 'rgba(0, 0, 0, 0.5)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 1000,
                  padding: '1rem'
                }} onClick={() => {
                  resetProductForm()
                  setShowProductForm(false)
                  setProductStatus('')
                }}>
                  <div className="admin-modal-content" onClick={(e) => e.stopPropagation()}>
                    <div style={{
                      position: 'absolute',
                      inset: 0,
                      pointerEvents: 'none',
                      overflow: 'hidden',
                      borderRadius: '0.75rem'
                    }}>
                      <div style={{
                        position: 'absolute',
                        width: '260px',
                        height: '260px',
                        top: '-120px',
                        left: '-80px',
                        background: 'radial-gradient(circle at 30% 30%, rgba(59,130,246,0.25), transparent 60%)',
                        filter: 'blur(20px)'
                      }} />
                      <div style={{
                        position: 'absolute',
                        width: '240px',
                        height: '240px',
                        bottom: '-140px',
                        right: '-100px',
                        background: 'radial-gradient(circle at 70% 70%, rgba(16,185,129,0.22), transparent 60%)',
                        filter: 'blur(20px)'
                      }} />
                    </div>

                    <div style={{ position: 'relative', display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', gap: '1rem' }}>
                      <div>
                        <h2 style={{ margin: 0, fontSize: '1.5rem', fontWeight: 800, color: '#0f172a' }}>
                          {editingProductId
                            ? (language === 'en' ? 'Edit Product' : 'পণ্য সম্পাদনা')
                            : (language === 'en' ? 'Add Product' : 'পণ্য যোগ করুন')}
                        </h2>
                        <p style={{ margin: '0.25rem 0 0 0', color: '#475569', fontWeight: 600 }}>
                          {language === 'en' ? 'Fill in product details and save' : 'পণ্যের বিবরণ পূরণ করুন এবং সংরক্ষণ করুন'}
                        </p>
                      </div>
                      <button
                        onClick={() => {
                          resetProductForm()
                          setShowProductForm(false)
                          setProductStatus('')
                        }}
                        style={{
                          background: '#e2e8f0',
                          border: 'none',
                          padding: '0.4rem 0.65rem',
                          borderRadius: '0.375rem',
                          cursor: 'pointer',
                          fontWeight: 700,
                          color: '#475569'
                        }}
                      >
                        ×
                      </button>
                    </div>

                    <div style={{ position: 'relative', zIndex: 1 }}>
                      {productStatus && (
                        <div style={{
                          padding: '0.75rem',
                          marginBottom: '1rem',
                          borderRadius: '0.5rem',
                          border: productStatus.includes('error') || productStatus.includes('Failed') ? '1px solid #fecaca' : '1px solid #bbf7d0',
                          backgroundColor: productStatus.includes('error') || productStatus.includes('Failed') ? '#fef2f2' : '#ecfdf3',
                          color: productStatus.includes('error') || productStatus.includes('Failed') ? '#b91c1c' : '#065f46',
                          fontWeight: 700
                        }}>
                          {productStatus}
                        </div>
                      )}
                      <form onSubmit={handleSaveProduct}>
                        <div className="admin-form-grid">
                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Product ID' : 'পণ্য আইডি'}</label>
                            <input
                              type="text"
                              value={productForm.productId || ''}
                              onChange={(e) => setProductForm({ ...productForm, productId: e.target.value })}
                              placeholder={language === 'en' ? 'Auto-generated (BP001, BP002...)' : 'স্বয়ংক্রিয়ভাবে তৈরি (BP001, BP002...)'}
                              style={{ backgroundColor: editingProductId ? 'white' : '#f3f4f6', cursor: editingProductId ? 'text' : 'not-allowed' }}
                              readOnly={!editingProductId}
                              title={language === 'en' ? 'Product ID is auto-generated for new products' : 'নতুন পণ্যের জন্য পণ্য আইডি স্বয়ংক্রিয়ভাবে তৈরি হয়'}
                            />
                            {!editingProductId && (
                              <small style={{ color: '#6b7280', fontSize: '0.75rem', marginTop: '0.25rem', display: 'block' }}>
                                {language === 'en' ? 'Will be auto-generated as BP001, BP002, etc.' : 'BP001, BP002 ইত্যাদি হিসাবে স্বয়ংক্রিয়ভাবে তৈরি হবে'}
                              </small>
                            )}
                          </div>
                          <div className="admin-form-group">
                            <label>{adminContent.productName} {language === 'en' ? '(English)' : '(ইংরেজি)'}</label>
                            <input
                              type="text"
                              value={productForm.name}
                              onChange={(e) => setProductForm({ ...productForm, name: e.target.value })}
                              required
                            />
                          </div>
                          <div className="admin-form-group">
                            <label>{adminContent.productName} {language === 'en' ? '(Bangla)' : '(বাংলা)'}</label>
                            <input
                              type="text"
                              value={productForm.nameBn}
                              onChange={(e) => setProductForm({ ...productForm, nameBn: e.target.value })}
                              placeholder={language === 'en' ? 'Product name in Bangla (optional)' : 'বাংলায় পণ্যের নাম (ঐচ্ছিক)'}
                            />
                          </div>
                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Generic Name' : 'জেনেরিক নাম'} {language === 'en' ? '(English)' : '(ইংরেজি)'}</label>
                            <input
                              type="text"
                              value={productForm.genericName}
                              onChange={(e) => setProductForm({ ...productForm, genericName: e.target.value })}
                              required
                            />
                          </div>
                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Generic Name' : 'জেনেরিক নাম'} {language === 'en' ? '(Bangla)' : '(বাংলা)'}</label>
                            <input
                              type="text"
                              value={productForm.genericNameBn}
                              onChange={(e) => setProductForm({ ...productForm, genericNameBn: e.target.value })}
                              placeholder={language === 'en' ? 'Generic name in Bangla (optional)' : 'বাংলায় জেনেরিক নাম (ঐচ্ছিক)'}
                            />
                          </div>
                          <div className="admin-form-group">
                            <label>{adminContent.category} {language === 'en' ? '(English)' : '(ইংরেজি)'}</label>
                            <select
                              value={productForm.category}
                              onChange={(e) => setProductForm({ ...productForm, category: e.target.value })}
                              style={{ width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem' }}
                            >
                              {['Herbicide', 'Fungicide', 'Insecticide', 'Growth Promoter', 'Fertilizer', 'Organic'].map((cat) => (
                                <option key={cat} value={cat}>{cat}</option>
                              ))}
                            </select>
                          </div>
                          <div className="admin-form-group">
                            <label>{adminContent.category} {language === 'en' ? '(Bangla)' : '(বাংলা)'}</label>
                            <input
                              type="text"
                              value={productForm.categoryBn}
                              onChange={(e) => setProductForm({ ...productForm, categoryBn: e.target.value })}
                              placeholder={language === 'en' ? 'Category in Bangla (optional)' : 'বাংলায় ক্যাটাগরি (ঐচ্ছিক)'}
                            />
                          </div>
                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Price Category' : 'মূল্য বিভাগ'}</label>
                            <select
                              value={productForm.priceCategory}
                              onChange={(e) => setProductForm({ ...productForm, priceCategory: e.target.value })}
                              style={{ width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem' }}
                            >
                              <option value="single">{language === 'en' ? 'Single Price' : 'একক মূল্য'}</option>
                              <option value="per_variant">{language === 'en' ? 'Per Variant' : 'প্রতি ভ্যারিয়েন্ট'}</option>
                            </select>
                          </div>
                          {productForm.priceCategory === 'single' && (
                            <div className="admin-form-group">
                              <label>{language === 'en' ? 'Price' : 'মূল্য'}</label>
                              <input
                                type="number"
                                min="0"
                                value={productForm.price || ''}
                                onChange={(e) => setProductForm({ ...productForm, price: e.target.value })}
                                placeholder={language === 'en' ? '0.00' : '০.০০'}
                              />
                            </div>
                          )}
                          <div className="admin-form-group" style={{ gridColumn: '1 / -1', padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.5rem', border: '1px solid #e5e7eb' }}>
                            <label style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', fontSize: '1rem', fontWeight: 600, color: '#111827', marginBottom: '0.75rem' }}>
                              <input
                                type="checkbox"
                                checked={productForm.hasOffer || false}
                                onChange={(e) => setProductForm({ ...productForm, hasOffer: e.target.checked })}
                                style={{ width: '20px', height: '20px', cursor: 'pointer', accentColor: '#16a34a' }}
                              />
                              <span>{language === 'en' ? 'Enable Special Offer' : 'বিশেষ অফার সক্রিয় করুন'}</span>
                            </label>
                            {productForm.hasOffer && (
                              <>
                                <div style={{ display: 'flex', gap: '1rem', marginTop: '0.75rem', flexWrap: 'wrap' }}>
                                  <div style={{ flex: 1, minWidth: '150px' }}>
                                    <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600, marginBottom: '0.5rem', display: 'block' }}>
                                      {language === 'en' ? 'Buy Quantity' : 'ক্রয় পরিমাণ'} *
                                    </label>
                                    <input
                                      type="number"
                                      min="1"
                                      value={productForm.buyQuantity || ''}
                                      onChange={(e) => setProductForm({ ...productForm, buyQuantity: e.target.value })}
                                      placeholder={language === 'en' ? 'e.g., 4' : 'যেমন, ৪'}
                                      style={{ width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', fontSize: '1rem' }}
                                    />
                                  </div>
                                  <div style={{ flex: 1, minWidth: '150px' }}>
                                    <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600, marginBottom: '0.5rem', display: 'block' }}>
                                      {language === 'en' ? 'Free Quantity' : 'ফ্রি পরিমাণ'} *
                                    </label>
                                    <input
                                      type="number"
                                      min="1"
                                      value={productForm.freeQuantity || ''}
                                      onChange={(e) => setProductForm({ ...productForm, freeQuantity: e.target.value })}
                                      placeholder={language === 'en' ? 'e.g., 1' : 'যেমন, ১'}
                                      style={{ width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', fontSize: '1rem' }}
                                    />
                                  </div>
                                </div>
                                {productForm.buyQuantity && productForm.freeQuantity && (
                                  <div style={{ marginTop: '0.75rem', padding: '0.75rem', backgroundColor: '#ecfdf3', borderRadius: '0.375rem', border: '1px solid #bbf7d0' }}>
                                    <p style={{ margin: 0, fontSize: '0.875rem', color: '#065f46', fontWeight: 600 }}>
                                      {language === 'en'
                                        ? `✓ Offer: Buy ${productForm.buyQuantity} units, get ${productForm.freeQuantity} unit(s) free`
                                        : `✓ অফার: ${productForm.buyQuantity} ইউনিট ক্রয় করলে ${productForm.freeQuantity} ইউনিট ফ্রি`}
                                    </p>
                                  </div>
                                )}
                              </>
                            )}
                          </div>
                          <div className="admin-form-group admin-product-variants-group" style={{ gridColumn: '1 / -1' }}>
                            <label>{language === 'en' ? 'Variants' : 'ভ্যারিয়েন্ট'}</label>
                            <div className="admin-product-variants-container" style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                              {(productForm.variants || []).map((variant, index) => (
                                <div key={index} className="admin-product-variant-item" style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', flexWrap: 'wrap' }}>
                                  <input
                                    type="text"
                                    value={variant.productCode || ''}
                                    onChange={(e) => updateVariant(index, 'productCode', e.target.value)}
                                    placeholder={language === 'en' ? 'Product Code' : 'পণ্য কোড'}
                                    style={{ width: '120px', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem' }}
                                  />
                                  <div style={{ display: 'flex', gap: '0.25rem', alignItems: 'center' }}>
                                    <input
                                      type="text"
                                      value={variant.packSize || ''}
                                      onChange={(e) => updateVariant(index, 'packSize', e.target.value)}
                                      placeholder={language === 'en' ? 'Pack Size' : 'প্যাক সাইজ'}
                                      style={{ width: '90px', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem' }}
                                    />
                                    <select
                                      value={variant.packUnit || 'ml'}
                                      onChange={(e) => updateVariant(index, 'packUnit', e.target.value)}
                                      style={{ width: '65px', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem' }}
                                    >
                                      <option value="gm">gm</option>
                                      <option value="kg">kg</option>
                                      <option value="ml">ml</option>
                                      <option value="Ltr">Ltr</option>
                                    </select>
                                  </div>

                                  <div style={{ display: 'flex', gap: '0.25rem', alignItems: 'center' }}>
                                    <input
                                      type="number"
                                      min="1"
                                      value={variant.cartoonSize || ''}
                                      onChange={(e) => updateVariant(index, 'cartoonSize', e.target.value === '' ? '' : (parseInt(e.target.value, 10) || ''))}
                                      placeholder={language === 'en' ? 'CTN Size' : 'কার্টুন সাইজ'}
                                      style={{ width: '80px', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem' }}
                                    />
                                    <select
                                      value={variant.cartoonUnit || 'Pcs'}
                                      onChange={(e) => updateVariant(index, 'cartoonUnit', e.target.value)}
                                      style={{ width: '85px', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', fontSize: '0.75rem' }}
                                    >
                                      <option value="Packets">{language === 'en' ? 'Packets' : 'প্যাকেট'}</option>
                                      <option value="Bottles">{language === 'en' ? 'Bottles' : 'বোতল'}</option>
                                      <option value="Pcs">{language === 'en' ? 'Pcs' : 'পিস'}</option>
                                    </select>
                                  </div>
                                  {productForm.priceCategory === 'per_variant' && (
                                    <>
                                      <input
                                        type="number"
                                        min="0"
                                        value={variant.price || ''}
                                        onChange={(e) => updateVariant(index, 'price', parseFloat(e.target.value) || 0)}
                                        placeholder={language === 'en' ? 'CTN Price' : 'কার্টুন মূল্য'}
                                        style={{ width: '110px', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem' }}
                                      />
                                      <div style={{ fontSize: '0.75rem', color: '#6b7280', minWidth: '80px' }}>
                                        {language === 'en' ? 'Unit:' : 'ইউনিট:'} ৳{Math.round(((variant.price || 0) / (variant.cartoonSize || 1)))}
                                      </div>
                                    </>
                                  )}
                                  <button
                                    type="button"
                                    onClick={() => removeVariant(index)}
                                    style={{
                                      padding: '0.5rem 0.75rem',
                                      backgroundColor: '#fee2e2',
                                      color: '#b91c1c',
                                      border: '1px solid #fecaca',
                                      borderRadius: '0.375rem',
                                      cursor: 'pointer',
                                      fontWeight: 600
                                    }}
                                  >
                                    {language === 'en' ? 'Remove' : 'মুছুন'}
                                  </button>
                                </div>
                              ))}
                              <button
                                type="button"
                                onClick={addVariant}
                                style={{
                                  padding: '0.5rem 1rem',
                                  backgroundColor: '#dbeafe',
                                  color: '#1e40af',
                                  border: '1px dashed #93c5fd',
                                  borderRadius: '0.375rem',
                                  cursor: 'pointer',
                                  fontWeight: 600,
                                  alignSelf: 'flex-start'
                                }}
                              >
                                + {language === 'en' ? 'Add Variant' : 'ভ্যারিয়েন্ট যোগ করুন'}
                              </button>
                            </div>
                          </div>
                          <div className="admin-form-group">
                            <label>{adminContent.description} {language === 'en' ? '(English)' : '(ইংরেজি)'}</label>
                            <textarea
                              rows={3}
                              value={productForm.description}
                              onChange={(e) => setProductForm({ ...productForm, description: e.target.value })}
                            />
                          </div>
                          <div className="admin-form-group">
                            <label>{adminContent.description} {language === 'en' ? '(Bangla)' : '(বাংলা)'}</label>
                            <textarea
                              rows={3}
                              value={productForm.descriptionBn}
                              onChange={(e) => setProductForm({ ...productForm, descriptionBn: e.target.value })}
                              placeholder={language === 'en' ? 'Description in Bangla (optional)' : 'বাংলায় বিবরণ (ঐচ্ছিক)'}
                            />
                          </div>
                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Usage' : 'ব্যবহার'} {language === 'en' ? '(English)' : '(ইংরেজি)'}</label>
                            <textarea
                              rows={3}
                              value={productForm.usage}
                              onChange={(e) => setProductForm({ ...productForm, usage: e.target.value })}
                            />
                          </div>
                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Usage' : 'ব্যবহার'} {language === 'en' ? '(Bangla)' : '(বাংলা)'}</label>
                            <textarea
                              rows={3}
                              value={productForm.usageBn}
                              onChange={(e) => setProductForm({ ...productForm, usageBn: e.target.value })}
                              placeholder={language === 'en' ? 'Usage instructions in Bangla (optional)' : 'বাংলায় ব্যবহারের নির্দেশাবলী (ঐচ্ছিক)'}
                            />
                          </div>
                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Benefits' : 'সুবিধা'} {language === 'en' ? '(English)' : '(ইংরেজি)'}</label>
                            <textarea
                              rows={4}
                              value={productForm.benefits}
                              onChange={(e) => setProductForm({ ...productForm, benefits: e.target.value })}
                              placeholder={language === 'en' ? 'List the key benefits of this product...' : 'এই পণ্যের মূল সুবিধাগুলি তালিকাভুক্ত করুন...'}
                            />
                          </div>
                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Benefits' : 'সুবিধা'} {language === 'en' ? '(Bangla)' : '(বাংলা)'}</label>
                            <textarea
                              rows={4}
                              value={productForm.benefitsBn}
                              onChange={(e) => setProductForm({ ...productForm, benefitsBn: e.target.value })}
                              placeholder={language === 'en' ? 'Benefits in Bangla (optional)' : 'বাংলায় সুবিধা (ঐচ্ছিক)'}
                            />
                          </div>
                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Application' : 'আবেদন'} {language === 'en' ? '(English)' : '(ইংরেজি)'}</label>
                            <textarea
                              rows={4}
                              value={productForm.application}
                              onChange={(e) => setProductForm({ ...productForm, application: e.target.value })}
                              placeholder={language === 'en' ? 'Application instructions and guidelines...' : 'আবেদনের নির্দেশাবলী এবং নির্দেশিকা...'}
                            />
                          </div>
                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Application' : 'আবেদন'} {language === 'en' ? '(Bangla)' : '(বাংলা)'}</label>
                            <textarea
                              rows={4}
                              value={productForm.applicationBn}
                              onChange={(e) => setProductForm({ ...productForm, applicationBn: e.target.value })}
                              placeholder={language === 'en' ? 'Application instructions in Bangla (optional)' : 'বাংলায় আবেদনের নির্দেশাবলী (ঐচ্ছিক)'}
                            />
                          </div>
                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Safety' : 'নিরাপত্তা'} {language === 'en' ? '(English)' : '(ইংরেজি)'}</label>
                            <textarea
                              rows={4}
                              value={productForm.safety}
                              onChange={(e) => setProductForm({ ...productForm, safety: e.target.value })}
                              placeholder={language === 'en' ? 'Safety precautions and guidelines...' : 'নিরাপত্তা সতর্কতা এবং নির্দেশিকা...'}
                            />
                          </div>
                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Safety' : 'নিরাপত্তা'} {language === 'en' ? '(Bangla)' : '(বাংলা)'}</label>
                            <textarea
                              rows={4}
                              value={productForm.safetyBn}
                              onChange={(e) => setProductForm({ ...productForm, safetyBn: e.target.value })}
                              placeholder={language === 'en' ? 'Safety precautions in Bangla (optional)' : 'বাংলায় নিরাপত্তা সতর্কতা (ঐচ্ছিক)'}
                            />
                          </div>
                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Image' : 'ছবি'}</label>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                              <input
                                type="text"
                                value={productForm.image}
                                onChange={(e) => setProductForm({ ...productForm, image: e.target.value })}
                                placeholder="https://... (optional)"
                              />
                              <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'center', flexWrap: 'wrap' }}>
                                <label
                                  style={{
                                    display: 'inline-flex',
                                    alignItems: 'center',
                                    gap: '0.35rem',
                                    padding: '0.5rem 0.75rem',
                                    border: '1px dashed #cbd5e1',
                                    borderRadius: '0.375rem',
                                    background: '#f8fafc',
                                    color: '#0f172a',
                                    cursor: 'pointer',
                                    fontWeight: 600
                                  }}
                                >
                                  <input
                                    type="file"
                                    accept="image/*"
                                    style={{ display: 'none' }}
                                    onChange={async (e) => {
                                      const file = e.target.files?.[0]
                                      if (!file) return
                                      try {
                                        const base64 = await fileToBase64(file)
                                        setProductForm((prev) => ({ ...prev, image: base64 }))
                                        setProductStatus('')
                                      } catch (err) {
                                        console.error('Product image upload failed', err)
                                        setProductStatus(language === 'en' ? 'Image upload failed' : 'ছবি আপলোড ব্যর্থ')
                                      }
                                    }}
                                  />
                                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                    <polyline points="17 8 12 3 7 8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                    <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                  </svg>
                                  {language === 'en' ? 'Upload image' : 'ছবি আপলোড করুন'}
                                </label>
                                {productForm.image && (
                                  <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                    <img
                                      src={productForm.image}
                                      alt="Product preview"
                                      style={{ width: 72, height: 72, objectFit: 'cover', borderRadius: '0.5rem', border: '1px solid #e2e8f0' }}
                                      onError={(e) => { e.target.style.display = 'none' }}
                                    />
                                    <button
                                      type="button"
                                      onClick={() => setProductForm((prev) => ({ ...prev, image: '' }))}
                                      style={{
                                        padding: '0.4rem 0.65rem',
                                        background: '#fee2e2',
                                        color: '#b91c1c',
                                        border: '1px solid #fecaca',
                                        borderRadius: '0.375rem',
                                        fontWeight: 600,
                                        cursor: 'pointer'
                                      }}
                                    >
                                      {language === 'en' ? 'Remove' : 'মুছুন'}
                                    </button>
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        </div>
                        <div className="admin-product-form-actions" style={{ display: 'flex', gap: '0.75rem', marginTop: '1rem' }}>
                          <button
                            type="submit"
                            disabled={savingProduct}
                            style={{
                              padding: '0.65rem 1.2rem',
                              backgroundColor: '#16a34a',
                              color: 'white',
                              border: 'none',
                              borderRadius: '0.375rem',
                              fontWeight: 700,
                              cursor: savingProduct ? 'not-allowed' : 'pointer'
                            }}
                          >
                            {savingProduct
                              ? (language === 'en' ? 'Saving...' : 'সংরক্ষণ হচ্ছে...')
                              : adminContent.save}
                          </button>
                          <button
                            type="button"
                            onClick={() => {
                              resetProductForm()
                              setShowProductForm(false)
                              setProductStatus('')
                            }}
                            style={{
                              padding: '0.65rem 1.2rem',
                              backgroundColor: '#e5e7eb',
                              color: '#0f172a',
                              border: '1px solid #cbd5e1',
                              borderRadius: '0.375rem',
                              fontWeight: 700,
                              cursor: 'pointer'
                            }}
                          >
                            {adminContent.cancel}
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              )}
              {loadingProducts ? (
                <LoadingSpinner text={language === 'en' ? 'Loading Products...' : 'পণ্য লোড হচ্ছে...'} />
              ) : (
                <>
                  <div className="admin-search-bar" style={{ marginBottom: '1rem' }}>
                    <input
                      type="text"
                      placeholder={adminContent.search}
                      value={productSearch}
                      onChange={(e) => setProductSearch(e.target.value)}
                    />
                  </div>
                  <div className="admin-table-container">
                    <table className="admin-table">
                      <thead>
                        <tr>
                          <th
                            onClick={() => {
                              const direction = productSortConfig.key === 'productId' && productSortConfig.direction === 'asc' ? 'desc' : 'asc'
                              setProductSortConfig({ key: 'productId', direction })
                            }}
                            style={{ cursor: 'pointer', userSelect: 'none' }}
                          >
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem' }}>
                              {language === 'en' ? 'Product ID' : 'পণ্য আইডি'}
                              {productSortConfig.key === 'productId' && (
                                <span>{productSortConfig.direction === 'asc' ? '↑' : '↓'}</span>
                              )}
                            </div>
                          </th>
                          <th
                            onClick={() => {
                              const direction = productSortConfig.key === 'name' && productSortConfig.direction === 'asc' ? 'desc' : 'asc'
                              setProductSortConfig({ key: 'name', direction })
                            }}
                            style={{ cursor: 'pointer', userSelect: 'none' }}
                          >
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem' }}>
                              {adminContent.productName}
                              {productSortConfig.key === 'name' && (
                                <span>{productSortConfig.direction === 'asc' ? '↑' : '↓'}</span>
                              )}
                            </div>
                          </th>
                          <th
                            onClick={() => {
                              const direction = productSortConfig.key === 'category' && productSortConfig.direction === 'asc' ? 'desc' : 'asc'
                              setProductSortConfig({ key: 'category', direction })
                            }}
                            style={{ cursor: 'pointer', userSelect: 'none' }}
                          >
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem' }}>
                              {adminContent.category}
                              {productSortConfig.key === 'category' && (
                                <span>{productSortConfig.direction === 'asc' ? '↑' : '↓'}</span>
                              )}
                            </div>
                          </th>
                          <th
                            onClick={() => {
                              const direction = productSortConfig.key === 'price' && productSortConfig.direction === 'asc' ? 'desc' : 'asc'
                              setProductSortConfig({ key: 'price', direction })
                            }}
                            style={{ cursor: 'pointer', userSelect: 'none' }}
                          >
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem' }}>
                              {language === 'en' ? 'Price' : 'মূল্য'}
                              {productSortConfig.key === 'price' && (
                                <span>{productSortConfig.direction === 'asc' ? '↑' : '↓'}</span>
                              )}
                            </div>
                          </th>
                          <th>{language === 'en' ? 'Actions' : 'কার্যক্রম'}</th>
                        </tr>
                      </thead>
                      <tbody>
                        {filteredProducts.length ? filteredProducts.map((product, index) => {
                          const hasVariants = product.priceCategory === 'per_variant' && Array.isArray(product.variants) && product.variants.length > 0
                          const displayPrice = hasVariants ? null : (product.price || 0)

                          return (
                            <tr key={product._id || product.name || index}>
                              <td>{product.productId || '-'}</td>
                              <td>{product.name}</td>
                              <td>{product.category}</td>
                              <td>
                                {hasVariants ? (
                                  <select
                                    style={{
                                      padding: '0.4rem 0.6rem',
                                      border: '1px solid #cbd5e1',
                                      borderRadius: '0.375rem',
                                      fontSize: '0.875rem',
                                      backgroundColor: 'white',
                                      cursor: 'pointer',
                                      width: '100%',
                                      minWidth: '150px'
                                    }}
                                    onChange={(e) => {
                                      // Purely for viewing
                                      e.target.blur()
                                    }}
                                  >
                                    <option value="">{language === 'en' ? 'Select variant' : 'ভ্যারিয়েন্ট নির্বাচন করুন'}</option>
                                    {product.variants.map((variant, vIndex) => (
                                      <option key={vIndex} value={variant.productCode}>
                                        {variant.productCode} ({variant.packSize} {variant.packUnit || 'ml'} x {variant.cartoonSize} {variant.cartoonUnit || 'Pcs'}): ৳{variant.price || 0}
                                      </option>
                                    ))}
                                  </select>
                                ) : (
                                  <span style={{ fontWeight: 600, color: '#16a34a' }}>
                                    ৳{Math.round(displayPrice)}
                                  </span>
                                )}
                              </td>
                              <td>
                                <div className="admin-action-buttons">
                                  <button
                                    className="admin-action-btn edit"
                                    style={{ backgroundColor: '#e0e7ff', color: '#1d4ed8' }}
                                    onClick={() => setViewingProduct(product)}
                                  >
                                    {language === 'en' ? 'View' : 'দেখুন'}
                                  </button>
                                </div>
                              </td>
                            </tr>
                          )
                        }) : (
                          <tr>
                            <td colSpan="5" style={{ textAlign: 'center', padding: '1.5rem' }}>
                              {adminContent.noData}
                            </td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>

                  {/* Mobile Card View for Products */}
                  <div className="mobile-card-container">
                    {filteredProducts.length === 0 ? (
                      <div style={{ textAlign: 'center', padding: '2rem', color: '#6b7280' }}>
                        {adminContent.noData}
                      </div>
                    ) : (
                      filteredProducts.map((product, index) => {
                        const hasVariants = product.priceCategory === 'per_variant' && Array.isArray(product.variants) && product.variants.length > 0
                        const displayPrice = hasVariants ? null : (product.price || 0)

                        return (
                          <div className="mobile-card" key={product._id || product.name || index}>
                            <div
                              className="mobile-card-header"
                              onClick={() => setExpandedProductId(prev => (prev === product._id ? null : product._id))}
                              style={{ cursor: 'pointer' }}
                            >
                              <div className="mobile-card-avatar" style={{ backgroundColor: '#e0f2fe', color: '#0369a1', overflow: 'hidden' }}>
                                {product.image ? (
                                  <img src={product.image} alt={product.name} style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                                ) : (
                                  product.name.charAt(0).toUpperCase()
                                )}
                              </div>
                              <div className="mobile-card-header-text">
                                <div className="mobile-card-title">{product.name}</div>
                                <div className="mobile-card-subtitle">{product.productId || ''}</div>
                              </div>

                              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', marginLeft: 'auto', alignSelf: 'center', justifyContent: 'center', flexShrink: 0 }}>
                                <div style={{ fontSize: '0.9rem', fontWeight: 700, color: '#475569', marginTop: 'auto' }}>
                                  {hasVariants ? (
                                    <span>
                                      {language === 'en' ? '৳' : '৳'}
                                      {Math.min(...product.variants.map(v => parseFloat(v.price) || 0)).toLocaleString()}+
                                    </span>
                                  ) : (
                                    <span>{language === 'en' ? '৳' : '৳'} {(product.price || 0).toLocaleString()}</span>
                                  )}
                                </div>
                              </div>
                            </div>

                            {expandedProductId === product._id && (
                              <>
                                <div className="mobile-card-body">
                                  <div className="mobile-card-row">
                                    <span className="mobile-card-label">{adminContent.category}</span>
                                    <span className="mobile-card-value">{product.category}</span>
                                  </div>
                                  <div className="mobile-card-row">
                                    <span className="mobile-card-label">{language === 'en' ? 'Price details' : 'মূল্যের বিবরণ'}</span>
                                    <span className="mobile-card-value">
                                      {hasVariants ? (
                                        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', width: '100%' }}>
                                          <div style={{ textAlign: 'left', width: '100%' }}>
                                            {product.variants.map((variant, vIndex) => (
                                              <div key={vIndex} style={{ fontSize: '0.85rem', marginBottom: '0.35rem', color: '#475569' }}>
                                                <span style={{ fontWeight: 700 }}>{variant.productCode}</span>: ({variant.packSize} {variant.packUnit || 'ml'} x {variant.cartoonSize} {variant.cartoonUnit || 'Pcs'}): <span style={{ fontWeight: 700, color: '#16a34a' }}>৳{variant.price}</span>
                                              </div>
                                            ))}
                                          </div>
                                        </div>
                                      ) : (
                                        <span style={{ fontWeight: 600, color: '#16a34a' }}>
                                          {language === 'en' ? 'Fixed Price: ' : 'নির্দিষ্ট মূল্য: '}
                                          ৳{Math.round(displayPrice)}
                                        </span>
                                      )}
                                    </span>
                                  </div>

                                  {product.hasOffer && product.buyQuantity && product.freeQuantity && (
                                    <div className="mobile-card-row">
                                      <span className="mobile-card-label">{language === 'en' ? 'Offer' : 'অফার'}</span>
                                      <span className="mobile-card-value" style={{ color: '#ea580c', fontWeight: 600 }}>
                                        {language === 'en'
                                          ? `Buy ${product.buyQuantity} Get ${product.freeQuantity} Free`
                                          : `${product.buyQuantity}টি কিনলে ${product.freeQuantity}টি ফ্রি`}
                                      </span>
                                    </div>
                                  )}
                                </div>
                                <div className="mobile-card-actions">
                                  <button
                                    className="mobile-action-btn"
                                    onClick={(e) => {
                                      e.stopPropagation()
                                      setViewingProduct(product)
                                    }}
                                  >
                                    {language === 'en' ? 'View Details' : 'বিস্তারিত দেখুন'}
                                  </button>
                                  <button
                                    className="mobile-action-btn edit"
                                    onClick={(e) => {
                                      e.stopPropagation()
                                      handleEditProduct(product)
                                    }}
                                    style={{ backgroundColor: '#e0e7ff', color: '#1d4ed8', marginLeft: '0.5rem' }}
                                  >
                                    {language === 'en' ? 'Edit' : 'সম্পাদনা'}
                                  </button>
                                  <button
                                    className="mobile-action-btn delete"
                                    onClick={(e) => {
                                      e.stopPropagation()
                                      handleDeleteProduct(product._id)
                                    }}
                                    style={{ backgroundColor: '#fee2e2', color: '#dc2626', marginLeft: '0.5rem' }}
                                  >
                                    {language === 'en' ? 'Delete' : 'মুছুন'}
                                  </button>
                                </div>
                              </>
                            )}
                          </div>
                        )
                      })
                    )}
                  </div>
                </>
              )}

              {/* Product Details Card */}
              {viewingProduct && (
                <div className="admin-product-view-overlay" style={{
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  backgroundColor: 'rgba(0, 0, 0, 0.5)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 1000,
                  padding: '1rem'
                }} onClick={() => setViewingProduct(null)}>
                  <div className="admin-product-view-modal" style={{
                    position: 'relative',
                    background: 'linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%)',
                    borderRadius: '0.75rem',
                    padding: '2rem',
                    maxWidth: '900px',
                    width: '100%',
                    maxHeight: '90vh',
                    overflowY: 'auto',
                    boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)'
                  }} onClick={(e) => e.stopPropagation()}>
                    <div style={{
                      position: 'absolute',
                      inset: 0,
                      pointerEvents: 'none',
                      overflow: 'hidden',
                      borderRadius: '0.75rem'
                    }}>
                      <div style={{
                        position: 'absolute',
                        width: '260px',
                        height: '260px',
                        top: '-120px',
                        left: '-80px',
                        background: 'radial-gradient(circle at 30% 30%, rgba(59,130,246,0.25), transparent 60%)',
                        filter: 'blur(20px)'
                      }} />
                      <div style={{
                        position: 'absolute',
                        width: '240px',
                        height: '240px',
                        bottom: '-140px',
                        right: '-100px',
                        background: 'radial-gradient(circle at 70% 70%, rgba(16,185,129,0.22), transparent 60%)',
                        filter: 'blur(20px)'
                      }} />
                    </div>

                    <div className="admin-product-view-header" style={{ position: 'relative', display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', gap: '1rem' }}>
                      <div>
                        <h2 style={{ margin: 0, fontSize: '1.5rem', fontWeight: 800, color: '#0f172a' }}>
                          {language === 'en' ? 'Product Details' : 'পণ্যের বিবরণ'}
                        </h2>
                        <p style={{ margin: '0.25rem 0 0 0', color: '#475569', fontWeight: 600 }}>
                          {viewingProduct.productId || viewingProduct.name || 'N/A'}
                        </p>
                      </div>
                      <button
                        onClick={() => setViewingProduct(null)}
                        style={{
                          background: '#e2e8f0',
                          border: 'none',
                          padding: '0.4rem 0.65rem',
                          borderRadius: '0.375rem',
                          cursor: 'pointer',
                          fontWeight: 700,
                          color: '#475569'
                        }}
                      >
                        ×
                      </button>
                    </div>

                    <div className="admin-product-details-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1rem', position: 'relative', zIndex: 1 }}>
                      {/* Product ID */}
                      <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                        <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                          {language === 'en' ? 'Product ID' : 'পণ্য আইডি'}
                        </label>
                        <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', fontWeight: 600, color: '#111827' }}>
                          {viewingProduct.productId || 'N/A'}
                        </p>
                      </div>

                      {/* Product Name */}
                      <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                        <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                          {language === 'en' ? 'Product Name' : 'পণ্যের নাম'}
                        </label>
                        <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                          {viewingProduct.name || 'N/A'}
                        </p>
                      </div>

                      {/* Category */}
                      <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                        <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                          {language === 'en' ? 'Category' : 'বিভাগ'}
                        </label>
                        <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                          {viewingProduct.category || 'N/A'}
                        </p>
                      </div>

                      {/* Price Category */}
                      <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                        <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                          {language === 'en' ? 'Price Category' : 'মূল্যের বিভাগ'}
                        </label>
                        <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                          {viewingProduct.priceCategory === 'per_variant' ? (language === 'en' ? 'Per Variant' : 'প্রতি ভ্যারিয়েন্ট') : (language === 'en' ? 'Single Price' : 'একক মূল্য')}
                        </p>
                      </div>

                      {/* Price */}
                      {viewingProduct.priceCategory === 'single' && (
                        <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                          <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                            {language === 'en' ? 'Price' : 'মূল্য'}
                          </label>
                          <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', fontWeight: 600, color: '#16a34a' }}>
                            ৳{Math.round(parseFloat(viewingProduct.price || 0))}
                          </p>
                        </div>
                      )}

                      {/* Offer */}
                      {viewingProduct.hasOffer && viewingProduct.buyQuantity && viewingProduct.freeQuantity && (
                        <div style={{ padding: '1rem', backgroundColor: '#fef3c7', borderRadius: '0.375rem', border: '1px solid #fbbf24' }}>
                          <label style={{ fontSize: '0.875rem', color: '#92400e', fontWeight: 600 }}>
                            {language === 'en' ? 'Special Offer' : 'বিশেষ অফার'}
                          </label>
                          <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', fontWeight: 700, color: '#78350f' }}>
                            {language === 'en'
                              ? `Buy ${viewingProduct.buyQuantity} units, get ${viewingProduct.freeQuantity} unit(s) free`
                              : `${viewingProduct.buyQuantity} ইউনিট ক্রয় করলে ${viewingProduct.freeQuantity} ইউনিট ফ্রি`}
                          </p>
                        </div>
                      )}

                      {/* Generic Name */}
                      {(viewingProduct.genericName || viewingProduct.genericNameBn) && (
                        <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                          <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                            {language === 'en' ? 'Generic Name' : 'জেনেরিক নাম'}
                          </label>
                          <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                            {language === 'en' ? (viewingProduct.genericName || 'N/A') : (viewingProduct.genericNameBn || viewingProduct.genericName || 'N/A')}
                          </p>
                        </div>
                      )}

                      {/* Description */}
                      {(viewingProduct.description || viewingProduct.descriptionBn) && (
                        <div className="admin-product-detail-full-width" style={{ gridColumn: '1 / -1', padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                          <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                            {language === 'en' ? 'Description' : 'বিবরণ'}
                          </label>
                          <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827', whiteSpace: 'pre-wrap' }}>
                            {language === 'en' ? (viewingProduct.description || 'N/A') : (viewingProduct.descriptionBn || viewingProduct.description || 'N/A')}
                          </p>
                        </div>
                      )}

                      {/* Variants Table (if per_variant) */}
                      {viewingProduct.priceCategory === 'per_variant' && viewingProduct.variants && Array.isArray(viewingProduct.variants) && viewingProduct.variants.length > 0 && (
                        <div className="admin-product-detail-full-width admin-product-variants-table-container" style={{ gridColumn: '1 / -1', padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                          <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600, marginBottom: '0.75rem', display: 'block' }}>
                            {language === 'en' ? 'Variants' : 'ভ্যারিয়েন্ট'}
                          </label>
                          <div className="admin-table-container" style={{ border: '1px solid #e5e7eb', borderRadius: '0.5rem', overflow: 'hidden', backgroundColor: '#fff' }}>
                            <table className="admin-table" style={{ width: '100%', borderCollapse: 'collapse' }}>
                              <thead>
                                <tr style={{ backgroundColor: '#f9fafb', borderBottom: '2px solid #e5e7eb' }}>
                                  <th style={{ padding: '0.75rem', textAlign: 'left', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                    {language === 'en' ? 'Code' : 'কোড'}
                                  </th>
                                  <th style={{ padding: '0.75rem', textAlign: 'left', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                    {language === 'en' ? 'Pack Size' : 'প্যাক সাইজ'}
                                  </th>
                                  <th style={{ padding: '0.75rem', textAlign: 'center', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                    {language === 'en' ? 'CTN Size' : 'কার্টুন সাইজ'}
                                  </th>
                                  <th style={{ padding: '0.75rem', textAlign: 'right', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                    {language === 'en' ? 'CTN Price' : 'কার্টুন মূল্য'}
                                  </th>
                                  <th style={{ padding: '0.75rem', textAlign: 'right', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                    {language === 'en' ? 'Unit Price' : 'ইউনিট মূল্য'}
                                  </th>
                                </tr>
                              </thead>
                              <tbody>
                                {viewingProduct.variants.map((variant, idx) => (
                                  <tr key={idx} style={{ borderBottom: '1px solid #f3f4f6' }}>
                                    <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#111827' }}>
                                      {variant.productCode || '-'}
                                    </td>
                                    <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#111827' }}>
                                      {variant.packSize || '-'} {variant.packUnit || 'ml'}
                                    </td>
                                    <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#111827', textAlign: 'center' }}>
                                      {variant.cartoonSize || 1} {variant.cartoonUnit || 'Pcs'}
                                    </td>
                                    <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#111827', fontWeight: 600, textAlign: 'right' }}>
                                      ৳{Math.round(parseFloat(variant.price || 0))}
                                    </td>
                                    <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#16a34a', fontWeight: 600, textAlign: 'right' }}>
                                      ৳{Math.round(((variant.price || 0) / (variant.cartoonSize || 1)))}
                                    </td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>

                          {/* Mobile View for Variants */}
                          <div className="mobile-card-container">
                            {viewingProduct.variants.map((variant, idx) => (
                              <div key={idx} className="mobile-card" style={{ padding: '1rem', border: '1px solid #e2e8f0' }}>
                                <div className="mobile-card-row">
                                  <span className="mobile-card-label" style={{ fontWeight: 600 }}>{language === 'en' ? 'Code' : 'কোড'}</span>
                                  <span className="mobile-card-value">{variant.productCode || '-'}</span>
                                </div>
                                <div className="mobile-card-row">
                                  <span className="mobile-card-label">{language === 'en' ? 'Pack Size' : 'প্যাক সাইজ'}</span>
                                  <span className="mobile-card-value">{variant.packSize || '-'} {variant.packUnit || 'ml'}</span>
                                </div>
                                <div className="mobile-card-row">
                                  <span className="mobile-card-label">{language === 'en' ? 'CTN Size' : 'কার্টুন সাইজ'}</span>
                                  <span className="mobile-card-value">{variant.cartoonSize || 1} {variant.cartoonUnit || 'Pcs'}</span>
                                </div>
                                <div className="mobile-card-row">
                                  <span className="mobile-card-label">{language === 'en' ? 'CTN Price' : 'কার্টুন মূল্য'}</span>
                                  <span className="mobile-card-value" style={{ fontWeight: 700, color: '#111827' }}>৳{Math.round(parseFloat(variant.price || 0))}</span>
                                </div>
                                <div className="mobile-card-row">
                                  <span className="mobile-card-label">{language === 'en' ? 'Unit Price' : 'ইউনিট মূল্য'}</span>
                                  <span className="mobile-card-value" style={{ fontWeight: 700, color: '#16a34a' }}>৳{Math.round(((variant.price || 0) / (variant.cartoonSize || 1)))}</span>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Product Image */}
                      {viewingProduct.image && (
                        <div className="admin-product-detail-full-width" style={{ gridColumn: '1 / -1', padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                          <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600, marginBottom: '0.75rem', display: 'block' }}>
                            {language === 'en' ? 'Product Image' : 'পণ্যের ছবি'}
                          </label>
                          <img
                            src={viewingProduct.image}
                            alt={viewingProduct.name}
                            style={{
                              maxWidth: '100%',
                              maxHeight: '300px',
                              borderRadius: '0.5rem',
                              border: '2px solid #e5e7eb'
                            }}
                            onError={(e) => {
                              e.target.style.display = 'none'
                            }}
                          />
                        </div>
                      )}
                    </div>

                    {/* Action Buttons */}
                    <div style={{ position: 'relative', display: 'flex', gap: '0.75rem', marginTop: '1.5rem', zIndex: 1 }}>
                      {(userRole || '').toLowerCase() === 'admin' && (
                        <>
                          <button
                            onClick={() => {
                              handleEditProduct(viewingProduct)
                              setViewingProduct(null)
                            }}
                            style={{
                              padding: '0.5rem 1.5rem',
                              backgroundColor: '#3b82f6',
                              color: 'white',
                              border: 'none',
                              borderRadius: '0.5rem',
                              cursor: 'pointer',
                              fontWeight: 700,
                              boxShadow: '0 10px 20px rgba(59,130,246,0.35)'
                            }}
                          >
                            {adminContent.edit}
                          </button>
                          {viewingProduct._id && (
                            <button
                              onClick={async () => {
                                if (window.confirm(language === 'en' ? 'Are you sure you want to delete this product?' : 'আপনি কি এই পণ্যটি মুছতে চান?')) {
                                  await handleDeleteProduct(viewingProduct._id)
                                  setViewingProduct(null)
                                }
                              }}
                              style={{
                                padding: '0.5rem 1.5rem',
                                backgroundColor: '#ef4444',
                                color: 'white',
                                border: 'none',
                                borderRadius: '0.5rem',
                                cursor: 'pointer',
                                fontWeight: 700,
                                boxShadow: '0 10px 20px rgba(239,68,68,0.35)'
                              }}
                            >
                              {adminContent.delete}
                            </button>
                          )}
                        </>
                      )}
                      <button
                        onClick={() => setViewingProduct(null)}
                        style={{
                          padding: '0.5rem 1.5rem',
                          backgroundColor: '#6b7280',
                          color: 'white',
                          border: 'none',
                          borderRadius: '0.5rem',
                          cursor: 'pointer',
                          fontWeight: 700
                        }}
                      >
                        {language === 'en' ? 'Close' : 'বন্ধ করুন'}
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Blogs Tab */}
          {activeTab === 'blogs' && (
            <div className="admin-tab-content">
              <div className="admin-tab-header">
                <h1 className="admin-page-title">{adminContent.manageBlogs}</h1>
                <button className="admin-add-btn">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                    <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                  </svg>
                  {adminContent.addNew}
                </button>
              </div>
              <div className="admin-table-container">
                <div className="admin-search-bar">
                  <input type="text" placeholder={adminContent.search} />
                </div>
                <table className="admin-table">
                  <thead>
                    <tr>
                      <th>{adminContent.blogTitle}</th>
                      <th>{adminContent.author}</th>
                      <th>{adminContent.date}</th>
                      <th>{language === 'en' ? 'Actions' : 'কার্যক্রম'}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {[...t.blog.featured, ...t.blog.list].map((blog, index) => (
                      <tr key={index}>
                        <td>{blog.title}</td>
                        <td>{blog.author}</td>
                        <td>{blog.date}</td>
                        <td>
                          <div className="admin-action-buttons">
                            <button className="admin-action-btn edit">{adminContent.edit}</button>
                            <button className="admin-action-btn delete">{adminContent.delete}</button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Contacts Tab */}
          {activeTab === 'contacts' && (
            <div className="admin-tab-content">
              <div className="admin-tab-header">
                <h1 className="admin-page-title">{adminContent.viewMessages}</h1>
              </div>
              <div className="admin-table-container">
                <div className="admin-search-bar">
                  <input type="text" placeholder={adminContent.search} />
                </div>
                <table className="admin-table">
                  <thead>
                    <tr>
                      <th>{adminContent.name}</th>
                      <th>{adminContent.email}</th>
                      <th>{adminContent.phone}</th>
                      <th>{adminContent.message}</th>
                      <th>{language === 'en' ? 'Actions' : 'কার্যক্রম'}</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colSpan="5" style={{ textAlign: 'center', padding: '2rem' }}>
                        {adminContent.noData}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Content Management Tab */}
          {activeTab === 'content' && (
            <div className="admin-tab-content">
              <div className="admin-tab-header">
                <h1 className="admin-page-title">{adminContent.contentManagement}</h1>
                <button
                  className={`admin-preview-btn ${showPreview ? 'active' : ''}`}
                  onClick={() => {
                    setShowPreview(!showPreview)
                    if (!showPreview) {
                      // Refresh preview when opening
                      setTimeout(() => {
                        const iframe = document.getElementById('admin-preview-iframe')
                        if (iframe) {
                          iframe.src = previewUrl
                        }
                      }, 100)
                    }
                  }}
                >
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                    <circle cx="12" cy="12" r="3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                  </svg>
                  {showPreview ? adminContent.closePreview : adminContent.livePreview}
                </button>
              </div>

              {showPreview ? (
                <div className="admin-preview-container">
                  <div className="admin-preview-header">
                    <div className="admin-preview-controls">
                      <button
                        className={`admin-preview-nav-btn ${editMode ? 'active' : ''}`}
                        onClick={() => setEditMode(!editMode)}
                        style={{ background: editMode ? '#22c55e' : '#334155' }}
                      >
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style={{ width: '16px', height: '16px', marginRight: '0.5rem' }}>
                          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                        </svg>
                        {editMode ? adminContent.disableEdit : adminContent.enableEdit}
                      </button>
                      <button
                        className="admin-preview-nav-btn"
                        onClick={() => { setPreviewUrl('/'); refreshPreview() }}
                      >
                        {language === 'en' ? 'Home' : 'হোম'}
                      </button>
                      <button
                        className="admin-preview-nav-btn"
                        onClick={() => { setPreviewUrl('/about'); refreshPreview() }}
                      >
                        {language === 'en' ? 'About' : 'আমাদের সম্পর্কে'}
                      </button>
                      <button
                        className="admin-preview-nav-btn"
                        onClick={() => { setPreviewUrl('/product'); refreshPreview() }}
                      >
                        {language === 'en' ? 'Products' : 'পণ্য'}
                      </button>
                      <button
                        className="admin-preview-nav-btn"
                        onClick={() => { setPreviewUrl('/contact'); refreshPreview() }}
                      >
                        {language === 'en' ? 'Contact' : 'যোগাযোগ'}
                      </button>
                    </div>
                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                      <button
                        className="admin-preview-refresh-btn"
                        onClick={refreshPreview}
                        title={language === 'en' ? 'Refresh Preview' : 'প্রিভিউ রিফ্রেশ করুন'}
                      >
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M23 4v6h-6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          <path d="M1 20v-6h6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                        </svg>
                      </button>
                      <button
                        className="admin-preview-refresh-btn"
                        onClick={() => window.open(previewUrl, '_blank')}
                        title={language === 'en' ? 'Open in New Tab' : 'নতুন ট্যাবে খুলুন'}
                        style={{ background: '#10b981' }}
                      >
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          <polyline points="15 3 21 3 21 9" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          <line x1="10" y1="14" x2="21" y2="3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  <iframe
                    id="admin-preview-iframe"
                    src={previewUrl}
                    className="admin-preview-iframe"
                    title="Live Preview"
                  />
                </div>
              ) : null}

              {/* Photo Management Section */}
              <div className="admin-content-section">
                <div className="admin-content-header" style={{
                  background: '#ffffff',
                  borderBottom: '1px solid #e5e7eb',
                  padding: '1.5rem 0',
                  marginBottom: '1.5rem'
                }}>
                  <h2 style={{
                    margin: 0,
                    fontSize: '1.5rem',
                    fontWeight: 600,
                    color: '#111827',
                    letterSpacing: '-0.01em'
                  }}>
                    {language === 'en' ? 'Photo Management' : 'ছবি ব্যবস্থাপনা'}
                  </h2>
                  <p style={{
                    margin: '0.5rem 0 0 0',
                    color: '#6b7280',
                    fontSize: '0.875rem'
                  }}>
                    {language === 'en'
                      ? 'Manage all images and videos across your website'
                      : 'আপনার ওয়েবসাইটের সমস্ত ছবি এবং ভিডিও পরিচালনা করুন'}
                  </p>
                </div>

                <div className="admin-photo-management">
                  {/* Home Page Hero Section */}
                  <div className="admin-photo-group" style={{ gridColumn: '1 / -1' }}>
                    <h3 style={{ '--emoji': '"🏠"' }}>{language === 'en' ? 'Home Page Hero' : 'হোম পেজ হিরো'}</h3>

                    {/* Home Page Hero Slider */}
                    <div className="admin-photo-item">
                      <label>{language === 'en' ? 'Home Page Hero Slider' : 'হোম পেজ হিরো স্লাইডার'}</label>

                      {/* Media Type Toggle */}
                      <div style={{ marginBottom: '1.5rem', display: 'flex', gap: '1rem', alignItems: 'center' }}>
                        <label style={{ fontWeight: 600, fontSize: '0.95rem' }}>
                          {language === 'en' ? 'Display Type:' : 'প্রদর্শনের ধরন:'}
                        </label>
                        <div style={{ display: 'flex', gap: '0.5rem' }}>
                          <button
                            type="button"
                            onClick={() => handleHeroMediaTypeChange('photos')}
                            style={{
                              background: (pageImages.homeHeroMediaType || 'photos') === 'photos' ? '#22c55e' : '#e2e8f0',
                              color: (pageImages.homeHeroMediaType || 'photos') === 'photos' ? 'white' : '#64748b',
                              border: 'none',
                              padding: '0.75rem 1.5rem',
                              borderRadius: '8px',
                              cursor: 'pointer',
                              fontSize: '0.95rem',
                              fontWeight: 600,
                              display: 'flex',
                              alignItems: 'center',
                              gap: '0.5rem',
                              transition: 'all 0.2s ease',
                              boxShadow: (pageImages.homeHeroMediaType || 'photos') === 'photos' ? '0 2px 8px rgba(34, 197, 94, 0.3)' : 'none'
                            }}
                          >
                            {(pageImages.homeHeroMediaType || 'photos') === 'photos' && (
                              <span style={{ fontSize: '1.2rem' }}>✓</span>
                            )}
                            {language === 'en' ? 'Photos' : 'ছবি'}
                          </button>
                          <button
                            type="button"
                            onClick={() => handleHeroMediaTypeChange('video')}
                            style={{
                              background: (pageImages.homeHeroMediaType || 'photos') === 'video' ? '#22c55e' : '#e2e8f0',
                              color: (pageImages.homeHeroMediaType || 'photos') === 'video' ? 'white' : '#64748b',
                              border: 'none',
                              padding: '0.75rem 1.5rem',
                              borderRadius: '8px',
                              cursor: 'pointer',
                              fontSize: '0.95rem',
                              fontWeight: 600,
                              display: 'flex',
                              alignItems: 'center',
                              gap: '0.5rem',
                              transition: 'all 0.2s ease',
                              boxShadow: (pageImages.homeHeroMediaType || 'photos') === 'video' ? '0 2px 8px rgba(34, 197, 94, 0.3)' : 'none'
                            }}
                          >
                            {(pageImages.homeHeroMediaType || 'photos') === 'video' && (
                              <span style={{ fontSize: '1.2rem' }}>✓</span>
                            )}
                            {language === 'en' ? 'Video' : 'ভিডিও'}
                          </button>
                        </div>
                      </div>

                      {/* Hero Video */}
                      <div style={{
                        marginBottom: '2rem',
                        padding: '1rem',
                        background: (pageImages.homeHeroMediaType || 'photos') === 'video' ? '#dcfce7' : '#f1f5f9',
                        borderRadius: '8px',
                        border: (pageImages.homeHeroMediaType || 'photos') === 'video' ? '2px solid #22c55e' : '1px solid #e2e8f0'
                      }}>
                        <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem', fontWeight: 600 }}>
                          {language === 'en' ? 'Hero Video' : 'হিরো ভিডিও'}
                          {(pageImages.homeHeroMediaType || 'photos') === 'video' && (
                            <span style={{
                              background: '#22c55e',
                              color: 'white',
                              padding: '0.2rem 0.5rem',
                              borderRadius: '4px',
                              fontSize: '0.75rem',
                              fontWeight: 700
                            }}>
                              {language === 'en' ? 'ACTIVE' : 'সক্রিয়'}
                            </span>
                          )}
                        </label>
                        {pageImages.homeHeroVideo ? (
                          <div style={{ marginBottom: '1rem' }}>
                            <video
                              src={pageImages.homeHeroVideo}
                              controls
                              style={{ width: '100%', maxWidth: '400px', borderRadius: '8px', marginBottom: '0.5rem' }}
                            />
                            <button
                              type="button"
                              onClick={() => handleHeroVideoChange('')}
                              style={{
                                background: '#dc2626',
                                color: 'white',
                                border: 'none',
                                padding: '0.5rem 1rem',
                                borderRadius: '6px',
                                cursor: 'pointer',
                                fontSize: '0.9rem'
                              }}
                            >
                              {language === 'en' ? 'Remove Video' : 'ভিডিও সরান'}
                            </button>
                          </div>
                        ) : null}
                        <div className="admin-image-controls">
                          <label className="admin-upload-btn">
                            {language === 'en' ? 'Upload Video' : 'ভিডিও আপলোড করুন'}
                            <input
                              type="file"
                              accept="video/*"
                              onChange={handleHeroVideoFileChange}
                              style={{ display: 'none' }}
                            />
                          </label>
                          <input
                            type="text"
                            value={pageImages.homeHeroVideo || ''}
                            onChange={(e) => handleHeroVideoChange(e.target.value)}
                            placeholder="Video URL or upload file"
                            className="admin-image-url-input"
                          />
                        </div>
                      </div>

                      {/* Hero Images */}
                      <div style={{
                        padding: '1rem',
                        background: (pageImages.homeHeroMediaType || 'photos') === 'photos' ? '#dcfce7' : '#f1f5f9',
                        borderRadius: '8px',
                        border: (pageImages.homeHeroMediaType || 'photos') === 'photos' ? '2px solid #22c55e' : '1px solid #e2e8f0'
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                          <label style={{ fontWeight: 600, display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                            {language === 'en' ? 'Hero Images (Slider)' : 'হিরো ছবি (স্লাইডার)'}
                            {(pageImages.homeHeroMediaType || 'photos') === 'photos' && (
                              <span style={{
                                background: '#22c55e',
                                color: 'white',
                                padding: '0.2rem 0.5rem',
                                borderRadius: '4px',
                                fontSize: '0.75rem',
                                fontWeight: 700
                              }}>
                                {language === 'en' ? 'ACTIVE' : 'সক্রিয়'}
                              </span>
                            )}
                          </label>
                          <button
                            type="button"
                            onClick={handleAddHeroImage}
                            style={{
                              background: '#22c55e',
                              color: 'white',
                              border: 'none',
                              padding: '0.5rem 1rem',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontSize: '0.9rem',
                              fontWeight: 600
                            }}
                          >
                            {language === 'en' ? '+ Add Image' : '+ ছবি যোগ করুন'}
                          </button>
                        </div>
                        <div className="admin-hero-images-grid">
                          {(pageImages.homeHeroImages || ['/hero-image.jpg']).map((image, index) => (
                            <div key={index} className="admin-photo-card" style={{ marginBottom: 0 }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                                <label style={{ fontWeight: 600 }}>
                                  {language === 'en' ? `Image ${index + 1}` : `ছবি ${index + 1}`}
                                </label>
                                {(pageImages.homeHeroImages || ['/hero-image.jpg']).length > 1 && (
                                  <button
                                    type="button"
                                    onClick={() => handleRemoveHeroImage(index)}
                                    style={{
                                      background: '#dc2626',
                                      color: 'white',
                                      border: 'none',
                                      padding: '0.4rem 0.8rem',
                                      borderRadius: '6px',
                                      cursor: 'pointer',
                                      fontSize: '0.85rem'
                                    }}
                                  >
                                    {language === 'en' ? 'Remove' : 'সরান'}
                                  </button>
                                )}
                              </div>
                              <div className="admin-image-upload">
                                <div className="admin-image-preview">
                                  <img src={image} alt={`Hero ${index + 1}`} />
                                </div>
                                <div className="admin-image-controls">
                                  <label className="admin-upload-btn">
                                    {language === 'en' ? 'Upload Image' : 'ইমেজ আপলোড করুন'}
                                    <input
                                      type="file"
                                      accept="image/*"
                                      onChange={(e) => handleHeroImageFileChange(index, e)}
                                      style={{ display: 'none' }}
                                    />
                                  </label>
                                  <input
                                    type="text"
                                    value={image}
                                    onChange={(e) => handleHeroImageChange(index, e.target.value)}
                                    placeholder="/hero-image.jpg or https://..."
                                    className="admin-image-url-input"
                                  />
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>

                    <div className="admin-hero-images-grid">
                      {/* About Page Hero */}
                      <div className="admin-photo-card" style={{ marginBottom: 0 }}>
                        <label style={{ fontWeight: 600, marginBottom: '0.75rem', fontSize: '0.875rem' }}>
                          {language === 'en' ? 'About Page Hero' : 'আমাদের সম্পর্কে পেজ হিরো'}
                        </label>
                        <div className="admin-image-upload" style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                          <div className="admin-image-preview" style={{ marginBottom: '0.75rem' }}>
                            <img src={pageImages.aboutHero || '/hero-image.jpg'} alt="About hero" />
                          </div>
                          <div className="admin-image-controls" style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                            <label className="admin-upload-btn" style={{ width: '100%', justifyContent: 'center' }}>
                              {language === 'en' ? 'Upload Image' : 'ইমেজ আপলোড করুন'}
                              <input
                                type="file"
                                accept="image/*"
                                onChange={(e) => handleImageFileChange('aboutHero', e)}
                                style={{ display: 'none' }}
                              />
                            </label>
                            <input
                              type="text"
                              value={pageImages.aboutHero || '/hero-image.jpg'}
                              onChange={(e) => handleImageChange('aboutHero', e.target.value)}
                              placeholder="/hero-image.jpg or https://..."
                              className="admin-image-url-input"
                            />
                          </div>
                        </div>
                      </div>

                      {/* Product Page Hero */}
                      <div className="admin-photo-card" style={{ marginBottom: 0 }}>
                        <label style={{ fontWeight: 600, marginBottom: '0.75rem', fontSize: '0.875rem' }}>
                          {language === 'en' ? 'Product Page Hero' : 'পণ্য পেজ হিরো'}
                        </label>
                        <div className="admin-image-upload" style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                          <div className="admin-image-preview" style={{ marginBottom: '0.75rem' }}>
                            <img src={pageImages.productHero || '/hero-image.jpg'} alt="Product hero" />
                          </div>
                          <div className="admin-image-controls" style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                            <label className="admin-upload-btn" style={{ width: '100%', justifyContent: 'center' }}>
                              {language === 'en' ? 'Upload Image' : 'ইমেজ আপলোড করুন'}
                              <input
                                type="file"
                                accept="image/*"
                                onChange={(e) => handleImageFileChange('productHero', e)}
                                style={{ display: 'none' }}
                              />
                            </label>
                            <input
                              type="text"
                              value={pageImages.productHero || '/hero-image.jpg'}
                              onChange={(e) => handleImageChange('productHero', e.target.value)}
                              placeholder="/hero-image.jpg or https://..."
                              className="admin-image-url-input"
                            />
                          </div>
                        </div>
                      </div>

                      {/* Notice Page Hero */}
                      <div className="admin-photo-card" style={{ marginBottom: 0 }}>
                        <label style={{ fontWeight: 600, marginBottom: '0.75rem', fontSize: '0.875rem' }}>
                          {language === 'en' ? 'Notice Page Hero' : 'নোটিশ পেজ হিরো'}
                        </label>
                        <div className="admin-image-upload" style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                          <div className="admin-image-preview" style={{ marginBottom: '0.75rem' }}>
                            <img src={pageImages.noticeHero || '/hero-image.jpg'} alt="Notice hero" />
                          </div>
                          <div className="admin-image-controls" style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                            <label className="admin-upload-btn" style={{ width: '100%', justifyContent: 'center' }}>
                              {language === 'en' ? 'Upload Image' : 'ইমেজ আপলোড করুন'}
                              <input
                                type="file"
                                accept="image/*"
                                onChange={(e) => handleImageFileChange('noticeHero', e)}
                                style={{ display: 'none' }}
                              />
                            </label>
                            <input
                              type="text"
                              value={pageImages.noticeHero || '/hero-image.jpg'}
                              onChange={(e) => handleImageChange('noticeHero', e.target.value)}
                              placeholder="/hero-image.jpg or https://..."
                              className="admin-image-url-input"
                            />
                          </div>
                        </div>
                      </div>

                      {/* Career Page Hero */}
                      <div className="admin-photo-card" style={{ marginBottom: 0 }}>
                        <label style={{ fontWeight: 600, marginBottom: '0.75rem', fontSize: '0.875rem' }}>
                          {language === 'en' ? 'Career Page Hero' : 'ক্যারিয়ার পেজ হিরো'}
                        </label>
                        <div className="admin-image-upload" style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                          <div className="admin-image-preview" style={{ marginBottom: '0.75rem' }}>
                            <img src={pageImages.careerHero || '/hero-image.jpg'} alt="Career hero" />
                          </div>
                          <div className="admin-image-controls" style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                            <label className="admin-upload-btn" style={{ width: '100%', justifyContent: 'center' }}>
                              {language === 'en' ? 'Upload Image' : 'ইমেজ আপলোড করুন'}
                              <input
                                type="file"
                                accept="image/*"
                                onChange={(e) => handleImageFileChange('careerHero', e)}
                                style={{ display: 'none' }}
                              />
                            </label>
                            <input
                              type="text"
                              value={pageImages.careerHero || '/hero-image.jpg'}
                              onChange={(e) => handleImageChange('careerHero', e.target.value)}
                              placeholder="/hero-image.jpg or https://..."
                              className="admin-image-url-input"
                            />
                          </div>
                        </div>
                      </div>

                      {/* Blog Page Hero */}
                      <div className="admin-photo-card" style={{ marginBottom: 0 }}>
                        <label style={{ fontWeight: 600, marginBottom: '0.75rem', fontSize: '0.875rem' }}>
                          {language === 'en' ? 'Blog Page Hero' : 'ব্লগ পেজ হিরো'}
                        </label>
                        <div className="admin-image-upload" style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                          <div className="admin-image-preview" style={{ marginBottom: '0.75rem' }}>
                            <img src={pageImages.blogHero || '/hero-image.jpg'} alt="Blog hero" />
                          </div>
                          <div className="admin-image-controls" style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                            <label className="admin-upload-btn" style={{ width: '100%', justifyContent: 'center' }}>
                              {language === 'en' ? 'Upload Image' : 'ইমেজ আপলোড করুন'}
                              <input
                                type="file"
                                accept="image/*"
                                onChange={(e) => handleImageFileChange('blogHero', e)}
                                style={{ display: 'none' }}
                              />
                            </label>
                            <input
                              type="text"
                              value={pageImages.blogHero || '/hero-image.jpg'}
                              onChange={(e) => handleImageChange('blogHero', e.target.value)}
                              placeholder="/hero-image.jpg or https://..."
                              className="admin-image-url-input"
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* About Section Images */}
                  <div className="admin-hero-images-grid" style={{ gridColumn: '1 / -1', marginTop: '1.5rem' }}>
                    {/* About Section Image 1 (Oval Top) */}
                    <div className="admin-photo-card" style={{ marginBottom: 0 }}>
                      <label style={{ fontWeight: 600, marginBottom: '0.75rem', fontSize: '0.875rem' }}>
                        {language === 'en' ? 'About Section Image 1 (Oval Top)' : 'আমাদের সম্পর্কে ছবি ১ (ওভাল উপরে)'}
                      </label>
                      <div className="admin-image-upload" style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                        <div className="admin-image-preview" style={{ marginBottom: '0.75rem' }}>
                          <img src={pageImages.aboutSectionImage1 || '/hero-image.jpg'} alt="About section 1" />
                        </div>
                        <div className="admin-image-controls" style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                          <label className="admin-upload-btn" style={{ width: '100%', justifyContent: 'center' }}>
                            {language === 'en' ? 'Upload Image' : 'ইমেজ আপলোড করুন'}
                            <input
                              type="file"
                              accept="image/*"
                              onChange={(e) => handleImageFileChange('aboutSectionImage1', e)}
                              style={{ display: 'none' }}
                            />
                          </label>
                          <input
                            type="text"
                            value={pageImages.aboutSectionImage1 || '/hero-image.jpg'}
                            onChange={(e) => handleImageChange('aboutSectionImage1', e.target.value)}
                            placeholder="/hero-image.jpg or https://..."
                            className="admin-image-url-input"
                          />
                        </div>
                      </div>
                    </div>

                    {/* About Section Image 2 (Oval Bottom) */}
                    <div className="admin-photo-card" style={{ marginBottom: 0 }}>
                      <label style={{ fontWeight: 600, marginBottom: '0.75rem', fontSize: '0.875rem' }}>
                        {language === 'en' ? 'About Section Image 2 (Oval Bottom)' : 'আমাদের সম্পর্কে ছবি ২ (ওভাল নিচে)'}
                      </label>
                      <div className="admin-image-upload" style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                        <div className="admin-image-preview" style={{ marginBottom: '0.75rem' }}>
                          <img src={pageImages.aboutSectionImage2 || '/hero-image.jpg'} alt="About section 2" />
                        </div>
                        <div className="admin-image-controls" style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                          <label className="admin-upload-btn" style={{ width: '100%', justifyContent: 'center' }}>
                            {language === 'en' ? 'Upload Image' : 'ইমেজ আপলোড করুন'}
                            <input
                              type="file"
                              accept="image/*"
                              onChange={(e) => handleImageFileChange('aboutSectionImage2', e)}
                              style={{ display: 'none' }}
                            />
                          </label>
                          <input
                            type="text"
                            value={pageImages.aboutSectionImage2 || '/hero-image.jpg'}
                            onChange={(e) => handleImageChange('aboutSectionImage2', e.target.value)}
                            placeholder="/hero-image.jpg or https://..."
                            className="admin-image-url-input"
                          />
                        </div>
                      </div>
                    </div>

                    {/* About Section Image 3 (Circular) */}
                    <div className="admin-photo-card" style={{ marginBottom: 0 }}>
                      <label style={{ fontWeight: 600, marginBottom: '0.75rem', fontSize: '0.875rem' }}>
                        {language === 'en' ? 'About Section Image 3 (Circular)' : 'আমাদের সম্পর্কে ছবি ৩ (বৃত্তাকার)'}
                      </label>
                      <div className="admin-image-upload" style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                        <div className="admin-image-preview" style={{ marginBottom: '0.75rem' }}>
                          <img src={pageImages.aboutSectionImage3 || '/hero-image.jpg'} alt="About section 3" />
                        </div>
                        <div className="admin-image-controls" style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                          <label className="admin-upload-btn" style={{ width: '100%', justifyContent: 'center' }}>
                            {language === 'en' ? 'Upload Image' : 'ইমেজ আপলোড করুন'}
                            <input
                              type="file"
                              accept="image/*"
                              onChange={(e) => handleImageFileChange('aboutSectionImage3', e)}
                              style={{ display: 'none' }}
                            />
                          </label>
                          <input
                            type="text"
                            value={pageImages.aboutSectionImage3 || '/hero-image.jpg'}
                            onChange={(e) => handleImageChange('aboutSectionImage3', e.target.value)}
                            placeholder="/hero-image.jpg or https://..."
                            className="admin-image-url-input"
                          />
                        </div>
                      </div>
                    </div>

                    {/* Vision Image */}
                    <div className="admin-photo-card" style={{ marginBottom: 0 }}>
                      <label style={{ fontWeight: 600, marginBottom: '0.75rem', fontSize: '0.875rem' }}>
                        {language === 'en' ? 'Vision Image' : 'ভিশন ছবি'}
                      </label>
                      <div className="admin-image-upload" style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                        <div className="admin-image-preview" style={{ marginBottom: '0.75rem' }}>
                          <img src={pageImages.visionImage || '/hero-image.jpg'} alt="Vision" />
                        </div>
                        <div className="admin-image-controls" style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                          <label className="admin-upload-btn" style={{ width: '100%', justifyContent: 'center' }}>
                            {language === 'en' ? 'Upload Image' : 'ইমেজ আপলোড করুন'}
                            <input
                              type="file"
                              accept="image/*"
                              onChange={(e) => handleImageFileChange('visionImage', e)}
                              style={{ display: 'none' }}
                            />
                          </label>
                          <input
                            type="text"
                            value={pageImages.visionImage || '/hero-image.jpg'}
                            onChange={(e) => handleImageChange('visionImage', e.target.value)}
                            placeholder="/hero-image.jpg or https://..."
                            className="admin-image-url-input"
                          />
                        </div>
                      </div>
                    </div>

                    {/* Mission Image */}
                    <div className="admin-photo-card" style={{ marginBottom: 0 }}>
                      <label style={{ fontWeight: 600, marginBottom: '0.75rem', fontSize: '0.875rem' }}>
                        {language === 'en' ? 'Mission Image' : 'মিশন ছবি'}
                      </label>
                      <div className="admin-image-upload" style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                        <div className="admin-image-preview" style={{ marginBottom: '0.75rem' }}>
                          <img src={pageImages.missionImage || '/hero-image.jpg'} alt="Mission" />
                        </div>
                        <div className="admin-image-controls" style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                          <label className="admin-upload-btn" style={{ width: '100%', justifyContent: 'center' }}>
                            {language === 'en' ? 'Upload Image' : 'ইমেজ আপলোড করুন'}
                            <input
                              type="file"
                              accept="image/*"
                              onChange={(e) => handleImageFileChange('missionImage', e)}
                              style={{ display: 'none' }}
                            />
                          </label>
                          <input
                            type="text"
                            value={pageImages.missionImage || '/hero-image.jpg'}
                            onChange={(e) => handleImageChange('missionImage', e.target.value)}
                            placeholder="/hero-image.jpg or https://..."
                            className="admin-image-url-input"
                          />
                        </div>
                      </div>
                    </div>

                    {/* About Values Background */}
                    <div className="admin-photo-card" style={{ marginBottom: 0 }}>
                      <label style={{ fontWeight: 600, marginBottom: '0.75rem', fontSize: '0.875rem' }}>
                        {language === 'en' ? 'What We Value Section Background (About Page)' : 'আমরা যা মূল্য দিই সেকশন ব্যাকগ্রাউন্ড (আমাদের সম্পর্কে পেজ)'}
                      </label>
                      <div className="admin-image-upload" style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                        <div className="admin-image-preview" style={{ marginBottom: '0.75rem' }}>
                          <img src={pageImages.aboutValuesBackground || 'https://images.stockcake.com/public/e/6/e/e6e4865c-08b7-4633-b428-f5658462485e_large/farmers-tending-crops-stockcake.jpg'} alt="About values background" />
                        </div>
                        <div className="admin-image-controls" style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                          <label className="admin-upload-btn" style={{ width: '100%', justifyContent: 'center' }}>
                            {language === 'en' ? 'Upload Image' : 'ইমেজ আপলোড করুন'}
                            <input
                              type="file"
                              accept="image/*"
                              onChange={(e) => handleImageFileChange('aboutValuesBackground', e)}
                              style={{ display: 'none' }}
                            />
                          </label>
                          <input
                            type="text"
                            value={pageImages.aboutValuesBackground || 'https://images.stockcake.com/public/e/6/e/e6e4865c-08b7-4633-b428-f5658462485e_large/farmers-tending-crops-stockcake.jpg'}
                            onChange={(e) => handleImageChange('aboutValuesBackground', e.target.value)}
                            placeholder="Image URL or https://..."
                            className="admin-image-url-input"
                          />
                        </div>
                      </div>
                    </div>

                    {/* Career Values Background */}
                    <div className="admin-photo-card" style={{ marginBottom: 0 }}>
                      <label style={{ fontWeight: 600, marginBottom: '0.75rem', fontSize: '0.875rem' }}>
                        {language === 'en' ? 'Why Build Your Career With Us Section Background (Career Page)' : 'কেন আমাদের দলে যোগ দেবেন সেকশন ব্যাকগ্রাউন্ড (ক্যারিয়ার পেজ)'}
                      </label>
                      <div className="admin-image-upload" style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                        <div className="admin-image-preview" style={{ marginBottom: '0.75rem' }}>
                          <img src={pageImages.careerValuesBackground || 'https://images.stockcake.com/public/e/6/e/e6e4865c-08b7-4633-b428-f5658462485e_large/farmers-tending-crops-stockcake.jpg'} alt="Career values background" />
                        </div>
                        <div className="admin-image-controls" style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                          <label className="admin-upload-btn" style={{ width: '100%', justifyContent: 'center' }}>
                            {language === 'en' ? 'Upload Image' : 'ইমেজ আপলোড করুন'}
                            <input
                              type="file"
                              accept="image/*"
                              onChange={(e) => handleImageFileChange('careerValuesBackground', e)}
                              style={{ display: 'none' }}
                            />
                          </label>
                          <input
                            type="text"
                            value={pageImages.careerValuesBackground || 'https://images.stockcake.com/public/e/6/e/e6e4865c-08b7-4633-b428-f5658462485e_large/farmers-tending-crops-stockcake.jpg'}
                            onChange={(e) => handleImageChange('careerValuesBackground', e.target.value)}
                            placeholder="Image URL or https://..."
                            className="admin-image-url-input"
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Profile Tab */}
          {activeTab === 'profile' && (
            <div className="admin-tab-content">
              <div className="admin-tab-header">
                <h1 className="admin-page-title">{adminContent.profile}</h1>
              </div>
              {loadingProfile ? (
                <LoadingSpinner text={language === 'en' ? 'Loading Profile...' : 'প্রোফাইল লোড হচ্ছে...'} />
              ) : (
                <>
                  <div className="admin-settings-section" style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>
                    {/* Profile summary */}
                    <div className="admin-profile-card">
                      <div className="admin-profile-photo-container">
                        {profileData.photo ? (
                          <img src={profileData.photo} alt="Profile" className="admin-profile-large-photo" />
                        ) : (
                          <div className="admin-profile-large-placeholder">
                            {(profileData.name || 'A').charAt(0)}
                          </div>
                        )}
                      </div>
                      <div className="admin-profile-details">
                        <div className="admin-profile-name-section">
                          <div className="admin-profile-name">{profileData.name || 'Admin'}</div>
                          {profileData.designation ? (
                            <div className="admin-profile-designation">{profileData.designation}</div>
                          ) : null}
                        </div>
                        <div className="admin-profile-info-grid">
                          <div className="admin-profile-info-item">
                            <div className="admin-profile-info-label">{language === 'en' ? 'Email' : 'ইমেইল'}</div>
                            <div className="admin-profile-info-value">{profileData.email}</div>
                          </div>
                          <div className="admin-profile-info-item">
                            <div className="admin-profile-info-label">{language === 'en' ? 'Phone' : 'ফোন'}</div>
                            <div className="admin-profile-info-value">{profileData.phone}</div>
                          </div>
                          <div className="admin-profile-info-item">
                            <div className="admin-profile-info-label">{language === 'en' ? 'Address' : 'ঠিকানা'}</div>
                            <div className="admin-profile-info-value">{profileData.address}</div>
                          </div>
                        </div>
                      </div>
                      <div className="admin-profile-actions">
                        <label className="admin-upload-btn admin-profile-action-btn">
                          {language === 'en' ? 'Upload Photo' : 'ছবি আপলোড করুন'}
                          <input type="file" accept="image/*" onChange={handleProfilePhotoFileChange} style={{ display: 'none' }} />
                        </label>
                        <button
                          className="admin-save-btn admin-profile-action-btn"
                          onClick={() => setShowEditProfile(true)}
                        >
                          {language === 'en' ? 'Edit Profile' : 'প্রোফাইল সম্পাদনা'}
                        </button>
                        <button
                          className="admin-save-btn admin-profile-action-btn"
                          onClick={() => {
                            setShowChangePassword(true)
                            setPasswordForm({ current: '', next: '', confirm: '', status: '' })
                          }}
                        >
                          {language === 'en' ? 'Change Password' : 'পাসওয়ার্ড পরিবর্তন করুন'}
                        </button>
                      </div>
                    </div>

                    {/* Profile form */}
                    {showEditProfile && (
                      <div className="admin-profile-edit-overlay" onClick={() => {
                        setShowEditProfile(false)
                        setProfileStatus('')
                      }}>
                        <div className="admin-profile-edit-modal" onClick={(e) => e.stopPropagation()}>
                          <div style={{
                            position: 'absolute',
                            inset: 0,
                            pointerEvents: 'none',
                            overflow: 'hidden',
                            borderRadius: '0.75rem'
                          }}>
                            <div style={{
                              position: 'absolute',
                              width: '260px',
                              height: '260px',
                              top: '-120px',
                              left: '-80px',
                              background: 'radial-gradient(circle at 30% 30%, rgba(59,130,246,0.25), transparent 60%)',
                              filter: 'blur(20px)'
                            }} />
                            <div style={{
                              position: 'absolute',
                              width: '240px',
                              height: '240px',
                              bottom: '-140px',
                              right: '-100px',
                              background: 'radial-gradient(circle at 70% 70%, rgba(16,185,129,0.22), transparent 60%)',
                              filter: 'blur(20px)'
                            }} />
                          </div>

                          <div className="admin-profile-edit-header">
                            <div>
                              <h2 className="admin-profile-edit-title">
                                {language === 'en' ? 'Edit Profile' : 'প্রোফাইল সম্পাদনা'}
                              </h2>
                              <p className="admin-profile-edit-subtitle">
                                {language === 'en' ? 'Update your profile information' : 'আপনার প্রোফাইল তথ্য আপডেট করুন'}
                              </p>
                            </div>
                          </div>

                          <div style={{ position: 'relative', zIndex: 1 }}>
                            <div className="admin-form-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))', gap: '1rem' }}>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Name' : 'নাম'}</label>
                                <input type="text" value={profileData.name} onChange={(e) => handleProfileFieldChange('name', e.target.value)} />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Designation' : 'পদবি'}</label>
                                <input
                                  type="text"
                                  value={profileData.designation || ''}
                                  onChange={(e) => handleProfileFieldChange('designation', e.target.value)}
                                />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Email' : 'ইমেইল'}</label>
                                <input type="email" value={profileData.email} onChange={(e) => handleProfileFieldChange('email', e.target.value)} />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Phone' : 'ফোন'}</label>
                                <input type="tel" value={profileData.phone} onChange={(e) => handleProfileFieldChange('phone', e.target.value)} />
                              </div>
                              <div className="admin-form-group">
                                <label>{adminContent.address}</label>
                                <textarea value={profileData.address || ''} onChange={(e) => handleProfileFieldChange('address', e.target.value)} rows={3} />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Role' : 'ভূমিকা'}</label>
                                <input
                                  type="text"
                                  value={userRole || (language === 'en' ? 'Administrator' : 'অ্যাডমিনিস্ট্রেটর')}
                                  readOnly
                                  style={{
                                    backgroundColor: userRole === 'Admin' ? '#dcfce7' : '#fef3c7',
                                    color: userRole === 'Admin' ? '#166534' : '#92400e',
                                    fontWeight: 600
                                  }}
                                />
                              </div>
                              {isEmployee && profileData.designation && (
                                <div className="admin-form-group">
                                  <label>{language === 'en' ? 'Designation' : 'পদবি'}</label>
                                  <input type="text" value={profileData.designation} readOnly />
                                </div>
                              )}
                              {isEmployee && profileData.department && (
                                <div className="admin-form-group">
                                  <label>{language === 'en' ? 'Department' : 'বিভাগ'}</label>
                                  <input type="text" value={profileData.department} readOnly />
                                </div>
                              )}
                            </div>
                            {profileStatus && (
                              <div style={{
                                padding: '0.75rem',
                                marginTop: '1rem',
                                borderRadius: '0.5rem',
                                border: profileStatus.includes('fail') || profileStatus.includes('ব্যর্থ') ? '1px solid #fecaca' : '1px solid #bbf7d0',
                                backgroundColor: profileStatus.includes('fail') || profileStatus.includes('ব্যর্থ') ? '#fef2f2' : '#ecfdf3',
                                color: profileStatus.includes('fail') || profileStatus.includes('ব্যর্থ') ? '#b91c1c' : '#065f46',
                                fontWeight: 700
                              }}>
                                {profileStatus}
                              </div>
                            )}
                            <div className="admin-profile-edit-buttons">
                              <button className="admin-save-btn" onClick={handleSaveProfile}>{adminContent.save}</button>
                              <button
                                className="admin-remove-btn"
                                onClick={() => {
                                  setShowEditProfile(false)
                                  setProfileStatus('')
                                }}
                              >
                                {language === 'en' ? 'Cancel' : 'বাতিল'}
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Change password */}
                    {showChangePassword && (
                      <div style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        backgroundColor: 'rgba(0, 0, 0, 0.5)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        zIndex: 1000,
                        padding: '1rem'
                      }} onClick={() => {
                        setShowChangePassword(false)
                        setPasswordForm({ current: '', next: '', confirm: '', status: '' })
                      }}>
                        <div className="admin-modal-content" onClick={(e) => e.stopPropagation()}>
                          <div style={{
                            position: 'absolute',
                            inset: 0,
                            pointerEvents: 'none',
                            overflow: 'hidden',
                            borderRadius: '0.75rem'
                          }}>
                            <div style={{
                              position: 'absolute',
                              width: '260px',
                              height: '260px',
                              top: '-120px',
                              left: '-80px',
                              background: 'radial-gradient(circle at 30% 30%, rgba(59,130,246,0.25), transparent 60%)',
                              filter: 'blur(20px)'
                            }} />
                            <div style={{
                              position: 'absolute',
                              width: '240px',
                              height: '240px',
                              bottom: '-140px',
                              right: '-100px',
                              background: 'radial-gradient(circle at 70% 70%, rgba(16,185,129,0.22), transparent 60%)',
                              filter: 'blur(20px)'
                            }} />
                          </div>

                          <div style={{ position: 'relative', display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', gap: '1rem' }}>
                            <div>
                              <h2 style={{ margin: 0, fontSize: '1.5rem', fontWeight: 800, color: '#0f172a' }}>
                                {adminContent.changePassword}
                              </h2>
                              <p style={{ margin: '0.25rem 0 0 0', color: '#475569', fontWeight: 600 }}>
                                {language === 'en' ? 'Update your password' : 'আপনার পাসওয়ার্ড আপডেট করুন'}
                              </p>
                            </div>
                          </div>

                          <div style={{ position: 'relative', zIndex: 1 }}>
                            <div style={{ border: '1px solid #e5e7eb', borderRadius: '0.5rem', padding: '1rem', background: '#f9fafb' }}>
                              <div className="admin-form-group">
                                <label>{adminContent.currentPassword}</label>
                                <input
                                  type="password"
                                  value={passwordForm.current}
                                  onChange={(e) => setPasswordForm({ ...passwordForm, current: e.target.value })}
                                />
                              </div>
                              <div className="admin-form-group">
                                <label>{adminContent.newPassword}</label>
                                <input
                                  type="password"
                                  value={passwordForm.next}
                                  onChange={(e) => setPasswordForm({ ...passwordForm, next: e.target.value })}
                                />
                              </div>
                              <div className="admin-form-group">
                                <label>{adminContent.confirmPassword}</label>
                                <input
                                  type="password"
                                  value={passwordForm.confirm}
                                  onChange={(e) => setPasswordForm({ ...passwordForm, confirm: e.target.value })}
                                />
                              </div>
                              {passwordForm.status && (
                                <div style={{
                                  padding: '0.75rem',
                                  marginTop: '1rem',
                                  borderRadius: '0.5rem',
                                  border: passwordForm.status.toLowerCase().includes('incorrect') || passwordForm.status.toLowerCase().includes('ব্যর্থ') ? '1px solid #fecaca' : '1px solid #bbf7d0',
                                  backgroundColor: passwordForm.status.toLowerCase().includes('incorrect') || passwordForm.status.toLowerCase().includes('ব্যর্থ') ? '#fef2f2' : '#ecfdf3',
                                  color: passwordForm.status.toLowerCase().includes('incorrect') || passwordForm.status.toLowerCase().includes('ব্যর্থ') ? '#b91c1c' : '#065f46',
                                  fontWeight: 700
                                }}>
                                  {passwordForm.status}
                                </div>
                              )}
                              <div style={{ display: 'flex', gap: '0.5rem', marginTop: '1rem' }}>
                                <button className="admin-save-btn" onClick={handleChangePassword}>{adminContent.updatePassword}</button>
                                <button
                                  className="admin-remove-btn"
                                  onClick={() => {
                                    setShowChangePassword(false)
                                    setPasswordForm({ current: '', next: '', confirm: '', status: '' })
                                  }}
                                >
                                  {language === 'en' ? 'Cancel' : 'বাতিল'}
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                </>
              )}
            </div>
          )}

          {/* CRM / Dealer Tab */}
          {activeTab === 'crm' && (
            <div className="admin-tab-content">
              <div className="admin-tab-header" style={{ gap: '0.75rem', flexWrap: 'wrap' }}>
                <h1 className="admin-page-title" style={{ flex: 1 }}>{language === 'en' ? 'Customers' : 'কাস্টমার'}</h1>
                <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                  <button
                    className="admin-add-btn"
                    onClick={() => {
                      setShowDealerForm(true)
                      setDealerStatus('')
                      setNewDealer((prev) => ({
                        ...prev,
                        dealerId: prev.dealerId || getNextDealerId()
                      }))
                    }}
                  >
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                      <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                    </svg>
                    {adminContent.addNew}
                  </button>
                  <button
                    type="button"
                    onClick={() => loadDealers()}
                    className="admin-add-btn"
                    style={{ backgroundColor: '#e2e8f0', color: '#0f172a' }}
                  >
                    {language === 'en' ? 'Refresh' : 'রিফ্রেশ'}
                  </button>
                </div>
              </div>
              {showDealerForm && (
                <div className="admin-dealer-form-overlay" style={{
                  position: 'fixed',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  backgroundColor: 'rgba(0, 0, 0, 0.5)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  zIndex: 1000,
                  padding: '1rem'
                }} onClick={() => {
                  setShowDealerForm(false)
                  setDealerStatus('')
                  setNewDealer({
                    dealerId: getNextDealerId(),
                    name: '',
                    phone: '',
                    email: '',
                    address: '',
                    photo: '',
                    nid: '',
                    tradeLicense: '',
                    pesticideLicense: '',
                    area: '',
                    agreement: '',
                    assignedTo: '',
                    assignedToName: '',
                    assignedToId: ''
                  })
                }}>
                  <div className="admin-modal-content" onClick={(e) => e.stopPropagation()}>
                    <div style={{
                      position: 'absolute',
                      inset: 0,
                      pointerEvents: 'none',
                      overflow: 'hidden',
                      borderRadius: '0.75rem'
                    }}>
                      <div style={{
                        position: 'absolute',
                        width: '260px',
                        height: '260px',
                        top: '-120px',
                        left: '-80px',
                        background: 'radial-gradient(circle at 30% 30%, rgba(59,130,246,0.25), transparent 60%)',
                        filter: 'blur(20px)'
                      }} />
                      <div style={{
                        position: 'absolute',
                        width: '240px',
                        height: '240px',
                        bottom: '-140px',
                        right: '-100px',
                        background: 'radial-gradient(circle at 70% 70%, rgba(16,185,129,0.22), transparent 60%)',
                        filter: 'blur(20px)'
                      }} />
                    </div>

                    <div style={{ position: 'relative', display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', gap: '1rem' }}>
                      <div>
                        <h2 style={{ margin: 0, fontSize: '1.5rem', fontWeight: 800, color: '#0f172a' }}>
                          {language === 'en' ? 'Add Dealer' : 'ডিলার যোগ করুন'}
                        </h2>
                        <p style={{ margin: '0.25rem 0 0 0', color: '#475569', fontWeight: 600 }}>
                          {language === 'en' ? 'Fill in dealer details and save' : 'ডিলারের বিবরণ পূরণ করুন এবং সংরক্ষণ করুন'}
                        </p>
                      </div>
                      <button
                        onClick={() => {
                          setShowDealerForm(false)
                          setDealerStatus('')
                          setNewDealer({
                            dealerId: getNextDealerId(),
                            name: '',
                            phone: '',
                            email: '',
                            address: '',
                            photo: '',
                            nid: '',
                            tradeLicense: '',
                            pesticideLicense: '',
                            regionId: '',
                            areaId: '',
                            territoryId: '',
                            area: '',
                            agreement: '',
                            assignedTo: '',
                            assignedToName: '',
                            assignedToId: ''
                          })
                        }}
                        style={{
                          background: '#e2e8f0',
                          border: 'none',
                          padding: '0.4rem 0.65rem',
                          borderRadius: '0.375rem',
                          cursor: 'pointer',
                          fontWeight: 700,
                          color: '#475569'
                        }}
                      >
                        ×
                      </button>
                    </div>

                    <div style={{ position: 'relative', zIndex: 1 }}>
                      {dealerStatus && (
                        <div style={{
                          padding: '0.75rem',
                          marginBottom: '1rem',
                          borderRadius: '0.5rem',
                          border: dealerStatus.includes('required') ? '1px solid #fecaca' : '1px solid #bbf7d0',
                          backgroundColor: dealerStatus.includes('required') ? '#fef2f2' : '#ecfdf3',
                          color: dealerStatus.includes('required') ? '#b91c1c' : '#065f46',
                          fontWeight: 700
                        }}>
                          {dealerStatus}
                        </div>
                      )}
                      <form onSubmit={handleAddDealer} className="admin-form-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))', gap: '1rem' }}>
                        <div className="admin-form-group">
                          <label>{language === 'en' ? 'Region ID' : 'অঞ্চল আইডি'}</label>
                          <select
                            value={newDealer.regionId}
                            onChange={(e) => setNewDealer({ ...newDealer, regionId: e.target.value, areaId: '', territoryId: '' })}
                            style={{ width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', fontSize: '0.95rem' }}
                          >
                            <option value="">{language === 'en' ? 'Select Region' : 'অঞ্চল নির্বাচন করুন'}</option>
                            {uniqueRegionIds.map(id => <option key={id} value={id}>{id}</option>)}
                          </select>
                        </div>
                        <div className="admin-form-group">
                          <label>{language === 'en' ? 'Area ID' : 'এলাকা আইডি'}</label>
                          <select
                            value={newDealer.areaId}
                            onChange={(e) => setNewDealer({ ...newDealer, areaId: e.target.value, territoryId: '' })}
                            disabled={!newDealer.regionId}
                            style={{ width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', fontSize: '0.95rem', opacity: !newDealer.regionId ? 0.7 : 1 }}
                          >
                            <option value="">{language === 'en' ? 'Select Area ID' : 'এলাকা আইডি নির্বাচন করুন'}</option>
                            {availableAreaIds.map(id => <option key={id} value={id}>{id}</option>)}
                          </select>
                        </div>
                        <div className="admin-form-group">
                          <label>{adminContent.territoryId}</label>
                          <select
                            value={newDealer.territoryId}
                            onChange={(e) => {
                              const tid = e.target.value
                              const found = territories.find(t => t.regionId === newDealer.regionId && t.areaId === newDealer.areaId && t.territoryId === tid)
                              setNewDealer({
                                ...newDealer,
                                territoryId: tid,
                                area: found ? found.area : newDealer.area
                              })
                            }}
                            disabled={!newDealer.areaId}
                            style={{ width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', fontSize: '0.95rem', opacity: !newDealer.areaId ? 0.7 : 1 }}
                          >
                            <option value="">{language === 'en' ? 'Select Territory' : 'টেরিটরি নির্বাচন করুন'}</option>
                            {availableTerritoryIds.map(id => <option key={id} value={id}>{id}</option>)}
                          </select>
                        </div>
                        <div className="admin-form-group">
                          <label>{language === 'en' ? 'CID' : 'সিআইডি'}</label>
                          <input type="text" value={newDealer.dealerId} onChange={(e) => setNewDealer({ ...newDealer, dealerId: e.target.value })} />
                        </div>
                        <div className="admin-form-group">
                          <label>{language === 'en' ? 'Shop Name' : 'দোকানের নাম'}</label>
                          <input type="text" value={newDealer.shopName || ''} onChange={(e) => setNewDealer({ ...newDealer, shopName: e.target.value })} />
                        </div>
                        <div className="admin-form-group">
                          <label>{language === 'en' ? 'Customer Name' : 'কাস্টমারের নাম'}</label>
                          <input type="text" value={newDealer.name} onChange={(e) => setNewDealer({ ...newDealer, name: e.target.value })} />
                        </div>
                        <div className="admin-form-group">
                          <label>{language === 'en' ? 'Phone' : 'ফোন'}</label>
                          <input type="tel" value={newDealer.phone} onChange={(e) => setNewDealer({ ...newDealer, phone: e.target.value })} />
                        </div>
                        <div className="admin-form-group">
                          <label>{language === 'en' ? 'Email' : 'ইমেইল'}</label>
                          <input type="email" value={newDealer.email} onChange={(e) => setNewDealer({ ...newDealer, email: e.target.value })} />
                        </div>
                        <div className="admin-form-group">
                          <label>{language === 'en' ? 'Address' : 'ঠিকানা'}</label>
                          <textarea value={newDealer.address} onChange={(e) => setNewDealer({ ...newDealer, address: e.target.value })} rows={3} />
                        </div>
                        <div className="admin-form-group">
                          <label>{language === 'en' ? 'NID' : 'এনআইডি'}</label>
                          <input type="text" value={newDealer.nid} onChange={(e) => setNewDealer({ ...newDealer, nid: e.target.value })} />
                        </div>
                        <div className="admin-form-group">
                          <label>{language === 'en' ? 'Trade License Number' : 'ট্রেড লাইসেন্স নম্বর'}</label>
                          <input type="text" value={newDealer.tradeLicense} onChange={(e) => setNewDealer({ ...newDealer, tradeLicense: e.target.value })} />
                        </div>
                        <div className="admin-form-group">
                          <label>{language === 'en' ? 'Pesticides License Number' : 'কীটনাশক লাইসেন্স নম্বর'}</label>
                          <input type="text" value={newDealer.pesticideLicense} onChange={(e) => setNewDealer({ ...newDealer, pesticideLicense: e.target.value })} />
                        </div>

                        <div className="admin-form-group">
                          <label>{language === 'en' ? 'Area Name' : 'এলাকার নাম'}</label>
                          <input type="text" value={newDealer.area} onChange={(e) => setNewDealer({ ...newDealer, area: e.target.value })} />
                        </div>
                        <div className="admin-form-group">
                          <label>{language === 'en' ? 'Assign Salesman' : 'সেলসম্যান নির্ধারণ করুন'}</label>
                          <select
                            value={newDealer.assignedTo}
                            onChange={(e) => setNewDealer({
                              ...newDealer,
                              assignedTo: e.target.value,
                              assignedToName: '',
                              assignedToId: ''
                            })}
                            style={{
                              width: '100%',
                              padding: '0.5rem',
                              border: '1px solid #d1d5db',
                              borderRadius: '0.375rem',
                              fontSize: '0.95rem'
                            }}
                          >
                            <option value="">{language === 'en' ? 'Select Salesman' : 'সেলসম্যান নির্বাচন করুন'}</option>
                            {salesEmployees.map((emp) => (
                              <option key={emp._id} value={emp._id}>
                                {emp.name} {emp.employeeId ? `(${emp.employeeId})` : ''}
                              </option>
                            ))}
                          </select>
                        </div>
                        <div className="admin-form-group">
                          <label>{language === 'en' ? 'Photo Upload' : 'ছবি আপলোড'}</label>
                          <input
                            type="file"
                            accept="image/*"
                            onChange={async (e) => {
                              const file = e.target.files?.[0]
                              if (!file) return
                              try {
                                const base64 = await fileToBase64(file)
                                setNewDealer({ ...newDealer, photo: base64 })
                              } catch (err) {
                                console.error('Dealer photo upload failed', err)
                              }
                            }}
                          />
                          {newDealer.photo && (
                            <p style={{ marginTop: '0.35rem', fontSize: '0.8rem', color: '#16a34a' }}>
                              {language === 'en' ? 'Photo ready' : 'ছবি প্রস্তুত'}
                            </p>
                          )}
                        </div>
                        <div className="admin-form-group">
                          <label>{language === 'en' ? 'Agreement Paper Upload' : 'চুক্তিপত্র আপলোড'}</label>
                          <input
                            type="file"
                            accept="application/pdf,image/*"
                            onChange={async (e) => {
                              const file = e.target.files?.[0]
                              if (!file) return
                              try {
                                const base64 = await fileToBase64(file)
                                setNewDealer({ ...newDealer, agreement: base64 })
                              } catch (err) {
                                console.error('Agreement upload failed', err)
                              }
                            }}
                          />
                          {newDealer.agreement && (
                            <p style={{ marginTop: '0.35rem', fontSize: '0.8rem', color: '#16a34a' }}>
                              {language === 'en' ? 'Agreement ready' : 'চুক্তি প্রস্তুত'}
                            </p>
                          )}
                        </div>
                        <div style={{ gridColumn: '1 / -1', display: 'flex', gap: '0.5rem' }}>
                          <button type="submit" className="admin-save-btn">{adminContent.save}</button>
                          <button
                            type="button"
                            className="admin-remove-btn"
                            onClick={() => {
                              setShowDealerForm(false);
                              setDealerStatus('');
                              setNewDealer({
                                dealerId: getNextDealerId(),
                                name: '',
                                phone: '',
                                email: '',
                                address: '',
                                photo: '',
                                nid: '',
                                tradeLicense: '',
                                pesticideLicense: '',
                                regionId: '',
                                areaId: '',
                                territoryId: '',
                                area: '',
                                agreement: '',
                                assignedTo: '',
                                assignedToName: '',
                                assignedToId: ''
                              })
                            }}
                          >
                            {language === 'en' ? 'Close' : 'বন্ধ করুন'}
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              )}
              {loadingDealers ? (
                <LoadingSpinner text={language === 'en' ? 'Loading Dealers...' : 'ডিলার তালিকা লোড হচ্ছে...'} />
              ) : (
                <>
                  <div className="admin-search-bar" style={{ marginBottom: '1rem' }}>
                    <input
                      type="text"
                      placeholder={language === 'en' ? 'Search customers...' : 'কাস্টমার খুঁজুন...'}
                      value={dealerSearch || ''}
                      onChange={(e) => setDealerSearch(e.target.value)}
                    />
                  </div>
                  <div className="admin-table-container">
                    <table className="admin-table">
                      <thead>
                        <tr>
                          <th
                            onClick={() => handleSortDealers('dealerId')}
                            style={{ cursor: 'pointer', userSelect: 'none' }}
                          >
                            {language === 'en' ? 'CID' : 'সিআইডি'}
                            {dealerSortField === 'dealerId' && (dealerSortDirection === 'asc' ? ' ↑' : ' ↓')}
                          </th>
                          <th>{language === 'en' ? 'Shop Name' : 'দোকানের নাম'}</th>
                          <th
                            onClick={() => handleSortDealers('name')}
                            style={{ cursor: 'pointer', userSelect: 'none' }}
                          >
                            {language === 'en' ? 'Customer Name' : 'কাস্টমারের নাম'}
                            {dealerSortField === 'name' && (dealerSortDirection === 'asc' ? ' ↑' : ' ↓')}
                          </th>
                          <th>{language === 'en' ? 'Phone' : 'ফোন'}</th>
                          <th>{language === 'en' ? 'Email' : 'ইমেইল'}</th>
                          <th>{language === 'en' ? 'Area' : 'এলাকা'}</th>
                          <th>{language === 'en' ? 'Assigned To' : 'নিয়োজিত'}</th>
                          <th
                            onClick={() => handleSortDealers('dueAmount')}
                            style={{ cursor: 'pointer', userSelect: 'none' }}
                          >
                            {language === 'en' ? 'Due Amount' : 'বকেয়া পরিমাণ'}
                            {dealerSortField === 'dueAmount' && (dealerSortDirection === 'asc' ? ' ↑' : ' ↓')}
                          </th>
                          <th>{language === 'en' ? 'Actions' : 'কার্যক্রম'}</th>
                        </tr>
                      </thead>
                      <tbody>
                        {sortedDealers.length === 0 ? (
                          <tr>
                            <td colSpan="8" style={{ textAlign: 'center', padding: '2rem' }}>
                              {adminContent.noData}
                            </td>
                          </tr>
                        ) : (
                          sortedDealers.map((d) => {
                            // Calculate due amount for this dealer (exclude cancelled orders)
                            const dealerOrders = (orders || []).filter(order =>
                              order.dealerId === d.dealerId &&
                              order.status !== 'Cancelled' &&
                              order.approvalStatus !== 'Rejected'
                            )
                            const dueAmount = dealerOrders.reduce((sum, order) => {
                              const totalPrice = parseFloat(order.totalPrice || 0)
                              const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                              const grandTotal = totalPrice * discount
                              const paid = parseFloat(order.paidAmount || 0)
                              const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                              const due = Math.max(0, grandTotal - (paid + commission))
                              return sum + due
                            }, 0)

                            return (
                              <tr key={d.id}>
                                <td>{d.dealerId}</td>
                                <td>{d.shopName || '-'}</td>
                                <td>{d.name}</td>
                                <td>{d.phone}</td>
                                <td>{d.email}</td>
                                <td>{d.area}</td>
                                <td>{d.assignedToName || d.assignedToId || '-'}</td>
                                <td style={{
                                  fontWeight: 700,
                                  color: dueAmount > 0 ? '#c2410c' : '#15803d'
                                }}>
                                  ৳{Number(dueAmount || 0).toLocaleString()}
                                </td>
                                <td style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                  <button
                                    className="admin-add-btn"
                                    style={{ padding: '0.35rem 0.75rem', fontSize: '0.9rem' }}
                                    onClick={() => {
                                      setViewingDealer(d)
                                      setIsEditingDealer(false)
                                      setEditingDealerData(null)
                                      // Show dealer details by default, hide orders section
                                      setShowDealerOrders(false)
                                    }}
                                  >
                                    {language === 'en' ? 'View' : 'দেখুন'}
                                  </button>
                                </td>
                              </tr>
                            )
                          })
                        )}
                      </tbody>
                    </table>
                  </div>

                  {/* Mobile Card View for Dealers */}
                  <div className="mobile-card-container">
                    {sortedDealers.length === 0 ? (
                      <div style={{ textAlign: 'center', padding: '2rem', color: '#6b7280' }}>
                        {adminContent.noData}
                      </div>
                    ) : (
                      sortedDealers.map((d) => {
                        const dealerOrders = (orders || []).filter(order =>
                          order.dealerId === d.dealerId &&
                          order.status !== 'Cancelled' &&
                          order.approvalStatus !== 'Rejected'
                        )
                        const dueAmount = dealerOrders.reduce((sum, order) => {
                          const totalPrice = parseFloat(order.totalPrice || 0)
                          const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                          const grandTotal = totalPrice * discount
                          const paid = parseFloat(order.paidAmount || 0)
                          const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                          const due = Math.max(0, grandTotal - (paid + commission))
                          return sum + due
                        }, 0)

                        const isExpanded = expandedDealerId === (d.id || d.dealerId)

                        return (
                          <div
                            className="mobile-card"
                            key={d.id}
                            onClick={() => toggleDealerExpansion(d.id || d.dealerId)}
                            style={{ cursor: 'pointer' }}
                          >
                            <div className="mobile-card-header">
                              <div className="mobile-card-avatar" style={{ overflow: 'hidden' }}>
                                {d.photo ? (
                                  <img src={d.photo} alt={d.name} style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                                ) : (
                                  d.name.charAt(0).toUpperCase()
                                )}
                              </div>
                              <div className="mobile-card-header-text">
                                <div className="mobile-card-title">{d.shopName || '-'}</div>
                                <div className="mobile-card-subtitle">{d.name}</div>
                                <div className="mobile-card-subtitle">{d.dealerId}</div>
                              </div>
                              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', marginLeft: 'auto' }}>
                                <div className="mobile-card-status-badge" style={{
                                  position: 'static', // Override absolute positioning
                                  backgroundColor: dueAmount > 0 ? '#fee2e2' : '#dcfce7',
                                  color: dueAmount > 0 ? '#dc2626' : '#166534',
                                  marginBottom: '0.25rem',
                                  alignSelf: 'flex-end'
                                }}>
                                  {dueAmount > 0 ? 'Due' : 'Paid'}
                                </div>
                                <div style={{ fontSize: '0.875rem', fontWeight: 600, color: dueAmount > 0 ? '#dc2626' : '#16a34a' }}>
                                  ৳{Number(dueAmount || 0).toLocaleString()}
                                </div>
                              </div>
                            </div>
                            <div className="mobile-card-body">
                              {isExpanded && (
                                <>
                                  <div className="mobile-card-row" style={{ animation: 'fadeIn 0.2s' }}>
                                    <span className="mobile-card-label">{language === 'en' ? 'Phone' : 'ফোন'}</span>
                                    <span className="mobile-card-value">{d.phone}</span>
                                  </div>
                                  <div className="mobile-card-row" style={{ animation: 'fadeIn 0.2s' }}>
                                    <span className="mobile-card-label">{language === 'en' ? 'Email' : 'ইমেইল'}</span>
                                    <span className="mobile-card-value">{d.email || '-'}</span>
                                  </div>
                                  <div className="mobile-card-row" style={{ animation: 'fadeIn 0.2s' }}>
                                    <span className="mobile-card-label">{language === 'en' ? 'Area' : 'এলাকা'}</span>
                                    <span className="mobile-card-value">{d.area}</span>
                                  </div>
                                  <div className="mobile-card-row" style={{ animation: 'fadeIn 0.2s' }}>
                                    <span className="mobile-card-label">{language === 'en' ? 'Assigned' : 'নিয়োজিত'}</span>
                                    <span className="mobile-card-value">{d.assignedToName || d.assignedToId || '-'}</span>
                                  </div>
                                </>
                              )}
                            </div>

                            {isExpanded && (
                              <div className="mobile-card-actions" onClick={(e) => e.stopPropagation()} style={{ animation: 'fadeIn 0.2s' }}>
                                <button
                                  className="mobile-action-btn"
                                  onClick={() => {
                                    setViewingDealer(d)
                                    setIsEditingDealer(false)
                                    setEditingDealerData(null)
                                    setShowDealerOrders(false)
                                  }}
                                >
                                  {language === 'en' ? 'View Details' : 'বিস্তারিত দেখুন'}
                                </button>
                                <button
                                  className="mobile-action-btn edit"
                                  onClick={() => {
                                    setViewingDealer(d)
                                    setIsEditingDealer(true)
                                    setEditingDealerData(d)
                                  }}
                                  style={{ backgroundColor: '#e0e7ff', color: '#1d4ed8', marginLeft: '0.5rem' }}
                                >
                                  {language === 'en' ? 'Edit' : 'সম্পাদনা'}
                                </button>
                                <button
                                  className="mobile-action-btn delete"
                                  onClick={() => {
                                    setViewingDealer(d)
                                    handleDeleteDealer()
                                  }}
                                  style={{ backgroundColor: '#fee2e2', color: '#dc2626', marginLeft: '0.5rem' }}
                                >
                                  {language === 'en' ? 'Delete' : 'মুছুন'}
                                </button>
                              </div>
                            )}
                          </div>
                        )
                      })
                    )}
                  </div>
                </>
              )}

              {viewingDealer && (
                <div
                  className="admin-dealer-view-overlay"
                  style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000,
                    padding: '1rem'
                  }}
                  onClick={() => setViewingDealer(null)}
                >
                  <div
                    className="admin-dealer-view-modal"
                    style={{
                      position: 'relative',
                      background: 'linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%)',
                      borderRadius: '0.75rem',
                      padding: '1.5rem',
                      maxWidth: '900px',
                      width: '100%',
                      maxHeight: '90vh',
                      overflowY: 'auto',
                      WebkitOverflowScrolling: 'touch',
                      boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)'
                    }}
                    onClick={(e) => e.stopPropagation()}
                  >
                    <div
                      style={{
                        position: 'absolute',
                        inset: 0,
                        pointerEvents: 'none',
                        overflow: 'hidden',
                        borderRadius: '0.75rem'
                      }}
                    >
                      <div
                        style={{
                          position: 'absolute',
                          width: '260px',
                          height: '260px',
                          top: '-120px',
                          left: '-80px',
                          background: 'radial-gradient(circle at 30% 30%, rgba(59,130,246,0.25), transparent 60%)',
                          filter: 'blur(20px)'
                        }}
                      />
                      <div
                        style={{
                          position: 'absolute',
                          width: '240px',
                          height: '240px',
                          bottom: '-140px',
                          right: '-100px',
                          background: 'radial-gradient(circle at 70% 70%, rgba(16,185,129,0.22), transparent 60%)',
                          filter: 'blur(20px)'
                        }}
                      />
                    </div>

                    <div
                      className="admin-dealer-view-header"
                      style={{
                        position: 'relative',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        marginBottom: '1.5rem',
                        gap: '1rem'
                      }}
                    >
                      <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', flexWrap: 'wrap' }}>
                        <div
                          style={{
                            width: 80,
                            height: 80,
                            borderRadius: '50%',
                            overflow: 'hidden',
                            border: '3px solid rgba(255,255,255,0.9)',
                            boxShadow: '0 10px 30px rgba(0,0,0,0.12)',
                            background: '#e5e7eb',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontWeight: 700,
                            fontSize: '1.5rem',
                            color: '#111827'
                          }}
                        >
                          {(isEditingDealer ? editingDealerData?.photo : viewingDealer.photo) ? (
                            <img
                              src={isEditingDealer ? editingDealerData?.photo : viewingDealer.photo}
                              alt={editingDealerData?.name || viewingDealer.name}
                              style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                              onError={(e) => (e.target.style.display = 'none')}
                            />
                          ) : (
                            (editingDealerData?.name || viewingDealer.name || 'D').charAt(0)
                          )}
                        </div>
                        <div>
                          <h2
                            style={{
                              margin: 0,
                              fontSize: '1.5rem',
                              fontWeight: 800,
                              color: '#0f172a'
                            }}
                          >
                            {viewingDealer.shopName || (language === 'en' ? 'Shop' : 'শপ')}
                          </h2>
                          <p style={{ margin: '0.25rem 0 0 0', color: '#475569', fontWeight: 700 }}>
                            {viewingDealer.name || '-'}
                          </p>
                          <p style={{ margin: '0.1rem 0 0 0', color: '#64748b', fontSize: '0.9rem', fontWeight: 600 }}>
                            {viewingDealer.dealerId || 'N/A'}
                          </p>
                        </div>
                      </div>
                      <div className="admin-dealer-view-buttons" style={{ display: 'flex', gap: '0.5rem', flexWrap: 'nowrap' }}>
                        {!isEditingDealer && (
                          <button
                            onClick={() => {
                              if (showDealerOrders) {
                                setShowDealerOrders(false)
                              } else {
                                handleShowDealerOrders()
                              }
                            }}
                            style={{
                              padding: '0.45rem 0.85rem',
                              backgroundColor: '#0ea5e9',
                              color: 'white',
                              border: 'none',
                              borderRadius: '0.5rem',
                              cursor: 'pointer',
                              fontWeight: 700,
                              boxShadow: '0 10px 20px rgba(14,165,233,0.35)'
                            }}
                          >
                            {showDealerOrders
                              ? (language === 'en' ? 'Back' : 'পেছনে যান')
                              : (language === 'en' ? 'Orders' : 'অর্ডার')}
                          </button>
                        )}

                        {/* Dealer Order Filters (Only when showing orders) */}
                        {showDealerOrders && !isEditingDealer && (
                          <>
                            <select
                              value={dealerFilterHalf}
                              onChange={(e) => setDealerFilterHalf(e.target.value)}
                              style={{
                                padding: '0.45rem 0.85rem',
                                border: '1px solid #d1d5db',
                                borderRadius: '0.5rem',
                                cursor: 'pointer',
                                fontWeight: 700,
                                fontSize: '0.9rem',
                                outline: 'none'
                              }}
                            >
                              <option value="H1">H1 (Jan-Jun)</option>
                              <option value="H2">H2 (Jul-Dec)</option>
                            </select>
                            <select
                              value={dealerFilterYear}
                              onChange={(e) => setDealerFilterYear(parseInt(e.target.value))}
                              style={{
                                padding: '0.45rem 0.85rem',
                                border: '1px solid #d1d5db',
                                borderRadius: '0.5rem',
                                cursor: 'pointer',
                                fontWeight: 700,
                                fontSize: '0.9rem',
                                outline: 'none'
                              }}
                            >
                              {Array.from({ length: 5 }, (_, i) => new Date().getFullYear() + 1 - i).map(year => (
                                <option key={year} value={year}>{year}</option>
                              ))}
                            </select>
                          </>
                        )}

                        {!isEditingDealer && !showDealerOrders && (
                          <button
                            onClick={() => {
                              setIsEditingDealer(true)
                              setEditingDealerData(viewingDealer)
                            }}
                            style={{
                              padding: '0.5rem 0.9rem',
                              backgroundColor: '#3b82f6',
                              color: 'white',
                              border: 'none',
                              borderRadius: '0.5rem',
                              cursor: 'pointer',
                              fontWeight: 700,
                              boxShadow: '0 10px 20px rgba(59,130,246,0.35)'
                            }}
                          >
                            {language === 'en' ? 'Edit' : 'সম্পাদনা'}
                          </button>
                        )}
                        {isEditingDealer && (
                          <>
                            <button
                              onClick={handleSaveDealerEdit}
                              disabled={savingDealer}
                              style={{
                                padding: '0.5rem 0.9rem',
                                backgroundColor: '#16a34a',
                                color: 'white',
                                border: 'none',
                                borderRadius: '0.5rem',
                                cursor: 'pointer',
                                fontWeight: 700,
                                opacity: savingDealer ? 0.7 : 1
                              }}
                            >
                              {savingDealer
                                ? language === 'en'
                                  ? 'Saving...'
                                  : 'সংরক্ষণ হচ্ছে...'
                                : language === 'en'
                                  ? 'Save'
                                  : 'সংরক্ষণ'}
                            </button>
                            <button
                              onClick={() => {
                                setIsEditingDealer(false)
                                setEditingDealerData(null)
                              }}
                              style={{
                                padding: '0.5rem 0.9rem',
                                backgroundColor: '#e2e8f0',
                                color: '#0f172a',
                                border: 'none',
                                borderRadius: '0.5rem',
                                cursor: 'pointer',
                                fontWeight: 700
                              }}
                            >
                              {language === 'en' ? 'Cancel' : 'বাতিল'}
                            </button>
                          </>
                        )}
                        {isEditingDealer && (
                          <button
                            onClick={handleDeleteDealer}
                            style={{
                              padding: '0.45rem 0.85rem',
                              backgroundColor: '#ef4444',
                              color: 'white',
                              border: 'none',
                              borderRadius: '0.5rem',
                              cursor: 'pointer',
                              fontWeight: 700,
                              boxShadow: '0 10px 20px rgba(239,68,68,0.35)'
                            }}
                          >
                            {language === 'en' ? 'Delete' : 'মুছুন'}
                          </button>
                        )}
                        <button
                          onClick={() => setViewingDealer(null)}
                          style={{
                            background: '#e2e8f0',
                            border: 'none',
                            padding: '0.4rem 0.65rem',
                            borderRadius: '0.375rem',
                            cursor: 'pointer',
                            fontWeight: 700,
                            color: '#475569'
                          }}
                        >
                          ×
                        </button>
                      </div>
                    </div>

                    {showDealerOrders && (
                      <div className="admin-card" style={{ marginTop: '0.5rem' }}>
                        {(() => {
                          const isAdmin = (userRole || '').toLowerCase() === 'admin'
                          return (
                            <>
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.75rem' }}>
                                <div>
                                  <h3 style={{ margin: 0 }}>{language === 'en' ? 'Dealer Orders' : 'ডিলারের অর্ডার'}</h3>

                                </div>

                              </div>

                              {dealerOrdersLoading && (
                                <div style={{ padding: '0.75rem', color: '#475569' }}>
                                  {language === 'en' ? 'Loading orders...' : 'অর্ডার লোড হচ্ছে...'}
                                </div>
                              )}
                              {dealerOrdersStatus && !dealerOrdersLoading && (
                                <div style={{
                                  padding: '0.75rem',
                                  marginBottom: '0.75rem',
                                  borderRadius: '0.375rem',
                                  backgroundColor: '#f1f5f9',
                                  color: '#475569'
                                }}>
                                  {dealerOrdersStatus}
                                </div>
                              )}

                              {!dealerOrdersLoading && dealerOrders.length > 0 && (
                                <>
                                  {(() => {
                                    // Filter used to be here, now using centralized filteredDealerOrders from scope


                                    const totalAmount = filteredDealerOrders.reduce((sum, order) => {
                                      const price = parseFloat(order.totalPrice || 0)
                                      const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                      return sum + (price * discount)
                                    }, 0)

                                    const totalPaid = filteredDealerOrders.reduce((sum, order) => {
                                      const paid = order.paidAmount ? parseFloat(order.paidAmount) || 0 : 0
                                      const commission = (order.paymentHistory || [])
                                        .filter(p => p.type !== 'Return')
                                        .reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                                      return sum + paid + commission
                                    }, 0)

                                    const totalDue = filteredDealerOrders.reduce((sum, order) => {
                                      const price = parseFloat(order.totalPrice || 0)
                                      const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                      const grandTotal = price * discount
                                      const paid = order.paidAmount ? parseFloat(order.paidAmount) || 0 : 0
                                      const commission = (order.paymentHistory || [])
                                        .filter(p => p.type !== 'Return')
                                        .reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                                      const due = Math.max(0, grandTotal - (paid + commission))
                                      return sum + due
                                    }, 0)

                                    return (
                                      <>
                                        <div style={{
                                          display: 'grid',
                                          gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                                          gap: '1rem',
                                          marginBottom: '1.5rem'
                                        }}>
                                          <div style={{
                                            padding: '1rem',
                                            borderRadius: '0.5rem',
                                            backgroundColor: '#ffffff',
                                            border: '1px solid #e5e7eb'
                                          }}>
                                            <div style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 700, marginBottom: '0.5rem' }}>
                                              {language === 'en' ? 'Total Amount' : 'মোট পরিমাণ'}
                                            </div>
                                            <div style={{ fontSize: '1.5rem', fontWeight: 800, color: '#0f172a' }}>
                                              ৳{Number(totalAmount || 0).toLocaleString()}
                                            </div>
                                          </div>
                                          <div style={{
                                            padding: '1rem',
                                            borderRadius: '0.5rem',
                                            backgroundColor: '#f0fdf4',
                                            border: '1px solid #dcfce7'
                                          }}>
                                            <div style={{ fontSize: '0.875rem', color: '#15803d', fontWeight: 700, marginBottom: '0.5rem' }}>
                                              {language === 'en' ? 'Total Paid' : 'মোট পরিশোধিত'}
                                            </div>
                                            <div style={{ fontSize: '1.5rem', fontWeight: 800, color: '#166534' }}>
                                              ৳{Number(totalPaid || 0).toLocaleString()}
                                            </div>
                                          </div>
                                          <div style={{
                                            padding: '1rem',
                                            borderRadius: '0.5rem',
                                            backgroundColor: '#fff7ed',
                                            border: '1px solid #fed7aa'
                                          }}>
                                            <div style={{ fontSize: '0.875rem', color: '#c2410c', fontWeight: 700, marginBottom: '0.5rem' }}>
                                              {language === 'en' ? 'Total Due' : 'মোট বকেয়া'}
                                            </div>
                                            <div style={{ fontSize: '1.5rem', fontWeight: 800, color: '#9a3412' }}>
                                              ৳{Number(totalDue || 0).toLocaleString()}
                                            </div>
                                          </div>
                                          <div style={{
                                            padding: '1rem',
                                            borderRadius: '0.5rem',
                                            backgroundColor: '#fef2f2',
                                            border: '1px solid #fecaca'
                                          }}>
                                            <div style={{ fontSize: '0.875rem', color: '#b91c1c', fontWeight: 700, marginBottom: '0.5rem' }}>
                                              {language === 'en' ? 'Total Commission' : 'মোট কমিশন'}
                                            </div>
                                            <div style={{ fontSize: '1.5rem', fontWeight: 800, color: '#991b1b' }}>
                                              ৳{filteredDealerOrders.reduce((sum, order) => {
                                                const orderComm = (order.paymentHistory || []).reduce((pSum, p) => pSum + (parseFloat(p.commission) || 0), 0)
                                                return sum + orderComm
                                              }, 0).toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                            </div>
                                          </div>
                                        </div>

                                        {isAdmin && (
                                          <div style={{
                                            display: 'grid',
                                            gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',
                                            gap: '1rem',
                                            marginBottom: '1.5rem'
                                          }}>
                                            <div style={{
                                              padding: '1rem',
                                              borderRadius: '0.5rem',
                                              backgroundColor: '#eff6ff',
                                              border: '1px solid #bfdbfe'
                                            }}>
                                              <div style={{ fontSize: '0.875rem', color: '#1e40af', fontWeight: 700, marginBottom: '0.5rem' }}>
                                                {language === 'en' ? 'Add Collection' : 'সংগ্রহ যোগ করুন'}
                                              </div>
                                              <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', flexWrap: 'wrap' }}>
                                                <select
                                                  value={addCollectionCommission}
                                                  onChange={(e) => setAddCollectionCommission(e.target.value)}
                                                  style={{
                                                    padding: '0.5rem',
                                                    border: '1px solid #3b82f6',
                                                    borderRadius: '0.375rem',
                                                    fontSize: '1rem',
                                                    fontWeight: 600,
                                                    color: '#1e40af',
                                                    backgroundColor: 'white',
                                                    width: '100px'
                                                  }}
                                                >
                                                  <option value="">Comm %</option>
                                                  {commissionRates.map(rate => (
                                                    <option key={rate} value={rate}>{rate}</option>
                                                  ))}
                                                </select>
                                                <input
                                                  type="number"
                                                  min="0"
                                                  value={addCollectionAmount}
                                                  onChange={(e) => setAddCollectionAmount(e.target.value)}
                                                  onKeyDown={(e) => {
                                                    if (e.key === 'Enter') {
                                                      e.preventDefault()
                                                      handleAddCollection(addCollectionAmount)
                                                    }
                                                  }}
                                                  placeholder={language === 'en' ? 'Enter amount' : 'পরিমাণ লিখুন'}
                                                  style={{
                                                    flex: 1,
                                                    minWidth: '120px',
                                                    padding: '0.5rem',
                                                    border: '1px solid #3b82f6',
                                                    borderRadius: '0.375rem',
                                                    fontSize: '1rem',
                                                    fontWeight: 600,
                                                    color: '#1e40af'
                                                  }}
                                                />
                                                <button
                                                  onClick={() => handleAddCollection(addCollectionAmount)}
                                                  disabled={savingCollection || !addCollectionAmount || parseFloat(addCollectionAmount) <= 0}
                                                  style={{
                                                    padding: '0.5rem 1rem',
                                                    backgroundColor: savingCollection ? '#9ca3af' : '#3b82f6',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '0.375rem',
                                                    fontSize: '0.875rem',
                                                    fontWeight: 700,
                                                    cursor: savingCollection || !addCollectionAmount || parseFloat(addCollectionAmount) <= 0 ? 'not-allowed' : 'pointer',
                                                    whiteSpace: 'nowrap'
                                                  }}
                                                >
                                                  {savingCollection
                                                    ? (language === 'en' ? 'Adding...' : 'যোগ করা হচ্ছে...')
                                                    : (language === 'en' ? 'Add' : 'যোগ করুন')}
                                                </button>
                                              </div>
                                            </div>

                                            <div style={{
                                              padding: '1rem',
                                              borderRadius: '0.5rem',
                                              backgroundColor: '#fef2f2',
                                              border: '1px solid #fecaca'
                                            }}>
                                              <div style={{ fontSize: '0.875rem', color: '#b91c1c', fontWeight: 700, marginBottom: '0.5rem' }}>
                                                {language === 'en' ? 'Return Product' : 'পণ্য ফেরত'}
                                              </div>
                                              <div style={{ display: 'flex', gap: '0.5rem', flexDirection: 'column' }}>
                                                {/* Product Selection Row */}
                                                <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                                  <select
                                                    value={returnForm.productId}
                                                    onChange={(e) => {
                                                      const prodId = e.target.value
                                                      const product = products.find(p => p._id === prodId)
                                                      setReturnForm({ ...returnForm, productId: prodId, variant: product?.variants?.[0]?.productCode || '' })
                                                    }}
                                                    style={{
                                                      flex: '1 1 200px',
                                                      padding: '0.5rem',
                                                      border: '1px solid #ef4444',
                                                      borderRadius: '0.375rem',
                                                      fontSize: '0.875rem'
                                                    }}
                                                  >
                                                    <option value="">{language === 'en' ? 'Select Product' : 'পণ্য নির্বাচন করুন'}</option>
                                                    {products.map(p => (
                                                      <option key={p._id} value={p._id}>{p.name}</option>
                                                    ))}
                                                  </select>
                                                  {returnForm.productId && products.find(p => p._id === returnForm.productId)?.priceCategory === 'per_variant' && (
                                                    <select
                                                      value={returnForm.variant}
                                                      onChange={(e) => setReturnForm({ ...returnForm, variant: e.target.value })}
                                                      style={{
                                                        flex: '1 1 150px',
                                                        padding: '0.5rem',
                                                        border: '1px solid #ef4444',
                                                        borderRadius: '0.375rem',
                                                        fontSize: '0.875rem'
                                                      }}
                                                    >
                                                      {products.find(p => p._id === returnForm.productId).variants.map(v => (
                                                        <option key={v.productCode} value={v.productCode}>{v.packSize}{v.packUnit}</option>
                                                      ))}
                                                    </select>
                                                  )}
                                                </div>
                                                {/* Quantities and Place Row */}
                                                <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                                                  <input
                                                    type="number"
                                                    placeholder={language === 'en' ? 'Pack Qty' : 'প্যাক পরিমাণ'}
                                                    value={returnForm.packQuantity}
                                                    onChange={(e) => setReturnForm({ ...returnForm, packQuantity: e.target.value })}
                                                    style={{ flex: '1 1 100px', padding: '0.5rem', border: '1px solid #ef4444', borderRadius: '0.375rem' }}
                                                  />
                                                  <input
                                                    type="number"
                                                    placeholder={language === 'en' ? 'Carton Qty' : 'কার্টুন পরিমাণ'}
                                                    value={returnForm.cartonQuantity}
                                                    onChange={(e) => setReturnForm({ ...returnForm, cartonQuantity: e.target.value })}
                                                    style={{ flex: '1 1 100px', padding: '0.5rem', border: '1px solid #ef4444', borderRadius: '0.375rem' }}
                                                  />
                                                  <select
                                                    value={returnForm.returnPlace}
                                                    onChange={(e) => setReturnForm({ ...returnForm, returnPlace: e.target.value })}
                                                    style={{ flex: '1 1 150px', padding: '0.5rem', border: '1px solid #ef4444', borderRadius: '0.375rem', fontSize: '0.875rem' }}
                                                  >
                                                    <option value="">{language === 'en' ? 'Return Place' : 'ফেরত স্থান'}</option>
                                                    <option value="Customer Point">Customer Point</option>
                                                    <option value="Salesman Point">Salesman Point</option>
                                                    <option value="BCCL">BCCL</option>
                                                  </select>
                                                  <button
                                                    onClick={handleReturnProduct}
                                                    disabled={savingReturn || !returnForm.productId}
                                                    style={{
                                                      flex: '0 0 auto',
                                                      padding: '0.5rem 1rem',
                                                      backgroundColor: savingReturn ? '#9ca3af' : '#ef4444',
                                                      color: 'white',
                                                      border: 'none',
                                                      borderRadius: '0.375rem',
                                                      fontWeight: 700,
                                                      cursor: savingReturn || !returnForm.productId ? 'not-allowed' : 'pointer',
                                                      whiteSpace: 'nowrap'
                                                    }}
                                                  >
                                                    {savingReturn ? '...' : (language === 'en' ? 'Return' : 'ফেরত')}
                                                  </button>
                                                </div>
                                              </div>
                                            </div>
                                          </div>
                                        )}
                                      </>
                                    )
                                  })()}

                                  {/* Collection History Table */}
                                  {(() => {
                                    // Flatten all payments from all orders
                                    const allPayments = []
                                    const allReturns = []
                                    filteredDealerOrders.forEach(order => {
                                      const price = parseFloat(order.totalPrice || 0)
                                      const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                      const orderGrandTotal = price * discount
                                      let runningPaid = 0
                                      let runningCommission = 0

                                      // Sort payments by date to calculate running totals correctly
                                      // Clone array to avoid mutating original
                                      const sortedHistory = [...(order.paymentHistory || [])].sort((a, b) => new Date(a.date) - new Date(b.date))

                                      sortedHistory.forEach(payment => {
                                        const payAmount = parseFloat(payment.amount) || 0
                                        const commAmount = parseFloat(payment.commission) || 0
                                        const isReturn = payment.type === 'Return'

                                        if (isReturn) {
                                          allReturns.push({
                                            _id: payment._id || Math.random().toString(),
                                            date: payment.date,
                                            orderId: customOrderIds[order._id] || order.orderId,
                                            amount: payAmount,
                                            productName: payment.metadata?.productName || (payment.note?.split(': ')?.[1]?.split(' - ')?.[0]) || '',
                                            packQty: payment.metadata?.packQuantity || (payment.note?.split(' - ')?.[1]?.split(' P/B')?.[0]) || 0,
                                            cartonQty: payment.metadata?.cartonQuantity || (payment.note?.split(', ')?.[1]?.split(' C')?.[0]) || 0,
                                            returnPlace: payment.metadata?.returnPlace || '',
                                            note: payment.note || ''
                                          })
                                          return // Don't add to collection history
                                        }

                                        const commPercent = payAmount > 0 ? Math.round(((commAmount / payAmount) * 100)) + '%' : '-'

                                        runningPaid += payAmount
                                        runningCommission += commAmount
                                        const totalPaidSoFar = runningPaid + runningCommission
                                        const runningDue = Math.max(0, orderGrandTotal - totalPaidSoFar)

                                        allPayments.push({
                                          _id: payment._id || Math.random().toString(),
                                          date: payment.date,
                                          orderId: customOrderIds[order._id] || order.orderId,
                                          totalAmount: orderGrandTotal,
                                          runningPaid: totalPaidSoFar, // Total Paid (Cash + Comm) so far
                                          paidAmount: payAmount, // This transaction amount
                                          commissionPercent: commPercent,
                                          commission: commAmount,
                                          totalCommission: runningCommission, // Total Commission so far for this order
                                          totalDue: runningDue, // Total Due after this payment
                                          note: payment.note || ''
                                        })
                                      })
                                    })

                                    // Sort by Date Descending
                                    allPayments.sort((a, b) => new Date(b.date) - new Date(a.date))
                                    allReturns.sort((a, b) => new Date(b.date) - new Date(a.date))

                                    console.log('Return History Data:', allReturns)

                                    return (
                                      <>
                                        <div className="admin-table-container" style={{ marginTop: '2rem' }}>
                                          <h4 style={{ fontSize: '1.1rem', fontWeight: 700, color: '#1e293b', marginBottom: '1rem' }}>
                                            {language === 'en' ? 'Collection History' : 'সংগ্রহের ইতিহাস'}
                                          </h4>
                                          <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '0.875rem' }}>
                                            <thead>
                                              <tr style={{ backgroundColor: '#f8fafc', borderBottom: '2px solid #e2e8f0', textAlign: 'left' }}>
                                                <th style={{ padding: '0.75rem', fontWeight: 600, color: '#475569', textAlign: 'center' }}>{language === 'en' ? 'Date' : 'তারিখ'}</th>
                                                <th style={{ padding: '0.75rem', fontWeight: 600, color: '#475569', textAlign: 'center' }}>{language === 'en' ? 'Order ID' : 'অর্ডার আইডি'}</th>
                                                <th style={{ padding: '0.75rem', fontWeight: 600, color: '#475569', textAlign: 'right' }}>{language === 'en' ? 'Total Amount' : 'মোট পরিমাণ'}</th>
                                                <th style={{ padding: '0.75rem', fontWeight: 600, color: '#475569', textAlign: 'right' }}>{language === 'en' ? 'Total Paid' : 'মোট পরিশোধিত'}</th>
                                                <th style={{ padding: '0.75rem', fontWeight: 600, color: '#475569', textAlign: 'right' }}>{language === 'en' ? 'Paid' : 'পরিশোধ'}</th>
                                                <th style={{ padding: '0.75rem', fontWeight: 600, color: '#475569', textAlign: 'center' }}>Comm %</th>
                                                <th style={{ padding: '0.75rem', fontWeight: 600, color: '#475569', textAlign: 'right' }}>Commission</th>
                                                <th style={{ padding: '0.75rem', fontWeight: 600, color: '#475569', textAlign: 'right' }}>Total Comm</th>
                                                <th style={{ padding: '0.75rem', fontWeight: 600, color: '#475569', textAlign: 'right' }}>Total Due</th>
                                              </tr>
                                            </thead>
                                            <tbody>
                                              {allPayments.length > 0 ? (
                                                allPayments.map((payment) => (
                                                  <tr key={payment._id} style={{ borderBottom: '1px solid #e2e8f0' }}>
                                                    <td style={{ padding: '0.75rem', color: '#334155', textAlign: 'center' }}>
                                                      {new Date(payment.date).toLocaleDateString(language === 'en' ? 'en-US' : 'bn-BD')}
                                                    </td>
                                                    <td style={{ padding: '0.75rem', color: '#334155', fontWeight: 500, textAlign: 'center' }}>
                                                      {payment.orderId}
                                                    </td>
                                                    <td style={{ padding: '0.75rem', textAlign: 'right', color: '#334155' }}>
                                                      ৳{Number(payment.totalAmount).toLocaleString()}
                                                    </td>
                                                    <td style={{ padding: '0.75rem', textAlign: 'right', color: '#166534', fontWeight: 600 }}>
                                                      ৳{Number(payment.runningPaid).toLocaleString()}
                                                    </td>
                                                    <td style={{ padding: '0.75rem', textAlign: 'right', color: '#15803d', fontWeight: 700, backgroundColor: '#f0fdf4' }}>
                                                      ৳{Number(payment.paidAmount).toLocaleString()}
                                                    </td>
                                                    <td style={{ padding: '0.75rem', textAlign: 'center', color: '#64748b' }}>
                                                      {payment.commissionPercent}
                                                    </td>
                                                    <td style={{ padding: '0.75rem', textAlign: 'right', color: '#b91c1c' }}>
                                                      ৳{Number(payment.commission).toLocaleString(undefined, { maximumFractionDigits: 2 })}
                                                    </td>
                                                    <td style={{ padding: '0.75rem', textAlign: 'right', color: '#991b1b', fontWeight: 600 }}>
                                                      ৳{Number(payment.totalCommission).toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                                    </td>
                                                    <td style={{ padding: '0.75rem', textAlign: 'right', color: '#c2410c', fontWeight: 600 }}>
                                                      ৳{Number(payment.totalDue).toLocaleString()}
                                                    </td>
                                                  </tr>
                                                ))
                                              ) : (
                                                <tr>
                                                  <td colSpan="10" style={{ padding: '1.5rem', textAlign: 'center', color: '#94a3b8' }}>
                                                    {language === 'en' ? 'No payment history found' : 'কোন পেমেন্ট ইতিহাস পাওয়া যায়নি'}
                                                  </td>
                                                </tr>
                                              )}
                                            </tbody>
                                          </table>
                                        </div>

                                        {/* Mobile Card View for Collection History */}
                                        <div className="mobile-card-container" style={{ marginTop: '2rem' }}>
                                          <h4 style={{ fontSize: '1.1rem', fontWeight: 700, color: '#1e293b', marginBottom: '1rem', paddingLeft: '0.5rem' }}>
                                            {language === 'en' ? 'Collection History' : 'সংগ্রহের ইতিহাস'}
                                          </h4>
                                          {allPayments.length === 0 ? (
                                            <div style={{ textAlign: 'center', padding: '2rem', color: '#6b7280' }}>
                                              {language === 'en' ? 'No payment history found' : 'কোন পেমেন্ট ইতিহাস পাওয়া যায়নি'}
                                            </div>
                                          ) : (
                                            allPayments.map((payment) => (
                                              <div className="mobile-card" key={payment._id}>
                                                <div className="mobile-card-header">
                                                  <div className="mobile-card-avatar" style={{ backgroundColor: '#f0fdf4', color: '#15803d' }}>
                                                    ৳
                                                  </div>
                                                  <div className="mobile-card-header-text">
                                                    <div className="mobile-card-title">{payment.orderId}</div>
                                                    <div className="mobile-card-subtitle">
                                                      {new Date(payment.date).toLocaleDateString(language === 'en' ? 'en-US' : 'bn-BD')}
                                                    </div>
                                                  </div>
                                                </div>
                                                <div className="mobile-card-body">
                                                  <div className="mobile-card-row">
                                                    <span className="mobile-card-label">{language === 'en' ? 'Total Amount' : 'মোট পরিমাণ'}</span>
                                                    <span className="mobile-card-value">৳{Number(payment.totalAmount).toLocaleString()}</span>
                                                  </div>
                                                  <div className="mobile-card-row">
                                                    <span className="mobile-card-label">{language === 'en' ? 'Paid (This Txn)' : 'পরিশোধ (এই লেনদেন)'}</span>
                                                    <span className="mobile-card-value" style={{ color: '#15803d', fontWeight: 700 }}>
                                                      ৳{Number(payment.paidAmount).toLocaleString()}
                                                    </span>
                                                  </div>
                                                  <div className="mobile-card-row">
                                                    <span className="mobile-card-label">{language === 'en' ? 'Commission' : 'কমিশন'}</span>
                                                    <span className="mobile-card-value" style={{ color: '#b91c1c' }}>
                                                      ৳{Number(payment.commission).toLocaleString(undefined, { maximumFractionDigits: 2 })} ({payment.commissionPercent})
                                                    </span>
                                                  </div>
                                                  <div className="mobile-card-row">
                                                    <span className="mobile-card-label">{language === 'en' ? 'Total Due' : 'মোট বকেয়া'}</span>
                                                    <span className="mobile-card-value" style={{ color: '#c2410c', fontWeight: 700 }}>
                                                      ৳{Number(payment.totalDue).toLocaleString()}
                                                    </span>
                                                  </div>
                                                </div>
                                              </div>
                                            ))
                                          )}
                                        </div>

                                        {/* Return History Table */}
                                        <div className="admin-table-container" style={{ marginTop: '2rem' }}>
                                          <h4 style={{ fontSize: '1.1rem', fontWeight: 700, color: '#b91c1c', marginBottom: '1rem' }}>
                                            {language === 'en' ? 'Return History' : 'ফেরত ইতিহাস'}
                                          </h4>
                                          <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '0.875rem' }}>
                                            <thead>
                                              <tr style={{ backgroundColor: '#fef2f2', borderBottom: '2px solid #fecaca', textAlign: 'left' }}>
                                                <th style={{ padding: '0.75rem', fontWeight: 600, color: '#991b1b' }}>{language === 'en' ? 'Date' : 'তারিখ'}</th>
                                                <th style={{ padding: '0.75rem', fontWeight: 600, color: '#991b1b' }}>{language === 'en' ? 'Product' : 'পণ্য'}</th>
                                                <th style={{ padding: '0.75rem', fontWeight: 600, color: '#991b1b', textAlign: 'center' }}>P/B</th>
                                                <th style={{ padding: '0.75rem', fontWeight: 600, color: '#991b1b', textAlign: 'center' }}>Carton</th>
                                                <th style={{ padding: '0.75rem', fontWeight: 600, color: '#991b1b', textAlign: 'right' }}>{language === 'en' ? 'Return Value' : 'ফেরত মূল্য'}</th>
                                                <th style={{ padding: '0.75rem', fontWeight: 600, color: '#991b1b' }}>{language === 'en' ? 'Return Place' : 'ফেরত স্থান'}</th>
                                              </tr>
                                            </thead>
                                            <tbody>
                                              {allReturns.length > 0 ? (
                                                allReturns.map((ret) => (
                                                  <tr key={ret._id} style={{ borderBottom: '1px solid #fecaca' }}>
                                                    <td style={{ padding: '0.75rem', color: '#334155' }}>
                                                      {new Date(ret.date).toLocaleDateString(language === 'en' ? 'en-US' : 'bn-BD')}
                                                    </td>
                                                    <td style={{ padding: '0.75rem', color: '#334155', fontWeight: 500 }}>
                                                      {ret.productName}
                                                    </td>
                                                    <td style={{ padding: '0.75rem', textAlign: 'center', color: '#334155' }}>
                                                      {ret.packQty}
                                                    </td>
                                                    <td style={{ padding: '0.75rem', textAlign: 'center', color: '#334155' }}>
                                                      {ret.cartonQty}
                                                    </td>
                                                    <td style={{ padding: '0.75rem', textAlign: 'right', color: '#b91c1c', fontWeight: 700 }}>
                                                      ৳{Number(ret.amount).toLocaleString()}
                                                    </td>
                                                    <td style={{ padding: '0.75rem', color: '#64748b', fontStyle: 'italic' }}>
                                                      {ret.returnPlace}
                                                    </td>
                                                  </tr>
                                                ))
                                              ) : (
                                                <tr>
                                                  <td colSpan="6" style={{ padding: '1.5rem', textAlign: 'center', color: '#94a3b8' }}>
                                                    {language === 'en' ? 'No return history found' : 'কোন ফেরত ইতিহাস পাওয়া যায়নি'}
                                                  </td>
                                                </tr>
                                              )}
                                            </tbody>
                                          </table>
                                        </div>

                                        {/* Mobile Card View for Return History */}
                                        <div className="mobile-card-container" style={{ marginTop: '2rem' }}>
                                          <h4 style={{ fontSize: '1.1rem', fontWeight: 700, color: '#b91c1c', marginBottom: '1rem', paddingLeft: '0.5rem' }}>
                                            {language === 'en' ? 'Return History' : 'ফেরত ইতিহাস'}
                                          </h4>
                                          {allReturns.length === 0 ? (
                                            <div style={{ textAlign: 'center', padding: '2rem', color: '#6b7280' }}>
                                              {language === 'en' ? 'No return history found' : 'কোন ফেরত ইতিহাস পাওয়া যায়নি'}
                                            </div>
                                          ) : (
                                            allReturns.map((ret) => (
                                              <div className="mobile-card" key={ret._id} style={{ borderLeft: '4px solid #ef4444' }}>
                                                <div className="mobile-card-header">
                                                  <div className="mobile-card-avatar" style={{ backgroundColor: '#fef2f2', color: '#b91c1c' }}>
                                                    R
                                                  </div>
                                                  <div className="mobile-card-header-text">
                                                    <div className="mobile-card-title">{ret.orderId}</div>
                                                    <div className="mobile-card-subtitle">
                                                      {new Date(ret.date).toLocaleDateString(language === 'en' ? 'en-US' : 'bn-BD')}
                                                    </div>
                                                  </div>
                                                </div>
                                                <div className="mobile-card-body">
                                                  <div className="mobile-card-row">
                                                    <span className="mobile-card-label">{language === 'en' ? 'Product' : 'পণ্য'}</span>
                                                    <span className="mobile-card-value">{ret.productName}</span>
                                                  </div>
                                                  <div className="mobile-card-row">
                                                    <span className="mobile-card-label">P/B | Carton</span>
                                                    <span className="mobile-card-value">{ret.packQty} | {ret.cartonQty}</span>
                                                  </div>
                                                  <div className="mobile-card-row">
                                                    <span className="mobile-card-label">{language === 'en' ? 'Return Value' : 'ফেরত মূল্য'}</span>
                                                    <span className="mobile-card-value" style={{ color: '#b91c1c', fontWeight: 700 }}>
                                                      ৳{Number(ret.amount).toLocaleString()}
                                                    </span>
                                                  </div>
                                                  <div className="mobile-card-row">
                                                    <span className="mobile-card-label">{language === 'en' ? 'Return Place' : 'ফেরত স্থান'}</span>
                                                    <span className="mobile-card-value" style={{ fontStyle: 'italic', fontSize: '0.75rem' }}>{ret.returnPlace}</span>
                                                  </div>
                                                </div>
                                              </div>
                                            ))
                                          )}
                                        </div>

                                      </>
                                    )
                                  })()}

                                  <div className="admin-table-container" style={{ width: '100%', overflowX: 'auto', marginTop: '2rem' }}>
                                    <div style={{ padding: '0 0.5rem 1rem 0.5rem', fontWeight: 700, fontSize: '1.1rem', color: '#1e293b' }}>
                                      {language === 'en' ? 'Dealer Orders' : 'ডিলারের অর্ডার'}
                                    </div>
                                    <table className="admin-table" style={{ width: '100%', fontSize: '0.875rem' }}>
                                      <thead>
                                        <tr>
                                          <th style={{ padding: '0.5rem', whiteSpace: 'nowrap', textAlign: 'center' }}>{language === 'en' ? 'Date' : 'তারিখ'}</th>
                                          <th style={{ padding: '0.5rem', whiteSpace: 'nowrap', textAlign: 'center' }}>{language === 'en' ? 'Order ID' : 'অর্ডার আইডি'}</th>
                                          <th style={{ padding: '0.5rem', whiteSpace: 'nowrap', textAlign: 'center' }}>{language === 'en' ? 'Product' : 'পণ্য'}</th>
                                          <th style={{ padding: '0.5rem', whiteSpace: 'nowrap', textAlign: 'center' }}>{language === 'en' ? 'Variant' : 'ভ্যারিয়েন্ট'}</th>
                                          <th style={{ padding: '0.5rem', whiteSpace: 'nowrap', textAlign: 'center' }}>{language === 'en' ? 'Quantity' : 'পরিমাণ'}</th>
                                          <th style={{ padding: '0.5rem', whiteSpace: 'nowrap', textAlign: 'center' }}>{language === 'en' ? 'Status' : 'স্ট্যাটাস'}</th>
                                          <th style={{ padding: '0.5rem', whiteSpace: 'nowrap', textAlign: 'center' }}>{language === 'en' ? 'Grand total' : 'সর্বমোট'}</th>
                                          <th style={{ padding: '0.5rem', whiteSpace: 'nowrap', textAlign: 'center' }}>{language === 'en' ? 'Paid Amount' : 'পরিশোধিত পরিমাণ'}</th>
                                          <th style={{ padding: '0.5rem', whiteSpace: 'nowrap', textAlign: 'center' }}>{language === 'en' ? 'Due Amount' : 'বাকি পরিমাণ'}</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        {filteredDealerOrders.map((order) => {
                                          const isExpandable = order.items && order.items.length > 1;
                                          const isExpanded = expandedOrderRows.includes(order._id);
                                          return (
                                            <tr
                                              key={order._id}
                                              onClick={() => isExpandable && toggleOrderRow(order._id)}
                                              style={{
                                                cursor: isExpandable ? 'pointer' : 'default',
                                                transition: 'background-color 0.1s ease'
                                              }}
                                              className={isExpandable ? "hover:bg-gray-50" : ""}
                                            >
                                              <td style={{ padding: '0.5rem', whiteSpace: 'nowrap', textAlign: 'center' }}>{order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '-'}</td>
                                              <td style={{ padding: '0.5rem', whiteSpace: 'nowrap', textAlign: 'center', fontWeight: 'bold', color: '#475569' }}>
                                                {customOrderIds[order._id] || order.orderId || '-'}
                                              </td>
                                              <td style={{ padding: '0.5rem', whiteSpace: 'nowrap', textAlign: 'center' }}>
                                                {isExpandable ? (
                                                  isExpanded ? (
                                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.25rem' }}>
                                                      {order.items.map((item, idx) => (
                                                        <div key={idx} style={{ borderBottom: idx < order.items.length - 1 ? '1px solid #f1f5f9' : 'none', paddingBottom: '2px', minHeight: '1.2em' }}>
                                                          {item.productName || item.product?.name || '-'}
                                                        </div>
                                                      ))}

                                                    </div>
                                                  ) : (
                                                    <div style={{ padding: '0.2rem', color: '#3b82f6', fontWeight: 600 }}>
                                                      Multiple Products ({order.items.length})

                                                    </div>
                                                  )
                                                ) : (
                                                  (order.items && order.items.length === 1) ? (
                                                    order.items[0].productName || order.items[0].product?.name || '-'
                                                  ) : (
                                                    order.productName || order.product?.name || '-'
                                                  )
                                                )}
                                              </td>
                                              <td style={{ padding: '0.5rem', whiteSpace: 'nowrap', textAlign: 'center' }}>
                                                {isExpandable ? (
                                                  isExpanded ? (
                                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.25rem' }}>
                                                      {order.items.map((item, idx) => (
                                                        <div key={idx} style={{ borderBottom: idx < order.items.length - 1 ? '1px solid #f1f5f9' : 'none', paddingBottom: '2px', minHeight: '1.2em' }}>
                                                          {item.variant?.productCode ? `${item.variant.productCode} (${item.variant.packSize} ${item.variant.packUnit || 'ml'}) [${item.variant.cartoonSize || 1} ${item.variant.cartoonUnit || 'Pcs'}]` : '-'}
                                                        </div>
                                                      ))}
                                                    </div>
                                                  ) : (
                                                    <div style={{ color: '#64748b' }}>-</div>
                                                  )
                                                ) : (
                                                  (order.items && order.items.length === 1) ? (
                                                    order.items[0].variant?.productCode ? `${order.items[0].variant.productCode} (${order.items[0].variant.packSize} ${order.items[0].variant.packUnit || 'ml'}) [${order.items[0].variant.cartoonSize || 1} ${order.items[0].variant.cartoonUnit || 'Pcs'}]` : '-'
                                                  ) : (
                                                    order.variant?.productCode ? `${order.variant.productCode} (${order.variant.packSize} ${order.variant.packUnit || 'ml'}) [${order.variant.cartoonSize || 1} ${order.variant.cartoonUnit || 'Pcs'}]` : '-'
                                                  )
                                                )}
                                              </td>
                                              <td style={{ padding: '0.5rem', whiteSpace: 'nowrap', textAlign: 'center', fontWeight: 600 }}>
                                                {isExpandable ? (
                                                  isExpanded ? (
                                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.25rem' }}>
                                                      {order.items.map((item, idx) => {
                                                        const itemQty = parseFloat(item.quantity) || 0
                                                        let freeQty = 0
                                                        const itemProduct = (products || []).find(p => p._id === (item.product?._id || item.product))
                                                        if (itemProduct && itemProduct.hasOffer && itemProduct.buyQuantity && itemProduct.freeQuantity) {
                                                          const buyQty = parseFloat(itemProduct.buyQuantity) || 0
                                                          const offerFreeQty = parseFloat(itemProduct.freeQuantity) || 0
                                                          if (buyQty > 0) {
                                                            const eligibleOffers = Math.floor(itemQty / buyQty)
                                                            freeQty = eligibleOffers * offerFreeQty
                                                          }
                                                        }
                                                        return (
                                                          <div key={idx} style={{ borderBottom: idx < order.items.length - 1 ? '1px solid #f1f5f9' : 'none', paddingBottom: '2px', minHeight: '1.2em' }}>
                                                            {freeQty > 0 ? `${itemQty + freeQty} (${freeQty})` : itemQty}
                                                          </div>
                                                        )
                                                      })}
                                                    </div>
                                                  ) : (
                                                    (() => {
                                                      const totalQty = order.items.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0), 0)
                                                      return <span style={{ color: '#3b82f6', fontWeight: 700 }}>{totalQty} (Total)</span>
                                                    })()
                                                  )
                                                ) : (
                                                  (() => {
                                                    const item = (order.items && order.items.length === 1) ? order.items[0] : order;
                                                    const qty = parseFloat(item.quantity) || 0;
                                                    let freeQty = 0;
                                                    const p = (products || []).find(prod => prod._id === (item.product?._id || item.product));
                                                    if (p && p.hasOffer && p.buyQuantity && p.freeQuantity) {
                                                      const bQty = parseFloat(p.buyQuantity) || 0;
                                                      const fQty = parseFloat(p.freeQuantity) || 0;
                                                      if (bQty > 0) {
                                                        const offers = Math.floor(qty / bQty);
                                                        freeQty = offers * fQty;
                                                      }
                                                    }
                                                    return freeQty > 0 ? `${qty + freeQty} (${freeQty})` : qty;
                                                  })()
                                                )}
                                              </td>
                                              <td style={{ padding: '0.5rem', whiteSpace: 'nowrap', textAlign: 'center' }}>{order.status || 'Pending'}</td>
                                              <td style={{ padding: '0.5rem', whiteSpace: 'nowrap', fontWeight: 700, textAlign: 'center' }}>
                                                ৳{(() => {
                                                  const price = parseFloat(order.totalPrice || 0)
                                                  const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                                  return Math.round((price * discount))
                                                })()}
                                              </td>
                                              <td style={{ padding: '0.5rem', whiteSpace: 'nowrap', fontWeight: 600, color: '#16a34a', textAlign: 'center' }}>
                                                ৳{(() => {
                                                  const paid = order.paidAmount ? parseFloat(order.paidAmount) || 0 : 0
                                                  const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                                                  return Math.round((paid + commission))
                                                })()}
                                              </td>
                                              <td style={{
                                                padding: '0.5rem', whiteSpace: 'nowrap', fontWeight: 600, textAlign: 'center', color: (() => {
                                                  const price = parseFloat(order.totalPrice || 0)
                                                  const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                                  const grandTotal = price * discount
                                                  const paid = order.paidAmount ? parseFloat(order.paidAmount) || 0 : 0
                                                  const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                                                  const due = Math.max(0, grandTotal - (paid + commission))
                                                  return due > 0 ? '#dc2626' : '#16a34a'
                                                })()
                                              }}>
                                                ৳{(() => {
                                                  const price = parseFloat(order.totalPrice || 0)
                                                  const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                                  const grandTotal = price * discount
                                                  const paid = order.paidAmount ? parseFloat(order.paidAmount) || 0 : 0
                                                  const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                                                  const due = Math.max(0, grandTotal - (paid + commission))
                                                  return Math.round(due)
                                                })()}
                                              </td>
                                            </tr>
                                          );
                                        })}
                                      </tbody>
                                    </table>
                                  </div>

                                  {/* Mobile Card View for Dealer Orders */}
                                  <div className="mobile-card-container" style={{ marginTop: '1rem' }}>
                                    <div style={{ padding: '0 0.5rem 1rem 0.5rem', fontWeight: 700, fontSize: '1.1rem', color: '#1e293b' }}>
                                      {language === 'en' ? 'Dealer Orders' : 'ডিলারের অর্ডার'}
                                    </div>
                                    {filteredDealerOrders.length === 0 ? (
                                      <div style={{ textAlign: 'center', padding: '2rem', color: '#6b7280' }}>
                                        {language === 'en' ? 'No orders found' : 'কোন অর্ডার পাওয়া যায়নি'}
                                      </div>
                                    ) : (
                                      filteredDealerOrders.map((order) => {
                                        const paid = order.paidAmount ? parseFloat(order.paidAmount) || 0 : 0
                                        const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                                        const price = parseFloat(order.totalPrice || 0)
                                        const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                        const grandTotal = price * discount
                                        const due = Math.max(0, grandTotal - (paid + commission))

                                        const isExpanded = expandedOrderRows.includes(order._id);

                                        return (
                                          <div
                                            className="mobile-card"
                                            key={order._id}
                                            onClick={() => {
                                              setExpandedOrderRows(prev =>
                                                prev.includes(order._id) ? prev.filter(id => id !== order._id) : [...prev, order._id]
                                              );
                                            }}
                                            style={{ cursor: 'pointer' }}
                                          >
                                            <div className="mobile-card-header" style={{ borderBottom: isExpanded ? '1px solid #f1f5f9' : 'none', paddingBottom: isExpanded ? '0.75rem' : '0' }}>
                                              <div className="mobile-card-header-text">
                                                <div className="mobile-card-title" style={{ color: '#0369a1', fontSize: '1.1rem', fontWeight: 700 }}>{customOrderIds[order._id] || order.orderId || '-'}</div>
                                                <div className="mobile-card-subtitle" style={{ fontSize: '0.9rem', color: '#64748b' }}>{order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '-'}</div>
                                              </div>
                                              <div className="mobile-card-status-badge" style={{
                                                backgroundColor:
                                                  order.status === 'Complete' ? '#dcfce7' :
                                                    order.status === 'Delivered' ? '#d1fae5' :
                                                      order.status === 'Shipped' ? '#dbeafe' :
                                                        order.status === 'Processing' ? '#fef3c7' :
                                                          order.status === 'Cancelled' ? '#fee2e2' :
                                                            '#f3f4f6',
                                                color:
                                                  order.status === 'Complete' ? '#166534' :
                                                    order.status === 'Delivered' ? '#065f46' :
                                                      order.status === 'Shipped' ? '#1e40af' :
                                                        order.status === 'Processing' ? '#92400e' :
                                                          order.status === 'Cancelled' ? '#b91c1c' :
                                                            '#374151',
                                                marginLeft: 'auto',
                                                alignSelf: 'start',
                                                marginTop: '4px'
                                              }}>
                                                {order.status || 'Pending'}
                                              </div>
                                            </div>

                                            {isExpanded && (
                                              <div className="mobile-card-body" style={{ marginTop: '0.75rem' }}>

                                                {order.items && order.items.length > 0 ? (
                                                  order.items.map((item, idx) => (
                                                    <div key={idx} style={{
                                                      marginTop: '0.75rem',
                                                      padding: '0.5rem',
                                                      backgroundColor: '#f8fafc',
                                                      borderRadius: '4px',
                                                      border: '1px solid #f1f5f9'
                                                    }}>
                                                      <div className="mobile-card-row" style={{ borderBottom: '1px solid #f1f5f9', paddingBottom: '4px', marginBottom: '4px' }}>
                                                        <span className="mobile-card-label" style={{ fontWeight: 700 }}>{language === 'en' ? `Item ${idx + 1}` : `আইটেম ${idx + 1}`}</span>
                                                      </div>
                                                      <div className="mobile-card-row">
                                                        <span className="mobile-card-label">{language === 'en' ? 'Product' : 'পণ্য'}</span>
                                                        <span className="mobile-card-value" style={{ fontWeight: 600 }}>{item.productName || item.product?.name || '-'}</span>
                                                      </div>
                                                      <div className="mobile-card-row">
                                                        <span className="mobile-card-label">{language === 'en' ? 'Variant' : 'ভ্যারিয়েন্ট'}</span>
                                                        <span className="mobile-card-value">{item.variant?.productCode ? `${item.variant.productCode} (${item.variant.packSize} ${item.variant.packUnit || 'ml'})` : '-'}</span>
                                                      </div>
                                                      <div className="mobile-card-row">
                                                        <span className="mobile-card-label">{language === 'en' ? 'Qty' : 'পরিমাণ'}</span>
                                                        <span className="mobile-card-value" style={{ fontWeight: 600 }}>
                                                          {(() => {
                                                            const purchased = parseFloat(item.quantity) || 0
                                                            const free = parseFloat(item.freeQuantity) || 0
                                                            return free > 0 ? `${purchased + free} (${free})` : purchased
                                                          })()}
                                                        </span>
                                                      </div>
                                                      <div className="mobile-card-row">
                                                        <span className="mobile-card-label">{language === 'en' ? 'Price' : 'দাম'}</span>
                                                        <span className="mobile-card-value">৳{Math.round(parseFloat(item.unitPrice || item.variant?.price || 0))}</span>
                                                      </div>
                                                      <div className="mobile-card-row">
                                                        <span className="mobile-card-label">{language === 'en' ? 'Subtotal' : 'উপ-মোট'}</span>
                                                        <span className="mobile-card-value" style={{ fontWeight: 700, color: '#16a34a' }}>৳{Math.round(parseFloat(item.totalPrice || (parseFloat(item.quantity || 0) * parseFloat(item.unitPrice || item.variant?.price || 0))))}</span>
                                                      </div>
                                                    </div>
                                                  ))
                                                ) : (
                                                  <>
                                                    <div className="mobile-card-row">
                                                      <span className="mobile-card-label">{language === 'en' ? 'Product' : 'পণ্য'}</span>
                                                      <span className="mobile-card-value" style={{ fontWeight: 600 }}>{order.productName || order.product?.name || '-'}</span>
                                                    </div>
                                                    <div className="mobile-card-row">
                                                      <span className="mobile-card-label">{language === 'en' ? 'Variant' : 'ভ্যারিয়েন্ট'}</span>
                                                      <span className="mobile-card-value">{order.variant?.productCode ? `${order.variant.productCode} (${order.variant.packSize} ${order.variant.packUnit || 'ml'}) [${order.variant.cartoonSize || 1} ${order.variant.cartoonUnit || 'Pcs'}]` : '-'}</span>
                                                    </div>
                                                    <div className="mobile-card-row">
                                                      <span className="mobile-card-label">{language === 'en' ? 'Qty' : 'পরিমাণ'}</span>
                                                      <span className="mobile-card-value" style={{ fontWeight: 600 }}>
                                                        {(() => {
                                                          const totalPurchasedQty = parseFloat(order.quantity) || 0
                                                          let totalFreeQty = 0
                                                          const orderProduct = (products || []).find(p => p._id === (order.product?._id || order.product))
                                                          if (orderProduct && orderProduct.hasOffer && orderProduct.buyQuantity && orderProduct.freeQuantity) {
                                                            const buyQty = parseFloat(orderProduct.buyQuantity) || 0
                                                            const freeQty = parseFloat(orderProduct.freeQuantity) || 0
                                                            if (buyQty > 0) {
                                                              const eligibleOffers = Math.floor(totalPurchasedQty / buyQty)
                                                              totalFreeQty = eligibleOffers * freeQty
                                                            }
                                                          }
                                                          return totalFreeQty > 0 ? `${totalPurchasedQty + totalFreeQty} (${totalFreeQty})` : totalPurchasedQty
                                                        })()}
                                                      </span>
                                                    </div>
                                                    <div className="mobile-card-row">
                                                      <span className="mobile-card-label">{language === 'en' ? 'Price' : 'দাম'}</span>
                                                      <span className="mobile-card-value">৳{Math.round(parseFloat(order.price || order.variant?.price || 0))}</span>
                                                    </div>
                                                    <div className="mobile-card-row">
                                                      <span className="mobile-card-label">{language === 'en' ? 'Subtotal' : 'উপ-মোট'}</span>
                                                      <span className="mobile-card-value" style={{ fontWeight: 700, color: '#16a34a' }}>৳{Math.round(parseFloat(order.totalPrice || (parseFloat(order.quantity || 0) * parseFloat(order.price || order.variant?.price || 0))))}</span>
                                                    </div>
                                                  </>
                                                )}
                                                <div className="mobile-card-row">
                                                  <span className="mobile-card-label">{language === 'en' ? 'Grand total' : 'সর্বমোট'}</span>
                                                  <span className="mobile-card-value" style={{ fontWeight: 700 }}>
                                                    ৳{Math.round(grandTotal)}
                                                  </span>
                                                </div>
                                                <div className="mobile-card-row">
                                                  <span className="mobile-card-label">{language === 'en' ? 'Paid' : 'পরিশোধিত'}</span>
                                                  <span className="mobile-card-value" style={{ color: '#16a34a' }}>
                                                    ৳{Math.round((paid + commission))}
                                                  </span>
                                                </div>
                                                <div className="mobile-card-row">
                                                  <span className="mobile-card-label">{language === 'en' ? 'Due' : 'বাকি'}</span>
                                                  <span className="mobile-card-value" style={{ color: due > 0 ? '#dc2626' : '#16a34a', fontWeight: 700 }}>
                                                    ৳{Math.round(due)}
                                                  </span>
                                                </div>
                                              </div>
                                            )}
                                          </div>
                                        )
                                      })
                                    )}
                                  </div>
                                </>
                              )
                              }
                            </>
                          )
                        })()}
                      </div >
                    )}

                    <div
                      style={{
                        display: showDealerOrders ? 'none' : 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',
                        gap: '1rem',
                        position: 'relative',
                        zIndex: 1
                      }}
                    >
                      {[
                        { key: 'regionId', label: language === 'en' ? 'Region ID' : 'অঞ্চল আইডি' },
                        { key: 'areaId', label: language === 'en' ? 'Area ID' : 'এলাকা আইডি' },
                        { key: 'territoryId', label: adminContent.territoryId },
                        { key: 'dealerId', label: language === 'en' ? 'CID' : 'সিআইডি' },
                        { key: 'shopName', label: language === 'en' ? 'Shop Name' : 'দোকানের নাম' },
                        { key: 'name', label: language === 'en' ? 'Customer Name' : 'কাস্টমারের নাম' },
                        { key: 'phone', label: language === 'en' ? 'Phone' : 'ফোন' },
                        { key: 'email', label: language === 'en' ? 'Email' : 'ইমেইল' },
                        { key: 'area', label: language === 'en' ? 'Area' : 'এলাকা' },
                        { key: 'nid', label: language === 'en' ? 'NID' : 'এনআইডি' },
                        { key: 'tradeLicense', label: language === 'en' ? 'Trade License' : 'ট্রেড লাইসেন্স' },
                        { key: 'pesticideLicense', label: language === 'en' ? 'Pesticides License' : 'কীটনাশক লাইসেন্স' }
                      ].map((item) => (
                        <div
                          key={item.label}
                          style={{
                            padding: '1rem',
                            backgroundColor: '#f9fafb',
                            borderRadius: '0.375rem'
                          }}
                        >
                          <div style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>{item.label}</div>
                          {isEditingDealer ? (
                            <input
                              type="text"
                              value={editingDealerData?.[item.key] || ''}
                              onChange={(e) =>
                                setEditingDealerData({
                                  ...editingDealerData,
                                  [item.key]: e.target.value
                                })
                              }
                              style={{
                                marginTop: '0.5rem',
                                width: '100%',
                                padding: '0.5rem',
                                borderRadius: '0.375rem',
                                border: '1px solid #d1d5db',
                                fontSize: '1rem',
                                color: '#111827'
                              }}
                            />
                          ) : (
                            <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', fontWeight: 600, color: '#111827' }}>
                              {viewingDealer?.[item.key] || 'N/A'}
                            </p>
                          )}
                        </div>
                      ))}

                      <div
                        style={{
                          gridColumn: '1 / -1',
                          padding: '1rem',
                          backgroundColor: '#f9fafb',
                          borderRadius: '0.375rem'
                        }}
                      >
                        <div style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                          {language === 'en' ? 'Address' : 'ঠিকানা'}
                        </div>
                        {isEditingDealer ? (
                          <textarea
                            value={editingDealerData?.address || ''}
                            onChange={(e) =>
                              setEditingDealerData({
                                ...editingDealerData,
                                address: e.target.value
                              })
                            }
                            rows={3}
                            style={{
                              marginTop: '0.5rem',
                              width: '100%',
                              padding: '0.5rem',
                              borderRadius: '0.375rem',
                              border: '1px solid #d1d5db',
                              fontSize: '1rem',
                              fontFamily: 'inherit',
                              color: '#111827',
                              resize: 'vertical'
                            }}
                          />
                        ) : (
                          <p
                            style={{
                              margin: '0.5rem 0 0 0',
                              fontSize: '1rem',
                              fontWeight: 600,
                              color: '#111827',
                              whiteSpace: 'pre-wrap'
                            }}
                          >
                            {viewingDealer.address || 'N/A'}
                          </p>
                        )}
                      </div>
                      <div
                        style={{
                          padding: '1rem',
                          backgroundColor: '#f9fafb',
                          borderRadius: '0.375rem'
                        }}
                      >
                        <div style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                          {language === 'en' ? 'Assign Salesman' : 'সেলসম্যান নির্ধারণ'}
                        </div>
                        {isEditingDealer ? (
                          <select
                            value={editingDealerData?.assignedTo || ''}
                            onChange={(e) => {
                              setEditingDealerData({
                                ...editingDealerData,
                                assignedTo: e.target.value,
                                assignedToName: '',
                                assignedToId: ''
                              })
                            }}
                            style={{
                              marginTop: '0.5rem',
                              width: '100%',
                              padding: '0.5rem',
                              borderRadius: '0.375rem',
                              border: '1px solid #d1d5db',
                              fontSize: '1rem',
                              color: '#111827'
                            }}
                          >
                            <option value="">{language === 'en' ? 'Select Salesman' : 'সেলসম্যান নির্বাচন করুন'}</option>
                            {salesEmployees.map((emp) => (
                              <option key={emp._id} value={emp._id}>
                                {emp.name} {emp.employeeId ? `(${emp.employeeId})` : ''}
                              </option>
                            ))}
                          </select>
                        ) : (
                          <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', fontWeight: 600, color: '#111827' }}>
                            {(viewingDealer.assignedToName || viewingDealer.assignedToId) || (language === 'en' ? 'Unassigned' : 'নির্ধারিত নয়')}
                          </p>
                        )}
                      </div>
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(260px, 1fr))', gap: '1rem' }}>
                        <div
                          style={{
                            padding: '1.25rem',
                            background: 'linear-gradient(180deg, #f8fbff 0%, #f2f7ff 100%)',
                            borderRadius: '0.75rem',
                            border: '1px solid #e5e7eb',
                            boxShadow: '0 15px 35px rgba(59,130,246,0.08)',
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '0.75rem'
                          }}
                        >
                          <div style={{ fontSize: '0.95rem', color: '#475569', fontWeight: 700 }}>
                            {language === 'en' ? 'Agreement' : 'চুক্তি'}
                          </div>
                          {(isEditingDealer ? editingDealerData?.agreement : viewingDealer.agreement) ? (
                            <a
                              href={isEditingDealer ? editingDealerData?.agreement : viewingDealer.agreement}
                              download={`${viewingDealer.shopName || viewingDealer.name || viewingDealer.dealerId || 'agreement'}.pdf`}
                              style={{
                                display: 'inline-flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                padding: '0.7rem 0.95rem',
                                background: '#3b82f6',
                                color: 'white',
                                fontWeight: 800,
                                borderRadius: '0.6rem',
                                textDecoration: 'none',
                                boxShadow: '0 10px 24px rgba(59,130,246,0.28)'
                              }}
                            >
                              {language === 'en' ? 'Download Agreement' : 'চুক্তি ডাউনলোড করুন'}
                            </a>
                          ) : (
                            <div style={{ color: '#94a3b8', fontWeight: 700 }}>
                              {language === 'en' ? 'No agreement uploaded' : 'কোনো চুক্তি নেই'}
                            </div>
                          )}
                          {isEditingDealer && (
                            <input
                              type="file"
                              accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                              onChange={async (e) => {
                                const file = e.target.files?.[0]
                                if (!file) return
                                try {
                                  const base64 = await fileToBase64(file)
                                  setEditingDealerData({
                                    ...editingDealerData,
                                    agreement: base64
                                  })
                                } catch (err) {
                                  console.error('Agreement upload failed', err)
                                }
                              }}
                              style={{
                                width: '100%',
                                padding: '0.55rem',
                                borderRadius: '0.5rem',
                                border: '1px solid #d1d5db',
                                backgroundColor: 'white',
                                cursor: 'pointer',
                                fontWeight: 600,
                                opacity: 0.65
                              }}
                            />
                          )}
                        </div>

                        <div
                          style={{
                            padding: '1rem',
                            backgroundColor: '#f9fafb',
                            borderRadius: '0.375rem',
                            border: '1px solid #e5e7eb',
                            textAlign: 'center'
                          }}
                        >
                          <div style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 700, marginBottom: '0.5rem' }}>
                            {language === 'en' ? 'Photo' : 'ছবি'}
                          </div>
                          {(isEditingDealer ? editingDealerData?.photo : viewingDealer.photo) ? (
                            <img
                              src={isEditingDealer ? editingDealerData?.photo : viewingDealer.photo}
                              alt={editingDealerData?.name || viewingDealer.name}
                              style={{ maxWidth: '240px', maxHeight: '240px', borderRadius: '0.75rem', border: '2px solid #e5e7eb', objectFit: 'cover' }}
                              onError={(e) => (e.target.style.display = 'none')}
                            />
                          ) : (
                            <div style={{ fontWeight: 700, color: '#94a3b8' }}>
                              {language === 'en' ? 'No photo' : 'ছবি নেই'}
                            </div>
                          )}
                          {isEditingDealer && (
                            <div style={{ marginTop: '0.75rem' }}>
                              <input
                                type="file"
                                accept="image/*"
                                onChange={async (e) => {
                                  const file = e.target.files?.[0]
                                  if (!file) return
                                  try {
                                    const base64 = await fileToBase64(file)
                                    setEditingDealerData({
                                      ...editingDealerData,
                                      photo: base64
                                    })
                                  } catch (err) {
                                    console.error('Photo upload failed', err)
                                  }
                                }}
                                style={{
                                  width: '100%',
                                  padding: '0.5rem',
                                  borderRadius: '0.375rem',
                                  border: '1px solid #d1d5db',
                                  backgroundColor: 'white',
                                  cursor: 'pointer',
                                  opacity: 0.65
                                }}
                              />
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )
          }

          {/* HR Tab */}
          {
            activeTab === 'hr' && (
              <div className="admin-tab-content">
                <div className="admin-tab-header" style={{ gap: '0.75rem', flexWrap: 'wrap' }}>
                  <h1 className="admin-page-title" style={{ flex: 1 }}>{adminContent.hr}</h1>
                  <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                    <button className="admin-add-btn" onClick={() => setShowEmployeeForm(true)}>
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                        <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                      </svg>
                      {adminContent.addNew}
                    </button>
                    <button
                      type="button"
                      onClick={() => loadEmployees()}
                      className="admin-add-btn"
                      style={{ backgroundColor: '#e2e8f0', color: '#0f172a' }}
                    >
                      {language === 'en' ? 'Refresh' : 'রিফ্রেশ'}
                    </button>
                  </div>
                </div>
                {loadingEmployees ? (
                  <LoadingSpinner text={language === 'en' ? 'Loading Employees...' : 'কর্মচারী লোড হচ্ছে...'} />
                ) : (
                  <>
                    <div className="admin-stats-grid">
                      <div className="admin-stat-card">
                        <div className="admin-stat-icon">
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                            <circle cx="9" cy="7" r="4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          </svg>
                        </div>
                        <div className="admin-stat-info">
                          <h3>{language === 'en' ? 'Total Employees' : 'মোট কর্মচারী'}</h3>
                          <p>{employees.length}</p>
                        </div>
                      </div>
                      <div className="admin-stat-card">
                        <div className="admin-stat-icon">
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          </svg>
                        </div>
                        <div className="admin-stat-info">
                          <h3>{language === 'en' ? 'Departments' : 'বিভাগ'}</h3>
                          <p>0</p>
                        </div>
                      </div>
                      <div className="admin-stat-card">
                        <div className="admin-stat-icon">
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                            <path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          </svg>
                        </div>
                        <div className="admin-stat-info">
                          <h3>{language === 'en' ? 'Leave Requests' : 'ছুটির অনুরোধ'}</h3>
                          <p>0</p>
                        </div>
                      </div>
                    </div>

                    {showEmployeeForm && (
                      <div className="admin-employee-form-overlay" style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        backgroundColor: 'rgba(0, 0, 0, 0.5)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        zIndex: 1000,
                        padding: '1rem'
                      }} onClick={() => {
                        setShowEmployeeForm(false)
                        setEmployeeStatus('')
                        setGeneratedCredentials(null)
                      }}>
                        <div className="admin-modal-content" onClick={(e) => e.stopPropagation()}>
                          <div style={{
                            position: 'absolute',
                            inset: 0,
                            pointerEvents: 'none',
                            overflow: 'hidden',
                            borderRadius: '0.75rem'
                          }}>
                            <div style={{
                              position: 'absolute',
                              width: '260px',
                              height: '260px',
                              top: '-120px',
                              left: '-80px',
                              background: 'radial-gradient(circle at 30% 30%, rgba(59,130,246,0.25), transparent 60%)',
                              filter: 'blur(20px)'
                            }} />
                            <div style={{
                              position: 'absolute',
                              width: '240px',
                              height: '240px',
                              bottom: '-140px',
                              right: '-100px',
                              background: 'radial-gradient(circle at 70% 70%, rgba(16,185,129,0.22), transparent 60%)',
                              filter: 'blur(20px)'
                            }} />
                          </div>

                          <div style={{ position: 'relative', display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', gap: '1rem' }}>
                            <div>
                              <h2 style={{ margin: 0, fontSize: '1.5rem', fontWeight: 800, color: '#0f172a' }}>
                                {language === 'en' ? 'Add Employee' : 'কর্মচারী যোগ করুন'}
                              </h2>
                              <p style={{ margin: '0.25rem 0 0 0', color: '#475569', fontWeight: 600 }}>
                                {language === 'en' ? 'Fill in employee details and save' : 'কর্মচারীর বিবরণ পূরণ করুন এবং সংরক্ষণ করুন'}
                              </p>
                            </div>
                            <button
                              onClick={() => {
                                setShowEmployeeForm(false)
                                setEmployeeStatus('')
                                setGeneratedCredentials(null)
                              }}
                              style={{
                                background: '#e2e8f0',
                                border: 'none',
                                padding: '0.4rem 0.65rem',
                                borderRadius: '0.375rem',
                                cursor: 'pointer',
                                fontWeight: 700,
                                color: '#475569'
                              }}
                            >
                              ×
                            </button>
                          </div>

                          <div style={{ position: 'relative', zIndex: 1 }}>
                            {employeeStatus && (
                              <div style={{
                                padding: '0.75rem',
                                marginBottom: '1rem',
                                borderRadius: '0.5rem',
                                border: employeeStatus.includes('fail') || employeeStatus.includes('ব্যর্থ') ? '1px solid #fecaca' : '1px solid #bbf7d0',
                                backgroundColor: employeeStatus.includes('fail') || employeeStatus.includes('ব্যর্থ') ? '#fef2f2' : '#ecfdf3',
                                color: employeeStatus.includes('fail') || employeeStatus.includes('ব্যর্থ') ? '#b91c1c' : '#065f46',
                                fontWeight: 700
                              }}>
                                {employeeStatus}
                              </div>
                            )}
                            {generatedCredentials && (
                              <div style={{
                                marginBottom: '1rem',
                                padding: '1rem',
                                backgroundColor: '#f0f9ff',
                                border: '2px solid #0ea5e9',
                                borderRadius: '0.5rem',
                                borderStyle: 'dashed'
                              }}>
                                <h4 style={{ marginTop: 0, marginBottom: '0.5rem', color: '#0369a1' }}>
                                  {language === 'en' ? 'Generated Login Credentials' : 'তৈরি করা লগইন পরিচয়পত্র'}
                                </h4>
                                <p style={{ margin: '0.25rem 0', fontSize: '0.875rem', color: '#0c4a6e' }}>
                                  <strong>{language === 'en' ? 'Username:' : 'ব্যবহারকারীর নাম:'}</strong> {generatedCredentials.username}
                                </p>
                                <p style={{ margin: '0.25rem 0', fontSize: '0.875rem', color: '#0c4a6e' }}>
                                  <strong>{language === 'en' ? 'Password:' : 'পাসওয়ার্ড:'}</strong> <span style={{ fontFamily: 'monospace', backgroundColor: '#fff', padding: '0.25rem 0.5rem', borderRadius: '0.25rem' }}>{generatedCredentials.password}</span>
                                </p>
                                <p style={{ margin: '0.5rem 0 0 0', fontSize: '0.75rem', color: '#dc2626', fontWeight: 600 }}>
                                  {language === 'en' ? '⚠️ Please save these credentials and share with the employee. This password will not be shown again.' : '⚠️ অনুগ্রহ করে এই পরিচয়পত্রগুলি সংরক্ষণ করুন এবং কর্মচারীর সাথে শেয়ার করুন। এই পাসওয়ার্ড আর দেখানো হবে না।'}
                                </p>
                                <button
                                  onClick={() => {
                                    setGeneratedCredentials(null)
                                    setShowEmployeeForm(false)
                                    setEmployeeStatus('')
                                  }}
                                  style={{
                                    marginTop: '0.75rem',
                                    padding: '0.5rem 1rem',
                                    backgroundColor: '#0ea5e9',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '0.375rem',
                                    cursor: 'pointer',
                                    fontSize: '0.875rem',
                                    fontWeight: 600
                                  }}
                                >
                                  {language === 'en' ? 'Close' : 'বন্ধ করুন'}
                                </button>
                              </div>
                            )}
                            <div className="admin-form-grid">
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Name' : 'নাম'}</label>
                                <input type="text" value={newEmployee.name} onChange={(e) => setNewEmployee({ ...newEmployee, name: e.target.value })} />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Email' : 'ইমেইল'}</label>
                                <input type="email" value={newEmployee.email} onChange={(e) => setNewEmployee({ ...newEmployee, email: e.target.value })} />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Phone' : 'ফোন'}</label>
                                <input type="tel" value={newEmployee.phone} onChange={(e) => setNewEmployee({ ...newEmployee, phone: e.target.value })} />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Address' : 'ঠিকানা'}</label>
                                <textarea value={newEmployee.address} onChange={(e) => setNewEmployee({ ...newEmployee, address: e.target.value })} rows={3} />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'NID (National ID)' : 'জাতীয় পরিচয়পত্র'}</label>
                                <input type="text" value={newEmployee.nid} onChange={(e) => setNewEmployee({ ...newEmployee, nid: e.target.value })} />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Document' : 'নথি'}</label>
                                <input
                                  type="file"
                                  accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                                  onChange={(e) => {
                                    const file = e.target.files[0]
                                    if (file) {
                                      const reader = new FileReader()
                                      reader.onloadend = () => {
                                        setNewEmployee({ ...newEmployee, document: reader.result })
                                      }
                                      reader.readAsDataURL(file)
                                    }
                                  }}
                                  style={{ width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', fontSize: '0.875rem' }}
                                />
                                {newEmployee.document && (
                                  <p style={{ marginTop: '0.5rem', fontSize: '0.75rem', color: '#16a34a' }}>
                                    {language === 'en' ? '✓ Document uploaded' : '✓ নথি আপলোড হয়েছে'}
                                  </p>
                                )}
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Emergency Contact Name' : 'জরুরি যোগাযোগের নাম'}</label>
                                <input type="text" value={newEmployee.emergencyContactName} onChange={(e) => setNewEmployee({ ...newEmployee, emergencyContactName: e.target.value })} />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Emergency Contact' : 'জরুরি যোগাযোগ'}</label>
                                <input type="text" value={newEmployee.emergencyContact} onChange={(e) => setNewEmployee({ ...newEmployee, emergencyContact: e.target.value })} placeholder={language === 'en' ? 'Phone or Email' : 'ফোন বা ইমেইল'} />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Salary' : 'বেতন'}</label>
                                <input type="number" value={newEmployee.salary} onChange={(e) => setNewEmployee({ ...newEmployee, salary: e.target.value })} min="0" />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Sales Target' : 'বিক্রয় লক্ষ্য'}</label>
                                <input type="number" value={newEmployee.salesTarget} onChange={(e) => setNewEmployee({ ...newEmployee, salesTarget: e.target.value })} min="0" />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Bank Name' : 'ব্যাংকের নাম'}</label>
                                <input type="text" value={newEmployee.bankName} onChange={(e) => setNewEmployee({ ...newEmployee, bankName: e.target.value })} />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Branch' : 'শাখা'}</label>
                                <input type="text" value={newEmployee.bankBranch} onChange={(e) => setNewEmployee({ ...newEmployee, bankBranch: e.target.value })} />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Account No.' : 'একাউন্ট নং'}</label>
                                <input type="text" value={newEmployee.accountNumber} onChange={(e) => setNewEmployee({ ...newEmployee, accountNumber: e.target.value })} />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Department' : 'বিভাগ'}</label>
                                <input type="text" value={newEmployee.department} onChange={(e) => setNewEmployee({ ...newEmployee, department: e.target.value })} />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Role' : 'ভূমিকা'}</label>
                                <select
                                  value={newEmployee.role}
                                  onChange={(e) => setNewEmployee({ ...newEmployee, role: e.target.value })}
                                  style={{ width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', fontSize: '0.875rem' }}
                                >
                                  <option value="">{language === 'en' ? 'Select Role' : 'ভূমিকা নির্বাচন করুন'}</option>
                                  <option value="Admin">Admin</option>
                                  <option value="RSM">RSM</option>
                                  <option value="Incharge">Incharge</option>
                                  <option value="SalesMan">SalesMan</option>
                                </select>
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Designation' : 'পদবি'}</label>
                                <input type="text" value={newEmployee.designation} onChange={(e) => setNewEmployee({ ...newEmployee, designation: e.target.value })} />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Region ID' : 'অঞ্চল আইডি'}</label>
                                <select
                                  value={newEmployee.regionId}
                                  onChange={(e) => setNewEmployee({ ...newEmployee, regionId: e.target.value, areaId: '', territoryId: '', postingArea: '' })}
                                  style={{ width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', fontSize: '0.875rem' }}
                                >
                                  <option value="">{language === 'en' ? 'Select Region' : 'অঞ্চল নির্বাচন করুন'}</option>
                                  {uniqueRegionIds.map(id => <option key={id} value={id}>{id}</option>)}
                                </select>
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Area ID' : 'এলাকা আইডি'}</label>
                                <select
                                  value={newEmployee.areaId}
                                  onChange={(e) => setNewEmployee({ ...newEmployee, areaId: e.target.value, territoryId: '', postingArea: '' })}
                                  disabled={!newEmployee.regionId}
                                  style={{ width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', fontSize: '0.875rem' }}
                                >
                                  <option value="">{language === 'en' ? 'Select Area' : 'এলাকা নির্বাচন করুন'}</option>
                                  {employeeAvailableAreaIds.map(id => <option key={id} value={id}>{id}</option>)}
                                </select>
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Territory ID' : 'টেরিটরি আইডি'}</label>
                                <select
                                  value={newEmployee.territoryId}
                                  onChange={(e) => {
                                    const tid = e.target.value;
                                    const found = territories.find(t => t.territoryId === tid);
                                    let fullArea = '';
                                    if (found) {
                                      fullArea = `${found.division}, ${found.zilla}, ${found.area}`;
                                    }
                                    setNewEmployee({
                                      ...newEmployee,
                                      territoryId: tid,
                                      postingArea: fullArea
                                    });
                                  }}
                                  disabled={!newEmployee.areaId}
                                  style={{ width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', fontSize: '0.875rem' }}
                                >
                                  <option value="">{language === 'en' ? 'Select Territory' : 'টেরিটরি নির্বাচন করুন'}</option>
                                  {employeeAvailableTerritoryIds.map(id => <option key={id} value={id}>{id}</option>)}
                                </select>
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Posting Area' : 'পোস্টিং এরিয়া'}</label>
                                <input
                                  type="text"
                                  value={newEmployee.postingArea}
                                  readOnly
                                  placeholder={language === 'en' ? 'Select Territory to see info' : 'তথ্য দেখতে টেরিটরি নির্বাচন করুন'}
                                  style={{ backgroundColor: '#f9fafb', cursor: 'not-allowed' }}
                                />
                              </div>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Upload Photo' : 'ছবি আপলোড করুন'}</label>
                                <input
                                  type="file"
                                  accept="image/*"
                                  onChange={async (e) => {
                                    const file = e.target.files?.[0]
                                    if (!file) return
                                    try {
                                      const base64 = await fileToBase64(file)
                                      setNewEmployee({ ...newEmployee, photo: base64 })
                                    } catch (err) {
                                      console.error('Photo upload failed', err)
                                    }
                                  }}
                                  style={{ width: '100%', padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', fontSize: '0.875rem' }}
                                />
                                {newEmployee.photo && (
                                  <p style={{ marginTop: '0.5rem', fontSize: '0.75rem', color: '#16a34a' }}>
                                    {language === 'en' ? '✓ Photo ready' : '✓ ছবি প্রস্তুত'}
                                  </p>
                                )}
                              </div>
                            </div>
                            <div style={{ display: 'flex', gap: '0.75rem', marginTop: '1rem' }}>
                              <button className="admin-save-btn" onClick={async () => {
                                try {
                                  setEmployeeStatus(language === 'en' ? 'Saving...' : 'সংরক্ষণ করা হচ্ছে...')
                                  setGeneratedCredentials(null)

                                  // Prepare employee data - ensure all fields are included
                                  const employeeData = {
                                    name: newEmployee.name || '',
                                    email: newEmployee.email || '',
                                    phone: newEmployee.phone || '',
                                    address: newEmployee.address || '',
                                    nid: newEmployee.nid || '',
                                    document: newEmployee.document || '',
                                    emergencyContactName: newEmployee.emergencyContactName || '',
                                    emergencyContact: newEmployee.emergencyContact || '',
                                    salary: newEmployee.salary || 0,
                                    salesTarget: newEmployee.salesTarget || 0,
                                    bankName: newEmployee.bankName || '',
                                    bankBranch: newEmployee.bankBranch || '',
                                    accountNumber: newEmployee.accountNumber || '',
                                    department: newEmployee.department || '',
                                    regionId: newEmployee.regionId || '',
                                    areaId: newEmployee.areaId || '',
                                    territoryId: newEmployee.territoryId || '',
                                    postingArea: newEmployee.postingArea || '',
                                    role: newEmployee.role || '',
                                    designation: newEmployee.designation || '',
                                    photo: newEmployee.photo || '',
                                    status: newEmployee.status || 'Unpaid'
                                  }

                                  console.log('[Frontend] Sending employee data:', { ...employeeData, document: employeeData.document ? 'Base64 data (hidden)' : 'No document' })

                                  const res = await fetch(`${API_BASE}/api/employees`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(employeeData)
                                  })
                                  if (!res.ok) {
                                    const errorData = await res.json().catch(() => ({}))
                                    console.error('[Frontend] Employee creation failed:', errorData)
                                    throw new Error(errorData.message || errorData.error || 'Failed to create employee')
                                  }
                                  const data = await res.json()
                                  console.log('[Frontend] Employee created successfully:', {
                                    employeeId: data.data?.employeeId,
                                    name: data.data?.name,
                                    hasAddress: !!data.data?.address,
                                    hasNID: !!data.data?.nid,
                                    hasDocument: !!data.data?.document,
                                    salary: data.data?.salary
                                  })
                                  setEmployees([
                                    { ...data.data, status: normalizeSalaryStatus(data.data.status) },
                                    ...employees.map((e) => ({ ...e, status: normalizeSalaryStatus(e.status) }))
                                  ])

                                  // Show generated credentials
                                  if (data.data.generatedPassword) {
                                    setGeneratedCredentials({
                                      username: data.data.username,
                                      password: data.data.generatedPassword
                                    })
                                    setEmployeeStatus(language === 'en' ? 'Employee created! Credentials generated below.' : 'কর্মচারী তৈরি হয়েছে! নিচে পরিচয়পত্র দেখুন।')
                                  } else {
                                    setEmployeeStatus(language === 'en' ? 'Saved to database' : 'ডাটাবেজে সংরক্ষিত')
                                  }

                                  setNewEmployee({ name: '', email: '', phone: '', address: '', nid: '', document: '', emergencyContactName: '', emergencyContact: '', salary: '', salesTarget: '', bankName: '', bankBranch: '', accountNumber: '', department: '', regionId: '', areaId: '', territoryId: '', postingArea: '', role: '', designation: '', photo: '', status: 'Unpaid' })
                                  // Don't close form if credentials are shown
                                  if (!data.data.generatedPassword) {
                                    setShowEmployeeForm(false)
                                  }
                                } catch (err) {
                                  setEmployeeStatus(language === 'en' ? `Save failed: ${err.message}` : `সংরক্ষণ ব্যর্থ: ${err.message}`)
                                }
                              }}>
                                {language === 'en' ? 'Save' : 'সংরক্ষণ'}
                              </button>
                              <button className="admin-remove-btn" onClick={() => {
                                setShowEmployeeForm(false);
                                setEmployeeStatus('');
                                setGeneratedCredentials(null);
                              }}>
                                {language === 'en' ? 'Cancel' : 'বাতিল'}
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}

                    <div className="admin-search-bar" style={{ marginTop: '1.5rem', marginBottom: '1rem' }}>
                      <input
                        type="text"
                        placeholder={language === 'en' ? 'Search employees...' : 'কর্মচারী খুঁজুন...'}
                        value={employeeSearch || ''}
                        onChange={(e) => setEmployeeSearch(e.target.value)}
                      />
                    </div>
                    <div className="admin-table-container">
                      <table className="admin-table">
                        <thead>
                          <tr>
                            <th
                              onClick={() => handleSortEmployees('employeeId')}
                              style={{ cursor: 'pointer', userSelect: 'none' }}
                            >
                              {language === 'en' ? 'ID' : 'আইডি'}
                              {employeeSortField === 'employeeId' && (employeeSortDirection === 'asc' ? ' ↑' : ' ↓')}
                            </th>
                            <th
                              onClick={() => handleSortEmployees('name')}
                              style={{ cursor: 'pointer', userSelect: 'none' }}
                            >
                              {language === 'en' ? 'Name' : 'নাম'}
                              {employeeSortField === 'name' && (employeeSortDirection === 'asc' ? ' ↑' : ' ↓')}
                            </th>
                            <th
                              onClick={() => handleSortEmployees('phone')}
                              style={{ cursor: 'pointer', userSelect: 'none' }}
                            >
                              {language === 'en' ? 'Phone' : 'ফোন'}
                              {employeeSortField === 'phone' && (employeeSortDirection === 'asc' ? ' ↑' : ' ↓')}
                            </th>
                            <th
                              onClick={() => handleSortEmployees('designation')}
                              style={{ cursor: 'pointer', userSelect: 'none' }}
                            >
                              {language === 'en' ? 'Designation' : 'পদবি'}
                              {employeeSortField === 'designation' && (employeeSortDirection === 'asc' ? ' ↑' : ' ↓')}
                            </th>
                            <th
                              onClick={() => handleSortEmployees('postingArea')}
                              style={{ cursor: 'pointer', userSelect: 'none' }}
                            >
                              {language === 'en' ? 'Posting Area' : 'পোস্টিং এলাকা'}
                              {employeeSortField === 'postingArea' && (employeeSortDirection === 'asc' ? ' ↑' : ' ↓')}
                            </th>
                            <th
                              onClick={() => handleSortEmployees('salary')}
                              style={{ cursor: 'pointer', userSelect: 'none' }}
                            >
                              {language === 'en' ? 'Salary' : 'বেতন'}
                              {employeeSortField === 'salary' && (employeeSortDirection === 'asc' ? ' ↑' : ' ↓')}
                            </th>
                            <th
                              onClick={() => handleSortEmployees('salesTarget')}
                              style={{ cursor: 'pointer', userSelect: 'none' }}
                            >
                              {language === 'en' ? 'Sales Target' : 'বিক্রয় লক্ষ্য'}
                              {employeeSortField === 'salesTarget' && (employeeSortDirection === 'asc' ? ' ↑' : ' ↓')}
                            </th>
                            <th
                              onClick={() => handleSortEmployees('salaryStatus')}
                              style={{ cursor: 'pointer', userSelect: 'none' }}
                            >
                              {language === 'en' ? 'Salary Status' : 'বেতন স্থিতি'}
                              {employeeSortField === 'salaryStatus' && (employeeSortDirection === 'asc' ? ' ↑' : ' ↓')}
                            </th>
                            <th>{language === 'en' ? 'Actions' : 'কার্যক্রম'}</th>
                          </tr>
                        </thead>
                        <tbody>
                          {sortedEmployees.length === 0 ? (
                            <tr>
                              <td colSpan="9" style={{ textAlign: 'center', padding: '1.5rem' }}>
                                {adminContent.noData}
                              </td>
                            </tr>
                          ) : (
                            sortedEmployees.map((emp, idx) => (
                              <tr key={emp._id || idx}>
                                <td>{emp.employeeId || 'N/A'}</td>
                                <td>{emp.name || 'N/A'}</td>
                                <td>{emp.phone || 'N/A'}</td>
                                <td>{emp.designation || 'N/A'}</td>
                                <td>{emp.postingArea || emp.area || 'N/A'}</td>
                                <td>
                                  {emp.salary ? `${language === 'en' ? '৳' : '৳'} ${Math.round(parseFloat(emp.salary)).toLocaleString()}` : 'N/A'}
                                </td>
                                <td>
                                  {emp.salesTarget ? `${language === 'en' ? '৳' : '৳'} ${Math.round(parseFloat(emp.salesTarget)).toLocaleString()}` : (
                                    (emp.role || '').toUpperCase() === 'RSM' ? 'Set in Revenue' : 'N/A'
                                  )}
                                </td>
                                <td>{normalizeSalaryStatus(emp.status)}</td>
                                <td>
                                  <button
                                    className="admin-action-btn"
                                    style={{ backgroundColor: '#3b82f6', color: 'white' }}
                                    onClick={async () => {
                                      // Fetch latest employee data to ensure password is up to date
                                      try {
                                        const res = await fetch(`${API_BASE}/api/employees/${emp._id}`)
                                        if (res.ok) {
                                          const data = await res.json()
                                          console.log('[View Employee] Fetched employee data:', {
                                            _id: data.data._id,
                                            name: data.data.name,
                                            username: data.data.username,
                                            hasPlainPassword: false,
                                            plainPassword: 'hidden'
                                          })
                                          setViewingEmployee({ ...data.data, status: normalizeSalaryStatus(data.data.status) })
                                          setLastGeneratedPassword(data.data.generatedPassword || '')
                                          setShowSalesHistory(false) // Show employee details by default
                                          setShowAssignedDealers(false) // Show employee details by default
                                        } else {
                                          // Fallback to existing data if fetch fails
                                          console.log('[View Employee] Using cached employee data:', emp)
                                          setViewingEmployee({ ...emp, status: normalizeSalaryStatus(emp.status) })
                                          setLastGeneratedPassword(emp.generatedPassword || '')
                                          setShowSalesHistory(false) // Show employee details by default
                                          setShowAssignedDealers(false) // Show employee details by default
                                        }
                                      } catch (err) {
                                        console.error('Failed to fetch employee details', err)
                                        // Fallback to existing data if fetch fails
                                        setViewingEmployee({ ...emp, status: normalizeSalaryStatus(emp.status) })
                                        setLastGeneratedPassword(emp.generatedPassword || '')
                                        setShowSalesHistory(false) // Show employee details by default
                                      }
                                    }}
                                  >
                                    {adminContent.view}
                                  </button>
                                </td>
                              </tr>
                            ))
                          )}
                        </tbody>
                      </table>
                    </div>

                    {/* Mobile Card View for Employees */}
                    <div className="mobile-card-container">
                      {sortedEmployees.length === 0 ? (
                        <div style={{ textAlign: 'center', padding: '2rem', color: '#6b7280' }}>
                          {adminContent.noData}
                        </div>
                      ) : (
                        sortedEmployees.map((emp, idx) => (
                          <div className="mobile-card" key={emp._id || idx}>
                            <div
                              className="mobile-card-header"
                              onClick={() => setExpandedEmployeeId(prev => (prev === emp._id ? null : emp._id))}
                              style={{ cursor: 'pointer' }}
                            >
                              <div className="mobile-card-avatar">
                                {emp.photo ? (
                                  <img src={emp.photo} alt={emp.name} style={{ width: '100%', height: '100%', objectFit: 'cover', borderRadius: '50%' }} />
                                ) : (
                                  (emp.name || '?').charAt(0).toUpperCase()
                                )}
                              </div>
                              <div className="mobile-card-header-text">
                                <div className="mobile-card-title">{emp.name || 'N/A'}</div>
                                <div className="mobile-card-subtitle">{emp.employeeId || 'N/A'}</div>
                                <div className="mobile-card-subtitle" style={{ fontSize: '0.75rem', marginTop: '0.1rem' }}>
                                  {emp.designation || '-'}
                                </div>
                              </div>
                              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', marginLeft: 'auto', alignSelf: 'stretch', justifyContent: 'space-between', flexShrink: 0, paddingBottom: 0 }}>
                                <div className="mobile-card-status-badge" style={{
                                  backgroundColor: emp.status === 'Paid' ? '#dcfce7' : '#fee2e2',
                                  color: emp.status === 'Paid' ? '#166534' : '#dc2626',
                                  margin: 0,
                                  whiteSpace: 'nowrap',
                                  alignSelf: 'flex-end'
                                }}>
                                  {normalizeSalaryStatus(emp.status)}
                                </div>
                                {emp.salary && (
                                  <div style={{ fontSize: '0.9rem', fontWeight: 700, color: '#475569', marginTop: '2rem' }}>
                                    {language === 'en' ? '৳' : '৳'} {Math.round(parseFloat(emp.salary)).toLocaleString()}
                                  </div>
                                )}
                              </div>
                            </div>

                            {expandedEmployeeId === emp._id && (
                              <>
                                <div className="mobile-card-body">
                                  <div className="mobile-card-row">
                                    <span className="mobile-card-label">{language === 'en' ? 'Designation' : 'পদবি'}</span>
                                    <span className="mobile-card-value">{emp.designation || 'N/A'}</span>
                                  </div>
                                  <div className="mobile-card-row">
                                    <span className="mobile-card-label">{language === 'en' ? 'Phone' : 'ফোন'}</span>
                                    <span className="mobile-card-value">{emp.phone || 'N/A'}</span>
                                  </div>
                                  <div className="mobile-card-row">
                                    <span className="mobile-card-label">{language === 'en' ? 'Area' : 'এলাকা'}</span>
                                    <span className="mobile-card-value">{emp.postingArea || emp.area || 'N/A'}</span>
                                  </div>
                                  <div className="mobile-card-row">
                                    <span className="mobile-card-label">{language === 'en' ? 'Salary' : 'বেতন'}</span>
                                    <span className="mobile-card-value">
                                      {emp.salary ? `${language === 'en' ? '৳' : '৳'} ${Math.round(parseFloat(emp.salary)).toLocaleString()}` : 'N/A'}
                                    </span>
                                  </div>
                                  <div className="mobile-card-row">
                                    <span className="mobile-card-label">{language === 'en' ? 'Sales Target' : 'বিক্রয় লক্ষ্য'}</span>
                                    <span className="mobile-card-value">
                                      {emp.salesTarget ? `${language === 'en' ? '৳' : '৳'} ${Math.round(parseFloat(emp.salesTarget)).toLocaleString()}` : (
                                        (emp.role || '').toUpperCase() === 'RSM' ? 'Set in Revenue' : 'N/A'
                                      )}
                                    </span>
                                  </div>
                                </div>
                                <div className="mobile-card-actions">
                                  <button
                                    className="mobile-action-btn"
                                    onClick={async (e) => {
                                      e.stopPropagation()
                                      try {
                                        const res = await fetch(`${API_BASE}/api/employees/${emp._id}`)
                                        if (res.ok) {
                                          const data = await res.json()
                                          setViewingEmployee({ ...data.data, status: normalizeSalaryStatus(data.data.status) })
                                          setLastGeneratedPassword(data.data.generatedPassword || '')
                                          setShowSalesHistory(false)
                                          setShowAssignedDealers(false)
                                        } else {
                                          setViewingEmployee({ ...emp, status: normalizeSalaryStatus(emp.status) })
                                          setLastGeneratedPassword(emp.generatedPassword || '')
                                          setShowSalesHistory(false)
                                          setShowAssignedDealers(false)
                                        }
                                      } catch (err) {
                                        setViewingEmployee({ ...emp, status: normalizeSalaryStatus(emp.status) })
                                        setLastGeneratedPassword(emp.generatedPassword || '')
                                        setShowSalesHistory(false)
                                      }
                                    }}
                                  >
                                    {adminContent.view}
                                  </button>
                                </div>
                              </>
                            )}
                          </div>
                        ))
                      )}
                    </div>
                  </>
                )}

                {/* Employee Details Modal */}
                {viewingEmployee && (
                  <div className="admin-employee-view-overlay" style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000,
                    padding: '1rem'
                  }} onClick={() => {
                    setViewingEmployee(null)
                    setIsEditingEmployee(false)
                    setEditingEmployeeData(null)
                    setLastGeneratedPassword('')
                  }}>
                    <div className="admin-modal-content" onClick={(e) => e.stopPropagation()}>
                      <div style={{
                        position: 'absolute',
                        inset: 0,
                        pointerEvents: 'none',
                        overflow: 'hidden',
                        borderRadius: '0.75rem'
                      }}>
                        <div style={{
                          position: 'absolute',
                          width: '260px',
                          height: '260px',
                          top: '-120px',
                          left: '-80px',
                          background: 'radial-gradient(circle at 30% 30%, rgba(59,130,246,0.25), transparent 60%)',
                          filter: 'blur(20px)'
                        }} />
                        <div style={{
                          position: 'absolute',
                          width: '240px',
                          height: '240px',
                          bottom: '-140px',
                          right: '-100px',
                          background: 'radial-gradient(circle at 70% 70%, rgba(16,185,129,0.22), transparent 60%)',
                          filter: 'blur(20px)'
                        }} />
                      </div>

                      <div className="admin-employee-view-header" style={{ position: 'relative', display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', gap: '1rem' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                          <div style={{
                            width: 80,
                            height: 80,
                            borderRadius: '50%',
                            overflow: 'hidden',
                            border: '3px solid rgba(255,255,255,0.9)',
                            boxShadow: '0 10px 30px rgba(0,0,0,0.12)',
                            background: '#e5e7eb',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontWeight: 700,
                            fontSize: '1.5rem',
                            color: '#111827'
                          }}>
                            {viewingEmployee.photo ? (
                              <img src={viewingEmployee.photo} alt={viewingEmployee.name} style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                            ) : (
                              (viewingEmployee.name || 'E').charAt(0)
                            )}
                          </div>
                          <div>
                            <h2 style={{ margin: 0, fontSize: '1.5rem', fontWeight: 800, color: '#0f172a' }}>
                              {viewingEmployee.name || (language === 'en' ? 'Employee' : 'কর্মচারী')}
                            </h2>
                            <p style={{ margin: '0.25rem 0 0 0', color: '#475569', fontWeight: 600 }}>{viewingEmployee.designation || viewingEmployee.role || ''}</p>
                          </div>
                        </div>
                        <div className="admin-employee-view-buttons" style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                          <button
                            onClick={() => {
                              setShowSalesHistory((prev) => !prev)
                              setShowAssignedDealers(false)
                            }}
                            style={{
                              padding: '0.6rem 1.1rem',
                              backgroundColor: '#3b82f6',
                              color: 'white',
                              border: 'none',
                              borderRadius: '0.5rem',
                              cursor: 'pointer',
                              fontWeight: 700,
                              fontSize: '0.9rem',
                              boxShadow: '0 10px 20px rgba(59,130,246,0.35)'
                            }}
                          >
                            {showSalesHistory
                              ? (language === 'en' ? 'Back' : 'পেছনে যান')
                              : (language === 'en' ? 'Sales History' : 'বিক্রয় ইতিহাস')}
                          </button>
                          {!showSalesHistory && (
                            <button
                              onClick={() => {
                                setShowAssignedDealers((prev) => !prev)
                                setShowSalesHistory(false)
                              }}
                              style={{
                                padding: '0.6rem 1.1rem',
                                backgroundColor: '#10b981',
                                color: 'white',
                                border: 'none',
                                borderRadius: '0.5rem',
                                cursor: 'pointer',
                                fontWeight: 700,
                                fontSize: '0.9rem',
                                boxShadow: '0 10px 20px rgba(16,185,129,0.35)'
                              }}
                            >
                              {showAssignedDealers
                                ? (language === 'en' ? 'Back' : 'পেছনে যান')
                                : (language === 'en' ? 'Dealers' : 'ডিলার')}
                            </button>
                          )}
                          <button
                            onClick={() => {
                              setViewingEmployee(null)
                              setIsEditingEmployee(false)
                              setEditingEmployeeData(null)
                            }}
                            style={{
                              background: '#e2e8f0',
                              border: 'none',
                              padding: '0.4rem 0.65rem',
                              borderRadius: '0.375rem',
                              cursor: 'pointer',
                              fontWeight: 700,
                              color: '#475569'
                            }}
                          >
                            ×
                          </button>
                        </div>
                      </div>

                      {showSalesHistory ? (
                        <div className="admin-employee-sales-history-section" style={{ marginTop: '1rem', display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                          {(() => {
                            // Check if viewing employee is RSM
                            const isRSM = (viewingEmployee?.role || '').toLowerCase() === 'rsm'

                            // For RSM: calculate sales target as sum of all salesmen's targets
                            // For others: use their own sales target
                            // For RSM: use synced salesTarget from settings (or sum sum if 0/missing) -> Actually user wants synced target.
                            // Let's use viewingEmployee.salesTarget if available (which we synced).
                            // Logic: If isRSM && viewingEmployee.salesTarget > 0 => use it. Else => sum.
                            const syncedTarget = parseFloat(viewingEmployee.salesTarget) || 0
                            const calculatedSalesTarget = (isRSM && syncedTarget > 0)
                              ? syncedTarget
                              : (isRSM
                                ? (employees || []).reduce((sum, emp) => {
                                  if ((emp.role || '').toLowerCase() === 'salesman') {
                                    return sum + (parseFloat(emp.salesTarget) || 0)
                                  }
                                  return sum
                                }, 0)
                                : (parseFloat(viewingEmployee.salesTarget) || 0)
                              )

                            // Calculate individual employee's total collection and total due
                            // Include both employee-created orders AND admin-created orders for assigned dealers
                            const employeeId = viewingEmployee?._id || ''

                            // Get all dealers assigned to this employee
                            const assignedDealerIds = (dealers || [])
                              .filter(dealer => {
                                const assignedToId = dealer.assignedTo?._id || dealer.assignedTo || ''
                                return String(assignedToId) === String(employeeId)
                              })
                              .map(dealer => ({
                                _id: String(dealer._id || ''),
                                dealerId: String(dealer.dealerId || '')
                              }))
                              .filter(d => d._id || d.dealerId)

                            // Filter orders: employee-created OR admin-created for assigned dealers
                            const employeeOrders = (orders || []).filter(order => {
                              const orderRequestedBy = order.requestedBy?._id || order.requestedBy || ''
                              const isEmployeeOrder = String(orderRequestedBy) === String(employeeId)

                              // Check if this is an admin-created order for an assigned dealer
                              const isAdminOrder = (order.requestedByRole || '').toLowerCase() === 'admin'
                              let isAdminOrderForAssignedDealer = false

                              if (isAdminOrder) {
                                const orderDealerId = order.dealer?._id || order.dealer || ''
                                const orderDealerIdString = String(orderDealerId)
                                const orderDealerIdFromDealer = order.dealerId || ''

                                isAdminOrderForAssignedDealer = assignedDealerIds.some(assignedDealer =>
                                  assignedDealer._id === orderDealerIdString ||
                                  assignedDealer.dealerId === orderDealerIdFromDealer ||
                                  (order.dealer && String(order.dealer._id || order.dealer) === assignedDealer._id)
                                )
                              }

                              return isEmployeeOrder || isAdminOrderForAssignedDealer
                            })

                            // Calculate date range for Current Month
                            const now = new Date()
                            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1)
                            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999)

                            // Filter orders by Current Month
                            // For RSM: Achieved Target = Total Revnue Achieved (All orders) for Current Month
                            // For others: calculate from own approved orders + admin-created orders for assigned dealers
                            let employeeAchievedTarget = 0
                            if (isRSM) {
                              // RSM gets credit for ALL approved orders in the current month (Company Wide)
                              // This matches the "Achieve Amount" in Revenue Dashboard
                              const allOrdersCurrentMonth = (orders || []).filter(order => {
                                const d = new Date(order.createdAt)
                                return d >= startOfMonth && d <= endOfMonth
                              })

                              employeeAchievedTarget = allOrdersCurrentMonth
                                .filter(order => order.approvalStatus === 'Approved' && order.status !== 'Cancelled')
                                .reduce((sum, order) => sum + (parseFloat(order.totalPrice || 0) * (order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1)), 0)

                            } else {
                              // Calculate achieved target from:
                              // 1. Employee-created approved orders (excluding cancelled)
                              // 2. Admin-created approved orders for dealers assigned to this employee (excluding cancelled)
                              // 3. FILTERED by Current Month
                              employeeAchievedTarget = employeeOrders
                                .filter(order => {
                                  const d = new Date(order.createdAt)
                                  return (
                                    order.approvalStatus === 'Approved' &&
                                    order.status !== 'Cancelled' &&
                                    order.approvalStatus !== 'Rejected' &&
                                    d >= startOfMonth && d <= endOfMonth
                                  )
                                }).reduce((sum, order) => {
                                  return sum + (parseFloat(order.totalPrice || 0) * (order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1))
                                }, 0)
                            }

                            let employeeTotalCollection = 0
                            let employeeTotalDue = 0

                            if (isRSM) {
                              // RSM gets stats from ALL orders in the current month (Company Wide)
                              const allOrdersCurrentMonth = (orders || []).filter(order => {
                                const d = new Date(order.createdAt)
                                return d >= startOfMonth && d <= endOfMonth && order.status !== 'Cancelled' && order.approvalStatus !== 'Rejected'
                              })

                              employeeTotalCollection = allOrdersCurrentMonth.reduce((sum, order) => {
                                const paid = Number(order.paidAmount || 0)
                                const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                                return sum + (paid + commission)
                              }, 0)

                              employeeTotalDue = allOrdersCurrentMonth.reduce((sum, order) => {
                                const totalPrice = Number(order.totalPrice || 0)
                                const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                const grandTotal = totalPrice * discount
                                const paid = Number(order.paidAmount || 0)
                                const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                                const due = Math.max(0, grandTotal - (paid + commission))
                                return sum + due
                              }, 0)
                            } else {
                              // Filter employee orders by month
                              const monthlyEmployeeOrders = employeeOrders.filter(order => {
                                const d = new Date(order.createdAt)
                                return d >= startOfMonth && d <= endOfMonth && order.status !== 'Cancelled' && order.approvalStatus !== 'Rejected'
                              })

                              employeeTotalCollection = monthlyEmployeeOrders.reduce((sum, order) => {
                                const paid = Number(order.paidAmount || 0)
                                const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                                return sum + (paid + commission)
                              }, 0)

                              employeeTotalDue = monthlyEmployeeOrders.reduce((sum, order) => {
                                const totalPrice = Number(order.totalPrice || 0)
                                const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                const grandTotal = totalPrice * discount
                                const paid = Number(order.paidAmount || 0)
                                const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                                const due = Math.max(0, grandTotal - (paid + commission))
                                return sum + due
                              }, 0)
                            }

                            return (
                              <div className="admin-employee-stats-grid" style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))',
                                gap: '0.75rem'
                              }}>
                                <div style={{ padding: '1rem', borderRadius: '0.5rem', backgroundColor: '#f8fafc', border: '1px solid #e5e7eb' }}>
                                  <div style={{ fontSize: '0.9rem', color: '#6b7280', fontWeight: 700 }}>
                                    {language === 'en' ? 'Total Target' : 'মোট টার্গেট'}
                                  </div>
                                  <div style={{ fontSize: '1.5rem', fontWeight: 800, color: '#0f172a', marginTop: '0.35rem' }}>
                                    ৳{Math.round(calculatedSalesTarget || 0).toLocaleString()}
                                  </div>
                                </div>
                                <div style={{ padding: '1rem', borderRadius: '0.5rem', backgroundColor: '#f0fdf4', border: '1px solid #dcfce7' }}>
                                  <div style={{ fontSize: '0.9rem', color: '#15803d', fontWeight: 700 }}>
                                    {language === 'en' ? 'Achieved Target' : 'অর্জিত টার্গেট'}
                                  </div>
                                  <div style={{ fontSize: '1.5rem', fontWeight: 800, color: '#166534', marginTop: '0.35rem' }}>
                                    ৳{Math.round(employeeAchievedTarget || 0).toLocaleString()}
                                  </div>
                                </div>
                                <div style={{ padding: '1rem', borderRadius: '0.5rem', backgroundColor: '#eef2ff', border: '1px solid #e0e7ff' }}>
                                  <div style={{ fontSize: '0.9rem', color: '#4338ca', fontWeight: 700 }}>
                                    {language === 'en' ? 'Progress' : 'অগ্রগতি'}
                                  </div>
                                  {(() => {
                                    const total = Number(calculatedSalesTarget || 0) || 0
                                    const achieved = Number(employeeAchievedTarget || 0) || 0
                                    const pct = total > 0 ? Math.min(100, Math.round((achieved / total) * 100)) : 0
                                    return (
                                      <div style={{ marginTop: '0.35rem' }}>
                                        <div style={{ height: '10px', background: '#e0e7ff', borderRadius: '999px', overflow: 'hidden' }}>
                                          <div style={{ width: `${pct}%`, height: '100%', background: 'linear-gradient(90deg, #4f46e5, #22c55e)' }} />
                                        </div>
                                        <div style={{ marginTop: '0.35rem', fontWeight: 700, color: '#312e81' }}>{pct}%</div>
                                      </div>
                                    )
                                  })()}
                                </div>
                                <div style={{ padding: '1rem', borderRadius: '0.5rem', backgroundColor: '#f8fafc', border: '1px solid #e5e7eb' }}>
                                  <div style={{ fontSize: '0.9rem', color: '#6b7280', fontWeight: 700 }}>
                                    {language === 'en' ? 'Total Collection' : 'মোট সংগ্রহ'}
                                  </div>
                                  <div style={{ fontSize: '1.4rem', fontWeight: 800, color: '#0f172a', marginTop: '0.35rem' }}>
                                    ৳{Math.round(employeeTotalCollection || 0).toLocaleString()}
                                  </div>
                                </div>
                                <div style={{ padding: '1rem', borderRadius: '0.5rem', backgroundColor: '#fff7ed', border: '1px solid #fed7aa' }}>
                                  <div style={{ fontSize: '0.9rem', color: '#c2410c', fontWeight: 700 }}>
                                    {language === 'en' ? 'Total Due' : 'মোট বকেয়া'}
                                  </div>
                                  <div style={{ fontSize: '1.4rem', fontWeight: 800, color: '#9a3412', marginTop: '0.35rem' }}>
                                    ৳{Math.round(employeeTotalDue || 0).toLocaleString()}
                                  </div>
                                </div>
                              </div>
                            )
                          })()
                          }

                          <h3 style={{ fontSize: '1.125rem', fontWeight: 700, color: '#0f172a', margin: '0.25rem 0' }}>
                            {language === 'en' ? 'Sales History' : 'বিক্রয় ইতিহাস'}
                          </h3>
                          {
                            viewingEmployee.salesHistory && Array.isArray(viewingEmployee.salesHistory) && viewingEmployee.salesHistory.length > 0 ? (
                              <>
                                <div className="admin-employee-sales-table-container admin-table-container" style={{
                                  border: '1px solid #e5e7eb',
                                  borderRadius: '0.5rem',
                                  overflow: 'hidden',
                                  backgroundColor: '#fff'
                                }}>
                                  <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <thead>
                                      <tr style={{ backgroundColor: '#f9fafb', borderBottom: '2px solid #e5e7eb' }}>
                                        <th style={{ padding: '0.75rem', textAlign: 'left', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                          {language === 'en' ? 'Date' : 'তারিখ'}
                                        </th>
                                        <th style={{ padding: '0.75rem', textAlign: 'left', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                          {language === 'en' ? 'Order ID' : 'অর্ডার আইডি'}
                                        </th>
                                        <th style={{ padding: '0.75rem', textAlign: 'left', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                          {language === 'en' ? 'Customer' : 'কাস্টমার'}
                                        </th>
                                        <th style={{ padding: '0.75rem', textAlign: 'right', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                          {language === 'en' ? 'Amount' : 'পরিমাণ'}
                                        </th>
                                        <th style={{ padding: '0.75rem', textAlign: 'right', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                          {language === 'en' ? 'Grand Total' : 'সর্বমোট'}
                                        </th>
                                        <th style={{ padding: '0.75rem', textAlign: 'left', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                          {language === 'en' ? 'Order Created By' : 'অর্ডার তৈরিকারী'}
                                        </th>
                                        <th style={{ padding: '0.75rem', textAlign: 'left', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                          {language === 'en' ? 'Approved By' : 'অনুমোদনকারী'}
                                        </th>
                                        <th style={{ padding: '0.75rem', textAlign: 'left', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                          {language === 'en' ? 'Status' : 'অবস্থা'}
                                        </th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {(() => {
                                        // Get all dealers assigned to this employee
                                        const employeeId = viewingEmployee?._id || ''
                                        const assignedDealerIds = (dealers || [])
                                          .filter(dealer => {
                                            const assignedToId = dealer.assignedTo?._id || dealer.assignedTo || ''
                                            return String(assignedToId) === String(employeeId)
                                          })
                                          .map(dealer => ({
                                            _id: String(dealer._id || ''),
                                            dealerId: String(dealer.dealerId || '')
                                          }))
                                          .filter(d => d._id || d.dealerId)

                                        return (viewingEmployee.salesHistory || [])
                                          .filter((sale) => {
                                            // Filter out deleted orders - only show if order still exists
                                            if (!sale || !sale.orderObjectId) return false

                                            const order = (orders || []).find(o => {
                                              if (!o) return false
                                              const orderIdMatch = o._id && sale.orderObjectId && (
                                                String(o._id) === String(sale.orderObjectId) ||
                                                String(o._id) === String(sale.orderObjectId._id || sale.orderObjectId)
                                              )
                                              const orderIdStringMatch = o.orderId && sale.orderId && (
                                                String(o.orderId) === String(sale.orderId)
                                              )
                                              return orderIdMatch || orderIdStringMatch
                                            })

                                            // Only show if order exists in the orders array
                                            if (!order) return false

                                            // Verify this order actually belongs to this employee
                                            const orderRequestedBy = order.requestedBy?._id || order.requestedBy || ''
                                            const isEmployeeOrder = String(orderRequestedBy) === String(employeeId)

                                            // Check if this is an admin-created order for an assigned dealer
                                            const isAdminOrder = (order.requestedByRole || '').toLowerCase() === 'admin'
                                            let isAdminOrderForAssignedDealer = false

                                            if (isAdminOrder) {
                                              const orderDealerId = order.dealer?._id || order.dealer || ''
                                              const orderDealerIdString = String(orderDealerId)
                                              const orderDealerIdFromDealer = order.dealerId || ''

                                              isAdminOrderForAssignedDealer = assignedDealerIds.some(assignedDealer =>
                                                assignedDealer._id === orderDealerIdString ||
                                                assignedDealer.dealerId === orderDealerIdFromDealer ||
                                                (order.dealer && String(order.dealer._id || order.dealer) === assignedDealer._id)
                                              )
                                            }

                                            // Only show if order belongs to this employee
                                            return isEmployeeOrder || isAdminOrderForAssignedDealer
                                          })
                                          // Remove duplicates - keep only the first occurrence of each order
                                          .filter((sale, index, self) => {
                                            // Get unique identifier for this sale entry
                                            const saleOrderObjectId = sale.orderObjectId?._id
                                              ? String(sale.orderObjectId._id)
                                              : (sale.orderObjectId ? String(sale.orderObjectId) : '')
                                            const saleOrderId = String(sale.orderId || '')

                                            // Find the first occurrence of this order (by orderObjectId or orderId)
                                            const firstIndex = self.findIndex(s => {
                                              const sOrderObjectId = s.orderObjectId?._id
                                                ? String(s.orderObjectId._id)
                                                : (s.orderObjectId ? String(s.orderObjectId) : '')
                                              const sOrderId = String(s.orderId || '')

                                              // Match by orderObjectId (preferred) or orderId
                                              return (saleOrderObjectId && sOrderObjectId && saleOrderObjectId === sOrderObjectId) ||
                                                (saleOrderId && sOrderId && saleOrderId === sOrderId && saleOrderId !== '')
                                            })

                                            // Only keep if this is the first occurrence
                                            return index === firstIndex
                                          })
                                          .map((sale, idx) => {
                                            // Find the order
                                            const order = (orders || []).find(o => {
                                              if (!o) return false
                                              const orderIdMatch = o._id && sale.orderObjectId && (
                                                String(o._id) === String(sale.orderObjectId) ||
                                                String(o._id) === String(sale.orderObjectId._id || sale.orderObjectId)
                                              )
                                              const orderIdStringMatch = o.orderId && sale.orderId && (
                                                String(o.orderId) === String(sale.orderId)
                                              )
                                              return orderIdMatch || orderIdStringMatch
                                            }) || {}

                                            const createdByName = order.requestedByName || order.requestedByRole || '-'
                                            const approvedByName = order.approvedByName || '-'

                                            return (
                                              <tr key={idx} style={{ borderBottom: '1px solid #f3f4f6' }}>
                                                <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#111827' }}>
                                                  {sale.date ? new Date(sale.date).toLocaleDateString() : (sale.createdAt ? new Date(sale.createdAt).toLocaleDateString() : (order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '-'))}
                                                </td>
                                                <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#111827', fontFamily: 'monospace' }}>
                                                  {customOrderIds[order._id] || order.orderId || sale.orderId || '-'}
                                                </td>
                                                <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#111827' }}>
                                                  {order.dealerName || (order.dealer && order.dealer.name) || sale.dealerName || '-'}
                                                </td>
                                                <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#111827', fontWeight: 500, textAlign: 'right' }}>
                                                  ৳{Number(order.totalPrice || sale.amount || sale.totalAmount || 0).toLocaleString()}
                                                </td>
                                                <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#16a34a', fontWeight: 700, textAlign: 'right' }}>
                                                  ৳{(() => {
                                                    const total = parseFloat(order.totalPrice || sale.amount || sale.totalAmount || 0)
                                                    const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                                    return (total * discount).toLocaleString()
                                                  })()}
                                                </td>
                                                <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#111827' }}>
                                                  {createdByName}
                                                </td>
                                                <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#111827' }}>
                                                  {approvedByName}
                                                </td>
                                                <td style={{ padding: '0.75rem' }}>
                                                  <span style={{
                                                    padding: '0.25rem 0.5rem',
                                                    borderRadius: '9999px',
                                                    fontSize: '0.75rem',
                                                    fontWeight: 500,
                                                    backgroundColor: (order.status === 'Delivered' || order.status === 'Completed') ? '#dcfce7' : ((order.status === 'Cancelled' || order.approvalStatus === 'Rejected') ? '#fee2e2' : '#fef9c3'),
                                                    color: (order.status === 'Delivered' || order.status === 'Completed') ? '#166534' : ((order.status === 'Cancelled' || order.approvalStatus === 'Rejected') ? '#991b1b' : '#854d0e')
                                                  }}>
                                                    {order.status || (language === 'en' ? 'Pending' : 'অপেক্ষমান')}
                                                  </span>
                                                </td>
                                              </tr>
                                            )
                                          })
                                      })()}
                                    </tbody>
                                  </table>
                                </div>

                                {/* Mobile Card View for Sales History */}
                                <div className="mobile-card-container">
                                  {(() => {
                                    const employeeId = viewingEmployee?._id || ''
                                    const assignedDealerIds = (dealers || [])
                                      .filter(dealer => {
                                        const assignedToId = dealer.assignedTo?._id || dealer.assignedTo || ''
                                        return String(assignedToId) === String(employeeId)
                                      })
                                      .map(dealer => ({
                                        _id: String(dealer._id || ''),
                                        dealerId: String(dealer.dealerId || '')
                                      }))
                                      .filter(d => d._id || d.dealerId)

                                    return (viewingEmployee.salesHistory || [])
                                      .filter((sale) => {
                                        // Filter out deleted orders - only show if order still exists
                                        if (!sale || !sale.orderObjectId) return false

                                        const order = (orders || []).find(o => {
                                          if (!o) return false
                                          const orderIdMatch = o._id && sale.orderObjectId && (
                                            String(o._id) === String(sale.orderObjectId) ||
                                            String(o._id) === String(sale.orderObjectId._id || sale.orderObjectId)
                                          )
                                          const orderIdStringMatch = o.orderId && sale.orderId && (
                                            String(o.orderId) === String(sale.orderId)
                                          )
                                          return orderIdMatch || orderIdStringMatch
                                        })

                                        // Only show if order exists in the orders array
                                        if (!order) return false

                                        // Verify this order actually belongs to this employee
                                        const orderRequestedBy = order.requestedBy?._id || order.requestedBy || ''
                                        const isEmployeeOrder = String(orderRequestedBy) === String(employeeId)

                                        // Check if this is an admin-created order for an assigned dealer
                                        const isAdminOrder = (order.requestedByRole || '').toLowerCase() === 'admin'
                                        let isAdminOrderForAssignedDealer = false

                                        if (isAdminOrder) {
                                          const orderDealerId = order.dealer?._id || order.dealer || ''
                                          const orderDealerIdString = String(orderDealerId)
                                          const orderDealerIdFromDealer = order.dealerId || ''

                                          isAdminOrderForAssignedDealer = assignedDealerIds.some(assignedDealer =>
                                            assignedDealer._id === orderDealerIdString ||
                                            assignedDealer.dealerId === orderDealerIdFromDealer ||
                                            (order.dealer && String(order.dealer._id || order.dealer) === assignedDealer._id)
                                          )
                                        }

                                        // Only show if order belongs to this employee
                                        return isEmployeeOrder || isAdminOrderForAssignedDealer
                                      })
                                      // Remove duplicates - keep only the first occurrence of each order
                                      .filter((sale, index, self) => {
                                        // Get unique identifier for this sale entry
                                        const saleOrderObjectId = sale.orderObjectId?._id
                                          ? String(sale.orderObjectId._id)
                                          : (sale.orderObjectId ? String(sale.orderObjectId) : '')
                                        const saleOrderId = String(sale.orderId || '')

                                        // Find the first occurrence of this order (by orderObjectId or orderId)
                                        const firstIndex = self.findIndex(s => {
                                          const sOrderObjectId = s.orderObjectId?._id
                                            ? String(s.orderObjectId._id)
                                            : (s.orderObjectId ? String(s.orderObjectId) : '')
                                          const sOrderId = String(s.orderId || '')

                                          // Match by orderObjectId (preferred) or orderId
                                          return (saleOrderObjectId && sOrderObjectId && saleOrderObjectId === sOrderObjectId) ||
                                            (saleOrderId && sOrderId && saleOrderId === sOrderId && saleOrderId !== '')
                                        })

                                        // Only keep if this is the first occurrence
                                        return index === firstIndex
                                      })
                                      .map((sale, index) => {
                                        const order = (orders || []).find(o => {
                                          if (!o) return false
                                          const orderIdMatch = o._id && sale.orderObjectId && (
                                            String(o._id) === String(sale.orderObjectId) ||
                                            String(o._id) === String(sale.orderObjectId._id || sale.orderObjectId)
                                          )
                                          const orderIdStringMatch = o.orderId && sale.orderId && (
                                            String(o.orderId) === String(sale.orderId)
                                          )
                                          return orderIdMatch || orderIdStringMatch
                                        }) || {}

                                        return (
                                          <div className="mobile-card" key={index}>
                                            <div className="mobile-card-header">
                                              <div className="mobile-card-avatar" style={{ backgroundColor: '#f0f9ff', color: '#0369a1' }}>
                                                {(order.dealerName || order.dealer?.name || order.orderId || '?').charAt(0).toUpperCase()}
                                              </div>
                                              <div className="mobile-card-header-text">
                                                <div className="mobile-card-title">
                                                  {customOrderIds[order._id] || order.orderId || sale.orderId || 'N/A'}
                                                </div>
                                                <div className="mobile-card-subtitle">
                                                  {sale.date ? new Date(sale.date).toLocaleDateString() : (sale.createdAt ? new Date(sale.createdAt).toLocaleDateString() : (order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '-'))}
                                                </div>
                                              </div>
                                              <div className="mobile-card-status-badge" style={{
                                                position: 'static',
                                                backgroundColor: (order.status === 'Delivered' || order.status === 'Completed') ? '#dcfce7' : ((order.status === 'Cancelled' || order.approvalStatus === 'Rejected') ? '#fee2e2' : '#fef9c3'),
                                                color: (order.status === 'Delivered' || order.status === 'Completed') ? '#166534' : ((order.status === 'Cancelled' || order.approvalStatus === 'Rejected') ? '#991b1b' : '#854d0e')
                                              }}>
                                                {order.status || (language === 'en' ? 'Pending' : 'অপেক্ষমান')}
                                              </div>
                                            </div>
                                            <div className="mobile-card-body">
                                              <div className="mobile-card-row">
                                                <span className="mobile-card-label">{language === 'en' ? 'Shop Name' : 'দোকানের নাম'}</span>
                                                <span className="mobile-card-value">{(order.dealer && order.dealer.shopName) || '-'}</span>
                                              </div>
                                              <div className="mobile-card-row">
                                                <span className="mobile-card-label">{language === 'en' ? 'Customer' : 'কাস্টমার'}</span>
                                                <span className="mobile-card-value">{order.dealerName || (order.dealer && order.dealer.name) || 'N/A'}</span>
                                              </div>
                                              <div className="mobile-card-row">
                                                <span className="mobile-card-label">{language === 'en' ? 'CID' : 'সিআইডি'}</span>
                                                <span className="mobile-card-value">{order.dealerId || (order.dealer && order.dealer.dealerId) || '-'}</span>
                                              </div>
                                              <div className="mobile-card-row">
                                                <span className="mobile-card-label">{language === 'en' ? 'Amount' : 'পরিমাণ'}</span>
                                                <span className="mobile-card-value" style={{ fontWeight: 500, color: '#475569' }}>
                                                  ৳{Number(order.totalPrice || sale.amount || sale.totalAmount || 0).toLocaleString()}
                                                </span>
                                              </div>
                                              <div className="mobile-card-row">
                                                <span className="mobile-card-label">{language === 'en' ? 'Grand Total' : 'সর্বমোট'}</span>
                                                <span className="mobile-card-value" style={{ fontWeight: 700, color: '#16a34a' }}>
                                                  ৳{(() => {
                                                    const total = parseFloat(order.totalPrice || sale.amount || sale.totalAmount || 0)
                                                    const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                                    return (total * discount).toLocaleString()
                                                  })()}
                                                </span>
                                              </div>
                                              <div className="mobile-card-row">
                                                <span className="mobile-card-label">{language === 'en' ? 'Created By' : 'তৈরি করেছেন'}</span>
                                                <span className="mobile-card-value">{order.requestedByName || order.requestedByRole || '-'}</span>
                                              </div>
                                              <div className="mobile-card-row">
                                                <span className="mobile-card-label">{language === 'en' ? 'Approved By' : 'অনুমোদনকারী'}</span>
                                                <span className="mobile-card-value">{order.approvedByName || '-'}</span>
                                              </div>
                                            </div>
                                          </div>
                                        )
                                      })
                                  })()}
                                </div>
                              </>
                            ) : (
                              <div style={{
                                padding: '1rem',
                                borderRadius: '0.5rem',
                                border: '1px solid #e5e7eb',
                                backgroundColor: '#fff',
                                color: '#475569',
                                fontWeight: 600
                              }}>
                                {language === 'en' ? 'No sales history found.' : 'কোন বিক্রয় ইতিহাস পাওয়া যায়নি।'}
                              </div>
                            )
                          }
                        </div>
                      ) : showAssignedDealers ? (
                        <div className="admin-employee-assigned-dealers-section" style={{ marginTop: '1rem', display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                          <h3 style={{ fontSize: '1.125rem', fontWeight: 700, color: '#0f172a', margin: '0.25rem 0' }}>
                            {language === 'en' ? 'Assigned Customers' : 'নির্ধারিত কাস্টমার'}
                          </h3>
                          {(() => {
                            // Filter dealers assigned to this employee
                            const assignedDealers = (dealers || []).filter(dealer => {
                              const assignedToId = dealer.assignedTo?._id || dealer.assignedTo || ''
                              const employeeId = viewingEmployee?._id || ''
                              return String(assignedToId) === String(employeeId)
                            })

                            if (assignedDealers.length === 0) {
                              return (
                                <div style={{
                                  padding: '2rem',
                                  textAlign: 'center',
                                  backgroundColor: '#f9fafb',
                                  borderRadius: '0.5rem',
                                  border: '1px solid #e5e7eb',
                                  color: '#6b7280'
                                }}>
                                  {language === 'en' ? 'No customers assigned to this employee' : 'এই কর্মচারীর জন্য কোন কাস্টমার নির্ধারিত নেই'}
                                </div>
                              )
                            }

                            return (
                              <>
                                <div className="admin-employee-dealers-table-container admin-table-container" style={{
                                  border: '1px solid #e5e7eb',
                                  borderRadius: '0.5rem',
                                  overflow: 'hidden',
                                  backgroundColor: '#fff'
                                }}>
                                  <table className="admin-table" style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <thead>
                                      <tr style={{ backgroundColor: '#f9fafb', borderBottom: '2px solid #e5e7eb' }}>
                                        <th style={{ padding: '0.75rem', textAlign: 'left', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                          {language === 'en' ? 'Customer ID' : 'কাস্টমার আইডি'}
                                        </th>
                                        <th style={{ padding: '0.75rem', textAlign: 'left', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                          {language === 'en' ? 'Shop Name' : 'দোকানের নাম'}
                                        </th>
                                        <th style={{ padding: '0.75rem', textAlign: 'left', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                          {language === 'en' ? 'Customer Name' : 'কাস্টমারের নাম'}
                                        </th>
                                        <th style={{ padding: '0.75rem', textAlign: 'left', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                          {language === 'en' ? 'Contact' : 'যোগাযোগ'}
                                        </th>
                                        <th style={{ padding: '0.75rem', textAlign: 'left', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                          {language === 'en' ? 'Address' : 'ঠিকানা'}
                                        </th>
                                        <th style={{ padding: '0.75rem', textAlign: 'right', fontSize: '0.875rem', fontWeight: 600, color: '#6b7280' }}>
                                          {language === 'en' ? 'Due Amount' : 'বকেয়া পরিমাণ'}
                                        </th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {assignedDealers.map((dealer, idx) => {
                                        // Calculate due amount for this dealer (excluding cancelled orders)
                                        const dealerOrders = (orders || []).filter(order => {
                                          const orderDealerId = order.dealerId || order.dealer?._id || ''
                                          const dealerId = dealer.dealerId || dealer._id || ''
                                          return (
                                            (String(orderDealerId) === String(dealerId) ||
                                              String(order.dealer?._id) === String(dealer._id)) &&
                                            order.status !== 'Cancelled' &&
                                            order.approvalStatus !== 'Rejected'
                                          )
                                        })

                                        const dealerDueAmount = dealerOrders.reduce((sum, order) => {
                                          const totalPrice = Number(order.totalPrice || 0)
                                          const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                          const grandTotal = totalPrice * discount
                                          const paid = Number(order.paidAmount || 0)
                                          const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                                          const due = Math.max(0, grandTotal - (paid + commission))
                                          return sum + due
                                        }, 0)

                                        return (
                                          <tr key={idx} style={{ borderBottom: '1px solid #f3f4f6' }}>
                                            <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#111827', fontFamily: 'monospace' }}>
                                              {dealer.dealerId || '-'}
                                            </td>
                                            <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#111827' }}>
                                              {dealer.shopName || '-'}
                                            </td>
                                            <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#111827', fontWeight: 600 }}>
                                              {dealer.name || '-'}
                                            </td>
                                            <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#374151' }}>
                                              {dealer.phone || '-'}
                                            </td>
                                            <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: '#374151' }}>
                                              {dealer.address || '-'}
                                            </td>
                                            <td style={{ padding: '0.75rem', fontSize: '0.875rem', color: dealerDueAmount > 0 ? '#dc2626' : '#16a34a', fontWeight: 600, textAlign: 'right' }}>
                                              ৳{dealerDueAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                            </td>
                                          </tr>
                                        )
                                      })}
                                    </tbody>
                                  </table>
                                </div>
                                <div className="mobile-card-container">
                                  {assignedDealers.map((dealer, idx) => {
                                    const dealerOrders = (orders || []).filter(order => {
                                      const orderDealerId = order.dealerId || order.dealer?._id || ''
                                      const dealerId = dealer.dealerId || dealer._id || ''
                                      return (
                                        (String(orderDealerId) === String(dealerId) ||
                                          String(order.dealer?._id) === String(dealer._id)) &&
                                        order.status !== 'Cancelled' &&
                                        order.approvalStatus !== 'Rejected'
                                      )
                                    })
                                    const dealerDueAmount = dealerOrders.reduce((sum, order) => {
                                      const totalPrice = Number(order.totalPrice || 0)
                                      const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                      const grandTotal = totalPrice * discount
                                      const paid = Number(order.paidAmount || 0)
                                      const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                                      const due = Math.max(0, grandTotal - (paid + commission))
                                      return sum + due
                                    }, 0)

                                    return (
                                      <div key={idx} className="mobile-card" style={{ padding: '0.75rem', border: '1px solid #e2e8f0', boxShadow: 'none' }}>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label" style={{ fontWeight: 600, color: '#475569' }}>{language === 'en' ? 'Customer ID' : 'কাস্টমার আইডি'}</span>
                                          <span className="mobile-card-value">{dealer.dealerId || '-'}</span>
                                        </div>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Shop Name' : 'দোকানের নাম'}</span>
                                          <span className="mobile-card-value">{dealer.shopName || '-'}</span>
                                        </div>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Customer Name' : 'কাস্টমারের নাম'}</span>
                                          <span className="mobile-card-value" style={{ fontWeight: 600 }}>{dealer.name || '-'}</span>
                                        </div>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Contact' : 'যোগাযোগ'}</span>
                                          <span className="mobile-card-value">{dealer.phone || '-'}</span>
                                        </div>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Address' : 'ঠিকানা'}</span>
                                          <span className="mobile-card-value" style={{ whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', maxWidth: '150px' }}>{dealer.address || '-'}</span>
                                        </div>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Due Amount' : 'বকেয়া পরিমাণ'}</span>
                                          <span className="mobile-card-value" style={{ color: dealerDueAmount > 0 ? '#dc2626' : '#16a34a', fontWeight: 600 }}>৳{dealerDueAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                                        </div>
                                      </div>
                                    )
                                  })}
                                </div>
                              </>
                            )
                          })()}
                        </div>
                      ) : (
                        <div className="admin-employee-details-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1rem', position: 'relative', zIndex: 1 }}>
                          {/* Employee ID */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Employee ID' : 'কর্মচারী আইডি'}
                            </label>
                            <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', fontWeight: 600, color: '#111827' }}>
                              {(isEditingEmployee ? editingEmployeeData : viewingEmployee).employeeId || 'N/A'}
                            </p>
                          </div>

                          {/* Name */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Name' : 'নাম'}
                            </label>
                            {isEditingEmployee ? (
                              <input
                                type="text"
                                value={editingEmployeeData?.name || ''}
                                onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, name: e.target.value })}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem'
                                }}
                              />
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                                {viewingEmployee.name || 'N/A'}
                              </p>
                            )}
                          </div>

                          {/* Email */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Email' : 'ইমেইল'}
                            </label>
                            {isEditingEmployee ? (
                              <input
                                type="email"
                                value={editingEmployeeData?.email || ''}
                                onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, email: e.target.value })}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem'
                                }}
                              />
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                                {viewingEmployee.email || 'N/A'}
                              </p>
                            )}
                          </div>

                          {/* Phone */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Phone' : 'ফোন'}
                            </label>
                            {isEditingEmployee ? (
                              <input
                                type="text"
                                value={editingEmployeeData?.phone || ''}
                                onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, phone: e.target.value })}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem'
                                }}
                              />
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                                {viewingEmployee.phone || 'N/A'}
                              </p>
                            )}
                          </div>

                          {/* Address */}
                          <div className="admin-employee-detail-full-width" style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem', gridColumn: 'span 2' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Address' : 'ঠিকানা'}
                            </label>
                            {isEditingEmployee ? (
                              <textarea
                                value={editingEmployeeData?.address || ''}
                                onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, address: e.target.value })}
                                rows={3}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem',
                                  fontFamily: 'inherit',
                                  resize: 'vertical'
                                }}
                              />
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827', whiteSpace: 'pre-wrap' }}>
                                {viewingEmployee.address || 'N/A'}
                              </p>
                            )}
                          </div>

                          {/* NID */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'NID (National ID)' : 'জাতীয় পরিচয়পত্র'}
                            </label>
                            {isEditingEmployee ? (
                              <input
                                type="text"
                                value={editingEmployeeData?.nid || ''}
                                onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, nid: e.target.value })}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem'
                                }}
                              />
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                                {viewingEmployee.nid || 'N/A'}
                              </p>
                            )}
                          </div>

                          {/* Salary */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Salary' : 'বেতন'}
                            </label>
                            {isEditingEmployee ? (
                              <input
                                type="number"
                                value={editingEmployeeData?.salary || ''}
                                onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, salary: e.target.value })}
                                min="0"
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem'
                                }}
                              />
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827', fontWeight: 600 }}>
                                {viewingEmployee.salary ? `${language === 'en' ? '৳' : '৳'} ${parseFloat(viewingEmployee.salary).toLocaleString()}` : 'N/A'}
                              </p>
                            )}
                          </div>

                          {/* Sales Target */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Sales Target' : 'বিক্রয় লক্ষ্য'}
                            </label>
                            {isEditingEmployee ? (
                              <input
                                type="number"
                                value={editingEmployeeData?.salesTarget || ''}
                                onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, salesTarget: e.target.value })}
                                min="0"
                                disabled={(viewingEmployee?.role || '').toLowerCase() === 'rsm'}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem',
                                  backgroundColor: (viewingEmployee?.role || '').toLowerCase() === 'rsm' ? '#f3f4f6' : 'white'
                                }}
                              />
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827', fontWeight: 600 }}>
                                {(() => {
                                  const isRSM = (viewingEmployee?.role || '').toLowerCase() === 'rsm'
                                  const calculatedTarget = isRSM
                                    ? (employees || []).reduce((sum, emp) => {
                                      if ((emp.role || '').toLowerCase() === 'salesman') {
                                        return sum + (parseFloat(emp.salesTarget) || 0)
                                      }
                                      return sum
                                    }, 0)
                                    : (parseFloat(viewingEmployee.salesTarget) || 0)
                                  return calculatedTarget > 0 ? `৳ ${Number(calculatedTarget).toLocaleString()}` : 'N/A'
                                })()}
                              </p>
                            )}
                          </div>

                          {/* Achieved Target */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Achieved Target' : 'অর্জিত লক্ষ্য'}
                            </label>
                            <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827', fontWeight: 600 }}>
                              {(() => {
                                const isRSM = (viewingEmployee?.role || '').toLowerCase() === 'rsm'
                                let achievedTarget = 0

                                if (isRSM) {
                                  // Sum all employees' achievedTarget values
                                  achievedTarget = (employees || []).reduce((sum, emp) => {
                                    return sum + (parseFloat(emp.achievedTarget) || 0)
                                  }, 0)
                                } else {
                                  // Calculate achieved target from own approved orders + admin-created orders for assigned dealers
                                  const employeeId = viewingEmployee?._id || ''

                                  // Get all dealers assigned to this employee
                                  const assignedDealerIds = (dealers || [])
                                    .filter(dealer => {
                                      const assignedToId = dealer.assignedTo?._id || dealer.assignedTo || ''
                                      return String(assignedToId) === String(employeeId)
                                    })
                                    .map(dealer => ({
                                      _id: String(dealer._id || ''),
                                      dealerId: String(dealer.dealerId || '')
                                    }))
                                    .filter(d => d._id || d.dealerId)

                                  // Filter orders: employee-created OR admin-created for assigned dealers
                                  const employeeOrders = (orders || []).filter(order => {
                                    const orderRequestedBy = order.requestedBy?._id || order.requestedBy || ''
                                    const isEmployeeOrder = String(orderRequestedBy) === String(employeeId)

                                    // Check if this is an admin-created order for an assigned dealer
                                    const isAdminOrder = (order.requestedByRole || '').toLowerCase() === 'admin'
                                    let isAdminOrderForAssignedDealer = false

                                    if (isAdminOrder) {
                                      const orderDealerId = order.dealer?._id || order.dealer || ''
                                      const orderDealerIdString = String(orderDealerId)
                                      const orderDealerIdFromDealer = order.dealerId || ''

                                      isAdminOrderForAssignedDealer = assignedDealerIds.some(assignedDealer =>
                                        assignedDealer._id === orderDealerIdString ||
                                        assignedDealer.dealerId === orderDealerIdFromDealer ||
                                        (order.dealer && String(order.dealer._id || order.dealer) === assignedDealer._id)
                                      )
                                    }

                                    return isEmployeeOrder || isAdminOrderForAssignedDealer
                                  })

                                  achievedTarget = employeeOrders
                                    .filter(order =>
                                      order.approvalStatus === 'Approved' &&
                                      order.status !== 'Cancelled' &&
                                      order.approvalStatus !== 'Rejected'
                                    )
                                    .reduce((sum, order) => {
                                      const price = parseFloat(order.totalPrice || 0)
                                      const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                      return sum + (price * discount)
                                    }, 0)
                                }

                                return `৳ ${Number(achievedTarget || 0).toLocaleString()}`
                              })()}
                            </p>
                            {(() => {
                              const isRSM = (viewingEmployee?.role || '').toLowerCase() === 'rsm'
                              const calculatedTarget = isRSM
                                ? (employees || []).reduce((sum, emp) => {
                                  if ((emp.role || '').toLowerCase() === 'salesman') {
                                    return sum + (parseFloat(emp.salesTarget) || 0)
                                  }
                                  return sum
                                }, 0)
                                : (parseFloat(viewingEmployee.salesTarget) || 0)

                              let achievedTarget = 0
                              if (isRSM) {
                                // Sum all employees' achievedTarget values
                                achievedTarget = (employees || []).reduce((sum, emp) => {
                                  return sum + (parseFloat(emp.achievedTarget) || 0)
                                }, 0)
                              } else {
                                // Calculate achieved target from own approved orders + admin-created orders for assigned dealers
                                const employeeId = viewingEmployee?._id || ''

                                // Get all dealers assigned to this employee
                                const assignedDealerIds = (dealers || [])
                                  .filter(dealer => {
                                    const assignedToId = dealer.assignedTo?._id || dealer.assignedTo || ''
                                    return String(assignedToId) === String(employeeId)
                                  })
                                  .map(dealer => String(dealer._id || dealer.dealerId || ''))
                                  .filter(id => id)

                                // Filter orders: employee-created OR admin-created for assigned dealers
                                const employeeOrders = (orders || []).filter(order => {
                                  const orderRequestedBy = order.requestedBy?._id || order.requestedBy || ''
                                  const orderDealerId = order.dealer?._id || order.dealer || ''
                                  const orderDealerIdString = String(orderDealerId)
                                  const isEmployeeOrder = String(orderRequestedBy) === String(employeeId)
                                  const isAdminOrderForAssignedDealer =
                                    (order.requestedByRole || '').toLowerCase() === 'admin' &&
                                    assignedDealerIds.includes(orderDealerIdString)
                                  return isEmployeeOrder || isAdminOrderForAssignedDealer
                                })

                                achievedTarget = employeeOrders
                                  .filter(order =>
                                    order.approvalStatus === 'Approved' &&
                                    order.status !== 'Cancelled' &&
                                    order.approvalStatus !== 'Rejected'
                                  )
                                  .reduce((sum, order) => {
                                    const price = parseFloat(order.totalPrice || 0)
                                    const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                    return sum + (price * discount)
                                  }, 0)
                              }

                              return calculatedTarget > 0 ? (
                                <p style={{ margin: '0.25rem 0 0 0', fontSize: '0.875rem', color: '#6b7280' }}>
                                  {(() => {
                                    const progress = Math.round(((Number(achievedTarget || 0) / Number(calculatedTarget || 1)) * 100))
                                    return `${language === 'en' ? 'Progress' : 'অগ্রগতি'}: ${progress}%`
                                  })()}
                                </p>
                              ) : null
                            })()}
                          </div>

                          {/* Bank Name */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Bank Name' : 'ব্যাংকের নাম'}
                            </label>
                            {isEditingEmployee ? (
                              <input
                                type="text"
                                value={editingEmployeeData?.bankName || ''}
                                onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, bankName: e.target.value })}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem'
                                }}
                              />
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                                {viewingEmployee.bankName || 'N/A'}
                              </p>
                            )}
                          </div>

                          {/* Bank Branch */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Branch' : 'শাখা'}
                            </label>
                            {isEditingEmployee ? (
                              <input
                                type="text"
                                value={editingEmployeeData?.bankBranch || ''}
                                onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, bankBranch: e.target.value })}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem'
                                }}
                              />
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                                {viewingEmployee.bankBranch || 'N/A'}
                              </p>
                            )}
                          </div>

                          {/* Account Number */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Account No.' : 'একাউন্ট নং'}
                            </label>
                            {isEditingEmployee ? (
                              <input
                                type="text"
                                value={editingEmployeeData?.accountNumber || ''}
                                onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, accountNumber: e.target.value })}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem'
                                }}
                              />
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                                {viewingEmployee.accountNumber || 'N/A'}
                              </p>
                            )}
                          </div>

                          {/* Salary Status */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            {isEditingEmployee ? (
                              <>
                                <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                                  {language === 'en' ? 'Salary Status' : 'বেতন স্থিতি'}
                                </label>
                                <select
                                  value={normalizeSalaryStatus(editingEmployeeData?.status)}
                                  onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, status: normalizeSalaryStatus(e.target.value) })}
                                  style={{
                                    marginTop: '0.5rem',
                                    width: '100%',
                                    padding: '0.5rem',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '0.375rem',
                                    fontSize: '1rem'
                                  }}
                                >
                                  <option value="Paid">{language === 'en' ? 'Paid' : 'পরিশোধিত'}</option>
                                  <option value="Unpaid">{language === 'en' ? 'Unpaid' : 'অপরিশোধিত'}</option>
                                </select>
                              </>
                            ) : (
                              <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', flexWrap: 'wrap' }}>
                                <span style={{ fontSize: '0.95rem', color: '#6b7280', fontWeight: 600 }}>
                                  {language === 'en' ? 'Salary Status' : 'বেতন স্থিতি'}
                                </span>
                                <span style={{
                                  fontSize: '1rem',
                                  display: 'inline-flex',
                                  alignItems: 'center',
                                  padding: '0.35rem 0.85rem',
                                  borderRadius: '0.5rem',
                                  backgroundColor: normalizeSalaryStatus(viewingEmployee.status) === 'Paid' ? '#dcfce7' : '#fee2e2',
                                  color: normalizeSalaryStatus(viewingEmployee.status) === 'Paid' ? '#166534' : '#991b1b',
                                  fontWeight: 700
                                }}>
                                  {normalizeSalaryStatus(viewingEmployee.status)}
                                </span>
                              </div>
                            )}
                          </div>

                          {/* Department */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Department' : 'বিভাগ'}
                            </label>
                            {isEditingEmployee ? (
                              <input
                                type="text"
                                value={editingEmployeeData?.department || ''}
                                onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, department: e.target.value })}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem'
                                }}
                              />
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                                {viewingEmployee.department || 'N/A'}
                              </p>
                            )}
                          </div>

                          {/* Posting Area - Region */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Region ID' : 'অঞ্চল আইডি'}
                            </label>
                            {isEditingEmployee ? (
                              <select
                                value={editingEmployeeData?.regionId || ''}
                                onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, regionId: e.target.value, areaId: '', territoryId: '', postingArea: '' })}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem'
                                }}
                              >
                                <option value="">{language === 'en' ? 'Select Region' : 'অঞ্চল নির্বাচন করুন'}</option>
                                {uniqueRegionIds.map(id => <option key={id} value={id}>{id}</option>)}
                              </select>
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                                {viewingEmployee.regionId || 'N/A'}
                              </p>
                            )}
                          </div>

                          {/* Posting Area - Area */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Area ID' : 'এলাকা আইডি'}
                            </label>
                            {isEditingEmployee ? (
                              <select
                                value={editingEmployeeData?.areaId || ''}
                                onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, areaId: e.target.value, territoryId: '', postingArea: '' })}
                                disabled={!editingEmployeeData?.regionId}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem',
                                  backgroundColor: !editingEmployeeData?.regionId ? '#f3f4f6' : 'white'
                                }}
                              >
                                <option value="">{language === 'en' ? 'Select Area' : 'এলাকা নির্বাচন করুন'}</option>
                                {editEmployeeAvailableAreaIds.map(id => <option key={id} value={id}>{id}</option>)}
                              </select>
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                                {viewingEmployee.areaId || 'N/A'}
                              </p>
                            )}
                          </div>

                          {/* Posting Area - Territory */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Territory ID' : 'টেরিটরি আইডি'}
                            </label>
                            {isEditingEmployee ? (
                              <select
                                value={editingEmployeeData?.territoryId || ''}
                                onChange={(e) => {
                                  const tid = e.target.value;
                                  const found = territories.find(t => t.territoryId === tid);
                                  let fullArea = '';
                                  if (found) {
                                    fullArea = `${found.division}, ${found.zilla}, ${found.area}`;
                                  }
                                  setEditingEmployeeData({
                                    ...editingEmployeeData,
                                    territoryId: tid,
                                    postingArea: fullArea
                                  });
                                }}
                                disabled={!editingEmployeeData?.areaId}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem',
                                  backgroundColor: !editingEmployeeData?.areaId ? '#f3f4f6' : 'white'
                                }}
                              >
                                <option value="">{language === 'en' ? 'Select Territory' : 'টেরিটরি নির্বাচন করুন'}</option>
                                {editEmployeeAvailableTerritoryIds.map(id => <option key={id} value={id}>{id}</option>)}
                              </select>
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                                {viewingEmployee.territoryId || 'N/A'}
                              </p>
                            )}
                          </div>

                          {/* Combined Posting Area */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Posting Area Info' : 'পোস্টিং এরিয়া তথ্য'}
                            </label>
                            <input
                              type="text"
                              value={(isEditingEmployee ? editingEmployeeData?.postingArea : viewingEmployee.postingArea) || 'N/A'}
                              readOnly
                              style={{
                                marginTop: '0.5rem',
                                width: '100%',
                                padding: '0.5rem',
                                border: '1px solid #d1d5db',
                                borderRadius: '0.375rem',
                                fontSize: '1rem',
                                backgroundColor: '#f3f4f6',
                                cursor: 'not-allowed'
                              }}
                            />
                          </div>

                          {/* Role */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            {isEditingEmployee ? (
                              <>
                                <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                                  {language === 'en' ? 'Role' : 'ভূমিকা'}
                                </label>
                                <select
                                  value={editingEmployeeData?.role || ''}
                                  onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, role: e.target.value })}
                                  style={{
                                    marginTop: '0.5rem',
                                    width: '100%',
                                    padding: '0.5rem',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '0.375rem',
                                    fontSize: '1rem'
                                  }}
                                >
                                  <option value="">{language === 'en' ? 'Select Role' : 'ভূমিকা নির্বাচন করুন'}</option>
                                  <option value="Admin">Admin</option>
                                  <option value="RSM">RSM</option>
                                  <option value="Incharge">Incharge</option>
                                  <option value="SalesMan">SalesMan</option>
                                </select>
                              </>
                            ) : (
                              <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', flexWrap: 'wrap' }}>
                                <span style={{ fontSize: '0.95rem', color: '#6b7280', fontWeight: 600 }}>
                                  {language === 'en' ? 'Role' : 'ভূমিকা'}
                                </span>
                                <span style={{
                                  fontSize: '1rem',
                                  display: 'inline-flex',
                                  alignItems: 'center',
                                  padding: '0.35rem 0.85rem',
                                  borderRadius: '0.5rem',
                                  backgroundColor: viewingEmployee.role === 'Admin' ? '#dcfce7' : '#fef3c7',
                                  color: viewingEmployee.role === 'Admin' ? '#166534' : '#92400e',
                                  fontWeight: 700
                                }}>
                                  {viewingEmployee.role || 'N/A'}
                                </span>
                              </div>
                            )}
                          </div>

                          {/* Designation */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Designation' : 'পদবি'}
                            </label>
                            {isEditingEmployee ? (
                              <input
                                type="text"
                                value={editingEmployeeData?.designation || ''}
                                onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, designation: e.target.value })}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem'
                                }}
                              />
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                                {viewingEmployee.designation || 'N/A'}
                              </p>
                            )}
                          </div>

                          {/* Username */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Username' : 'ব্যবহারকারীর নাম'}
                            </label>
                            <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827', fontFamily: 'monospace' }}>
                              {viewingEmployee.username || 'N/A'}
                            </p>
                          </div>

                          {/* Password */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Password' : 'পাসওয়ার্ড'}
                            </label>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginTop: '0.5rem' }}>
                              <p style={{
                                margin: 0,
                                fontSize: '1rem',
                                color: '#111827',
                                fontFamily: 'monospace',
                                backgroundColor: '#fee2e2',
                                padding: '0.5rem',
                                borderRadius: '0.25rem',
                                border: '1px solid #fecaca',
                                fontWeight: 600,
                                flex: 1
                              }}>
                                {lastGeneratedPassword || (language === 'en' ? 'Hidden' : 'লুকানো')}
                              </p>
                              <button
                                onClick={async () => {
                                  if (window.confirm(language === 'en' ? 'Reset password for this employee? A new password will be generated.' : 'এই কর্মচারীর পাসওয়ার্ড রিসেট করবেন? একটি নতুন পাসওয়ার্ড তৈরি করা হবে।')) {
                                    try {
                                      const res = await fetch(`${API_BASE}/api/employees/reset-password`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ id: viewingEmployee._id })
                                      })
                                      if (!res.ok) throw new Error('Failed to reset password')
                                      const data = await res.json()

                                      // Store newly generated password locally for display
                                      setLastGeneratedPassword(data.newPassword)

                                      // Refresh employee list
                                      const resEmployees = await fetch(`${API_BASE}/api/employees`)
                                      if (resEmployees.ok) {
                                        const empData = await resEmployees.json()
                                        setEmployees((empData.data || []).map((e) => ({
                                          ...e,
                                          status: normalizeSalaryStatus(e.status)
                                        })))
                                      }

                                      alert(language === 'en'
                                        ? `Password reset successfully! New password: ${data.newPassword}`
                                        : `পাসওয়ার্ড সফলভাবে রিসেট করা হয়েছে! নতুন পাসওয়ার্ড: ${data.newPassword}`)
                                    } catch (err) {
                                      alert(language === 'en' ? 'Failed to reset password' : 'পাসওয়ার্ড রিসেট করতে ব্যর্থ')
                                    }
                                  }
                                }}
                                style={{
                                  padding: '0.5rem 1rem',
                                  backgroundColor: '#3b82f6',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '0.25rem',
                                  cursor: 'pointer',
                                  fontWeight: 600,
                                  fontSize: '0.875rem',
                                  whiteSpace: 'nowrap'
                                }}
                              >
                                {language === 'en' ? 'Reset Password' : 'পাসওয়ার্ড রিসেট'}
                              </button>
                            </div>
                          </div>

                          {/* Emergency Contact Name */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Emergency Contact Name' : 'জরুরি যোগাযোগের নাম'}
                            </label>
                            {isEditingEmployee ? (
                              <input
                                type="text"
                                value={editingEmployeeData?.emergencyContactName || ''}
                                onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, emergencyContactName: e.target.value })}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem'
                                }}
                              />
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                                {viewingEmployee.emergencyContactName || 'N/A'}
                              </p>
                            )}
                          </div>

                          {/* Emergency Contact */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Emergency Contact' : 'জরুরি যোগাযোগ'}
                            </label>
                            {isEditingEmployee ? (
                              <input
                                type="text"
                                value={editingEmployeeData?.emergencyContact || ''}
                                onChange={(e) => setEditingEmployeeData({ ...editingEmployeeData, emergencyContact: e.target.value })}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem'
                                }}
                              />
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                                {viewingEmployee.emergencyContact || 'N/A'}
                              </p>
                            )}
                          </div>

                          {/* Document */}
                          {viewingEmployee.document && (
                            <div className="admin-employee-detail-full-width" style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem', gridColumn: 'span 2' }}>
                              <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                                {language === 'en' ? 'Document' : 'নথি'}
                              </label>
                              <div style={{ marginTop: '0.5rem' }}>
                                {viewingEmployee.document.startsWith('data:') ? (
                                  <a
                                    href={viewingEmployee.document}
                                    download={`${viewingEmployee.name}_document`}
                                    style={{
                                      display: 'inline-block',
                                      padding: '0.5rem 1rem',
                                      backgroundColor: '#3b82f6',
                                      color: 'white',
                                      borderRadius: '0.375rem',
                                      textDecoration: 'none',
                                      fontWeight: 600
                                    }}
                                  >
                                    {language === 'en' ? 'Download Document' : 'নথি ডাউনলোড করুন'}
                                  </a>
                                ) : (
                                  <p style={{ margin: 0, fontSize: '1rem', color: '#111827' }}>
                                    {viewingEmployee.document}
                                  </p>
                                )}
                              </div>
                            </div>
                          )}

                          {/* Photo */}
                          <div className="admin-employee-detail-full-width" style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem', gridColumn: 'span 2', textAlign: 'center' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600, display: 'block', marginBottom: '0.5rem' }}>
                              {language === 'en' ? 'Photo' : 'ছবি'}
                            </label>
                            {isEditingEmployee ? (
                              <input
                                type="file"
                                accept="image/*"
                                onChange={async (e) => {
                                  const file = e.target.files?.[0]
                                  if (!file) return
                                  try {
                                    const base64 = await fileToBase64(file)
                                    setEditingEmployeeData({ ...editingEmployeeData, photo: base64 })
                                  } catch (err) {
                                    console.error('Photo upload failed', err)
                                  }
                                }}
                                style={{
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '0.875rem',
                                  marginTop: '0.25rem'
                                }}
                              />
                            ) : null}
                            {(isEditingEmployee ? editingEmployeeData?.photo : viewingEmployee.photo) && (
                              <img
                                src={isEditingEmployee ? editingEmployeeData?.photo : viewingEmployee.photo}
                                alt={viewingEmployee.name}
                                style={{
                                  maxWidth: '200px',
                                  maxHeight: '200px',
                                  borderRadius: '0.5rem',
                                  border: '2px solid #e5e7eb',
                                  marginTop: '0.5rem'
                                }}
                                onError={(e) => {
                                  e.target.style.display = 'none'
                                }}
                              />
                            )}
                          </div>
                        </div>
                      )
                      }


                      <div style={{ marginTop: '1.5rem', display: 'flex', justifyContent: 'flex-end', gap: '0.5rem' }}>
                        {isEditingEmployee ? (
                          <>
                            <button
                              onClick={() => {
                                setIsEditingEmployee(false)
                                setEditingEmployeeData(null)
                              }}
                              disabled={savingEmployee}
                              style={{
                                padding: '0.5rem 1.5rem',
                                backgroundColor: '#6b7280',
                                color: 'white',
                                border: 'none',
                                borderRadius: '0.375rem',
                                cursor: savingEmployee ? 'not-allowed' : 'pointer',
                                fontWeight: 600,
                                opacity: savingEmployee ? 0.6 : 1
                              }}
                            >
                              {adminContent.cancel}
                            </button>
                            <button
                              onClick={handleSaveEmployeeEdit}
                              disabled={savingEmployee}
                              style={{
                                padding: '0.5rem 1.5rem',
                                backgroundColor: '#10b981',
                                color: 'white',
                                border: 'none',
                                borderRadius: '0.375rem',
                                cursor: savingEmployee ? 'not-allowed' : 'pointer',
                                fontWeight: 600,
                                opacity: savingEmployee ? 0.6 : 1
                              }}
                            >
                              {savingEmployee ? (language === 'en' ? 'Saving...' : 'সংরক্ষণ করা হচ্ছে...') : adminContent.save}
                            </button>
                          </>
                        ) : (
                          <>
                            <button
                              onClick={() => {
                                setIsEditingEmployee(true)
                                setEditingEmployeeData({ ...viewingEmployee, status: normalizeSalaryStatus(viewingEmployee.status) })
                              }}
                              style={{
                                padding: '0.5rem 1.5rem',
                                backgroundColor: '#3b82f6',
                                color: 'white',
                                border: 'none',
                                borderRadius: '0.375rem',
                                cursor: 'pointer',
                                fontWeight: 600
                              }}
                            >
                              {adminContent.edit}
                            </button>
                            <button
                              onClick={async () => {
                                if (!viewingEmployee?._id) return
                                if (window.confirm(language === 'en' ? 'Are you sure you want to delete this employee?' : 'আপনি কি নিশ্চিত যে আপনি এই কর্মচারীটি মুছতে চান?')) {
                                  try {
                                    const res = await fetch(`${API_BASE}/api/employees/${viewingEmployee._id}`, {
                                      method: 'DELETE'
                                    })
                                    if (!res.ok) throw new Error('Failed to delete')
                                    setEmployees(employees.filter(e => e._id !== viewingEmployee._id))
                                    setViewingEmployee(null)
                                    setIsEditingEmployee(false)
                                    setEditingEmployeeData(null)
                                  } catch (err) {
                                    alert(language === 'en' ? 'Failed to delete employee' : 'কর্মচারী মুছে ফেলতে ব্যর্থ')
                                  }
                                }
                              }}
                              style={{
                                padding: '0.5rem 1.5rem',
                                backgroundColor: '#ef4444',
                                color: 'white',
                                border: 'none',
                                borderRadius: '0.375rem',
                                cursor: 'pointer',
                                fontWeight: 600
                              }}
                            >
                              {adminContent.delete}
                            </button>
                            <button
                              onClick={() => {
                                setViewingEmployee(null)
                                setIsEditingEmployee(false)
                                setEditingEmployeeData(null)
                                setLastGeneratedPassword('')
                              }}
                              style={{
                                padding: '0.5rem 1.5rem',
                                backgroundColor: '#6b7280',
                                color: 'white',
                                border: 'none',
                                borderRadius: '0.375rem',
                                cursor: 'pointer',
                                fontWeight: 600
                              }}
                            >
                              {language === 'en' ? 'Close' : 'বন্ধ করুন'}
                            </button>
                          </>
                        )}
                      </div>
                    </div>
                  </div>
                )
                }
              </div >
            )
          }

          {/* Orders Tab */}
          {
            activeTab === 'orders' && (
              <div className="admin-tab-content">
                <div className="admin-tab-header" style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', flexWrap: 'wrap' }}>
                  <h1 className="admin-page-title" style={{ flex: 1 }}>{adminContent.orders}</h1>
                  <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                    <button
                      className="admin-add-btn"
                      onClick={() => {
                        resetOrderForm()
                        setShowOrderForm(true)
                      }}
                    >
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                        <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                      </svg>
                      {adminContent.addNew}
                    </button>
                    <button
                      type="button"
                      onClick={() => {
                        setShowOrderRequests((prev) => !prev)
                        if (!showOrderRequests) {
                          loadOrderRequests()
                        }
                      }}
                      style={{
                        padding: '0.55rem 1rem',
                        backgroundColor: showOrderRequests ? '#0ea5e9' : '#e2e8f0',
                        color: showOrderRequests ? '#ffffff' : '#0f172a',
                        border: showOrderRequests ? '1px solid #0ea5e9' : '1px solid #cbd5e1',
                        borderRadius: '0.5rem',
                        fontWeight: 700,
                        minHeight: '44px',
                        cursor: 'pointer',
                        boxShadow: showOrderRequests ? '0 8px 16px rgba(14,165,233,0.25)' : 'none'
                      }}
                    >
                      {language === 'en' ? 'Order Requests' : 'অর্ডার অনুরোধ'}
                    </button>
                    <button
                      type="button"
                      onClick={() => loadOrders()}
                      className="admin-add-btn"
                      style={{ backgroundColor: '#e2e8f0', color: '#0f172a' }}
                    >
                      {language === 'en' ? 'Refresh' : 'রিফ্রেশ'}
                    </button>
                  </div>
                </div>

                {showOrderForm && (
                  <div className="admin-order-form-overlay" style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000,
                    padding: '1rem'
                  }} onClick={() => {
                    setShowOrderForm(false)
                    resetOrderForm()
                  }}>
                    <div className="admin-modal-content" onClick={(e) => e.stopPropagation()}>
                      <div style={{
                        position: 'absolute',
                        inset: 0,
                        pointerEvents: 'none',
                        overflow: 'hidden',
                        borderRadius: '0.75rem'
                      }}>
                        <div style={{
                          position: 'absolute',
                          width: '260px',
                          height: '260px',
                          top: '-120px',
                          left: '-80px',
                          background: 'radial-gradient(circle at 30% 30%, rgba(59,130,246,0.25), transparent 60%)',
                          filter: 'blur(20px)'
                        }} />
                        <div style={{
                          position: 'absolute',
                          width: '240px',
                          height: '240px',
                          bottom: '-140px',
                          right: '-100px',
                          background: 'radial-gradient(circle at 70% 70%, rgba(16,185,129,0.22), transparent 60%)',
                          filter: 'blur(20px)'
                        }} />
                      </div>

                      <div className="admin-order-form-header" style={{ position: 'relative', display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', gap: '1rem' }}>
                        <div>
                          <h2 style={{ margin: 0, fontSize: '1.5rem', fontWeight: 800, color: '#0f172a' }}>
                            {editingOrderId ? (language === 'en' ? 'Edit Order' : 'অর্ডার সম্পাদনা') : (language === 'en' ? 'Add New Order' : 'নতুন অর্ডার যোগ করুন')}
                          </h2>
                          <p style={{ margin: '0.25rem 0 0 0', color: '#475569', fontWeight: 600 }}>
                            {language === 'en' ? 'Fill in order details and add to cart' : 'অর্ডারের তথ্য পূরণ করে কার্টে যোগ করুন'}
                          </p>
                        </div>
                        <button
                          onClick={() => {
                            setShowOrderForm(false)
                            resetOrderForm()
                          }}
                          style={{
                            background: '#e2e8f0',
                            border: 'none',
                            padding: '0.4rem 0.65rem',
                            borderRadius: '0.375rem',
                            cursor: 'pointer',
                            fontWeight: 700,
                            color: '#475569'
                          }}
                        >
                          ×
                        </button>
                      </div>

                      <div style={{ position: 'relative', zIndex: 1 }}>
                        {orderStatus && (
                          <div style={{
                            padding: '0.75rem',
                            marginBottom: '1rem',
                            borderRadius: '0.5rem',
                            border: orderStatus.includes('error') || orderStatus.includes('Failed') ? '1px solid #fecaca' : '1px solid #bbf7d0',
                            backgroundColor: orderStatus.includes('error') || orderStatus.includes('Failed') ? '#fef2f2' : '#ecfdf3',
                            color: orderStatus.includes('error') || orderStatus.includes('Failed') ? '#b91c1c' : '#065f46',
                            fontWeight: 700
                          }}>
                            {orderStatus}
                          </div>
                        )}
                        <form onSubmit={(e) => { e.preventDefault(); handleAddOrderToCart() }} className="admin-form-grid">
                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Customer *' : 'কাস্টমার *'}</label>
                            <select
                              value={orderForm.dealer}
                              onChange={(e) => setOrderForm({ ...orderForm, dealer: e.target.value })}
                              required
                              style={{
                                width: '100%',
                                padding: '0.5rem',
                                border: '1px solid #d1d5db',
                                borderRadius: '0.375rem',
                                fontSize: '0.875rem'
                              }}
                            >
                              <option value="">{language === 'en' ? 'Select Customer' : 'কাস্টমার নির্বাচন করুন'}</option>
                              {filteredDealers.map((dealer) => {
                                return (
                                  <option key={dealer._id} value={dealer._id}>
                                    {dealer.shopName ? `${dealer.shopName}, ` : ''}{dealer.name} {dealer.dealerId ? `(${dealer.dealerId})` : ''}
                                  </option>
                                )
                              })}
                            </select>

                          </div>

                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Product *' : 'পণ্য *'}</label>
                            <select
                              value={orderForm.product}
                              onChange={(e) => setOrderForm({ ...orderForm, product: e.target.value, variant: { productCode: '', packSize: '', packUnit: 'ml', cartoonSize: 1, cartoonUnit: 'Pcs', price: 0 } })}
                              required
                              style={{
                                width: '100%',
                                padding: '0.5rem',
                                border: '1px solid #d1d5db',
                                borderRadius: '0.375rem',
                                fontSize: '0.875rem'
                              }}
                            >
                              <option value="">{language === 'en' ? 'Select Product' : 'পণ্য নির্বাচন করুন'}</option>
                              {products.map((product) => (
                                <option key={product._id} value={product._id}>
                                  {product.name} {product.productId ? `(${product.productId})` : ''}
                                </option>
                              ))}
                            </select>
                          </div>

                          {selectedProductVariants.length > 0 && (
                            <div className="admin-form-group">
                              <label>{language === 'en' ? 'Product Variant *' : 'পণ্যের ভ্যারিয়েন্ট *'}</label>
                              <select
                                value={orderForm.variant.productCode}
                                onChange={(e) => {
                                  const selectedVariant = selectedProductVariants.find(v => v.productCode === e.target.value)
                                  setOrderForm({
                                    ...orderForm,
                                    variant: selectedVariant ? {
                                      productCode: selectedVariant.productCode || '',
                                      packSize: selectedVariant.packSize || '',
                                      packUnit: selectedVariant.packUnit || 'ml',
                                      cartoonSize: selectedVariant.cartoonSize || 1,
                                      cartoonUnit: selectedVariant.cartoonUnit || 'Pcs',
                                      price: selectedVariant.price || 0
                                    } : { productCode: '', packSize: '', packUnit: 'ml', cartoonSize: 1, cartoonUnit: 'Pcs', price: 0 }
                                  })
                                }}
                                required
                                style={{
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '0.875rem'
                                }}
                              >
                                <option value="">{language === 'en' ? 'Select Variant' : 'ভ্যারিয়েন্ট নির্বাচন করুন'}</option>
                                {selectedProductVariants.map((variant, index) => (
                                  <option key={index} value={variant.productCode}>
                                    {variant.productCode} ({variant.packSize} {variant.packUnit || 'ml'}) [{variant.cartoonSize || 1} {variant.cartoonUnit || 'Pcs'}] - ৳{variant.price || 0}
                                  </option>
                                ))}
                              </select>
                            </div>
                          )}

                          {/* Selected Price Display */}
                          {(orderForm.variant?.price > 0 || (orderForm.product && (() => {
                            const p = products.find(prod => prod._id === orderForm.product)
                            return p && p.price > 0
                          })())) && (
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Price' : 'মূল্য'}</label>
                                <div style={{
                                  padding: '0.5rem',
                                  backgroundColor: '#f3f4f6',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontWeight: 600,
                                  color: '#111827'
                                }}>
                                  <div style={{ display: 'flex', flexDirection: 'column', gap: '0.25rem' }}>
                                    <div>
                                      {language === 'en' ? 'CTN Price:' : 'কার্টুন মূল্য:'} ৳{orderForm.variant?.price || (() => {
                                        const p = products.find(prod => prod._id === orderForm.product)
                                        return p ? p.price : 0
                                      })()}
                                    </div>
                                    <div style={{ fontSize: '0.875rem', color: '#16a34a' }}>
                                      {language === 'en' ? 'Unit Price:' : 'ইউনিট মূল্য:'} ৳{Math.round(((orderForm.variant?.price || (() => {
                                        const p = products.find(prod => prod._id === orderForm.product)
                                        return p ? p.price : 0
                                      })()) / (orderForm.variant?.cartoonSize || 1)))}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            )}

                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Quantity *' : 'পরিমাণ *'}</label>
                            <input
                              type="number"
                              min="1"
                              value={orderForm.quantity}
                              onChange={(e) => setOrderForm({ ...orderForm, quantity: e.target.value })}
                              required
                              style={{
                                width: '100%',
                                padding: '0.5rem',
                                border: '1px solid #d1d5db',
                                borderRadius: '0.375rem',
                                fontSize: '0.875rem'
                              }}
                            />
                          </div>

                          {/* Product Offer Section */}
                          {orderForm.product && (() => {
                            const selectedProduct = products.find(p => p._id === orderForm.product)
                            if (selectedProduct && selectedProduct.hasOffer && selectedProduct.buyQuantity && selectedProduct.freeQuantity) {
                              const buyQty = parseFloat(selectedProduct.buyQuantity) || 0
                              const freeQty = parseFloat(selectedProduct.freeQuantity) || 0
                              const orderQty = parseFloat(orderForm.quantity) || 0
                              const eligibleOffers = Math.floor(orderQty / buyQty)
                              const freeUnits = eligibleOffers * freeQty

                              return (
                                <div className="admin-form-group" style={{ gridColumn: '1 / -1', padding: '1rem', backgroundColor: '#fef3c7', borderRadius: '0.5rem', border: '1px solid #fbbf24' }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.75rem' }}>
                                    <span style={{ fontSize: '1.25rem' }}>🎁</span>
                                    <label style={{ fontSize: '1rem', color: '#92400e', fontWeight: 700, margin: 0 }}>
                                      {language === 'en' ? 'Special Offer Available!' : 'বিশেষ অফার উপলব্ধ!'}
                                    </label>
                                  </div>
                                  <div style={{ marginBottom: '0.75rem' }}>
                                    <p style={{ margin: 0, fontSize: '0.95rem', color: '#78350f', fontWeight: 600 }}>
                                      {language === 'en'
                                        ? `Buy ${buyQty} units, get ${freeQty} unit(s) free`
                                        : `${buyQty} ইউনিট ক্রয় করলে ${freeQty} ইউনিট ফ্রি`}
                                    </p>
                                  </div>
                                  {orderQty >= buyQty && (
                                    <div style={{ padding: '0.75rem', backgroundColor: '#ecfdf3', borderRadius: '0.375rem', border: '1px solid #bbf7d0' }}>
                                      <p style={{ margin: 0, fontSize: '0.9rem', color: '#065f46', fontWeight: 600 }}>
                                        {language === 'en'
                                          ? `✓ You are eligible for ${eligibleOffers} offer(s)! You will get ${freeUnits} free unit(s) with your order.`
                                          : `✓ আপনি ${eligibleOffers}টি অফারের জন্য যোগ্য! আপনার অর্ডারের সাথে ${freeUnits}টি ফ্রি ইউনিট পাবেন।`}
                                      </p>
                                    </div>
                                  )}
                                  {orderQty > 0 && orderQty < buyQty && (
                                    <div style={{ padding: '0.75rem', backgroundColor: '#fef2f2', borderRadius: '0.375rem', border: '1px solid #fecaca' }}>
                                      <p style={{ margin: 0, fontSize: '0.9rem', color: '#991b1b', fontWeight: 600 }}>
                                        {language === 'en'
                                          ? `⚠️ Add ${buyQty - orderQty} more unit(s) to qualify for the offer!`
                                          : `⚠️ অফারের জন্য যোগ্য হতে আরও ${buyQty - orderQty} ইউনিট যোগ করুন!`}
                                      </p>
                                    </div>
                                  )}
                                </div>
                              )
                            }
                            return null
                          })()}

                          <div className="admin-form-group" style={{ gridColumn: '1 / -1' }}>
                            <label>{language === 'en' ? 'Notes' : 'নোট'}</label>
                            <textarea
                              rows={3}
                              value={orderForm.notes}
                              onChange={(e) => setOrderForm({ ...orderForm, notes: e.target.value })}
                              placeholder={language === 'en' ? 'Additional notes (optional)' : 'অতিরিক্ত নোট (ঐচ্ছিক)'}
                              style={{
                                width: '100%',
                                padding: '0.5rem',
                                border: '1px solid #d1d5db',
                                borderRadius: '0.375rem',
                                fontSize: '0.875rem',
                                resize: 'vertical'
                              }}
                            />
                          </div>

                          {/* Target Half and Year Selection */}
                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Target Half *' : 'লক্ষ্য অর্ধ *'}</label>
                            <select
                              value={orderForm.targetHalf}
                              onChange={(e) => setOrderForm({ ...orderForm, targetHalf: e.target.value })}
                              required
                              style={{
                                width: '100%',
                                padding: '0.5rem',
                                border: '1px solid #d1d5db',
                                borderRadius: '0.375rem',
                                fontSize: '0.875rem'
                              }}
                            >
                              <option value="H1">{language === 'en' ? '1st Half (Jan-Jun)' : '১ম অর্ধ (জানু-জুন)'}</option>
                              <option value="H2">{language === 'en' ? '2nd Half (Jul-Dec)' : '২য় অর্ধ (জুলাই-ডিসে)'}</option>
                            </select>
                          </div>

                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Target Year *' : 'লক্ষ্য বছর *'}</label>
                            <select
                              value={orderForm.targetYear}
                              onChange={(e) => setOrderForm({ ...orderForm, targetYear: parseInt(e.target.value) })}
                              required
                              style={{
                                width: '100%',
                                padding: '0.5rem',
                                border: '1px solid #d1d5db',
                                borderRadius: '0.375rem',
                                fontSize: '0.875rem'
                              }}
                            >
                              {Array.from({ length: 6 }, (_, i) => new Date().getFullYear() - 2 + i).map(year => (
                                <option key={year} value={year}>{year}</option>
                              ))}
                            </select>
                          </div>

                          {/* Target Month Selection */}
                          <div className="admin-form-group">
                            <label>{language === 'en' ? 'Target Month *' : 'লক্ষ্য মাস *'}</label>
                            <select
                              value={orderForm.targetMonth}
                              onChange={(e) => setOrderForm({ ...orderForm, targetMonth: parseInt(e.target.value) })}
                              required
                              style={{
                                width: '100%',
                                padding: '0.5rem',
                                border: '1px solid #d1d5db',
                                borderRadius: '0.375rem',
                                fontSize: '0.875rem'
                              }}
                            >
                              <option value={0}>{language === 'en' ? 'January' : 'জানুয়ারি'}</option>
                              <option value={1}>{language === 'en' ? 'February' : 'ফেব্রুয়ারি'}</option>
                              <option value={2}>{language === 'en' ? 'March' : 'মার্চ'}</option>
                              <option value={3}>{language === 'en' ? 'April' : 'এপ্রিল'}</option>
                              <option value={4}>{language === 'en' ? 'May' : 'মে'}</option>
                              <option value={5}>{language === 'en' ? 'June' : 'জুন'}</option>
                              <option value={6}>{language === 'en' ? 'July' : 'জুলাই'}</option>
                              <option value={7}>{language === 'en' ? 'August' : 'আগস্ট'}</option>
                              <option value={8}>{language === 'en' ? 'September' : 'সেপ্টেম্বর'}</option>
                              <option value={9}>{language === 'en' ? 'October' : 'অক্টোবর'}</option>
                              <option value={10}>{language === 'en' ? 'November' : 'নভেম্বর'}</option>
                              <option value={11}>{language === 'en' ? 'December' : 'ডিসেম্বর'}</option>
                            </select>
                          </div>

                          {/* Paid Amount and Status - Only show when editing */}
                          {editingOrderId && (
                            <>
                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Paid Amount' : 'পরিশোধিত পরিমাণ'}</label>
                                <input
                                  type="number"
                                  min="0"
                                  value={orderForm.paidAmount || 0}
                                  onChange={(e) => setOrderForm({ ...orderForm, paidAmount: parseFloat(e.target.value) || 0 })}
                                  style={{
                                    width: '100%',
                                    padding: '0.5rem',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '0.375rem',
                                    fontSize: '0.875rem'
                                  }}
                                />
                              </div>

                              <div className="admin-form-group">
                                <label>{language === 'en' ? 'Status' : 'স্ট্যাটাস'}</label>
                                <select
                                  value={orderForm.status}
                                  onChange={(e) => setOrderForm({ ...orderForm, status: e.target.value })}
                                  style={{
                                    width: '100%',
                                    padding: '0.5rem',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '0.375rem',
                                    fontSize: '0.875rem'
                                  }}
                                >
                                  <option value="Pending">{language === 'en' ? 'Pending' : 'অপেক্ষমাণ'}</option>
                                  <option value="Processing">{language === 'en' ? 'Processing' : 'প্রক্রিয়াকরণ'}</option>
                                  <option value="Shipped">{language === 'en' ? 'Shipped' : 'প্রেরিত'}</option>
                                  <option value="Delivered">{language === 'en' ? 'Delivered' : 'বিতরণকৃত'}</option>
                                  <option value="Complete">{language === 'en' ? 'Complete' : 'সম্পন্ন'}</option>
                                </select>
                              </div>
                            </>
                          )}

                          <div style={{ gridColumn: '1 / -1', display: 'flex', gap: '0.75rem', marginTop: '1rem', flexWrap: 'wrap' }}>
                            <button
                              type="button"
                              disabled={savingOrder}
                              onClick={handleAddOrderToCart}
                              style={{
                                padding: '0.65rem 1.2rem',
                                backgroundColor: '#0ea5e9',
                                color: 'white',
                                border: 'none',
                                borderRadius: '0.375rem',
                                fontWeight: 700,
                                cursor: savingOrder ? 'not-allowed' : 'pointer'
                              }}
                            >
                              {language === 'en' ? 'Add to Cart' : 'কার্টে যোগ করুন'}
                            </button>
                            <button
                              type="button"
                              onClick={() => {
                                setShowOrderForm(false)
                                resetOrderForm()
                              }}
                              style={{
                                padding: '0.65rem 1.2rem',
                                backgroundColor: '#64748b',
                                color: 'white',
                                border: 'none',
                                borderRadius: '0.375rem',
                                fontWeight: 700,
                                cursor: 'pointer'
                              }}
                            >
                              {adminContent.cancel}
                            </button>
                          </div>
                        </form>

                        {/* Cart Details Section */}
                        {orderCart.length > 0 && (
                          <div style={{ position: 'relative', zIndex: 1, marginTop: '2rem', paddingTop: '2rem', borderTop: '2px solid #e5e7eb' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                              <h3 style={{ margin: 0, fontSize: '1.25rem', fontWeight: 800, color: '#0f172a' }}>
                                {language === 'en' ? 'Order Cart' : 'অর্ডার কার্ট'}
                              </h3>
                              <span style={{
                                padding: '0.35rem 0.75rem',
                                backgroundColor: '#e0f2fe',
                                color: '#0ea5e9',
                                borderRadius: '999px',
                                fontSize: '0.875rem',
                                fontWeight: 700
                              }}>
                                {orderCart.length} {language === 'en' ? 'item(s)' : 'আইটেম'}
                              </span>
                            </div>
                            <div style={{ marginBottom: '0.75rem', color: '#475569', fontWeight: 600 }}>
                              {language === 'en' ? 'Customer:' : 'কাস্টমার:'} {(() => { const d = filteredDealers.find(d => d._id === orderForm.dealer); return d ? (d.shopName ? `${d.shopName}, ${d.name}` : d.name) : '-'; })()}
                            </div>
                            <div className="admin-table-container" style={{ marginBottom: '1rem', background: '#fff', borderRadius: '0.5rem', border: '1px solid #e2e8f0' }}>
                              <table className="admin-table">
                                <thead>
                                  <tr>
                                    <th>{language === 'en' ? 'Product' : 'পণ্য'}</th>
                                    <th>{language === 'en' ? 'Variant' : 'ভ্যারিয়েন্ট'}</th>
                                    <th>{language === 'en' ? 'Qty' : 'পরিমাণ'}</th>
                                    <th>{language === 'en' ? 'Free Qty' : 'ফ্রি পরিমাণ'}</th>
                                    <th>{language === 'en' ? 'Total Qty' : 'মোট পরিমাণ'}</th>
                                    <th>{language === 'en' ? 'Total Price' : 'মোট মূল্য'}</th>
                                    <th>{language === 'en' ? 'Grand Total' : 'সর্বমোট'}</th>
                                    <th>{language === 'en' ? 'Status' : 'স্ট্যাটাস'}</th>
                                    <th>{language === 'en' ? 'Notes' : 'নোট'}</th>
                                    <th>{language === 'en' ? 'Actions' : 'কার্যক্রম'}</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {orderCart.map((item, idx) => {
                                    const cartProduct = products.find(p => p._id === item.product)
                                    const hasOffer = cartProduct && cartProduct.hasOffer && cartProduct.buyQuantity && cartProduct.freeQuantity
                                    const buyQty = hasOffer ? (parseFloat(cartProduct.buyQuantity) || 0) : 0
                                    const freeQty = hasOffer ? (parseFloat(cartProduct.freeQuantity) || 0) : 0
                                    const orderQty = parseFloat(item.quantity) || 0
                                    const eligibleOffers = hasOffer ? Math.floor(orderQty / buyQty) : 0
                                    const freeUnits = eligibleOffers * freeQty
                                    const totalQty = orderQty + freeUnits

                                    return (
                                      <tr key={`${item.product}-${idx}`}>
                                        <td>
                                          <span style={{ fontWeight: 600 }}>{item.productName || item.productId || '-'}</span>
                                        </td>
                                        <td>{item.variant?.productCode ? `${item.variant.productCode} (${item.variant.packSize} ${item.variant.packUnit || 'ml'})` : '-'}</td>
                                        <td style={{ textAlign: 'center', fontWeight: 600 }}>{item.quantity}</td>
                                        <td style={{ textAlign: 'center', fontWeight: 600, color: freeUnits > 0 ? '#16a34a' : '#6b7280' }}>
                                          {freeUnits > 0 ? (
                                            <span style={{
                                              padding: '0.2rem 0.5rem',
                                              backgroundColor: '#ecfdf3',
                                              color: '#065f46',
                                              borderRadius: '0.25rem',
                                              fontSize: '0.75rem',
                                              fontWeight: 700,
                                              border: '1px solid #bbf7d0'
                                            }}>
                                              {freeUnits}
                                            </span>
                                          ) : '-'}
                                        </td>
                                        <td style={{ textAlign: 'center', fontWeight: 700, color: '#0f172a' }}>{totalQty}</td>
                                        <td style={{ fontWeight: 700, color: '#0f172a' }}>৳{Math.round(getCartItemTotal(item))}</td>
                                        <td style={{ fontWeight: 800, color: '#16a34a', fontSize: '1.05rem' }}>
                                          ৳{(discountEnabled && discountAmount > 0 ? Math.round(getCartItemTotal(item) * parseFloat(discountAmount)) : Math.round(getCartItemTotal(item)))}
                                        </td>
                                        <td>
                                          <span style={{
                                            padding: '0.25rem 0.5rem',
                                            borderRadius: '0.25rem',
                                            fontSize: '0.75rem',
                                            fontWeight: 600,
                                            backgroundColor: '#f3f4f6',
                                            color: '#374151'
                                          }}>
                                            {item.status || 'Pending'}
                                          </span>
                                        </td>
                                        <td>{item.notes || '-'}</td>
                                        <td>
                                          <button
                                            className="admin-action-btn delete"
                                            onClick={() => handleRemoveCartItem(idx)}
                                            style={{
                                              padding: '0.35rem 0.75rem',
                                              fontSize: '0.875rem'
                                            }}
                                          >
                                            {adminContent.delete}
                                          </button>
                                        </td>
                                      </tr>
                                    )
                                  })}
                                </tbody>
                                <tfoot>
                                  <tr>
                                    <td colSpan="5" style={{ textAlign: 'right', fontWeight: 700, padding: '0.75rem' }}>
                                      {language === 'en' ? 'Cart Total:' : 'কার্ট মোট:'}
                                    </td>
                                    <td style={{ fontWeight: 800, fontSize: '1.1rem', color: '#0f172a', padding: '0.75rem' }}>
                                      ৳{Math.round(getOrderCartTotal())}
                                    </td>
                                    <td style={{ fontWeight: 900, fontSize: '1.25rem', color: '#16a34a', padding: '0.75rem' }}>
                                      ৳{(discountEnabled && discountAmount > 0 ? Math.round(getOrderCartTotal() * parseFloat(discountAmount)) : Math.round(getOrderCartTotal()))}
                                    </td>
                                    <td colSpan="3"></td>
                                  </tr>
                                </tfoot>
                              </table>
                            </div>
                            <div className="mobile-card-container">
                              {orderCart.map((item, idx) => {
                                const cartProduct = products.find(p => p._id === item.product)
                                const hasOffer = cartProduct && cartProduct.hasOffer && cartProduct.buyQuantity && cartProduct.freeQuantity
                                const buyQty = hasOffer ? (parseFloat(cartProduct.buyQuantity) || 0) : 0
                                const freeQty = hasOffer ? (parseFloat(cartProduct.freeQuantity) || 0) : 0
                                const orderQty = parseFloat(item.quantity) || 0
                                const eligibleOffers = hasOffer ? Math.floor(orderQty / buyQty) : 0
                                const freeUnits = eligibleOffers * freeQty
                                const totalQty = orderQty + freeUnits

                                return (
                                  <div className="mobile-card" key={idx}>
                                    <div className="mobile-card-header">
                                      <div className="mobile-card-avatar" style={{ backgroundColor: '#e0f2fe', color: '#0369a1' }}>
                                        {(item.productName || item.productId || '?').charAt(0).toUpperCase()}
                                      </div>
                                      <div className="mobile-card-header-text">
                                        <div className="mobile-card-title">{item.productName || item.productId || 'N/A'}</div>
                                        <div className="mobile-card-subtitle">{item.variant?.name || item.variant?.value || '-'}</div>
                                      </div>
                                    </div>
                                    <div className="mobile-card-body">
                                      <div className="mobile-card-row">
                                        <span className="mobile-card-label">{language === 'en' ? 'Quantity' : 'পরিমাণ'}</span>
                                        <span className="mobile-card-value">
                                          {orderQty}
                                          {freeUnits > 0 && <span style={{ color: '#16a34a', marginLeft: '0.25rem' }}>(+{freeUnits} Free)</span>}
                                        </span>
                                      </div>
                                      <div className="mobile-card-row">
                                        <span className="mobile-card-label">{language === 'en' ? 'Total' : 'মোট'}</span>
                                        <span className="mobile-card-value">{totalQty}</span>
                                      </div>
                                      <div className="mobile-card-row">
                                        <span className="mobile-card-label">{language === 'en' ? 'Price' : 'মূল্য'}</span>
                                        <span className="mobile-card-value" style={{ fontWeight: 700 }}>৳{Math.round(getCartItemTotal(item))}</span>
                                      </div>
                                      <div className="mobile-card-row">
                                        <span className="mobile-card-label" style={{ fontWeight: 700 }}>{language === 'en' ? 'Grand Total' : 'সর্বমোট'}</span>
                                        <span className="mobile-card-value" style={{ fontWeight: 800, color: '#16a34a', fontSize: '1.05rem' }}>
                                          ৳{(discountEnabled && discountAmount > 0 ? Math.round(getCartItemTotal(item) * parseFloat(discountAmount)) : Math.round(getCartItemTotal(item)))}
                                        </span>
                                      </div>
                                      <div className="mobile-card-row">
                                        <span className="mobile-card-label">{language === 'en' ? 'Status' : 'স্ট্যাটাস'}</span>
                                        <span className="mobile-card-value">{item.status || 'Pending'}</span>
                                      </div>
                                    </div>
                                    <div className="mobile-card-footer" style={{ marginTop: '1rem', textAlign: 'right' }}>
                                      <button
                                        className="admin-action-btn delete"
                                        onClick={() => handleRemoveCartItem(idx)}
                                        style={{
                                          padding: '0.35rem 1rem',
                                          fontSize: '0.875rem',
                                          backgroundColor: '#ef4444',
                                          color: 'white',
                                          border: 'none',
                                          borderRadius: '0.375rem',
                                          fontWeight: 600
                                        }}
                                      >
                                        {adminContent.delete}
                                      </button>
                                    </div>
                                  </div>
                                )
                              })}
                              {orderCart.length > 0 && (
                                <div className="mobile-card" style={{ marginTop: '1rem', padding: '1rem' }}>
                                  {discountEnabled && discountAmount > 0 && (
                                    <>
                                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontWeight: 600, fontSize: '0.95rem', color: '#475569', marginBottom: '0.5rem' }}>
                                        <span>{language === 'en' ? 'Subtotal:' : 'উপ-মোট:'}</span>
                                        <span>৳{Math.round(getOrderCartTotal())}</span>
                                      </div>
                                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontWeight: 600, fontSize: '0.95rem', color: '#dc2626', marginBottom: '0.5rem' }}>
                                        <span>{language === 'en' ? 'Discount:' : 'ডিসকাউন্ট:'}</span>
                                        <span>{Math.round(((1 - parseFloat(discountAmount)) * 100))}%</span>
                                      </div>
                                    </>
                                  )}
                                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontWeight: 800, fontSize: '1.1rem', color: '#0f172a', paddingTop: discountEnabled && discountAmount > 0 ? '0.5rem' : '0', borderTop: discountEnabled && discountAmount > 0 ? '2px solid #e2e8f0' : 'none' }}>
                                    <span>{language === 'en' ? 'Cart Total:' : 'কার্ট মোট:'}</span>
                                    <span style={{ color: '#16a34a' }}>৳{(discountEnabled && discountAmount > 0 ? Math.round(getOrderCartTotal() * parseFloat(discountAmount)) : Math.round(getOrderCartTotal()))}</span>
                                  </div>
                                </div>
                              )}
                            </div>
                            <div className="admin-order-cart-actions" style={{ display: 'flex', gap: '0.75rem', flexWrap: 'wrap', marginTop: '1rem' }}>
                              <button
                                type="button"
                                disabled={savingOrder}
                                onClick={handleConfirmOrders}
                                style={{
                                  padding: '0.65rem 1.5rem',
                                  backgroundColor: '#16a34a',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '0.5rem',
                                  fontWeight: 700,
                                  cursor: savingOrder ? 'not-allowed' : 'pointer',
                                  boxShadow: '0 10px 20px rgba(22,163,74,0.35)'
                                }}
                              >
                                {savingOrder
                                  ? (language === 'en' ? 'Saving...' : 'সংরক্ষণ হচ্ছে...')
                                  : (language === 'en' ? 'Confirm Order' : 'অর্ডার নিশ্চিত করুন')}
                              </button>
                              <button
                                type="button"
                                onClick={() => {
                                  setOrderCart([])
                                  setShowOrderCart(false)
                                }}
                                style={{
                                  padding: '0.65rem 1.5rem',
                                  backgroundColor: '#ef4444',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '0.5rem',
                                  fontWeight: 700,
                                  cursor: 'pointer',
                                  boxShadow: '0 10px 20px rgba(239,68,68,0.35)'
                                }}
                              >
                                {language === 'en' ? 'Clear Cart' : 'কার্ট খালি করুন'}
                              </button>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                )}

                <div>
                  {showOrderRequests && (
                    <div className="admin-order-requests-overlay" style={{
                      position: 'fixed',
                      top: 0,
                      left: 0,
                      right: 0,
                      bottom: 0,
                      backgroundColor: 'rgba(0, 0, 0, 0.5)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      zIndex: 1000,
                      padding: '1rem'
                    }}>
                      <div className="admin-modal-content" style={{ maxWidth: '1200px' }} onClick={(e) => e.stopPropagation()}>
                        {loadingOrderRequests ? (
                          <LoadingSpinner text={language === 'en' ? 'Loading Requests...' : 'অনুরোধ লোড হচ্ছে...'} />
                        ) : (
                          <>
                            <div style={{
                              position: 'absolute',
                              inset: 0,
                              pointerEvents: 'none',
                              overflow: 'hidden',
                              borderRadius: '0.75rem'
                            }}>
                              <div style={{
                                position: 'absolute',
                                width: '260px',
                                height: '260px',
                                top: '-120px',
                                left: '-80px',
                                background: 'radial-gradient(circle at 30% 30%, rgba(59,130,246,0.25), transparent 60%)',
                                filter: 'blur(20px)'
                              }} />
                              <div style={{
                                position: 'absolute',
                                width: '240px',
                                height: '240px',
                                bottom: '-140px',
                                right: '-100px',
                                background: 'radial-gradient(circle at 70% 70%, rgba(16,185,129,0.22), transparent 60%)',
                                filter: 'blur(20px)'
                              }} />
                            </div>

                            <div style={{ position: 'relative', display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', gap: '1rem' }}>
                              <div>
                                <h2 style={{ margin: 0, fontSize: '1.5rem', fontWeight: 800, color: '#0f172a' }}>
                                  {language === 'en' ? 'Pending Order Requests' : 'অপেক্ষমাণ অর্ডার অনুরোধ'}
                                </h2>
                                <p style={{ margin: '0.25rem 0 0 0', color: '#475569', fontWeight: 600 }}>
                                  {language === 'en' ? 'Approve or reject pending requests' : 'অপেক্ষমাণ অনুরোধ অনুমোদন বা বাতিল করুন'}
                                </p>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                                <span
                                  style={{
                                    fontWeight: 800,
                                    color: '#0ea5e9',
                                    background: '#e0f2fe',
                                    padding: '0.35rem 0.75rem',
                                    borderRadius: '999px',
                                    border: '1px solid #bae6fd',
                                    minWidth: '72px',
                                    textAlign: 'center'
                                  }}
                                >
                                  {orderRequests.length} {language === 'en' ? 'pending' : 'অপেক্ষমাণ'}
                                </span>
                                <button
                                  onClick={() => {
                                    setShowOrderRequests(false)
                                  }}
                                  style={{
                                    background: '#e2e8f0',
                                    border: 'none',
                                    padding: '0.4rem 0.65rem',
                                    borderRadius: '0.375rem',
                                    cursor: 'pointer',
                                    fontWeight: 700,
                                    color: '#475569'
                                  }}
                                >
                                  ×
                                </button>
                              </div>
                            </div>

                            <div style={{ position: 'relative', zIndex: 1 }}>

                              {orderRequests.length === 0 ? (
                                <div style={{ padding: '0.75rem', color: '#475569' }}>
                                  {language === 'en' ? 'No pending requests.' : 'কোনো অপেক্ষমাণ অনুরোধ নেই।'}
                                </div>
                              ) : (
                                <>
                                  <div className="admin-table-container" style={{ background: '#fff', borderRadius: '0.65rem', border: '1px solid #e2e8f0' }}>
                                    <table className="admin-table">
                                      <thead>
                                        <tr>
                                          <th>{language === 'en' ? 'Date' : 'তারিখ'}</th>
                                          <th>{language === 'en' ? 'Order ID' : 'অর্ডার আইডি'}</th>
                                          <th>{language === 'en' ? 'Customer' : 'কাস্টমার'}</th>
                                          <th>{language === 'en' ? 'CID' : 'সিআইডি'}</th>
                                          <th>{language === 'en' ? 'Product' : 'পণ্য'}</th>
                                          <th>{language === 'en' ? 'Variant' : 'ভ্যারিয়েন্ট'}</th>
                                          <th>{language === 'en' ? 'Qty' : 'পরিমাণ'}</th>
                                          <th>{language === 'en' ? 'Requested By' : 'অনুরোধকারী'}</th>
                                          <th>{language === 'en' ? 'Actions' : 'কার্যক্রম'}</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        {orderRequests.map((order) => {
                                          const isAdmin = (userRole || '').toLowerCase() === 'admin'
                                          return (
                                            <tr key={order._id}>
                                              <td>{order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '-'}</td>
                                              <td>{order.orderId || '-'}</td>
                                              <td>{order.dealerName || order.dealer?.name || '-'}</td>
                                              <td>{order.dealerId || order.dealer?.dealerId || '-'}</td>
                                              <td>{order.productName || order.product?.name || '-'}</td>
                                              <td>{order.variant?.productCode ? `${order.variant.productCode} (${order.variant.packSize} ${order.variant.packUnit || 'ml'})` : '-'}</td>
                                              <td>{order.quantity || 0}</td>
                                              <td>{order.requestedByName || order.requestedByRole || '-'}</td>
                                              <td>
                                                <div className="admin-action-buttons">
                                                  {isAdmin ? (
                                                    <>
                                                      <button
                                                        className="admin-action-btn edit"
                                                        onClick={async () => {
                                                          try {
                                                            const res = await fetch(`${API_BASE}/api/orders/${order._id}`, {
                                                              method: 'PUT',
                                                              headers: { 'Content-Type': 'application/json' },
                                                              body: JSON.stringify({
                                                                approvalStatus: 'Approved',
                                                                approvedBy: loggedInUserId,
                                                                approvedByName: loggedInUser || 'Admin'
                                                              })
                                                            })
                                                            const data = await res.json()
                                                            if (!res.ok) throw new Error(data.message || 'Failed to approve')
                                                            await loadOrders()
                                                            await loadOrderRequests()
                                                            // Reload employees to update achieved target
                                                            const empRes = await fetch(`${API_BASE}/api/employees`)
                                                            if (empRes.ok) {
                                                              const empData = await empRes.json()
                                                              setEmployees(empData.data || [])

                                                              // Update viewingEmployee if it's the same employee who created the order
                                                              if (viewingEmployee && order.requestedBy && viewingEmployee._id === order.requestedBy) {
                                                                const updatedEmp = empData.data.find(e => e._id === order.requestedBy)
                                                                if (updatedEmp) {
                                                                  setViewingEmployee({ ...updatedEmp, status: normalizeSalaryStatus(updatedEmp.status) })
                                                                }
                                                              }
                                                            }
                                                          } catch (err) {
                                                            alert(language === 'en' ? 'Approval failed' : 'অনুমোদন ব্যর্থ')
                                                            console.error(err)
                                                          }
                                                        }}
                                                      >
                                                        {language === 'en' ? 'Approve' : 'অনুমোদন'}
                                                      </button>
                                                      <button
                                                        className="admin-action-btn delete"
                                                        onClick={async () => {
                                                          try {
                                                            const res = await fetch(`${API_BASE}/api/orders/${order._id}`, {
                                                              method: 'PUT',
                                                              headers: { 'Content-Type': 'application/json' },
                                                              body: JSON.stringify({ approvalStatus: 'Rejected', status: 'Cancelled' })
                                                            })
                                                            const data = await res.json()
                                                            if (!res.ok) throw new Error(data.message || 'Failed to reject')
                                                            await loadOrders()
                                                            await loadOrderRequests()
                                                          } catch (err) {
                                                            alert(language === 'en' ? 'Rejection failed' : 'বাতিল ব্যর্থ')
                                                            console.error(err)
                                                          }
                                                        }}
                                                      >
                                                        {language === 'en' ? 'Reject' : 'বাতিল'}
                                                      </button>
                                                      <button
                                                        className="admin-action-btn edit"
                                                        style={{ backgroundColor: '#e0e7ff', color: '#1d4ed8' }}
                                                        onClick={() => {
                                                          setViewingOrder(order)
                                                          setIsEditingOrderDetails(false)
                                                          setEditingOrderDetails(null)
                                                        }}
                                                      >
                                                        {language === 'en' ? 'View' : 'দেখুন'}
                                                      </button>
                                                    </>
                                                  ) : (
                                                    <button
                                                      className="admin-action-btn edit"
                                                      onClick={() => {
                                                        setEditingOrderId(order._id)
                                                        const existingItems = Array.isArray(order.items) && order.items.length
                                                          ? order.items
                                                          : [{
                                                            product: order.product?._id || order.product || '',
                                                            productName: order.productName || '',
                                                            productId: order.productId || '',
                                                            variant: order.variant || { name: '', value: '', price: 0 },
                                                            quantity: order.quantity || 1,
                                                            notes: order.notes || '',
                                                            status: order.status || 'Pending'
                                                          }]
                                                        setOrderCart(existingItems.map((it) => ({
                                                          product: it.product,
                                                          productName: it.productName,
                                                          productId: it.productId,
                                                          variant: it.variant,
                                                          quantity: it.quantity,
                                                          notes: it.notes,
                                                          status: ((userRole || '').toLowerCase() === 'admin' && (it.status || 'Pending') === 'Pending') ? 'Processing' : (it.status || 'Pending')
                                                        })))
                                                        setOrderForm({
                                                          dealer: order.dealer?._id || order.dealer || '',
                                                          product: existingItems[0]?.product || '',
                                                          variant: existingItems[0]?.variant || { productCode: '', packSize: '', packUnit: 'ml', cartoonSize: 1, cartoonUnit: 'Pcs', price: 0 },
                                                          quantity: existingItems[0]?.quantity || 1,
                                                          notes: existingItems[0]?.notes || '',
                                                          status: ((userRole || '').toLowerCase() === 'admin' && (existingItems[0]?.status || 'Pending') === 'Pending') ? 'Processing' : (existingItems[0]?.status || 'Pending')
                                                        })
                                                        setShowOrderForm(true)
                                                        setShowOrderCart(true)
                                                        setShowOrderRequests(false)
                                                      }}
                                                    >
                                                      {language === 'en' ? 'Edit' : 'সম্পাদনা'}
                                                    </button>
                                                  )}
                                                </div>
                                              </td>
                                            </tr>
                                          )
                                        })}
                                      </tbody>
                                    </table>
                                  </div>

                                  <div className="mobile-card-container">
                                    {orderRequests.map((order) => {
                                      const isAdmin = (userRole || '').toLowerCase() === 'admin'
                                      // Removed debug logs
                                      return (
                                        <div className="mobile-card" key={order._id}>
                                          <div
                                            className="mobile-card-header"
                                            onClick={() => setExpandedRequestId(prev => (prev === order._id ? null : order._id))}
                                            style={{ cursor: 'pointer' }}
                                          >
                                            <div className="mobile-card-avatar-container" style={{ position: 'relative', width: '3rem', height: '3rem', display: 'flex', alignItems: 'center' }}>
                                              {order.items && order.items.length > 1 ? (
                                                <div style={{ display: 'flex', position: 'relative', width: '100%', height: '100%' }}>
                                                  {order.items.slice(0, 3).map((item, index) => {
                                                    const itemProduct = products.find(p => p._id === item.product || p._id === item.product?._id)
                                                    // Correctly use 'image' for products
                                                    const photoUrl = itemProduct?.image || (item.product && item.product.image)
                                                    return (
                                                      <div key={index} style={{
                                                        width: '2rem',
                                                        height: '2rem',
                                                        borderRadius: '50%',
                                                        border: '2px solid white',
                                                        overflow: 'hidden',
                                                        position: 'absolute',
                                                        left: `${index * 12}px`,
                                                        zIndex: 3 - index,
                                                        backgroundColor: '#f1f5f9',
                                                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                                                      }}>
                                                        {photoUrl ? (
                                                          <img src={photoUrl} alt="Product" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                                                        ) : (
                                                          <div style={{ width: '100%', height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '0.6rem', color: '#0369a1', fontWeight: 'bold' }}>
                                                            {(item.productName || 'P').charAt(0).toUpperCase()}
                                                          </div>
                                                        )}
                                                      </div>
                                                    )
                                                  })}
                                                  {order.items.length > 3 && (
                                                    <div style={{
                                                      width: '2rem',
                                                      height: '2rem',
                                                      borderRadius: '50%',
                                                      border: '2px solid white',
                                                      overflow: 'hidden',
                                                      position: 'absolute',
                                                      left: '36px',
                                                      zIndex: 0,
                                                      backgroundColor: '#e2e8f0',
                                                      display: 'flex',
                                                      alignItems: 'center',
                                                      justifyContent: 'center',
                                                      fontSize: '0.7rem',
                                                      fontWeight: 'bold',
                                                      color: '#64748b'
                                                    }}>
                                                      +{order.items.length - 3}
                                                    </div>
                                                  )}
                                                </div>
                                              ) : (
                                                <div className="mobile-card-avatar" style={{ backgroundColor: '#e0f2fe', color: '#0369a1', overflow: 'hidden', width: '3rem', height: '3rem' }}>
                                                  {products.find(p => p._id === order.product || p._id === order.product?._id)?.image || (order.product && order.product.image) ? (
                                                    <img src={products.find(p => p._id === order.product || p._id === order.product?._id)?.image || (order.product && order.product.image)} alt="Product" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                                                  ) : (
                                                    (order.productName || order.product?.name || '?').charAt(0).toUpperCase()
                                                  )}
                                                </div>
                                              )}
                                            </div>
                                            <div className="mobile-card-header-text">
                                              <div className="mobile-card-title">{order.productName || order.product?.name || 'N/A'}</div>
                                              <div className="mobile-card-subtitle">{customOrderIds[order._id] || order.orderId || '-'}</div>
                                            </div>

                                            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', marginLeft: 'auto', alignSelf: 'stretch', justifyContent: 'space-between', flexShrink: 0, paddingBottom: 0 }}>
                                              <div style={{ fontSize: '0.75rem', color: '#64748b', marginBottom: '0.1rem' }}>
                                                {order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '-'}
                                              </div>
                                              <div style={{ fontSize: '0.85rem', color: '#64748b', marginBottom: '0.15rem', fontWeight: 600 }}>
                                                {(() => {
                                                  const dealerShopName = order.dealer?.shopName
                                                  if (dealerShopName) return dealerShopName
                                                  // Try to find dealer in dealers list
                                                  const dealerId = order.dealer?._id || order.dealer
                                                  const foundDealer = dealers.find(d => d._id === dealerId)
                                                  return foundDealer?.shopName || '-'
                                                })()}
                                              </div>
                                              <div style={{ fontSize: '0.85rem', fontWeight: 600, color: '#334155' }}>
                                                {order.dealerName || order.dealer?.name || 'N/A'}
                                              </div>
                                              <div style={{ fontSize: '0.9rem', fontWeight: 700, color: '#16a34a', marginTop: '0.25rem' }}>
                                                ৳{(() => {
                                                  const total = parseFloat(order.totalPrice || 0)
                                                  const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                                  return Math.round((total * discount))
                                                })()}
                                              </div>
                                            </div>
                                          </div>

                                          {expandedRequestId === order._id && (
                                            <>
                                              <div className="mobile-card-body">
                                                {/* Detailed Items / Fallback */}
                                                {order.items && order.items.length > 0 ? (
                                                  <div style={{ marginTop: '0.5rem', borderTop: '1px dashed #e2e8f0', paddingTop: '0.5rem' }}>
                                                    {order.items.map((item, idx) => {
                                                      // Calculate free quantities
                                                      const itemProduct = products.find(p => p._id === item.product || p._id === item.product?._id)
                                                      const hasOffer = itemProduct && itemProduct.hasOffer && itemProduct.buyQuantity && itemProduct.freeQuantity
                                                      const buyQty = hasOffer ? (parseFloat(itemProduct.buyQuantity) || 0) : 0
                                                      const freeQty = hasOffer ? (parseFloat(itemProduct.freeQuantity) || 0) : 0
                                                      const orderQty = parseFloat(item.quantity) || 0
                                                      const eligibleOffers = hasOffer ? Math.floor(orderQty / buyQty) : 0
                                                      const freeUnits = eligibleOffers * freeQty
                                                      const totalQty = orderQty + freeUnits

                                                      return (
                                                        <div key={idx} style={{ marginBottom: '0.75rem', paddingBottom: '0.75rem', borderBottom: idx < order.items.length - 1 ? '1px solid #f1f5f9' : 'none' }}>
                                                          <div className="mobile-card-row">
                                                            <span className="mobile-card-label" style={{ fontWeight: 600 }}>{item.productName || item.product?.name || `Item ${idx + 1}`}</span>
                                                          </div>
                                                          {item.variant && item.variant.productCode && (
                                                            <div className="mobile-card-row">
                                                              <span className="mobile-card-label" style={{ fontSize: '0.8rem' }}>{language === 'en' ? 'Var' : 'ভ্যারিয়েন্ট'}</span>
                                                              <span className="mobile-card-value" style={{ fontSize: '0.8rem' }}>{item.variant.productCode} ({item.variant.packSize} {item.variant.packUnit || 'ml'})</span>
                                                            </div>
                                                          )}
                                                          <div className="mobile-card-row">
                                                            <span className="mobile-card-label" style={{ fontSize: '0.8rem' }}>{language === 'en' ? 'Qty' : 'পরিমাণ'}</span>
                                                            <span className="mobile-card-value" style={{ fontSize: '0.8rem' }}>
                                                              {orderQty} {freeUnits > 0 && <span style={{ color: '#16a34a' }}>(+{freeUnits} Free)</span>} = {totalQty}
                                                            </span>
                                                          </div>
                                                          <div className="mobile-card-row">
                                                            <span className="mobile-card-label" style={{ fontSize: '0.8rem' }}>{language === 'en' ? 'Price' : 'দাম'}</span>
                                                            <span className="mobile-card-value" style={{ fontSize: '0.8rem' }}>
                                                              {orderQty} x ৳{item.unitPrice !== undefined ? Math.round((item.unitPrice || 0)) : (item.variant?.price || item.variant?.price === 0 ? item.variant.price : (item.product?.price || 0))}
                                                            </span>
                                                          </div>
                                                          <div className="mobile-card-row">
                                                            <span className="mobile-card-label" style={{ fontSize: '0.8rem' }}>{language === 'en' ? 'Total' : 'মোট'}</span>
                                                            <span className="mobile-card-value" style={{ fontWeight: 600 }}>
                                                              ৳{item.totalPrice !== undefined ? Math.round((item.totalPrice || 0)) : Math.round(((parseFloat(item.quantity) || 0) * parseFloat(item.variant?.price || item.variant?.price === 0 ? item.variant.price : (item.product?.price || 0))))}
                                                            </span>
                                                          </div>
                                                          <div className="mobile-card-row">
                                                            <span className="mobile-card-label" style={{ fontSize: '0.8rem', fontWeight: 700 }}>{language === 'en' ? 'Grand Total' : 'সর্বমোট'}</span>
                                                            <span className="mobile-card-value" style={{ fontWeight: 700, color: '#16a34a' }}>
                                                              ৳{(() => {
                                                                const itemTotal = item.totalPrice !== undefined ? (item.totalPrice || 0) : ((parseFloat(item.quantity) || 0) * parseFloat(item.variant?.price || item.variant?.price === 0 ? item.variant.price : (item.product?.price || 0)))
                                                                const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                                                return Math.round((itemTotal * discount))
                                                              })()}
                                                            </span>
                                                          </div>
                                                        </div>
                                                      )
                                                    })}
                                                    <div className="mobile-card-row" style={{ borderTop: '2px solid #e2e8f0', paddingTop: '0.5rem', marginTop: '0.25rem' }}>
                                                      <span className="mobile-card-label" style={{ fontWeight: 700 }}>{language === 'en' ? 'Grand Total' : 'সর্বমোট'}</span>
                                                      <span className="mobile-card-value" style={{ fontWeight: 700, color: '#16a34a', fontSize: '1.1rem' }}>
                                                        ৳{(() => {
                                                          const total = parseFloat(order.totalPrice || 0)
                                                          const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                                          return Math.round((total * discount))
                                                        })()}
                                                      </span>
                                                    </div>
                                                  </div>
                                                ) : (
                                                  <>
                                                    {/* Single Item Fallback (Hidden in Header, shown here for detail completeness) */}
                                                    {order.variant && order.variant.productCode && (
                                                      <div className="mobile-card-row">
                                                        <span className="mobile-card-label">{language === 'en' ? 'Variant' : 'ভ্যারিয়েন্ট'}</span>
                                                        <span className="mobile-card-value">{order.variant.productCode} ({order.variant.packSize} {order.variant.packUnit || 'ml'})</span>
                                                      </div>
                                                    )}
                                                    <div className="mobile-card-row">
                                                      <span className="mobile-card-label">{language === 'en' ? 'Quantity' : 'পরিমাণ'}</span>
                                                      <span className="mobile-card-value">{order.quantity || 0}</span>
                                                    </div>
                                                  </>
                                                )}

                                                <div className="mobile-card-row">
                                                  <span className="mobile-card-label">{language === 'en' ? 'Requested By' : 'অনুরোধকারী'}</span>
                                                  <span className="mobile-card-value">{order.requestedByName || order.requestedByRole || '-'}</span>
                                                </div>
                                              </div>

                                              <div className="mobile-card-actions">
                                                {isAdmin ? (
                                                  <>
                                                    <button
                                                      className="mobile-action-btn"
                                                      style={{ backgroundColor: '#22c55e', color: 'white' }}
                                                      onClick={async (e) => {
                                                        e.stopPropagation()
                                                        try {
                                                          const res = await fetch(`${API_BASE}/api/orders/${order._id}`, {
                                                            method: 'PUT',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({
                                                              approvalStatus: 'Approved',
                                                              approvedBy: loggedInUserId,
                                                              approvedByName: loggedInUser || 'Admin'
                                                            })
                                                          })
                                                          const data = await res.json()
                                                          if (!res.ok) throw new Error(data.message || 'Failed to approve')
                                                          await loadOrders()
                                                          await loadOrderRequests()
                                                          const empRes = await fetch(`${API_BASE}/api/employees`)
                                                          if (empRes.ok) {
                                                            const empData = await empRes.json()
                                                            setEmployees(empData.data || [])
                                                            if (viewingEmployee && order.requestedBy && viewingEmployee._id === order.requestedBy) {
                                                              const updatedEmp = empData.data.find(e => e._id === order.requestedBy)
                                                              if (updatedEmp) {
                                                                setViewingEmployee({ ...updatedEmp, status: normalizeSalaryStatus(updatedEmp.status) })
                                                              }
                                                            }
                                                          }
                                                        } catch (err) {
                                                          alert(language === 'en' ? 'Approval failed' : 'অনুমোদন ব্যর্থ')
                                                          console.error(err)
                                                        }
                                                      }}
                                                    >
                                                      {language === 'en' ? 'Approve' : 'অনুমোদন'}
                                                    </button>
                                                    <button
                                                      className="mobile-action-btn"
                                                      style={{ backgroundColor: '#ef4444', color: 'white' }}
                                                      onClick={async (e) => {
                                                        e.stopPropagation()
                                                        try {
                                                          const res = await fetch(`${API_BASE}/api/orders/${order._id}`, {
                                                            method: 'PUT',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify({ approvalStatus: 'Rejected', status: 'Cancelled' })
                                                          })
                                                          const data = await res.json()
                                                          if (!res.ok) throw new Error(data.message || 'Failed to reject')
                                                          await loadOrders()
                                                          await loadOrderRequests()
                                                        } catch (err) {
                                                          alert(language === 'en' ? 'Rejection failed' : 'বাতিল ব্যর্থ')
                                                          console.error(err)
                                                        }
                                                      }}
                                                    >
                                                      {language === 'en' ? 'Reject' : 'বাতিল'}
                                                    </button>
                                                    <button
                                                      className="mobile-action-btn"
                                                      style={{ backgroundColor: '#e0e7ff', color: '#1d4ed8' }}
                                                      onClick={(e) => {
                                                        e.stopPropagation()
                                                        setViewingOrder(order)
                                                        setIsEditingOrderDetails(false)
                                                        setEditingOrderDetails(null)
                                                      }}
                                                    >
                                                      {language === 'en' ? 'View' : 'দেখুন'}
                                                    </button>
                                                  </>
                                                ) : (
                                                  <button
                                                    className="mobile-action-btn"
                                                    style={{ backgroundColor: '#e0e7ff', color: '#1d4ed8' }}
                                                    onClick={(e) => {
                                                      e.stopPropagation()
                                                      setEditingOrderId(order._id)
                                                      const existingItems = Array.isArray(order.items) && order.items.length
                                                      const item = existingItems ? order.items[0] : {}
                                                      setOrderForm({
                                                        dealer: order.dealerId || order.dealer?._id || '',
                                                        product: order.productId || order.product?._id || item.product || '',
                                                        variant: {
                                                          name: order.variant?.name || item.variant?.name || '',
                                                          value: order.variant?.value || item.variant?.value || '',
                                                          price: order.variant?.price || item.variant?.price || 0
                                                        },
                                                        quantity: order.quantity || item.quantity || 1,
                                                        notes: order.notes || '',
                                                        status: ((userRole || '').toLowerCase() === 'admin' && (order.status || 'Pending') === 'Pending') ? 'Processing' : (order.status || 'Pending'),
                                                        paidAmount: order.paidAmount || 0
                                                      })
                                                      if (order.product?.variants) setSelectedProductVariants(order.product.variants)
                                                      setShowOrderRequests(false)
                                                      setShowOrderForm(true)
                                                    }}
                                                  >
                                                    {language === 'en' ? 'Edit' : 'সম্পাদনা'}
                                                  </button>
                                                )}
                                              </div>
                                            </>
                                          )}
                                        </div>
                                      )
                                    })}
                                  </div>
                                </>
                              )}
                            </div>
                          </>
                        )}
                      </div>
                    </div>
                  )}

                  {!showOrderRequests && !showOrderForm && loadingOrders && (
                    <LoadingSpinner text={language === 'en' ? 'Loading Orders...' : 'অর্ডার লোড হচ্ছে...'} />
                  )}
                  {!showOrderRequests && !showOrderForm && !loadingOrders && (
                    <>
                      <div className="admin-orders-controls" style={{ marginBottom: '1rem' }}>
                        <div className="admin-search-bar admin-orders-search-bar" style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', flexWrap: 'wrap' }}>
                          <input
                            type="text"
                            placeholder={language === 'en' ? 'Search orders...' : 'অর্ডার খুঁজুন...'}
                            value={orderSearch || ''}
                            onChange={(e) => setOrderSearch(e.target.value)}
                            style={{ flex: 1, minWidth: '200px' }}
                          />
                          <div className="admin-orders-filter-buttons" style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', flexWrap: 'wrap' }}>
                            {/* Consolidated Filter Dropdown Button */}
                            <div style={{ position: 'relative', display: 'inline-block' }}>
                              <button
                                onClick={() => setShowOrderFilterDropdown(!showOrderFilterDropdown)}
                                style={{
                                  padding: '0.5rem 1rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '0.875rem',
                                  fontWeight: 600,
                                  cursor: 'pointer',
                                  backgroundColor: 'white',
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '0.5rem',
                                  minWidth: '120px',
                                  justifyContent: 'center'
                                }}
                              >
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                  <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                                </svg>
                                {language === 'en' ? 'Filters' : 'ফিল্টার'}
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ marginLeft: 'auto' }}>
                                  <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                              </button>

                              {/* Dropdown Menu */}
                              {showOrderFilterDropdown && (
                                <div
                                  style={{
                                    position: 'absolute',
                                    top: '100%',
                                    left: 0,
                                    marginTop: '0.5rem',
                                    backgroundColor: 'white',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '0.5rem',
                                    boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
                                    padding: '1rem',
                                    minWidth: '280px',
                                    zIndex: 1000
                                  }}
                                >
                                  {/* Order Status Filter */}
                                  <div style={{ marginBottom: '1rem' }}>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: 600 }}>
                                      {language === 'en' ? 'Order Status' : 'অর্ডার স্ট্যাটাস'}
                                    </label>
                                    <select
                                      value={orderFilter}
                                      onChange={(e) => setOrderFilter(e.target.value)}
                                      style={{
                                        width: '100%',
                                        padding: '0.5rem',
                                        border: '1px solid #d1d5db',
                                        borderRadius: '0.375rem',
                                        fontSize: '0.875rem',
                                        cursor: 'pointer'
                                      }}
                                    >
                                      <option value="all">{language === 'en' ? 'Active Orders' : 'সক্রিয় অর্ডার'}</option>
                                      <option value="rejected">{language === 'en' ? 'Rejected Orders' : 'প্রত্যাখ্যাত অর্ডার'}</option>
                                      <option value="cancelled">{language === 'en' ? 'Cancelled Orders' : 'বাতিল অর্ডার'}</option>
                                    </select>
                                  </div>

                                  {/* Time Filter Type */}
                                  <div style={{ marginBottom: '1rem' }}>
                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: 600 }}>
                                      {language === 'en' ? 'Time Period' : 'সময়কাল'}
                                    </label>
                                    <select
                                      value={orderTimeFilter}
                                      onChange={(e) => setOrderTimeFilter(e.target.value)}
                                      style={{
                                        width: '100%',
                                        padding: '0.5rem',
                                        border: '1px solid #d1d5db',
                                        borderRadius: '0.375rem',
                                        fontSize: '0.875rem',
                                        cursor: 'pointer'
                                      }}
                                    >
                                      <option value="monthly">{language === 'en' ? 'Monthly' : 'মাসিক'}</option>
                                      <option value="yearly">{language === 'en' ? 'Yearly' : 'বার্ষিক'}</option>
                                      <option value="all">{language === 'en' ? 'All Time' : 'সব সময়'}</option>
                                    </select>
                                  </div>

                                  {/* Month Selector */}
                                  {orderTimeFilter === 'monthly' && (
                                    <div style={{ marginBottom: '1rem' }}>
                                      <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: 600 }}>
                                        {language === 'en' ? 'Month' : 'মাস'}
                                      </label>
                                      <select
                                        value={orderSelectedMonth}
                                        onChange={(e) => setOrderSelectedMonth(parseInt(e.target.value))}
                                        style={{
                                          width: '100%',
                                          padding: '0.5rem',
                                          border: '1px solid #d1d5db',
                                          borderRadius: '0.375rem',
                                          fontSize: '0.875rem',
                                          cursor: 'pointer'
                                        }}
                                      >
                                        <option value={0}>{language === 'en' ? 'January' : 'জানুয়ারি'}</option>
                                        <option value={1}>{language === 'en' ? 'February' : 'ফেব্রুয়ারি'}</option>
                                        <option value={2}>{language === 'en' ? 'March' : 'মার্চ'}</option>
                                        <option value={3}>{language === 'en' ? 'April' : 'এপ্রিল'}</option>
                                        <option value={4}>{language === 'en' ? 'May' : 'মে'}</option>
                                        <option value={5}>{language === 'en' ? 'June' : 'জুন'}</option>
                                        <option value={6}>{language === 'en' ? 'July' : 'জুলাই'}</option>
                                        <option value={7}>{language === 'en' ? 'August' : 'আগস্ট'}</option>
                                        <option value={8}>{language === 'en' ? 'September' : 'সেপ্টেম্বর'}</option>
                                        <option value={9}>{language === 'en' ? 'October' : 'অক্টোবর'}</option>
                                        <option value={10}>{language === 'en' ? 'November' : 'নভেম্বর'}</option>
                                        <option value={11}>{language === 'en' ? 'December' : 'ডিসেম্বর'}</option>
                                      </select>
                                    </div>
                                  )}

                                  {/* Year Selector */}
                                  {(orderTimeFilter === 'monthly' || orderTimeFilter === 'yearly') && (
                                    <div style={{ marginBottom: '1rem' }}>
                                      <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem', fontWeight: 600 }}>
                                        {language === 'en' ? 'Year' : 'বছর'}
                                      </label>
                                      <select
                                        value={orderSelectedYear}
                                        onChange={(e) => setOrderSelectedYear(parseInt(e.target.value))}
                                        style={{
                                          width: '100%',
                                          padding: '0.5rem',
                                          border: '1px solid #d1d5db',
                                          borderRadius: '0.375rem',
                                          fontSize: '0.875rem',
                                          cursor: 'pointer'
                                        }}
                                      >
                                        {Array.from({ length: 6 }, (_, i) => new Date().getFullYear() + 1 - i).map(year => (
                                          <option key={year} value={year}>{year}</option>
                                        ))}
                                      </select>
                                    </div>
                                  )}

                                  {/* Apply/Close Button */}
                                  <button
                                    onClick={() => setShowOrderFilterDropdown(false)}
                                    style={{
                                      width: '100%',
                                      padding: '0.5rem',
                                      backgroundColor: '#3b82f6',
                                      color: 'white',
                                      border: 'none',
                                      borderRadius: '0.375rem',
                                      fontSize: '0.875rem',
                                      fontWeight: 600,
                                      cursor: 'pointer'
                                    }}
                                  >
                                    {language === 'en' ? 'Apply Filters' : 'ফিল্টার প্রয়োগ করুন'}
                                  </button>
                                </div>
                              )}
                            </div>




                            <button
                              onClick={handleExportOrders}
                              style={{
                                padding: '0.5rem 1rem',
                                backgroundColor: '#10b981',
                                color: 'white',
                                border: 'none',
                                borderRadius: '0.375rem',
                                cursor: 'pointer',
                                fontWeight: 600,
                                fontSize: '0.875rem',
                                whiteSpace: 'nowrap',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.5rem'
                              }}
                            >
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                              </svg>
                              {language === 'en' ? 'Export Excel' : 'এক্সেল রপ্তানি'}
                            </button>
                          </div>
                        </div>
                      </div>
                      <div className="admin-table-container">
                        <table className="admin-table">

                          <thead>
                            <tr>
                              <th
                                onClick={() => handleSortOrders('date')}
                                style={{ cursor: 'pointer', userSelect: 'none', textAlign: 'center' }}
                              >
                                {language === 'en' ? 'Date' : 'তারিখ'}
                                {orderSortField === 'date' && (orderSortDirection === 'asc' ? ' ↑' : ' ↓')}
                              </th>
                              <th
                                onClick={() => handleSortOrders('orderId')}
                                style={{ cursor: 'pointer', userSelect: 'none', textAlign: 'center' }}
                              >
                                {language === 'en' ? 'Order ID' : 'অর্ডার আইডি'}
                                {orderSortField === 'orderId' && (orderSortDirection === 'asc' ? ' ↑' : ' ↓')}
                              </th>
                              <th
                                onClick={() => handleSortOrders('dealer')}
                                style={{ cursor: 'pointer', userSelect: 'none', textAlign: 'center' }}
                              >
                                {language === 'en' ? 'Customer' : 'কাস্টমার'}
                                {orderSortField === 'dealer' && (orderSortDirection === 'asc' ? ' ↑' : ' ↓')}
                              </th>
                              <th
                                onClick={() => handleSortOrders('dealerId')}
                                style={{ cursor: 'pointer', userSelect: 'none', textAlign: 'center' }}
                              >
                                {language === 'en' ? 'CID' : 'সিআইডি'}
                                {orderSortField === 'dealerId' && (orderSortDirection === 'asc' ? ' ↑' : ' ↓')}
                              </th>
                              <th
                                onClick={() => handleSortOrders('product')}
                                style={{ cursor: 'pointer', userSelect: 'none', textAlign: 'center' }}
                              >
                                {language === 'en' ? 'Product' : 'পণ্য'}
                                {orderSortField === 'product' && (orderSortDirection === 'asc' ? ' ↑' : ' ↓')}
                              </th>
                              <th style={{ textAlign: 'center' }}>{language === 'en' ? 'Variant' : 'ভ্যারিয়েন্ট'}</th>
                              <th
                                onClick={() => handleSortOrders('totalQuantity')}
                                style={{ cursor: 'pointer', userSelect: 'none', textAlign: 'center' }}
                              >
                                {language === 'en' ? 'Total Quantity' : 'মোট পরিমাণ'}
                                {orderSortField === 'totalQuantity' && (orderSortDirection === 'asc' ? ' ↑' : ' ↓')}
                              </th>
                              <th
                                onClick={() => handleSortOrders('createdBy')}
                                style={{ cursor: 'pointer', userSelect: 'none', textAlign: 'center' }}
                              >
                                {language === 'en' ? 'Created By' : 'তৈরিকারী'}
                                {orderSortField === 'createdBy' && (orderSortDirection === 'asc' ? ' ↑' : ' ↓')}
                              </th>
                              <th
                                onClick={() => handleSortOrders('totalPrice')}
                                style={{ cursor: 'pointer', userSelect: 'none', textAlign: 'center' }}
                              >
                                {language === 'en' ? 'Total Price' : 'মোট মূল্য'}
                                {orderSortField === 'totalPrice' && (orderSortDirection === 'asc' ? ' ↑' : ' ↓')}
                              </th>
                              <th style={{ textAlign: 'center' }}>
                                {language === 'en' ? 'Grand Total' : 'সর্বমোট'}
                              </th>
                              <th
                                onClick={() => handleSortOrders('paidAmount')}
                                style={{ cursor: 'pointer', userSelect: 'none', textAlign: 'center' }}
                              >
                                {language === 'en' ? 'Paid Amount' : 'পরিশোধিত পরিমাণ'}
                                {orderSortField === 'paidAmount' && (orderSortDirection === 'asc' ? ' ↑' : ' ↓')}
                              </th>
                              <th style={{ textAlign: 'center' }}>
                                {language === 'en' ? 'Commission' : 'কমিশন'}
                              </th>
                              <th
                                onClick={() => handleSortOrders('dueAmount')}
                                style={{ cursor: 'pointer', userSelect: 'none', textAlign: 'center' }}
                              >
                                {language === 'en' ? 'Due Amount' : 'বাকি পরিমাণ'}
                                {orderSortField === 'dueAmount' && (orderSortDirection === 'asc' ? ' ↑' : ' ↓')}
                              </th>
                              <th style={{ textAlign: 'center' }}>{language === 'en' ? 'Actions' : 'কার্যক্রম'}</th>
                            </tr>
                          </thead>
                          <tbody>
                            {sortedOrders.length ? sortedOrders.map((order) => {
                              const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                              const grandTotal = parseFloat(order.totalPrice || 0) * discount
                              return (
                                <tr
                                  key={order._id}
                                  onClick={() => {
                                    if (order.items && order.items.length > 1) {
                                      toggleOrderRow(order._id)
                                    }
                                  }}
                                  style={{
                                    cursor: (order.items && order.items.length > 1) ? 'pointer' : 'default',
                                    transition: 'background-color 0.1s ease'
                                  }}
                                  className={order.items && order.items.length > 1 ? "hover:bg-gray-50" : ""}
                                >
                                  <td style={{ textAlign: 'center' }}>{order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '-'}</td>
                                  <td style={{ textAlign: 'center', fontWeight: 'bold', color: '#475569' }}>
                                    {customOrderIds[order._id] || order.orderId || '-'}
                                  </td>
                                  <td style={{ textAlign: 'center' }}>
                                    {(() => {
                                      const dealer = dealers.find(d => d._id === (order.dealer?._id || order.dealer)) || order.dealer;
                                      const shopName = dealer?.shopName || order.dealer?.shopName;
                                      const name = order.dealerName || dealer?.name || order.dealer?.name;
                                      return shopName ? (
                                        <span style={{ fontWeight: 600 }}>{shopName}</span>
                                      ) : (
                                        name || '-'
                                      );
                                    })()}
                                  </td>
                                  <td style={{ textAlign: 'center' }}>{order.dealerId || order.dealer?.dealerId || '-'}</td>
                                  <td style={{ textAlign: 'center' }}>
                                    {order.items && order.items.length > 1 ? (
                                      expandedOrderRows.includes(order._id) ? (
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.25rem' }}>
                                          {order.items.map((item, idx) => (
                                            <div key={idx} style={{ borderBottom: idx < order.items.length - 1 ? '1px solid #f1f5f9' : 'none', padding: '6px 4px', minHeight: '45px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                              {item.productName || item.product?.name || '-'}
                                            </div>
                                          ))}

                                        </div>
                                      ) : (
                                        <div style={{ padding: '0.5rem', color: '#3b82f6', fontWeight: 600 }}>
                                          Multiple Products ({order.items.length})

                                        </div>
                                      )
                                    ) : (
                                      (order.items && order.items.length === 1) ? (
                                        order.items[0].productName || order.items[0].product?.name || '-'
                                      ) : (
                                        order.productName || order.product?.name || '-'
                                      )
                                    )}
                                  </td>
                                  <td style={{ textAlign: 'center' }}>
                                    {order.items && order.items.length > 1 ? (
                                      expandedOrderRows.includes(order._id) ? (
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.25rem' }}>
                                          {order.items.map((item, idx) => (
                                            <div key={idx} style={{ borderBottom: idx < order.items.length - 1 ? '1px solid #f1f5f9' : 'none', padding: '6px 4px', minHeight: '45px', display: 'flex', alignItems: 'center', justifyContent: 'center', whiteSpace: 'nowrap' }}>
                                              {item.variant && item.variant.packSize
                                                ? `${item.variant.packSize} ${item.variant.packUnit || 'ml'} (${item.variant.cartoonSize || 1} ${item.variant.cartoonUnit || 'Pcs'})`
                                                : '-'}
                                            </div>
                                          ))}
                                        </div>
                                      ) : (
                                        <div style={{ padding: '0.5rem', color: '#64748b' }}>
                                          -
                                        </div>
                                      )
                                    ) : (
                                      (order.items && order.items.length === 1) ? (
                                        (order.items[0].variant && order.items[0].variant.packSize)
                                          ? `${order.items[0].variant.packSize} ${order.items[0].variant.packUnit || 'ml'} (${order.items[0].variant.cartoonSize || 1} ${order.items[0].variant.cartoonUnit || 'Pcs'})`
                                          : '-'
                                      ) : (
                                        order.variant && order.variant.packSize
                                          ? `${order.variant.packSize} ${order.variant.packUnit || 'ml'} (${order.variant.cartoonSize || 1} ${order.variant.cartoonUnit || 'Pcs'})`
                                          : '-'
                                      )
                                    )}
                                  </td>
                                  <td style={{ fontWeight: 700, color: '#0f172a', textAlign: 'center' }}>
                                    {order.items && order.items.length > 1 ? (
                                      expandedOrderRows.includes(order._id) ? (
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.25rem' }}>
                                          {order.items.map((item, idx) => {
                                            const itemQty = parseFloat(item.quantity) || 0
                                            let freeQty = 0
                                            const itemProduct = products.find(p => p._id === item.product || p._id === item.product?._id)
                                            if (itemProduct && itemProduct.hasOffer && itemProduct.buyQuantity && itemProduct.freeQuantity) {
                                              const buyQty = parseFloat(itemProduct.buyQuantity) || 0
                                              const offerFreeQty = parseFloat(itemProduct.freeQuantity) || 0
                                              if (buyQty > 0) {
                                                const eligibleOffers = Math.floor(itemQty / buyQty)
                                                freeQty = eligibleOffers * offerFreeQty
                                              }
                                            }
                                            return (
                                              <div key={idx} style={{ borderBottom: idx < order.items.length - 1 ? '1px solid #f1f5f9' : 'none', padding: '6px 4px', minHeight: '45px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                                {freeQty > 0 ? `${itemQty}+${freeQty}=${itemQty + freeQty}` : itemQty}
                                              </div>
                                            )
                                          })}
                                        </div>
                                      ) : (
                                        <div style={{ padding: '0.5rem' }}>
                                          {(() => {
                                            const totalQty = order.items.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0), 0)
                                            return <span style={{ color: '#3b82f6', fontWeight: 700 }}>{totalQty} (Total)</span>
                                          })()}
                                        </div>
                                      )
                                    ) : (
                                      (order.items && order.items.length === 1) ? (
                                        (() => {
                                          const item = order.items[0]
                                          const itemQty = parseFloat(item.quantity) || 0
                                          let freeQty = 0
                                          const itemProduct = products.find(p => p._id === item.product || p._id === item.product?._id)
                                          if (itemProduct && itemProduct.hasOffer && itemProduct.buyQuantity && itemProduct.freeQuantity) {
                                            const buyQty = parseFloat(itemProduct.buyQuantity) || 0
                                            const offerFreeQty = parseFloat(itemProduct.freeQuantity) || 0
                                            if (buyQty > 0) {
                                              const eligibleOffers = Math.floor(itemQty / buyQty)
                                              freeQty = eligibleOffers * offerFreeQty
                                            }
                                          }
                                          return (
                                            <span>
                                              {freeQty > 0 ? `${itemQty}+${freeQty}=${itemQty + freeQty}` : itemQty}
                                            </span>
                                          )
                                        })()
                                      ) : (
                                        (() => {
                                          // Single item order logic (legacy)
                                          const totalPurchasedQty = parseFloat(order.quantity) || 0
                                          let totalFreeQty = 0
                                          const orderProduct = products.find(p => p._id === order.product || p._id === order.product?._id)
                                          if (orderProduct && orderProduct.hasOffer && orderProduct.buyQuantity && orderProduct.freeQuantity) {
                                            const buyQty = parseFloat(orderProduct.buyQuantity) || 0
                                            const freeQty = parseFloat(orderProduct.freeQuantity) || 0
                                            if (buyQty > 0) {
                                              const eligibleOffers = Math.floor(totalPurchasedQty / buyQty)
                                              totalFreeQty = eligibleOffers * freeQty
                                            }
                                          }
                                          return (
                                            <span>
                                              {totalFreeQty > 0 ? `${totalPurchasedQty}+${totalFreeQty}=${totalPurchasedQty + totalFreeQty}` : totalPurchasedQty}
                                            </span>
                                          )
                                        })()
                                      )
                                    )}
                                  </td>
                                  <td style={{ textAlign: 'center' }}>{order.requestedByName || order.requestedByRole || '-'}</td>
                                  <td style={{ textAlign: 'center' }}>৳{Math.round((order.totalPrice || 0))}</td>
                                  <td style={{ textAlign: 'center', fontWeight: 700, color: '#16a34a' }}>
                                    ৳{Math.round(grandTotal)}
                                  </td>
                                  <td style={{ fontWeight: 600, color: '#16a34a', textAlign: 'center' }}>
                                    ৳{(() => {
                                      const paid = parseFloat(order.paidAmount) || 0
                                      const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                                      return Math.round((paid + commission))
                                    })()}
                                  </td>
                                  <td style={{ fontWeight: 600, color: '#111827', textAlign: 'center' }}>
                                    ৳{(() => {
                                      const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                                      return Math.round(commission)
                                    })()}
                                  </td>
                                  <td style={{
                                    fontWeight: 600, color: (() => {
                                      const paid = parseFloat(order.paidAmount || 0)
                                      const commission = (order.paymentHistory || []).reduce((sum, p) => sum + (parseFloat(p.commission) || 0), 0)
                                      const due = Math.max(0, grandTotal - (paid + commission))
                                      return due > 0 ? '#dc2626' : '#16a34a'
                                    })()
                                  }}>
                                    ৳{(() => {
                                      const paid = parseFloat(order.paidAmount || 0)
                                      const commission = (order.paymentHistory || []).reduce((sum, p) => sum + (parseFloat(p.commission) || 0), 0)
                                      const due = Math.max(0, grandTotal - (paid + commission))
                                      return Math.round(due)
                                    })()}
                                  </td>
                                  <td style={{ textAlign: 'center' }}>
                                    <div className="admin-action-buttons" style={{ justifyContent: 'center', flexDirection: 'column', gap: '0.5rem', alignItems: 'center' }}>
                                      <span style={{
                                        padding: '0.25rem 0.5rem',
                                        borderRadius: '0.25rem',
                                        fontSize: '0.75rem',
                                        fontWeight: 600,
                                        backgroundColor:
                                          order.status === 'Complete' ? '#dcfce7' :
                                            order.status === 'Delivered' ? '#d1fae5' :
                                              order.status === 'Shipped' ? '#dbeafe' :
                                                order.status === 'Processing' ? '#fef3c7' :
                                                  order.status === 'Cancelled' ? '#fee2e2' :
                                                    '#f3f4f6',
                                        color:
                                          order.status === 'Complete' ? '#166534' :
                                            order.status === 'Delivered' ? '#065f46' :
                                              order.status === 'Shipped' ? '#1e40af' :
                                                order.status === 'Processing' ? '#92400e' :
                                                  order.status === 'Cancelled' ? '#b91c1c' :
                                                    '#374151',
                                        marginBottom: '0.25rem'
                                      }}>
                                        {order.status || 'Pending'}
                                      </span>
                                      <button
                                        className="admin-action-btn edit"
                                        style={{ backgroundColor: '#e0e7ff', color: '#1d4ed8', width: '100%' }}
                                        onClick={(e) => { e.stopPropagation(); setViewingOrder(order); }}
                                      >
                                        {language === 'en' ? 'View' : 'দেখুন'}
                                      </button>
                                      <button
                                        className="admin-action-btn"
                                        style={{
                                          backgroundColor: '#f3f4f6',
                                          color: '#374151',
                                          width: '100%',
                                          display: window.innerWidth > 768 ? 'none' : 'block'
                                        }}
                                        onClick={(e) => { e.stopPropagation(); handlePrintOrder(order); }}
                                      >
                                        {language === 'en' ? 'Print Invoice' : 'ইনভয়েস প্রিন্ট'}
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                              )
                            }) : (
                              <tr>
                                <td colSpan="14" style={{ textAlign: 'center', padding: '2rem' }}>
                                  {adminContent.noData}
                                </td>
                              </tr>
                            )}
                          </tbody>
                        </table>
                      </div>

                      {/* Mobile Card View for Orders */}
                      <div className="mobile-card-container" style={{ marginTop: '1rem' }}>
                        {sortedOrders.length === 0 ? (
                          <div style={{ textAlign: 'center', padding: '2rem', color: '#6b7280' }}>
                            {adminContent.noData}
                          </div>
                        ) : (
                          sortedOrders.map((order) => {
                            // Calculate financial values for card
                            const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                            const grandTotalOrderPrice = parseFloat(order.totalPrice || 0) * discount
                            const paid = parseFloat(order.paidAmount) || 0
                            const commission = (order.paymentHistory || []).reduce((cSum, p) => cSum + (parseFloat(p.commission) || 0), 0)
                            const due = Math.max(0, grandTotalOrderPrice - (paid + commission))

                            // Calculate total quantity for card
                            let totalPurchasedQty = 0
                            let totalFreeQty = 0
                            if (order.items && Array.isArray(order.items) && order.items.length > 0) {
                              order.items.forEach(item => {
                                const itemQty = parseFloat(item.quantity) || 0
                                totalPurchasedQty += itemQty
                                const itemProduct = products.find(p => p._id === item.product || p._id === item.product?._id)
                                if (itemProduct && itemProduct.hasOffer && itemProduct.buyQuantity && itemProduct.freeQuantity) {
                                  const buyQty = parseFloat(itemProduct.buyQuantity) || 0
                                  const freeQty = parseFloat(itemProduct.freeQuantity) || 0
                                  if (buyQty > 0) {
                                    const eligibleOffers = Math.floor(itemQty / buyQty)
                                    totalFreeQty += eligibleOffers * freeQty
                                  }
                                }
                              })
                            } else {
                              totalPurchasedQty = parseFloat(order.quantity) || 0
                              const orderProduct = products.find(p => p._id === order.product || p._id === order.product?._id)
                              if (orderProduct && orderProduct.hasOffer && orderProduct.buyQuantity && orderProduct.freeQuantity) {
                                const buyQty = parseFloat(orderProduct.buyQuantity) || 0
                                const freeQty = parseFloat(orderProduct.freeQuantity) || 0
                                if (buyQty > 0) {
                                  const eligibleOffers = Math.floor(totalPurchasedQty / buyQty)
                                  totalFreeQty = eligibleOffers * freeQty
                                }
                              }
                            }
                            const totalQty = totalPurchasedQty + totalFreeQty

                            return (
                              <div className="mobile-card" key={order._id}>
                                <div
                                  className="mobile-card-header"
                                  onClick={() => setExpandedOrderId(prev => (prev === order._id ? null : order._id))}
                                  style={{ cursor: 'pointer' }}
                                >
                                  <div className="mobile-card-avatar-container" style={{ position: 'relative', width: '3rem', height: '3rem', display: 'flex', alignItems: 'center' }}>
                                    {order.items && order.items.length > 1 ? (
                                      <div style={{ display: 'flex', position: 'relative', width: '100%', height: '100%' }}>
                                        {order.items.slice(0, 3).map((item, index) => {
                                          const itemProduct = products.find(p => p._id === item.product || p._id === item.product?._id)
                                          // Correctly use 'image' for products
                                          const photoUrl = itemProduct?.image || (item.product && item.product.image)
                                          return (
                                            <div key={index} style={{
                                              width: '2rem',
                                              height: '2rem',
                                              borderRadius: '50%',
                                              border: '2px solid white',
                                              overflow: 'hidden',
                                              position: 'absolute',
                                              left: `${index * 12}px`,
                                              zIndex: 3 - index,
                                              backgroundColor: '#f1f5f9',
                                              boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                                            }}>
                                              {photoUrl ? (
                                                <img src={photoUrl} alt="Product" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                                              ) : (
                                                <div style={{ width: '100%', height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '0.6rem', color: '#64748b', fontWeight: 'bold' }}>
                                                  {(item.productName || 'P').charAt(0).toUpperCase()}
                                                </div>
                                              )}
                                            </div>
                                          )
                                        })}
                                        {order.items.length > 3 && (
                                          <div style={{
                                            width: '2rem',
                                            height: '2rem',
                                            borderRadius: '50%',
                                            border: '2px solid white',
                                            overflow: 'hidden',
                                            position: 'absolute',
                                            left: '36px',
                                            zIndex: 0,
                                            backgroundColor: '#e2e8f0',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontSize: '0.7rem',
                                            fontWeight: 'bold',
                                            color: '#64748b'
                                          }}>
                                            +{order.items.length - 3}
                                          </div>
                                        )}
                                      </div>
                                    ) : (
                                      <div className="mobile-card-avatar" style={{ backgroundColor: '#f0fdf4', color: '#15803d', overflow: 'hidden', width: '3rem', height: '3rem' }}>
                                        {order.items && order.items.length === 1 && (products.find(p => p._id === order.items[0].product || p._id === order.items[0].product?._id)?.image || (order.items[0].product && order.items[0].product.image)) ? (
                                          <img src={products.find(p => p._id === order.items[0].product || p._id === order.items[0].product?._id)?.image || (order.items[0].product && order.items[0].product.image)} alt="Product" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                                        ) : products.find(p => p._id === order.product || p._id === order.product?._id)?.image ? (
                                          <img src={products.find(p => p._id === order.product || p._id === order.product?._id)?.image} alt="Product" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                                        ) : (
                                          (order.items && order.items.length === 1 ? (order.items[0].productName || 'P') : (order.productName || order.product?.name || '?')).charAt(0).toUpperCase()
                                        )}
                                      </div>
                                    )}
                                  </div>
                                  <div className="mobile-card-header-text">
                                    <div className="mobile-card-title" style={{ fontSize: '0.85rem', fontWeight: 600 }}>
                                      {(() => {
                                        const dealerShopName = order.dealer?.shopName
                                        if (dealerShopName) return dealerShopName
                                        // Try to find dealer in dealers list
                                        const dealerId = order.dealer?._id || order.dealer
                                        const foundDealer = dealers.find(d => d._id === dealerId)
                                        return foundDealer?.shopName || '-'
                                      })()}
                                    </div>
                                    <div className="mobile-card-subtitle" style={{ marginTop: '0.15rem' }}>
                                      {order.dealerName || order.dealer?.name || 'N/A'}
                                    </div>
                                    <div className="mobile-card-subtitle">{customOrderIds[order._id] || order.orderId || '-'}</div>
                                  </div>

                                  <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', marginLeft: 'auto', alignSelf: 'stretch', justifyContent: 'space-between', flexShrink: 0, paddingBottom: 0 }}>
                                    <div className="mobile-card-status-badge" style={{
                                      backgroundColor:
                                        order.status === 'Complete' ? '#dcfce7' :
                                          order.status === 'Delivered' ? '#d1fae5' :
                                            order.status === 'Shipped' ? '#dbeafe' :
                                              order.status === 'Processing' ? '#fef3c7' :
                                                order.status === 'Cancelled' ? '#fee2e2' :
                                                  '#f3f4f6',
                                      color:
                                        order.status === 'Complete' ? '#166534' :
                                          order.status === 'Delivered' ? '#065f46' :
                                            order.status === 'Shipped' ? '#1e40af' :
                                              order.status === 'Processing' ? '#92400e' :
                                                order.status === 'Cancelled' ? '#b91c1c' :
                                                  '#374151',
                                      margin: 0,
                                      whiteSpace: 'nowrap',
                                      alignSelf: 'flex-end',
                                      fontSize: '0.75rem',
                                      padding: '0.15rem 0.5rem'
                                    }}>
                                      {order.status || 'Pending'}
                                    </div>

                                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', marginTop: '2.5rem' }}>
                                      <div style={{ fontSize: '0.75rem', color: '#64748b', marginBottom: '0.1rem' }}>
                                        {order.createdAt ? new Date(order.createdAt).toLocaleDateString() : '-'}
                                      </div>
                                      <div style={{ fontSize: '0.9rem', fontWeight: 700, color: '#475569' }}>
                                        ৳{Math.round(grandTotalOrderPrice)}
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                {expandedOrderId === order._id && (
                                  <>
                                    <div className="mobile-card-body">
                                      <div className="mobile-card-row">
                                        <span className="mobile-card-label">{language === 'en' ? 'Created By' : 'তৈরিকারী'}</span>
                                        <span className="mobile-card-value">{order.requestedByName || order.requestedByRole || '-'}</span>
                                      </div>

                                      {order.items && order.items.length > 0 ? (
                                        <div style={{ marginTop: '0.5rem', borderTop: '1px dashed #e2e8f0', paddingTop: '0.5rem' }}>
                                          {order.items.map((item, idx) => {
                                            const itemProduct = products.find(p => p._id === item.product || p._id === item.product?._id)
                                            const hasOffer = itemProduct && itemProduct.hasOffer && itemProduct.buyQuantity && itemProduct.freeQuantity
                                            const buyQty = hasOffer ? (parseFloat(itemProduct.buyQuantity) || 0) : 0
                                            const freeQty = hasOffer ? (parseFloat(itemProduct.freeQuantity) || 0) : 0
                                            const orderQty = parseFloat(item.quantity) || 0
                                            const eligibleOffers = (hasOffer && buyQty > 0) ? Math.floor(orderQty / buyQty) : 0
                                            const freeUnits = eligibleOffers * freeQty
                                            const itemTotalQty = orderQty + freeUnits

                                            return (
                                              <div key={idx} style={{ marginBottom: '0.75rem', paddingBottom: '0.75rem', borderBottom: idx < order.items.length - 1 ? '1px solid #f1f5f9' : 'none' }}>
                                                <div className="mobile-card-row">
                                                  <span className="mobile-card-label" style={{ fontWeight: 600 }}>{item.productName || item.product?.name || `Item ${idx + 1}`}</span>
                                                </div>
                                                {item.variant && (item.variant.productCode || item.variant.packSize || item.variant.name) && (
                                                  <div className="mobile-card-row">
                                                    <span className="mobile-card-label" style={{ fontSize: '0.8rem' }}>{language === 'en' ? 'Var' : 'ভ্যারিয়েন্ট'}</span>
                                                    <span className="mobile-card-value" style={{ fontSize: '0.8rem' }}>
                                                      {item.variant.productCode ? `${item.variant.productCode} ` : ''}
                                                      {item.variant.packSize ? `(${item.variant.packSize} ${item.variant.packUnit || 'ml'}` : ''}
                                                      {item.variant.cartoonSize ? ` - ${item.variant.cartoonSize} ${item.variant.cartoonUnit || 'Pcs'}/Cartoon` : ''}
                                                      {item.variant.packSize ? ')' : (item.variant.name || item.variant.value || '-')}
                                                    </span>
                                                  </div>
                                                )}
                                                <div className="mobile-card-row">
                                                  <span className="mobile-card-label" style={{ fontSize: '0.8rem' }}>{language === 'en' ? 'Qty' : 'পরিমাণ'}</span>
                                                  <span className="mobile-card-value" style={{ fontSize: '0.8rem' }}>
                                                    {orderQty} {freeUnits > 0 ? `+ ${freeUnits} Free` : ''} = {itemTotalQty}
                                                  </span>
                                                </div>
                                                <div className="mobile-card-row">
                                                  <span className="mobile-card-label" style={{ fontSize: '0.8rem' }}>{language === 'en' ? 'Price' : 'দাম'}</span>
                                                  <span className="mobile-card-value" style={{ fontSize: '0.8rem' }}>
                                                    {orderQty} x ৳{item.unitPrice !== undefined ? Math.round((item.unitPrice || 0)) : (item.variant?.price || item.variant?.price === 0 ? item.variant.price : (item.product?.price || 0))}
                                                  </span>
                                                </div>
                                                <div className="mobile-card-row">
                                                  <span className="mobile-card-label" style={{ fontSize: '0.8rem' }}>{language === 'en' ? 'Total' : 'মোট'}</span>
                                                  <span className="mobile-card-value" style={{ fontWeight: 600 }}>
                                                    ৳{item.totalPrice !== undefined ? Math.round((item.totalPrice || 0)) : Math.round(((parseFloat(item.quantity) || 0) * parseFloat(item.variant?.price || item.variant?.price === 0 ? item.variant.price : (item.product?.price || 0))))}
                                                  </span>
                                                </div>
                                                <div className="mobile-card-row">
                                                  <span className="mobile-card-label" style={{ fontSize: '0.8rem', fontWeight: 700 }}>{language === 'en' ? 'Grand Total' : 'সর্বমোট'}</span>
                                                  <span className="mobile-card-value" style={{ fontWeight: 700, color: '#16a34a' }}>
                                                    ৳{(() => {
                                                      const itemTotal = item.totalPrice !== undefined ? (item.totalPrice || 0) : ((parseFloat(item.quantity) || 0) * parseFloat(item.variant?.price || item.variant?.price === 0 ? item.variant.price : (item.product?.price || 0)))
                                                      return Math.round((itemTotal * discount))
                                                    })()}
                                                  </span>
                                                </div>
                                              </div>
                                            )
                                          })}
                                        </div>
                                      ) : (
                                        <>
                                          <div className="mobile-card-row">
                                            <span className="mobile-card-label">{language === 'en' ? 'Product' : 'পণ্য'}</span>
                                            <span className="mobile-card-value">{order.productName || order.product?.name || '-'}</span>
                                          </div>
                                          {order.variant && order.variant.productCode && (
                                            <div className="mobile-card-row">
                                              <span className="mobile-card-label">{language === 'en' ? 'Variant' : 'ভ্যারিয়েন্ট'}</span>
                                              <span className="mobile-card-value">{order.variant.productCode} ({order.variant.packSize} {order.variant.packUnit || 'ml'})</span>
                                            </div>
                                          )}
                                          <div className="mobile-card-row">
                                            <span className="mobile-card-label">{language === 'en' ? 'Total Quantity' : 'মোট পরিমাণ'}</span>
                                            <span className="mobile-card-value">{totalQty}</span>
                                          </div>
                                        </>
                                      )}

                                      {/* Price Summary Section */}
                                      <div style={{ marginTop: '0.75rem', borderTop: '2px solid #e2e8f0', paddingTop: '0.5rem' }}>
                                        {discount < 1 && (
                                          <div className="mobile-card-row">
                                            <span className="mobile-card-label">{language === 'en' ? 'Subtotal' : 'উপ-মোট'}</span>
                                            <span className="mobile-card-value">৳{Math.round(parseFloat(order.totalPrice || 0))}</span>
                                          </div>
                                        )}
                                        {discount < 1 && (
                                          <div className="mobile-card-row">
                                            <span className="mobile-card-label">{language === 'en' ? 'Discount' : 'ডিসকাউন্ট'}</span>
                                            <span className="mobile-card-value" style={{ color: '#dc2626' }}>{Math.round(((1 - discount) * 100))}%</span>
                                          </div>
                                        )}
                                        <div className="mobile-card-row" style={{ marginBottom: '0.5rem' }}>
                                          <span className="mobile-card-label" style={{ fontWeight: 700 }}>{language === 'en' ? 'Grand Total' : 'সর্বমোট'}</span>
                                          <span className="mobile-card-value" style={{ fontWeight: 700, color: '#0f172a', fontSize: '1.1rem' }}>
                                            ৳{Math.round(grandTotalOrderPrice)}
                                          </span>
                                        </div>
                                      </div>

                                      {/* Payment Summary Section */}
                                      <div style={{ borderTop: '1px solid #e2e8f0', paddingTop: '0.5rem' }}>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Paid Amount' : 'পরিশোধিত পরিমাণ'}</span>
                                          <span className="mobile-card-value" style={{ color: '#16a34a' }}>
                                            ৳{Math.round(paid)}
                                          </span>
                                        </div>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Commission' : 'কমিশন'}</span>
                                          <span className="mobile-card-value" style={{ color: '#ca8a04' }}>
                                            ৳{Math.round(commission)}
                                          </span>
                                        </div>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Total Paid Amount' : 'সর্বমোট পরিশোধিত'}</span>
                                          <span className="mobile-card-value" style={{ color: '#16a34a', fontWeight: 600 }}>
                                            ৳{Math.round((paid + commission))}
                                          </span>
                                        </div>

                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Due Amount' : 'বাকি পরিমাণ'}</span>
                                          <span className="mobile-card-value" style={{ color: due > 0 ? '#dc2626' : '#166534', fontWeight: 600 }}>
                                            ৳{Math.round(due)}
                                          </span>
                                        </div>
                                      </div>
                                    </div>
                                    <div className="mobile-card-actions">
                                      <button
                                        className="mobile-action-btn"
                                        onClick={(e) => {
                                          e.stopPropagation()
                                          setViewingOrder(order)
                                        }}
                                      >
                                        {language === 'en' ? 'View/Edit' : 'দেখুন/সম্পাদনা'}
                                      </button>
                                      <button
                                        className="mobile-action-btn"
                                        style={{ backgroundColor: '#f3f4f6', color: '#374151' }}
                                        onClick={(e) => {
                                          e.stopPropagation()
                                          handlePrintOrder(order)
                                        }}
                                      >
                                        {language === 'en' ? 'Print' : 'প্রিন্ট'}
                                      </button>
                                      {/* Add Print Button if needed? */}
                                    </div>
                                  </>
                                )
                                }
                              </div>

                            )
                          })
                        )}
                      </div>
                    </>
                  )}


                  {/* Order Details Card */}
                  {viewingOrder && !showOrderForm && (
                    <div className="admin-order-view-overlay" style={{
                      position: 'fixed',
                      top: 0,
                      left: 0,
                      right: 0,
                      bottom: 0,
                      backgroundColor: 'rgba(0, 0, 0, 0.5)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      zIndex: 1000,
                      padding: '1rem'
                    }} onClick={() => setViewingOrder(null)}>
                      <div className="admin-order-view-modal" style={{
                        position: 'relative',
                        background: 'linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%)',
                        borderRadius: '0.75rem',
                        padding: '2rem',
                        maxWidth: '900px',
                        width: '100%',
                        maxHeight: '90vh',
                        overflowY: 'auto',
                        WebkitOverflowScrolling: 'touch',
                        boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)'
                      }} onClick={(e) => e.stopPropagation()}>
                        <div style={{
                          position: 'absolute',
                          inset: 0,
                          pointerEvents: 'none',
                          overflow: 'hidden',
                          borderRadius: '0.75rem'
                        }}>
                          <div style={{
                            position: 'absolute',
                            width: '260px',
                            height: '260px',
                            top: '-120px',
                            left: '-80px',
                            background: 'radial-gradient(circle at 30% 30%, rgba(59,130,246,0.25), transparent 60%)',
                            filter: 'blur(20px)'
                          }} />
                          <div style={{
                            position: 'absolute',
                            width: '240px',
                            height: '240px',
                            bottom: '-140px',
                            right: '-100px',
                            background: 'radial-gradient(circle at 70% 70%, rgba(16,185,129,0.22), transparent 60%)',
                            filter: 'blur(20px)'
                          }} />
                        </div>

                        <div className="admin-order-view-header" style={{ position: 'relative', display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', gap: '1rem' }}>
                          <div>
                            <h2 style={{ margin: 0, fontSize: '1.5rem', fontWeight: 800, color: '#0f172a' }}>
                              {language === 'en' ? 'Order Details' : 'অর্ডার বিবরণ'}
                            </h2>
                            <p style={{ margin: '0.25rem 0 0 0', color: '#475569', fontWeight: 600 }}>
                              {customOrderIds[viewingOrder._id] || viewingOrder.orderId || 'N/A'}
                            </p>
                          </div>
                          <button
                            onClick={() => setViewingOrder(null)}
                            style={{
                              background: '#e2e8f0',
                              border: 'none',
                              padding: '0.4rem 0.65rem',
                              borderRadius: '0.375rem',
                              cursor: 'pointer',
                              fontWeight: 700,
                              color: '#475569'
                            }}
                          >
                            ×
                          </button>
                        </div>

                        <div className="admin-order-details-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1rem', position: 'relative', zIndex: 1 }}>
                          {/* Order ID */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Order ID' : 'অর্ডার আইডি'}
                            </label>
                            <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', fontWeight: 600, color: '#111827' }}>
                              {customOrderIds[viewingOrder._id] || viewingOrder.orderId || 'N/A'}
                            </p>
                          </div>

                          {/* Date */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Date' : 'তারিখ'}
                            </label>
                            <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                              {viewingOrder.createdAt ? new Date(viewingOrder.createdAt).toLocaleDateString() : 'N/A'}
                            </p>
                          </div>

                          {/* Dealer ID */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'CID' : 'সিআইডি'}
                            </label>
                            <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                              {viewingOrder.dealerId || viewingOrder.dealer?.dealerId || 'N/A'}
                            </p>
                          </div>

                          {/* Shop Name */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Shop Name' : 'দোকানের নাম'}
                            </label>
                            <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                              {(() => {
                                const dealerId = viewingOrder.dealer?._id || viewingOrder.dealer;
                                const foundDealer = dealers.find(d => d._id === dealerId);
                                return foundDealer?.shopName || viewingOrder.dealer?.shopName || '-';
                              })()}
                            </p>
                          </div>

                          {/* Dealer Name */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Customer Name' : 'কাস্টমারের নাম'}
                            </label>
                            <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                              {viewingOrder.dealerName || viewingOrder.dealer?.name || 'N/A'}
                            </p>
                          </div>

                          {/* Total Price */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Total Price' : 'মোট মূল্য'}
                            </label>
                            <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', fontWeight: 600, color: '#111827' }}>
                              ৳{(viewingOrder.totalPrice || 0).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                            </p>
                          </div>

                          {/* Grand Total */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Grand Total' : 'সর্বমোট মূল্য'}
                            </label>
                            <p style={{ margin: '0.5rem 0 0 0', fontSize: '1.1rem', color: '#16a34a', fontWeight: 800 }}>
                              ৳{(() => {
                                const total = parseFloat(viewingOrder.totalPrice || 0)
                                const discount = viewingOrder.discountEnabled && viewingOrder.discountAmount > 0 ? viewingOrder.discountAmount : 1
                                return (total * discount).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })
                              })()}
                            </p>
                          </div>

                          {/* Paid Amount */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Paid Amount' : 'পরিশোধিত পরিমাণ'}
                            </label>
                            {isEditingOrderDetails ? (
                              <div style={{ padding: '0.5rem', border: '1px solid #d1d5db', borderRadius: '0.375rem', backgroundColor: '#e5e7eb', marginTop: '0.5rem' }}>
                                ৳{(() => {
                                  const cashPaid = editingOrderDetails?.paidAmount ? parseFloat(editingOrderDetails.paidAmount) : 0
                                  const payInput = parseFloat(editingOrderDetails?.payInput || 0)
                                  const rateStr = editingOrderDetails?.commission || ''
                                  const rate = parseFloat(rateStr.replace('%', '')) || 0
                                  const currentComm = (payInput * rate) / 100
                                  const histComm = (viewingOrder.paymentHistory || []).reduce((sum, p) => sum + (parseFloat(p.commission) || 0), 0)
                                  return Math.round((cashPaid + histComm + currentComm))
                                })()}
                              </div>
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#16a34a', fontWeight: 600 }}>
                                ৳{(() => {
                                  // Paid Amount in UI should show total credit (Paid + Commissions)
                                  const paid = viewingOrder.paidAmount ? parseFloat(viewingOrder.paidAmount) || 0 : 0
                                  const comm = (viewingOrder.paymentHistory || []).reduce((sum, p) => sum + (parseFloat(p.commission) || 0), 0)
                                  return Math.round((paid + comm))
                                })()}
                              </p>
                            )}
                          </div>

                          {/* Pay Field (Only in Edit Mode) */}
                          {isEditingOrderDetails && (
                            <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                              <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                                {language === 'en' ? 'Pay' : 'পরিশোধ করুন'}
                              </label>
                              <input
                                type="number"
                                min="0"
                                value={editingOrderDetails?.payInput || ''}
                                onChange={(e) => {
                                  const pay = parseFloat(e.target.value) || 0
                                  const originalPaid = parseFloat(viewingOrder.paidAmount || 0)
                                  const newTotalPaid = originalPaid + pay

                                  const rateStr = editingOrderDetails?.commission || ''
                                  const rate = parseFloat(rateStr.replace('%', '')) || 0
                                  const currentComm = (pay * rate) / 100
                                  const histComm = (viewingOrder.paymentHistory || []).reduce((sum, p) => sum + (parseFloat(p.commission) || 0), 0)

                                  const discount = viewingOrder.discountEnabled && viewingOrder.discountAmount > 0 ? viewingOrder.discountAmount : 1
                                  const grandTotalVal = parseFloat(viewingOrder.totalPrice || 0) * discount
                                  const due = Math.max(0, grandTotalVal - (newTotalPaid + currentComm + histComm))

                                  setEditingOrderDetails({
                                    ...editingOrderDetails,
                                    payInput: e.target.value,
                                    paidAmount: newTotalPaid,
                                    dueAmount: due
                                  })
                                }}
                                placeholder={language === 'en' ? 'Enter amount' : 'পরিমাণ লিখুন'}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem',
                                  fontWeight: 600
                                }}
                              />
                            </div>
                          )}

                          {/* Commission Section */}
                          {isEditingOrderDetails ? (
                            <>
                              {/* Select Commission (Edit Only) */}
                              <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                                <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                                  {language === 'en' ? 'Select Commission' : 'কমিশন নির্বাচন করুন'}
                                </label>
                                <select
                                  value={editingOrderDetails?.commission || ''}
                                  onChange={(e) => {
                                    const newComm = e.target.value
                                    const pay = parseFloat(editingOrderDetails?.payInput || 0)
                                    const rate = parseFloat(newComm.replace('%', '')) || 0
                                    const currentComm = (pay * rate) / 100

                                    const originalPaid = parseFloat(viewingOrder.paidAmount || 0)
                                    const newTotalPaid = originalPaid + pay
                                    const histComm = (viewingOrder.paymentHistory || []).reduce((sum, p) => sum + (parseFloat(p.commission) || 0), 0)
                                    const discount = viewingOrder.discountEnabled && viewingOrder.discountAmount > 0 ? viewingOrder.discountAmount : 1
                                    const grandTotalVal = parseFloat(viewingOrder.totalPrice || 0) * discount
                                    const due = Math.max(0, grandTotalVal - (newTotalPaid + currentComm + histComm))

                                    setEditingOrderDetails({ ...editingOrderDetails, commission: newComm, dueAmount: due })
                                  }}
                                  style={{
                                    marginTop: '0.5rem',
                                    width: '100%',
                                    padding: '0.5rem',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '0.375rem',
                                    fontSize: '1rem'
                                  }}
                                >
                                  <option value="">Select Commission</option>
                                  {commissionRates.map(rate => (
                                    <option key={rate} value={rate}>{rate}</option>
                                  ))}
                                </select>
                              </div>

                              {/* Commission Calculation (Edit Only) */}
                              <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                                <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                                  {language === 'en' ? 'Commission' : 'কমিশন'}
                                </label>
                                <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827', fontWeight: 600 }}>
                                  ৳{(() => {
                                    const pay = parseFloat(editingOrderDetails?.payInput || 0)
                                    const rateStr = editingOrderDetails?.commission || ''
                                    const rate = parseFloat(rateStr.replace('%', '')) || 0
                                    const amount = (pay * rate) / 100
                                    return amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                                  })()}
                                </p>
                              </div>
                            </>
                          ) : (
                            /* Total Commission (View Only) */
                            <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                              <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                                {language === 'en' ? 'Total Commission' : 'মোট কমিশন'}
                              </label>
                              <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827', fontWeight: 600 }}>
                                ৳{(() => {
                                  const total = (viewingOrder.paymentHistory || []).reduce((sum, p) => sum + (parseFloat(p.commission) || 0), 0)
                                  return total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                                })()}
                              </p>
                            </div>
                          )}

                          {/* Due Amount */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Due Amount' : 'বাকি পরিমাণ'}
                            </label>
                            <p style={{
                              margin: '0.5rem 0 0 0',
                              fontSize: '1rem',
                              color: (() => {
                                let due = 0
                                if (isEditingOrderDetails && editingOrderDetails) {
                                  due = parseFloat(editingOrderDetails.dueAmount || 0)
                                } else {
                                  const totalRaw = parseFloat(viewingOrder.totalPrice || 0)
                                  const discount = viewingOrder.discountEnabled && viewingOrder.discountAmount > 0 ? viewingOrder.discountAmount : 1
                                  const grandTotalVal = totalRaw * discount
                                  const paid = parseFloat(viewingOrder.paidAmount || 0)
                                  const comm = (viewingOrder.paymentHistory || []).reduce((sum, p) => sum + (parseFloat(p.commission) || 0), 0)
                                  due = Math.max(0, grandTotalVal - (paid + comm))
                                }
                                return due > 0 ? '#dc2626' : '#16a34a'
                              })(),
                              fontWeight: 600
                            }}>
                              ৳{(() => {
                                let due = 0
                                if (isEditingOrderDetails && editingOrderDetails) {
                                  due = parseFloat(editingOrderDetails.dueAmount || 0)
                                } else {
                                  const totalRaw = parseFloat(viewingOrder.totalPrice || 0)
                                  const discount = viewingOrder.discountEnabled && viewingOrder.discountAmount > 0 ? viewingOrder.discountAmount : 1
                                  const grandTotalVal = totalRaw * discount
                                  const paid = parseFloat(viewingOrder.paidAmount || 0)
                                  const comm = (viewingOrder.paymentHistory || []).reduce((sum, p) => sum + (parseFloat(p.commission) || 0), 0)
                                  due = Math.max(0, grandTotalVal - (paid + comm))
                                }
                                return Math.round(due)
                              })()}
                            </p>
                          </div>

                          {/* Status */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Status' : 'স্ট্যাটাস'}
                            </label>
                            {isEditingOrderDetails ? (
                              <select
                                value={editingOrderDetails?.status || 'Pending'}
                                onChange={(e) => setEditingOrderDetails({ ...editingOrderDetails, status: e.target.value })}
                                style={{
                                  marginTop: '0.5rem',
                                  width: '100%',
                                  padding: '0.5rem',
                                  border: '1px solid #d1d5db',
                                  borderRadius: '0.375rem',
                                  fontSize: '1rem'
                                }}
                              >
                                {(userRole || '').toLowerCase() === 'admin' ? (
                                  <>
                                    <option value="Pending">{language === 'en' ? 'Pending' : 'অপেক্ষমাণ'}</option>
                                    <option value="Processing">{language === 'en' ? 'Processing' : 'প্রক্রিয়াকরণ'}</option>
                                    <option value="Shipped">{language === 'en' ? 'Shipped' : 'প্রেরিত'}</option>
                                    <option value="Delivered">{language === 'en' ? 'Delivered' : 'বিতরণকৃত'}</option>
                                    <option value="Complete">{language === 'en' ? 'Complete' : 'সম্পন্ন'}</option>
                                    <option value="Cancelled">{language === 'en' ? 'Cancelled' : 'বাতিল'}</option>
                                  </>
                                ) : (
                                  <>
                                    <option value="Shipped">{language === 'en' ? 'Shipped' : 'প্রেরিত'}</option>
                                    <option value="Delivered">{language === 'en' ? 'Delivered' : 'বিতরণকৃত'}</option>
                                    <option value="Complete">{language === 'en' ? 'Complete' : 'সম্পন্ন'}</option>
                                  </>
                                )}
                              </select>
                            ) : (
                              <p style={{ margin: '0.5rem 0 0 0' }}>
                                <span style={{
                                  padding: '0.35rem 0.75rem',
                                  borderRadius: '0.375rem',
                                  fontSize: '0.875rem',
                                  fontWeight: 600,
                                  backgroundColor:
                                    viewingOrder.status === 'Complete' ? '#dcfce7' :
                                      viewingOrder.status === 'Delivered' ? '#d1fae5' :
                                        viewingOrder.status === 'Shipped' ? '#dbeafe' :
                                          viewingOrder.status === 'Processing' ? '#fef3c7' :
                                            viewingOrder.status === 'Cancelled' ? '#fee2e2' :
                                              '#f3f4f6',
                                  color:
                                    viewingOrder.status === 'Complete' ? '#166534' :
                                      viewingOrder.status === 'Delivered' ? '#065f46' :
                                        viewingOrder.status === 'Shipped' ? '#1e40af' :
                                          viewingOrder.status === 'Processing' ? '#92400e' :
                                            viewingOrder.status === 'Cancelled' ? '#b91c1c' :
                                              '#374151'
                                }}>
                                  {viewingOrder.status || 'Pending'}
                                </span>
                              </p>
                            )}
                          </div>

                          {/* Approval Status */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Approval Status' : 'অনুমোদন স্ট্যাটাস'}
                            </label>
                            <p style={{ margin: '0.5rem 0 0 0' }}>
                              <span style={{
                                padding: '0.35rem 0.75rem',
                                borderRadius: '0.375rem',
                                fontSize: '0.875rem',
                                fontWeight: 600,
                                backgroundColor:
                                  viewingOrder.approvalStatus === 'Approved' ? '#d1fae5' :
                                    viewingOrder.approvalStatus === 'Rejected' ? '#fee2e2' :
                                      '#fef3c7',
                                color:
                                  viewingOrder.approvalStatus === 'Approved' ? '#065f46' :
                                    viewingOrder.approvalStatus === 'Rejected' ? '#b91c1c' :
                                      '#92400e'
                              }}>

                                {viewingOrder.approvalStatus || 'Pending'}
                              </span>
                            </p>
                          </div>



                          {/* Requested By */}
                          <div style={{ padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Requested By' : 'অনুরোধকারী'}
                            </label>
                            <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827' }}>
                              {viewingOrder.requestedByName || viewingOrder.requestedByRole || 'N/A'}
                            </p>
                          </div>

                          {/* Notes */}
                          <div className="admin-order-detail-full-width" style={{ gridColumn: '1 / -1', padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600 }}>
                              {language === 'en' ? 'Notes' : 'নোট'}
                            </label>
                            <p style={{ margin: '0.5rem 0 0 0', fontSize: '1rem', color: '#111827', whiteSpace: 'pre-wrap' }}>
                              {viewingOrder.notes || 'N/A'}
                            </p>
                          </div>

                          {/* Order Items Table (if multi-item or single-item order) */}
                          {(() => {
                            const displayItems = viewingOrder.items && viewingOrder.items.length > 0
                              ? viewingOrder.items
                              : (viewingOrder.product ? [{
                                product: viewingOrder.product,
                                productName: viewingOrder.productName || viewingOrder.product?.name,
                                variant: viewingOrder.variant,
                                quantity: viewingOrder.quantity,
                                unitPrice: viewingOrder.price, // Uses root price for single item
                                totalPrice: viewingOrder.totalPrice,
                                notes: viewingOrder.notes
                              }] : [])

                            if (displayItems.length === 0) return null

                            return (
                              <div className="admin-order-detail-full-width" style={{ gridColumn: '1 / -1', padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem' }}>
                                <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600, marginBottom: '0.75rem', display: 'block' }}>
                                  {language === 'en' ? 'Order Items' : 'অর্ডার আইটেম'}
                                </label>
                                <div className="admin-table-container" style={{ background: '#fff', borderRadius: '0.5rem', border: '1px solid #e2e8f0' }}>
                                  <table className="admin-table">
                                    <thead>
                                      <tr>
                                        <th style={{ textAlign: 'center' }}>{language === 'en' ? 'Product' : 'পণ্য'}</th>
                                        <th style={{ textAlign: 'center' }}>{language === 'en' ? 'Variant' : 'ভ্যারিয়েন্ট'}</th>
                                        <th style={{ textAlign: 'center' }}>{language === 'en' ? 'Qty' : 'পরিমাণ'}</th>
                                        <th style={{ textAlign: 'center' }}>{language === 'en' ? 'Free Qty' : 'ফ্রি পরিমাণ'}</th>
                                        <th style={{ textAlign: 'center' }}>{language === 'en' ? 'Total Qty' : 'মোট পরিমাণ'}</th>
                                        <th style={{ textAlign: 'center' }}>{language === 'en' ? 'Unit Price' : 'একক মূল্য'}</th>
                                        <th style={{ textAlign: 'center' }}>{language === 'en' ? 'Total Price' : 'মোট মূল্য'}</th>
                                        <th style={{ textAlign: 'center' }}>{language === 'en' ? 'Grand Total' : 'সর্বমোট'}</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {displayItems.map((item, idx) => {
                                        // Calculate free quantity if product has offer
                                        const itemProduct = products.find(p => p._id === item.product || p._id === item.product?._id)
                                        const hasOffer = itemProduct && itemProduct.hasOffer && itemProduct.buyQuantity && itemProduct.freeQuantity
                                        const buyQty = hasOffer ? (parseFloat(itemProduct.buyQuantity) || 0) : 0
                                        const freeQty = hasOffer ? (parseFloat(itemProduct.freeQuantity) || 0) : 0
                                        const orderQty = parseFloat(item.quantity) || 0
                                        const eligibleOffers = hasOffer ? Math.floor(orderQty / buyQty) : 0
                                        const freeUnits = eligibleOffers * freeQty
                                        const totalQty = orderQty + freeUnits

                                        return (
                                          <tr key={idx}>
                                            <td style={{ textAlign: 'center' }}>{item.productName || itemProduct?.name || '-'}</td>
                                            <td style={{ textAlign: 'center' }}>{item.variant && item.variant.packSize ? `${item.variant.packSize} ${item.variant.packUnit || 'ml'} (${item.variant.cartoonSize || 1} ${item.variant.cartoonUnit || 'Pcs'})` : '-'}</td>
                                            <td style={{ textAlign: 'center', fontWeight: 600 }}>{orderQty}</td>
                                            <td style={{ textAlign: 'center', fontWeight: 600, color: freeUnits > 0 ? '#16a34a' : '#6b7280' }}>
                                              {freeUnits > 0 ? (
                                                <span style={{
                                                  padding: '0.2rem 0.5rem',
                                                  backgroundColor: '#ecfdf3',
                                                  color: '#065f46',
                                                  borderRadius: '0.25rem',
                                                  fontSize: '0.75rem',
                                                  fontWeight: 700,
                                                  border: '1px solid #bbf7d0'
                                                }}>
                                                  {freeUnits}
                                                </span>
                                              ) : '-'}
                                            </td>
                                            <td style={{ textAlign: 'center', fontWeight: 700, color: '#0f172a' }}>{totalQty}</td>
                                            <td style={{ textAlign: 'center' }}>৳{item.unitPrice !== undefined ? Math.round((item.unitPrice || 0)) : '-'}</td>
                                            <td style={{ textAlign: 'center', fontWeight: 700, color: '#0f172a' }}>৳{item.totalPrice !== undefined ? Math.round((item.totalPrice || 0)) : '-'}</td>
                                            <td style={{ textAlign: 'center', fontWeight: 900, color: '#16a34a', fontSize: '1rem' }}>
                                              ৳{(() => {
                                                const itemTotal = parseFloat(item.totalPrice || 0)
                                                const discount = viewingOrder.discountEnabled && viewingOrder.discountAmount > 0 ? viewingOrder.discountAmount : 1
                                                return (itemTotal * discount).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })
                                              })()}
                                            </td>
                                          </tr>
                                        )
                                      })}
                                    </tbody>
                                  </table>
                                </div>
                                <div className="mobile-card-container">
                                  {displayItems.map((item, idx) => {
                                    const itemProduct = products.find(p => p._id === item.product || p._id === item.product?._id)
                                    const hasOffer = itemProduct && itemProduct.hasOffer && itemProduct.buyQuantity && itemProduct.freeQuantity
                                    const buyQty = hasOffer ? (parseFloat(itemProduct.buyQuantity) || 0) : 0
                                    const freeQty = hasOffer ? (parseFloat(itemProduct.freeQuantity) || 0) : 0
                                    const orderQty = parseFloat(item.quantity) || 0
                                    const eligibleOffers = hasOffer ? Math.floor(orderQty / buyQty) : 0
                                    const freeUnits = eligibleOffers * freeQty
                                    const totalQty = orderQty + freeUnits

                                    return (
                                      <div key={idx} className="mobile-card" style={{ padding: '0.75rem', border: '1px solid #e2e8f0', boxShadow: 'none' }}>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label" style={{ fontWeight: 600, color: '#475569' }}>{language === 'en' ? 'Product' : 'পণ্য'}</span>
                                          <span className="mobile-card-value">{item.productName || itemProduct?.name || '-'}</span>
                                        </div>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Variant' : 'ভ্যারিয়েন্ট'}</span>
                                          <span className="mobile-card-value">{item.variant && item.variant.packSize ? `${item.variant.packSize} ${item.variant.packUnit || 'ml'} (${item.variant.cartoonSize || 1} ${item.variant.cartoonUnit || 'Pcs'})` : '-'}</span>
                                        </div>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Qty' : 'পরিমাণ'}</span>
                                          <span className="mobile-card-value">{orderQty}</span>
                                        </div>
                                        {freeUnits > 0 && (
                                          <div className="mobile-card-row">
                                            <span className="mobile-card-label">{language === 'en' ? 'Free Qty' : 'ফ্রি পরিমাণ'}</span>
                                            <span className="mobile-card-value" style={{ color: '#16a34a', fontWeight: 600 }}>{freeUnits}</span>
                                          </div>
                                        )}
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Total Qty' : 'মোট পরিমাণ'}</span>
                                          <span className="mobile-card-value">{totalQty}</span>
                                        </div>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Grand Total' : 'সর্বমোট'}</span>
                                          <span className="mobile-card-value" style={{ fontWeight: 800, color: '#16a34a' }}>
                                            ৳{(() => {
                                              const itemTotal = parseFloat(item.totalPrice || 0)
                                              const discount = viewingOrder.discountEnabled && viewingOrder.discountAmount > 0 ? viewingOrder.discountAmount : 1
                                              return (itemTotal * discount).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })
                                            })()}
                                          </span>
                                        </div>
                                      </div>
                                    )
                                  })}
                                </div>
                              </div>
                            )
                          })()}
                        </div>

                        {/* Payment History */}
                        {viewingOrder.approvalStatus !== 'Pending' && (
                          <div className="admin-order-detail-full-width" style={{ gridColumn: '1 / -1', padding: '1rem', backgroundColor: '#f9fafb', borderRadius: '0.375rem', marginTop: '1rem', marginBottom: '1.5rem' }}>
                            <label style={{ fontSize: '0.875rem', color: '#6b7280', fontWeight: 600, marginBottom: '0.75rem', display: 'block' }}>
                              {language === 'en' ? 'Payment History' : 'পেমেন্ট ইতিহাস'}
                            </label>
                            <div className="admin-table-container" style={{ background: '#fff', borderRadius: '0.5rem', border: '1px solid #e2e8f0', overflowX: 'auto' }}>
                              <table className="admin-table" style={{ width: '100%', minWidth: '800px' }}>
                                <thead>
                                  <tr>
                                    <th style={{ textAlign: 'center', whiteSpace: 'nowrap', padding: '0.75rem' }}>{language === 'en' ? 'Date' : 'তারিখ'}</th>
                                    <th style={{ textAlign: 'center', whiteSpace: 'nowrap', padding: '0.75rem' }}>{language === 'en' ? 'Total Price' : 'মোট মূল্য'}</th>
                                    <th style={{ textAlign: 'center', whiteSpace: 'nowrap', padding: '0.75rem' }}>{language === 'en' ? 'Grand Total' : 'সর্বমোট'}</th>
                                    <th style={{ textAlign: 'center', whiteSpace: 'nowrap', padding: '0.75rem' }}>{language === 'en' ? 'Total Paid Amount' : 'মোট পরিশোধিত'}</th>
                                    <th style={{ textAlign: 'center', whiteSpace: 'nowrap', padding: '0.75rem' }}>{language === 'en' ? 'Pay Amount' : 'পরিশোধের পরিমাণ'}</th>
                                    <th style={{ textAlign: 'center', whiteSpace: 'nowrap', padding: '0.75rem' }}>{language === 'en' ? 'Commission %' : 'কমিশন %'}</th>
                                    <th style={{ textAlign: 'center', whiteSpace: 'nowrap', padding: '0.75rem' }}>{language === 'en' ? 'Commission' : 'কমিশন'}</th>
                                    <th style={{ textAlign: 'center', whiteSpace: 'nowrap', padding: '0.75rem' }}>{language === 'en' ? 'Total Commission' : 'মোট কমিশন'}</th>
                                    <th style={{ textAlign: 'center', whiteSpace: 'nowrap', padding: '0.75rem' }}>{language === 'en' ? 'Due Amount' : 'বাকি পরিমাণ'}</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {viewingOrder.paymentHistory && viewingOrder.paymentHistory.length > 0 ? (
                                    (() => {
                                      let runningPaid = 0
                                      let runningCommission = 0
                                      const totalPrice = parseFloat(viewingOrder.totalPrice || 0)
                                      const discount = viewingOrder.discountEnabled && viewingOrder.discountAmount > 0 ? viewingOrder.discountAmount : 1
                                      const orderGrandTotal = totalPrice * discount

                                      const rows = viewingOrder.paymentHistory.map((payment, index) => {
                                        const amount = parseFloat(payment.amount || 0)
                                        const commission = parseFloat(payment.commission || 0)
                                        const commPercent = amount > 0 ? Math.round(((commission / amount) * 100)) + '%' : '-'

                                        runningPaid += amount
                                        runningCommission += commission
                                        // Correctly calculate due as (Order Grand Total) - (all paid cash + all commissions so far)
                                        const currentDue = Math.max(0, orderGrandTotal - (runningPaid + runningCommission))

                                        return (
                                          <tr key={index}>
                                            <td style={{ textAlign: 'center' }}>{payment.date ? new Date(payment.date).toLocaleDateString() : '-'}</td>
                                            <td style={{ textAlign: 'center' }}>৳{Math.round(totalPrice)}</td>
                                            <td style={{ textAlign: 'center', fontWeight: 600, color: '#1e40af' }}>৳{Math.round(orderGrandTotal)}</td>
                                            <td style={{ textAlign: 'center', fontWeight: 600 }}>৳{Math.round(runningPaid)}</td>
                                            <td style={{ textAlign: 'center', color: '#16a34a', fontWeight: 600 }}>৳{Math.round(amount)}</td>
                                            <td style={{ textAlign: 'center' }}>{commPercent}</td>
                                            <td style={{ textAlign: 'center' }}>৳{Math.round(commission)}</td>
                                            <td style={{ textAlign: 'center', fontWeight: 600 }}>৳{Math.round(runningCommission)}</td>
                                            <td style={{ textAlign: 'center', color: '#dc2626', fontWeight: 600 }}>৳{Math.round(currentDue)}</td>
                                          </tr>
                                        )
                                      })

                                      // Add summary row
                                      rows.push(
                                        <tr key="summary" style={{ backgroundColor: '#f8fafc', fontWeight: 700, borderTop: '2px solid #e2e8f0' }}>
                                          <td colSpan="4" style={{ textAlign: 'right', padding: '0.75rem' }}>{language === 'en' ? 'TOTAL:' : 'মোট:'}</td>
                                          <td style={{ textAlign: 'center', color: '#16a34a' }}>৳{Math.round(runningPaid)}</td>
                                          <td style={{ textAlign: 'center' }}>-</td>
                                          <td style={{ textAlign: 'center', color: '#ca8a04' }}>৳{Math.round(runningCommission)}</td>
                                          <td colSpan="2" style={{ textAlign: 'center', backgroundColor: '#eff6ff' }}>
                                            <div style={{ fontSize: '0.75rem', color: '#1e40af' }}>{language === 'en' ? 'TOTAL COLLECTION' : 'মোট সংগ্রহ'}</div>
                                            <div style={{ color: '#1e40af', fontSize: '1rem' }}>৳{Math.round((runningPaid + runningCommission))}</div>
                                          </td>
                                        </tr>
                                      )
                                      rows.push(
                                        <tr key="final-due" style={{ backgroundColor: '#fef2f2', fontWeight: 800 }}>
                                          <td colSpan="7" style={{ textAlign: 'right', padding: '0.75rem', color: '#dc2626' }}>
                                            {language === 'en' ? 'FINAL DUE AMOUNT:' : 'সর্বমোট বকেয়া পরিমাণ:'}
                                          </td>
                                          <td colSpan="2" style={{ textAlign: 'center', color: '#dc2626', fontSize: '1.1rem' }}>
                                            ৳{Math.round(Math.max(0, orderGrandTotal - (runningPaid + runningCommission)))}
                                          </td>
                                        </tr>
                                      )
                                      return rows
                                    })()
                                  ) : (
                                    <tr>
                                      <td colSpan="9" style={{ textAlign: 'center', padding: '1rem', color: '#6b7280' }}>
                                        {language === 'en' ? 'No payment history available' : 'কোনো পেমেন্ট ইতিহাস নেই'}
                                      </td>
                                    </tr>
                                  )}
                                </tbody>
                              </table>
                            </div>

                            {/* Mobile View for Payment History */}
                            <div className="mobile-card-container">
                              {viewingOrder.paymentHistory && viewingOrder.paymentHistory.length > 0 ? (
                                (() => {
                                  let runningPaid = 0
                                  let runningCommission = 0
                                  const totalPrice = parseFloat(viewingOrder.totalPrice || 0)
                                  const discount = viewingOrder.discountEnabled && viewingOrder.discountAmount > 0 ? viewingOrder.discountAmount : 1
                                  const orderGrandTotal = totalPrice * discount

                                  const cards = viewingOrder.paymentHistory.map((payment, index) => {
                                    const amount = parseFloat(payment.amount || 0)
                                    const commission = parseFloat(payment.commission || 0)
                                    const commPercent = amount > 0 ? Math.round(((commission / amount) * 100)) + '%' : ''

                                    runningPaid += amount
                                    runningCommission += commission
                                    const currentDue = Math.max(0, orderGrandTotal - (runningPaid + runningCommission))

                                    return (
                                      <div key={index} className="mobile-card" style={{ padding: '0.75rem', border: '1px solid #e2e8f0', boxShadow: 'none' }}>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label" style={{ fontWeight: 600, color: '#475569' }}>{language === 'en' ? 'Date' : 'তারিখ'}</span>
                                          <span className="mobile-card-value">{payment.date ? new Date(payment.date).toLocaleDateString() : '-'}</span>
                                        </div>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Total Price' : 'মোট মূল্য'}</span>
                                          <span className="mobile-card-value">৳{Math.round(totalPrice)}</span>
                                        </div>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Grand Total' : 'সর্বমোট'}</span>
                                          <span className="mobile-card-value" style={{ fontWeight: 700, color: '#1e40af' }}>৳{Math.round(orderGrandTotal)}</span>
                                        </div>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Paid Amount' : 'পরিশোধিত'}</span>
                                          <span className="mobile-card-value" style={{ color: '#16a34a', fontWeight: 600 }}>৳{Math.round(amount)}</span>
                                        </div>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">
                                            {language === 'en' ? 'Commission' : 'কমিশন'}
                                            {commPercent && <span style={{ fontSize: '0.75rem', color: '#64748b', marginLeft: '0.4rem' }}>({commPercent})</span>}
                                          </span>
                                          <span className="mobile-card-value">৳{Math.round(commission)}</span>
                                        </div>
                                        <div className="mobile-card-row">
                                          <span className="mobile-card-label">{language === 'en' ? 'Due' : 'বাকি'}</span>
                                          <span className="mobile-card-value" style={{ color: '#dc2626', fontWeight: 600 }}>৳{Math.round(currentDue)}</span>
                                        </div>
                                      </div>
                                    )
                                  })

                                  // Add summary card for mobile
                                  cards.push(
                                    <div key="mobile-summary" className="mobile-card" style={{
                                      padding: '0.75rem',
                                      border: '2px solid #e2e8f0',
                                      backgroundColor: '#f8fafc',
                                      boxShadow: 'none',
                                      marginTop: '1rem'
                                    }}>
                                      <div className="mobile-card-row" style={{ borderBottom: '1px solid #e2e8f0', paddingBottom: '0.5rem', marginBottom: '0.5rem' }}>
                                        <span className="mobile-card-label" style={{ fontWeight: 800, color: '#0f172a' }}>{language === 'en' ? 'TOTAL SUMMARY' : 'মোট সারসংক্ষেপ'}</span>
                                      </div>
                                      <div className="mobile-card-row">
                                        <span className="mobile-card-label">{language === 'en' ? 'Total Paid' : 'মোট পরিশোধিত'}</span>
                                        <span className="mobile-card-value" style={{ color: '#16a34a', fontWeight: 700 }}>৳{Math.round(runningPaid)}</span>
                                      </div>
                                      <div className="mobile-card-row">
                                        <span className="mobile-card-label">{language === 'en' ? 'Total Commission' : 'মোট কমিশন'}</span>
                                        <span className="mobile-card-value" style={{ color: '#ca8a04', fontWeight: 700 }}>৳{Math.round(runningCommission)}</span>
                                      </div>
                                      <div className="mobile-card-row" style={{ backgroundColor: '#eff6ff', padding: '0.4rem', borderRadius: '0.25rem', marginTop: '0.5rem' }}>
                                        <span className="mobile-card-label" style={{ color: '#1e40af', fontWeight: 700 }}>{language === 'en' ? 'TOTAL COLLECTION' : 'মোট সংগ্রহ'}</span>
                                        <span className="mobile-card-value" style={{ color: '#1e40af', fontWeight: 800 }}>৳{Math.round((runningPaid + runningCommission))}</span>
                                      </div>
                                      <div className="mobile-card-row" style={{ backgroundColor: '#fef2f2', padding: '0.4rem', borderRadius: '0.25rem', marginTop: '0.5rem' }}>
                                        <span className="mobile-card-label" style={{ color: '#dc2626', fontWeight: 800 }}>{language === 'en' ? 'FINAL DUE' : 'সর্বমোট বকেয়া'}</span>
                                        <span className="mobile-card-value" style={{ color: '#dc2626', fontWeight: 900, fontSize: '1.1rem' }}>৳{Math.round(Math.max(0, orderGrandTotal - (runningPaid + runningCommission)))}</span>
                                      </div>
                                    </div>
                                  )
                                  return cards
                                })()
                              ) : (
                                <div style={{ padding: '1rem', textAlign: 'center', color: '#6b7280', fontSize: '0.875rem', background: '#f9fafb', borderRadius: '0.375rem', border: '1px solid #e5e7eb' }}>
                                  {language === 'en' ? 'No payment history available' : 'কোনো পেমেন্ট ইতিহাস নেই'}
                                </div>
                              )}
                            </div>
                          </div>
                        )}

                        {/* Action Buttons */}
                        <div style={{ position: 'relative', display: 'flex', gap: '0.75rem', marginTop: '1.5rem', zIndex: 1 }}>
                          {isEditingOrderDetails ? (
                            <>
                              <button
                                onClick={async () => {
                                  try {
                                    const res = await fetch(`${API_BASE}/api/orders/${viewingOrder._id}`, {
                                      method: 'PUT',
                                      headers: { 'Content-Type': 'application/json' },
                                      body: JSON.stringify({
                                        paidAmount: editingOrderDetails.paidAmount || 0,
                                        status: editingOrderDetails.status || 'Pending',
                                        commission: editingOrderDetails.commission,
                                        newPayment: editingOrderDetails.payInput ? {
                                          amount: parseFloat(editingOrderDetails.payInput),
                                          commission: (() => {
                                            const pay = parseFloat(editingOrderDetails.payInput) || 0
                                            const rateStr = editingOrderDetails.commission || ''
                                            const rate = parseFloat(rateStr.replace('%', '')) || 0
                                            return (pay * rate) / 100
                                          })()
                                        } : undefined
                                      })
                                    })
                                    const data = await res.json()
                                    if (!res.ok) throw new Error(data.message || 'Failed to update order')
                                    await loadOrders()
                                    await loadOrderRequests()
                                    if (data.data) {
                                      setViewingOrder(data.data)
                                    } else {
                                      setViewingOrder({ ...viewingOrder, ...editingOrderDetails })
                                    }
                                    setIsEditingOrderDetails(false)
                                    setEditingOrderDetails(null)
                                  } catch (err) {
                                    alert(language === 'en' ? 'Failed to update order' : 'অর্ডার আপডেট করতে ব্যর্থ')
                                    console.error(err)
                                  }
                                }}
                                style={{
                                  padding: '0.5rem 1.5rem',
                                  backgroundColor: '#10b981',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '0.5rem',
                                  cursor: 'pointer',
                                  fontWeight: 700,
                                  boxShadow: '0 10px 20px rgba(16,185,129,0.35)'
                                }}
                              >
                                {language === 'en' ? 'Save' : 'সংরক্ষণ'}
                              </button>
                              <button
                                onClick={() => {
                                  setIsEditingOrderDetails(false)
                                  setEditingOrderDetails(null)
                                }}
                                style={{
                                  padding: '0.5rem 1.5rem',
                                  backgroundColor: '#6b7280',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '0.5rem',
                                  cursor: 'pointer',
                                  fontWeight: 700
                                }}
                              >
                                {language === 'en' ? 'Cancel' : 'বাতিল'}
                              </button>
                            </>
                          ) : (
                            <>
                              <button
                                onClick={() => {
                                  setIsEditingOrderDetails(true)
                                  const totalVal = parseFloat(viewingOrder.totalPrice || 0)
                                  const discount = viewingOrder.discountEnabled && viewingOrder.discountAmount > 0 ? viewingOrder.discountAmount : 1
                                  const grandTotal = viewingOrder.grandTotal || (totalVal * discount)
                                  const paid = parseFloat(viewingOrder.paidAmount || 0)
                                  const comm = (viewingOrder.paymentHistory || []).reduce((sum, p) => sum + (parseFloat(p.commission) || 0), 0)
                                  const due = Math.max(0, grandTotal - (paid + comm))
                                  const currentStatus = viewingOrder.status || 'Pending'
                                  // For non-admin users, if status is not Shipped, Delivered, or Complete, default to Shipped
                                  let initialStatus = currentStatus
                                  if ((userRole || '').toLowerCase() !== 'admin') {
                                    if (currentStatus !== 'Shipped' && currentStatus !== 'Delivered' && currentStatus !== 'Complete') {
                                      initialStatus = 'Shipped'
                                    }
                                  }
                                  setEditingOrderDetails({
                                    paidAmount: paid,
                                    dueAmount: due,
                                    status: initialStatus,
                                    commission: viewingOrder.commission || ''
                                  })
                                }}
                                style={{
                                  padding: '0.5rem 1.5rem',
                                  backgroundColor: '#3b82f6',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '0.5rem',
                                  cursor: 'pointer',
                                  fontWeight: 700,
                                  boxShadow: '0 10px 20px rgba(59,130,246,0.35)'
                                }}
                              >
                                {adminContent.edit}
                              </button>
                              {(userRole || '').toLowerCase() === 'admin' && (
                                <button
                                  onClick={async () => {
                                    if (window.confirm(language === 'en' ? 'Are you sure you want to delete this order?' : 'আপনি কি এই অর্ডারটি মুছতে চান?')) {
                                      await handleDeleteOrder(viewingOrder._id)
                                      setViewingOrder(null)
                                    }
                                  }}
                                  style={{
                                    padding: '0.5rem 1.5rem',
                                    backgroundColor: '#ef4444',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '0.5rem',
                                    cursor: 'pointer',
                                    fontWeight: 700,
                                    boxShadow: '0 10px 20px rgba(239,68,68,0.35)'
                                  }}
                                >
                                  {adminContent.delete}
                                </button>
                              )}
                              <button
                                onClick={() => handlePrintOrder(viewingOrder)}
                                style={{
                                  padding: '0.5rem 1.5rem',
                                  backgroundColor: '#f3f4f6',
                                  color: '#374151',
                                  border: 'none',
                                  borderRadius: '0.5rem',
                                  cursor: 'pointer',
                                  fontWeight: 700,
                                  boxShadow: '0 10px 20px rgba(0,0,0,0.1)'
                                }}
                              >
                                {language === 'en' ? 'Print Invoice' : 'ইনভয়েস প্রিন্ট'}
                              </button>
                            </>
                          )}
                          <button
                            onClick={() => {
                              setViewingOrder(null)
                              setIsEditingOrderDetails(false)
                              setEditingOrderDetails(null)
                            }}
                            style={{
                              padding: '0.5rem 1.5rem',
                              backgroundColor: '#6b7280',
                              color: 'white',
                              border: 'none',
                              borderRadius: '0.5rem',
                              cursor: 'pointer',
                              fontWeight: 700
                            }}
                          >
                            {language === 'en' ? 'Close' : 'বন্ধ করুন'}
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div >
            )
          }

          {/* Inventory Tab */}
          {
            activeTab === 'inventory' && (
              <div className="admin-tab-content">
                <div className="admin-tab-header">
                  <div style={{ display: 'flex', alignItems: 'center', gap: '1.5rem', flexWrap: 'wrap' }}>
                    <h1 className="admin-page-title" style={{ margin: 0 }}>{adminContent.inventory}</h1>

                    {/* Inventory Filter Controls */}
                    <div style={{ display: 'flex', gap: '0.6rem', alignItems: 'center', backgroundColor: '#f8fafc', padding: '0.4rem', borderRadius: '0.5rem', border: '1px solid #e2e8f0' }}>
                      <div style={{ display: 'flex', borderRadius: '0.375rem', overflow: 'hidden', border: '1px solid #cbd5e1' }}>
                        {['all', 'monthly', 'half', 'yearly'].map((type) => (
                          <button
                            key={type}
                            onClick={() => setInventoryFilter(type)}
                            style={{
                              padding: '0.4rem 0.8rem',
                              border: 'none',
                              backgroundColor: inventoryFilter === type ? '#3b82f6' : 'white',
                              color: inventoryFilter === type ? 'white' : '#64748b',
                              fontSize: '0.75rem',
                              fontWeight: 700,
                              cursor: 'pointer',
                              borderRight: type !== 'yearly' ? '1px solid #cbd5e1' : 'none',
                              transition: 'all 0.2s'
                            }}
                          >
                            {type === 'all' ? (language === 'en' ? 'All' : 'সব') :
                              type === 'monthly' ? (language === 'en' ? 'Monthly' : 'মাসিক') :
                                type === 'half' ? (language === 'en' ? 'Half' : 'অর্ধ-বার্ষিক') :
                                  (language === 'en' ? 'Yearly' : 'বার্ষিক')}
                          </button>
                        ))}
                      </div>

                      {/* Period Selection Details */}
                      {inventoryFilter !== 'all' && (
                        <div style={{ display: 'flex', gap: '0.4rem', borderLeft: '1px solid #e2e8f0', paddingLeft: '0.6rem' }}>
                          {inventoryFilter === 'monthly' && (
                            <select
                              value={inventorySelectedMonth}
                              onChange={(e) => setInventorySelectedMonth(parseInt(e.target.value))}
                              style={{ padding: '0.35rem 0.6rem', borderRadius: '0.375rem', border: '1px solid #cbd5e1', fontSize: '0.75rem', fontWeight: 600, backgroundColor: 'white' }}
                            >
                              {Array.from({ length: 12 }, (_, i) => (
                                <option key={i} value={i}>
                                  {new Date(0, i).toLocaleString('en-US', { month: 'short' })}
                                </option>
                              ))}
                            </select>
                          )}

                          {inventoryFilter === 'half' && (
                            <select
                              value={inventorySelectedHalf}
                              onChange={(e) => setInventorySelectedHalf(e.target.value)}
                              style={{ padding: '0.35rem 0.6rem', borderRadius: '0.375rem', border: '1px solid #cbd5e1', fontSize: '0.75rem', fontWeight: 600, backgroundColor: 'white' }}
                            >
                              <option value="H1">H1 (Jan-Jun)</option>
                              <option value="H2">H2 (Jul-Dec)</option>
                            </select>
                          )}

                          {['monthly', 'half', 'yearly'].includes(inventoryFilter) && (
                            <select
                              value={inventorySelectedYear}
                              onChange={(e) => setInventorySelectedYear(parseInt(e.target.value))}
                              style={{ padding: '0.35rem 0.6rem', borderRadius: '0.375rem', border: '1px solid #cbd5e1', fontSize: '0.75rem', fontWeight: 600, backgroundColor: 'white' }}
                            >
                              {[2024, 2025, 2026].map(y => (
                                <option key={y} value={y}>{y}</option>
                              ))}
                            </select>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                  <button className="admin-add-btn" onClick={() => { setShowInventoryForm(true); resetInventoryForm(); }}>
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                      <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                    </svg>
                    {adminContent.addNew}
                  </button>
                </div>
                {loadingInventory ? (
                  <LoadingSpinner text={language === 'en' ? 'Loading Inventory...' : 'ইনভেন্টরি লোড হচ্ছে...'} />
                ) : (
                  <>
                    <div className="admin-stats-grid">
                      <div className="admin-stat-card">
                        <div className="admin-stat-icon" style={{ backgroundColor: '#eff6ff', color: '#3b82f6' }}>
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4H6z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          </svg>
                        </div>
                        <div className="admin-stat-info">
                          <h3>{language === 'en' ? 'Total Items' : 'মোট আইটেম'}</h3>
                          <p>{inventoryStats.totalItems}</p>
                        </div>
                      </div>
                      <div className="admin-stat-card">
                        <div className="admin-stat-icon" style={{ backgroundColor: '#fff7ed', color: '#f97316' }}>
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          </svg>
                        </div>
                        <div className="admin-stat-info">
                          <h3>{language === 'en' ? 'Low Stock' : 'কম স্টক'}</h3>
                          <p>{inventoryStats.lowStock}</p>
                        </div>
                      </div>
                      <div className="admin-stat-card">
                        <div className="admin-stat-icon" style={{ backgroundColor: '#ecfdf5', color: '#10b981' }}>
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          </svg>
                        </div>
                        <div className="admin-stat-info">
                          <h3>{language === 'en' ? 'Total Value' : 'মোট মূল্য'}</h3>
                          <p>৳{inventoryStats.totalValue.toLocaleString()}</p>
                        </div>
                      </div>
                    </div>
                    <div className="admin-table-container" style={{ marginTop: '2rem' }}>
                      <table className="admin-table">
                        <thead>
                          <tr style={{ cursor: 'pointer' }}>
                            <th onClick={() => handleSortInventory('productName')}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem' }}>
                                {language === 'en' ? 'Product Name' : 'পণ্যের নাম'}
                                {inventorySortField === 'productName' && (
                                  <span>{inventorySortDirection === 'asc' ? '↑' : '↓'}</span>
                                )}
                              </div>
                            </th>
                            <th onClick={() => handleSortInventory('productCode')}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem' }}>
                                {language === 'en' ? 'Variant Details' : 'ভ্যারিয়েন্ট বিস্তারিত'}
                                {inventorySortField === 'productCode' && (
                                  <span>{inventorySortDirection === 'asc' ? '↑' : '↓'}</span>
                                )}
                              </div>
                            </th>
                            <th onClick={() => handleSortInventory('quantity')}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem' }}>
                                {language === 'en' ? 'Quantity' : 'পরিমাণ'}
                                {inventorySortField === 'quantity' && (
                                  <span>{inventorySortDirection === 'asc' ? '↑' : '↓'}</span>
                                )}
                              </div>
                            </th>
                            <th onClick={() => handleSortInventory('required')}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem' }}>
                                {language === 'en' ? 'Required' : 'প্রয়োজন'}
                                {inventorySortField === 'required' && (
                                  <span>{inventorySortDirection === 'asc' ? '↑' : '↓'}</span>
                                )}
                              </div>
                            </th>
                            <th onClick={() => handleSortInventory('delivered')}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem' }}>
                                {language === 'en' ? 'Delivered' : 'সরবরাহকৃত'}
                                {inventorySortField === 'delivered' && (
                                  <span>{inventorySortDirection === 'asc' ? '↑' : '↓'}</span>
                                )}
                              </div>
                            </th>
                            <th>{language === 'en' ? 'Status' : 'অবস্থা'}</th>
                            <th>{language === 'en' ? 'Actions' : 'কার্যক্রম'}</th>
                          </tr>
                        </thead>
                        <tbody>
                          {sortedInventory.length > 0 ? (
                            sortedInventory.map((item) => (
                              <tr key={item._id}>
                                <td>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                    {item.product?.image && <img src={item.product.image} alt="" style={{ width: '32px', height: '32px', borderRadius: '4px', objectFit: 'cover' }} />}
                                    <span>{item.product?.name || 'Unknown'}</span>
                                  </div>
                                </td>
                                <td>{item.variant?.productCode ? `${item.variant.productCode} (${item.variant.packSize} ${item.variant.packUnit || 'ml'}) [${item.variant.cartoonSize || 1} ${item.variant.cartoonUnit || 'Pcs'}]` : '-'}</td>
                                <td style={{
                                  color: ((item.requiredQuantity > item.quantity) || (item.quantity <= (item.minStockLevel || 10))) ? '#ef4444' : 'inherit',
                                  fontWeight: ((item.requiredQuantity > item.quantity) || (item.quantity <= (item.minStockLevel || 10))) ? 700 : 400
                                }}>
                                  {item.quantity}
                                </td>
                                <td style={{ color: '#3b82f6', fontWeight: 600 }}>{item.requiredQuantity || 0}</td>
                                <td style={{ color: '#10b981', fontWeight: 600 }}>{item.deliveredQuantity || 0}</td>
                                <td>
                                  <div className="mobile-card-status-badge" style={{
                                    position: 'static',
                                    backgroundColor: ((item.requiredQuantity > item.quantity) || (item.quantity <= (item.minStockLevel || 10))) ? '#fee2e2' : '#dcfce7',
                                    color: ((item.requiredQuantity > item.quantity) || (item.quantity <= (item.minStockLevel || 10))) ? '#dc2626' : '#166534',
                                    display: 'inline-block'
                                  }}>
                                    {((item.requiredQuantity > item.quantity) || (item.quantity <= (item.minStockLevel || 10))) ? (language === 'en' ? 'Low Stock' : 'কম স্টক') : (language === 'en' ? 'In Stock' : 'স্টকে আছে')}
                                  </div>
                                </td>
                                <td>
                                  <div style={{ display: 'flex', gap: '0.5rem' }}>
                                    <button
                                      onClick={() => {
                                        setInventoryForm({
                                          id: item._id,
                                          product: item.product?._id || item.product,
                                          variant: item.variant,
                                          quantity: item.quantity,
                                          minStockLevel: item.minStockLevel,
                                          notes: item.notes
                                        });
                                        setShowInventoryForm(true);
                                      }}
                                      className="admin-edit-btn"
                                      style={{ padding: '0.25rem 0.75rem', fontSize: '0.75rem' }}
                                    >
                                      Edit
                                    </button>
                                    <button
                                      onClick={() => handleDeleteInventory(item._id)}
                                      className="admin-remove-btn"
                                      style={{ padding: '0.25rem 0.75rem', fontSize: '0.75rem' }}
                                    >
                                      Delete
                                    </button>
                                  </div>
                                </td>
                              </tr>
                            ))
                          ) : (
                            <tr>
                              <td colSpan="7" style={{ textAlign: 'center', padding: '2rem' }}>
                                {adminContent.noData}
                              </td>
                            </tr>
                          )}
                        </tbody>
                      </table>
                    </div>

                    {/* Mobile Card View for Inventory */}
                    <div className="mobile-card-container">
                      {inventory.length === 0 ? (
                        <div style={{ textAlign: 'center', padding: '2rem', color: '#6b7280' }}>
                          {adminContent.noData}
                        </div>
                      ) : (
                        inventory.map((item) => {
                          const isExpanded = expandedInventoryId === item._id;
                          const isLowStock = (item.requiredQuantity > item.quantity) || (item.quantity <= (item.minStockLevel || 10));

                          return (
                            <div
                              className="mobile-card"
                              key={item._id}
                              onClick={() => toggleInventoryExpansion(item._id)}
                              style={{ cursor: 'pointer', borderLeft: isLowStock ? '4px solid #ef4444' : '4px solid #3b82f6' }}
                            >
                              <div className="mobile-card-header">
                                <div className="mobile-card-avatar" style={{ overflow: 'hidden', borderRadius: '4px' }}>
                                  {item.product?.image ? (
                                    <img src={item.product.image} alt="" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                                  ) : (
                                    (item.product?.name || 'U').charAt(0).toUpperCase()
                                  )}
                                </div>
                                <div className="mobile-card-header-text">
                                  <div className="mobile-card-title">{item.product?.name || 'Unknown'}</div>
                                  <div className="mobile-card-subtitle">{item.variant?.productCode ? `${item.variant.productCode} (${item.variant.packSize} ${item.variant.packUnit || 'ml'}) [${item.variant.cartoonSize || 1} ${item.variant.cartoonUnit || 'Pcs'}]` : '-'}</div>
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', marginLeft: 'auto' }}>
                                  <div className="mobile-card-status-badge" style={{
                                    position: 'static',
                                    backgroundColor: isLowStock ? '#fee2e2' : '#dcfce7',
                                    color: isLowStock ? '#dc2626' : '#166534',
                                    marginBottom: '0.25rem'
                                  }}>
                                    {isLowStock ? 'Low Stock' : 'In Stock'}
                                  </div>
                                  <div style={{ fontSize: '0.875rem', fontWeight: 700, color: isLowStock ? '#ef4444' : '#1e293b' }}>
                                    Qty: {item.quantity}
                                  </div>
                                </div>
                              </div>

                              <div className="mobile-card-body">
                                {isExpanded && (
                                  <>
                                    <div className="mobile-card-row" style={{ animation: 'fadeIn 0.2s' }}>
                                      <span className="mobile-card-label">{language === 'en' ? 'Required' : 'প্রয়োজন'}</span>
                                      <span className="mobile-card-value" style={{ color: '#3b82f6', fontWeight: 600 }}>{item.requiredQuantity || 0}</span>
                                    </div>
                                    <div className="mobile-card-row" style={{ animation: 'fadeIn 0.2s' }}>
                                      <span className="mobile-card-label">{language === 'en' ? 'Delivered' : 'সরবরাহকৃত'}</span>
                                      <span className="mobile-card-value" style={{ color: '#10b981', fontWeight: 600 }}>{item.deliveredQuantity || 0}</span>
                                    </div>
                                    <div className="mobile-card-row" style={{ animation: 'fadeIn 0.2s' }}>
                                      <span className="mobile-card-label">{language === 'en' ? 'Status' : 'অবস্থা'}</span>
                                      <span className="mobile-card-value" style={{
                                        color: isLowStock ? '#dc2626' : '#166534',
                                        fontWeight: 600
                                      }}>
                                        {isLowStock ? (language === 'en' ? 'Low Stock' : 'কম স্টক') : (language === 'en' ? 'In Stock' : 'স্টকে আছে')}
                                      </span>
                                    </div>
                                    {item.notes && (
                                      <div className="mobile-card-row" style={{ animation: 'fadeIn 0.2s', flexDirection: 'column', alignItems: 'flex-start' }}>
                                        <span className="mobile-card-label">{language === 'en' ? 'Notes' : 'নোট'}</span>
                                        <span className="mobile-card-value" style={{ marginTop: '0.25rem', fontSize: '0.8rem' }}>{item.notes}</span>
                                      </div>
                                    )}
                                  </>
                                )}
                              </div>

                              {isExpanded && (
                                <div className="mobile-card-actions" onClick={(e) => e.stopPropagation()} style={{ animation: 'fadeIn 0.2s' }}>
                                  <button
                                    className="mobile-action-btn"
                                    onClick={() => {
                                      setInventoryForm({
                                        id: item._id,
                                        product: item.product?._id || item.product,
                                        variant: item.variant,
                                        quantity: item.quantity,
                                        minStockLevel: item.minStockLevel,
                                        notes: item.notes
                                      });
                                      setShowInventoryForm(true);
                                    }}
                                  >
                                    {language === 'en' ? 'Edit' : 'সম্পাদনা'}
                                  </button>
                                  <button
                                    className="mobile-action-btn delete"
                                    onClick={() => handleDeleteInventory(item._id)}
                                    style={{ backgroundColor: '#fee2e2', color: '#dc2626', marginLeft: '0.5rem' }}
                                  >
                                    {language === 'en' ? 'Delete' : 'মুছুন'}
                                  </button>
                                </div>
                              )}
                            </div>
                          );
                        })
                      )}
                    </div>
                  </>
                )
                }
              </div>
            )
          }

          {/* Territory Management Tab */}
          {
            activeTab === 'territory' && (
              <div className="admin-tab-content">
                <div className="admin-tab-header">
                  <h1 className="admin-page-title" style={{ margin: 0 }}>{adminContent.territory}</h1>
                  <button
                    className="admin-add-btn"
                    onClick={() => {
                      resetTerritoryForm()
                      setShowTerritoryForm(true)
                    }}
                  >
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                      <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                    </svg>
                    {language === 'en' ? 'Add Territory' : 'টেরিটরি যোগ করুন'}
                  </button>
                </div>

                {loadingTerritories ? (
                  <LoadingSpinner text={language === 'en' ? 'Loading territories...' : 'টেরিটরি লোড হচ্ছে...'} />
                ) : (
                  <>
                    {/* Desktop Table View */}
                    <div className="admin-table-container desktop-only">
                      <table className="admin-table">
                        <thead>
                          <tr>
                            <th onClick={() => handleSortTerritory('regionId')} style={{ cursor: 'pointer' }}>
                              {language === 'en' ? 'Region ID' : 'অঞ্চল আইডি'}
                              {territorySortField === 'regionId' && (
                                <span style={{ marginLeft: '0.5rem' }}>{territorySortDirection === 'asc' ? '↑' : '↓'}</span>
                              )}
                            </th>
                            <th onClick={() => handleSortTerritory('areaId')} style={{ cursor: 'pointer' }}>
                              {language === 'en' ? 'Area ID' : 'এলাকা আইডি'}
                              {territorySortField === 'areaId' && (
                                <span style={{ marginLeft: '0.5rem' }}>{territorySortDirection === 'asc' ? '↑' : '↓'}</span>
                              )}
                            </th>
                            <th onClick={() => handleSortTerritory('territoryId')} style={{ cursor: 'pointer' }}>
                              {adminContent.territoryId}
                              {territorySortField === 'territoryId' && (
                                <span style={{ marginLeft: '0.5rem' }}>{territorySortDirection === 'asc' ? '↑' : '↓'}</span>
                              )}
                            </th>
                            <th onClick={() => handleSortTerritory('division')} style={{ cursor: 'pointer' }}>
                              {language === 'en' ? 'Division' : 'বিভাগ'}
                              {territorySortField === 'division' && (
                                <span style={{ marginLeft: '0.5rem' }}>{territorySortDirection === 'asc' ? '↑' : '↓'}</span>
                              )}
                            </th>
                            <th onClick={() => handleSortTerritory('zilla')} style={{ cursor: 'pointer' }}>
                              {language === 'en' ? 'Zilla' : 'জেলা'}
                              {territorySortField === 'zilla' && (
                                <span style={{ marginLeft: '0.5rem' }}>{territorySortDirection === 'asc' ? '↑' : '↓'}</span>
                              )}
                            </th>
                            <th onClick={() => handleSortTerritory('area')} style={{ cursor: 'pointer' }}>
                              {language === 'en' ? 'Area' : 'এলাকা'}
                              {territorySortField === 'area' && (
                                <span style={{ marginLeft: '0.5rem' }}>{territorySortDirection === 'asc' ? '↑' : '↓'}</span>
                              )}
                            </th>
                            <th>{language === 'en' ? 'Actions' : 'কার্যক্রম'}</th>
                          </tr>
                        </thead>
                        <tbody>
                          {sortedTerritories.length > 0 ? (
                            sortedTerritories.map((territory) => (
                              <tr key={territory._id}>
                                <td>{territory.regionId}</td>
                                <td>{territory.areaId}</td>
                                <td>{territory.territoryId}</td>
                                <td>{territory.division}</td>
                                <td>{territory.zilla}</td>
                                <td>{territory.area}</td>
                                <td>
                                  <div style={{ display: 'flex', gap: '0.5rem' }}>
                                    <button
                                      className="admin-action-btn edit"
                                      onClick={() => {
                                        setTerritoryForm(territory)
                                        setShowTerritoryForm(true)
                                      }}
                                      title={language === 'en' ? 'Edit' : 'সম্পাদনা'}
                                    >
                                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                      </svg>
                                    </button>
                                    <button
                                      className="admin-action-btn delete"
                                      onClick={() => handleDeleteTerritory(territory._id)}
                                      title={language === 'en' ? 'Delete' : 'মুছুন'}
                                    >
                                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <polyline points="3 6 5 6 21 6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                      </svg>
                                    </button>
                                  </div>
                                </td>
                              </tr>
                            ))
                          ) : (
                            <tr>
                              <td colSpan="6" style={{ textAlign: 'center', padding: '2rem' }}>
                                {adminContent.noData}
                              </td>
                            </tr>
                          )}
                        </tbody>
                      </table>
                    </div>

                    {/* Mobile Card View */}
                    <div className="mobile-card-container">
                      {sortedTerritories.length === 0 ? (
                        <div style={{ textAlign: 'center', padding: '2rem', color: '#6b7280' }}>
                          {adminContent.noData}
                        </div>
                      ) : (
                        sortedTerritories.map((territory) => (
                          <div className="mobile-card" key={territory._id}>
                            <div className="mobile-card-header">
                              <div className="mobile-card-avatar" style={{ backgroundColor: '#3b82f6' }}>
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style={{ width: '20px', height: '20px' }}>
                                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                  <circle cx="12" cy="10" r="3" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                </svg>
                              </div>
                              <div className="mobile-card-header-text">
                                <div className="mobile-card-title">{territory.division} - {territory.zilla}</div>
                                <div className="mobile-card-subtitle">{territory.area}</div>
                              </div>
                            </div>
                            <div className="mobile-card-body">
                              <div className="mobile-card-row">
                                <span className="mobile-card-label">{language === 'en' ? 'Region ID' : 'অঞ্চল আইডি'}:</span>
                                <span className="mobile-card-value">{territory.regionId}</span>
                              </div>
                              <div className="mobile-card-row">
                                <span className="mobile-card-label">{language === 'en' ? 'Area ID' : 'এলাকা আইডি'}:</span>
                                <span className="mobile-card-value">{territory.areaId}</span>
                              </div>
                              <div className="mobile-card-row">
                                <span className="mobile-card-label">{adminContent.territoryId}:</span>
                                <span className="mobile-card-value">{territory.territoryId}</span>
                              </div>
                            </div>
                            <div className="mobile-card-actions">
                              <button
                                className="mobile-action-btn"
                                onClick={() => {
                                  setTerritoryForm(territory)
                                  setShowTerritoryForm(true)
                                }}
                              >
                                {language === 'en' ? 'Edit' : 'সম্পাদনা'}
                              </button>
                              <button
                                className="mobile-action-btn delete"
                                onClick={() => handleDeleteTerritory(territory._id)}
                                style={{ backgroundColor: '#fee2e2', color: '#dc2626', marginLeft: '0.5rem' }}
                              >
                                {language === 'en' ? 'Delete' : 'মুছুন'}
                              </button>
                            </div>
                          </div>
                        ))
                      )}
                    </div>
                  </>
                )}
              </div>
            )
          }

          {/* Revenue Tab */}
          {
            activeTab === 'revenue' && (
              <div className="admin-tab-content">
                <div className="admin-tab-header admin-revenue-header">
                  <h1 className="admin-page-title">{adminContent.revenue}</h1>
                </div>
                {loadingOrders ? (
                  <LoadingSpinner text={language === 'en' ? 'Calculating Revenue...' : 'রাজস্ব হিসাব করা হচ্ছে...'} />
                ) : (
                  <>
                    <div className="admin-revenue-controls">
                      <div className="revenue-filters">
                        <select
                          value={revenueFilterType}
                          onChange={(e) => setRevenueFilterType(e.target.value)}
                          style={{
                            padding: '0.5rem',
                            borderRadius: '0.375rem',
                            border: '1px solid #cbd5e1',
                            fontSize: '0.875rem',
                            backgroundColor: 'white'
                          }}
                        >
                          <option value="all">{language === 'en' ? 'All Time' : 'সব সময়'}</option>
                          <option value="monthly">{language === 'en' ? 'Monthly' : 'মাসিক'}</option>
                          <option value="half-yearly">{language === 'en' ? 'Half Yearly' : 'অর্ধ-বার্ষিক'}</option>
                          <option value="yearly">{language === 'en' ? 'Yearly' : 'বার্ষিক'}</option>
                        </select>

                        {revenueFilterType === 'monthly' && (
                          <div style={{ display: 'flex', gap: '0.5rem' }}>
                            <select
                              className="revenue-filter-select"
                              value={revenueSelectedMonth}
                              onChange={(e) => setRevenueSelectedMonth(parseInt(e.target.value))}
                              style={{
                                padding: '0.5rem',
                                borderRadius: '0.375rem',
                                border: '1px solid #cbd5e1',
                                fontSize: '0.875rem',
                                backgroundColor: 'white'
                              }}
                            >
                              {Array.from({ length: 12 }, (_, i) => (
                                <option key={i} value={i}>
                                  {new Date(0, i).toLocaleString(language === 'en' ? 'en-US' : 'en-US', { month: 'long' })}
                                </option>
                              ))}
                            </select>
                            <select
                              className="revenue-filter-select"
                              value={revenueSelectedYear}
                              onChange={(e) => setRevenueSelectedYear(parseInt(e.target.value))}
                              style={{
                                padding: '0.5rem',
                                borderRadius: '0.375rem',
                                border: '1px solid #cbd5e1',
                                fontSize: '0.875rem',
                                backgroundColor: 'white'
                              }}
                            >
                              {Array.from({ length: 6 }, (_, i) => new Date().getFullYear() + 1 - i).map(year => (
                                <option key={year} value={year}>{year}</option>
                              ))}
                            </select>
                          </div>
                        )}

                        {revenueFilterType === 'half-yearly' && (
                          <div style={{ display: 'flex', gap: '0.5rem' }}>
                            <select
                              value={revenueSelectedHalf}
                              onChange={(e) => setRevenueSelectedHalf(e.target.value)}
                              style={{
                                padding: '0.5rem',
                                borderRadius: '0.375rem',
                                border: '1px solid #cbd5e1',
                                fontSize: '0.875rem',
                                backgroundColor: 'white'
                              }}
                            >
                              <option value="H1">{language === 'en' ? '1st Half (Jan-Jun)' : '১ম অর্ধ (জানু-জুন)'}</option>
                              <option value="H2">{language === 'en' ? '2nd Half (Jul-Dec)' : '২য় অর্ধ (জুলাই-ডিসে)'}</option>
                            </select>
                            <select
                              value={revenueSelectedYear}
                              onChange={(e) => setRevenueSelectedYear(parseInt(e.target.value))}
                              style={{
                                padding: '0.5rem',
                                borderRadius: '0.375rem',
                                border: '1px solid #cbd5e1',
                                fontSize: '0.875rem',
                                backgroundColor: 'white'
                              }}
                            >
                              {Array.from({ length: 6 }, (_, i) => new Date().getFullYear() + 1 - i).map(year => (
                                <option key={year} value={year}>{year}</option>
                              ))}
                            </select>
                          </div>
                        )}

                        {revenueFilterType === 'yearly' && (
                          <select
                            value={revenueSelectedYear}
                            onChange={(e) => setRevenueSelectedYear(parseInt(e.target.value))}
                            style={{
                              padding: '0.5rem',
                              borderRadius: '0.375rem',
                              border: '1px solid #cbd5e1',
                              fontSize: '0.875rem',
                              backgroundColor: 'white'
                            }}
                          >
                            {Array.from({ length: 6 }, (_, i) => new Date().getFullYear() + 1 - i).map(year => (
                              <option key={year} value={year}>{year}</option>
                            ))}
                          </select>
                        )}
                      </div>

                      <div className="revenue-actions">
                        <button
                          onClick={() => setShowManageTarget(true)}
                          className="revenue-action-btn"
                          style={{
                            backgroundColor: 'rgba(16, 185, 129, 0.9)', // Emerald Green Glass
                            color: 'white',
                            border: '1px solid rgba(52, 211, 153, 0.5)',
                            borderRadius: '0.375rem',
                            cursor: 'pointer',
                            fontWeight: 600,
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.5rem',
                            backdropFilter: 'blur(8px)',
                            WebkitBackdropFilter: 'blur(8px)',
                            boxShadow: '0 4px 6px -1px rgba(16, 185, 129, 0.2), 0 2px 4px -1px rgba(16, 185, 129, 0.1)'
                          }}
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                          </svg>
                          {language === 'en' ? 'Target' : 'লক্ষ্য'}
                        </button>
                        {/* Debug Log Removed */}
                        <button
                          onClick={() => setShowManageCommissions(true)}
                          className="revenue-action-btn"
                          style={{
                            backgroundColor: '#e0f2fe',
                            color: '#0369a1',
                            border: '1px solid #bae6fd',
                            borderRadius: '0.375rem',
                            cursor: 'pointer',
                            fontWeight: 600,
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.5rem'
                          }}
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                          </svg>
                          {language === 'en' ? 'Commission' : 'কমিশন'}
                        </button>
                        <button
                          onClick={() => setShowManageDiscount(true)}
                          className="revenue-action-btn"
                          style={{
                            backgroundColor: '#fef2f2',
                            color: '#dc2626',
                            border: '1px solid #fecaca',
                            borderRadius: '0.375rem',
                            cursor: 'pointer',
                            fontWeight: 600,
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.5rem'
                          }}
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <circle cx="9" cy="21" r="1" />
                            <circle cx="20" cy="21" r="1" />
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                            <path d="M12 6l-3 3 3 3" />
                          </svg>
                          {language === 'en' ? `Discount${discountEnabled ? ` (৳${discountAmount})` : ''}` : `ডিসকাউন্ট${discountEnabled ? ` (৳${discountAmount})` : ''}`}
                        </button>
                      </div>
                    </div>

                    {showManageTarget && (
                      <div style={{
                        position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                        backgroundColor: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 9999
                      }}>
                        <div style={{ backgroundColor: 'white', padding: '1.5rem', borderRadius: '0.5rem', width: '400px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                            <h3 style={{ margin: 0, color: '#1e293b' }}>{language === 'en' ? 'Set Sales Target' : 'বিক্রয় লক্ষ্য নির্ধারণ করুন'}</h3>
                            <button onClick={() => setShowManageTarget(false)} style={{ background: 'none', border: 'none', fontSize: '1.25rem', cursor: 'pointer', color: '#64748b' }}>×</button>
                          </div>

                          <div style={{ marginBottom: '1rem', display: 'flex', gap: '0.5rem' }}>
                            <button
                              onClick={() => setTargetMode('half-yearly')}
                              style={{
                                flex: 1, padding: '0.5rem', borderRadius: '0.375rem', border: '1px solid #e2e8f0',
                                backgroundColor: targetMode === 'half-yearly' ? '#0ea5e9' : 'white',
                                color: targetMode === 'half-yearly' ? 'white' : '#64748b'
                              }}
                            >
                              {language === 'en' ? 'Half Yearly' : 'অর্ধ বার্ষিক'}
                            </button>
                            <button
                              onClick={() => setTargetMode('monthly')}
                              style={{
                                flex: 1, padding: '0.5rem', borderRadius: '0.375rem', border: '1px solid #e2e8f0',
                                backgroundColor: targetMode === 'monthly' ? '#0ea5e9' : 'white',
                                color: targetMode === 'monthly' ? 'white' : '#64748b'
                              }}
                            >
                              {language === 'en' ? 'Monthly' : 'মাসিক'}
                            </button>
                          </div>

                          <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <div>
                              <label style={{ display: 'block', marginBottom: '0.25rem', fontSize: '0.875rem' }}>Year</label>
                              <select value={targetYear} onChange={(e) => setTargetYear(parseInt(e.target.value))} style={{ width: '100%', padding: '0.5rem', borderRadius: '0.375rem', border: '1px solid #e2e8f0' }}>
                                {Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - i + 2).map(year => (
                                  <option key={year} value={year}>{year}</option>
                                ))}
                              </select>
                            </div>

                            {targetMode === 'half-yearly' ? (
                              <div>
                                <label style={{ display: 'block', marginBottom: '0.25rem', fontSize: '0.875rem' }}>Period</label>
                                <select value={targetPeriod} onChange={(e) => setTargetPeriod(e.target.value)} style={{ width: '100%', padding: '0.5rem', borderRadius: '0.375rem', border: '1px solid #e2e8f0' }}>
                                  <option value="H1">Jan - Jun (1st Half)</option>
                                  <option value="H2">Jul - Dec (2nd Half)</option>
                                </select>
                              </div>
                            ) : (
                              <div>
                                <label style={{ display: 'block', marginBottom: '0.25rem', fontSize: '0.875rem' }}>Month</label>
                                <select value={targetMonth} onChange={(e) => setTargetMonth(parseInt(e.target.value))} style={{ width: '100%', padding: '0.5rem', borderRadius: '0.375rem', border: '1px solid #e2e8f0' }}>
                                  {Array.from({ length: 12 }, (_, i) => (
                                    <option key={i} value={i}>
                                      {new Date(0, i).toLocaleString('en-US', { month: 'long' })}
                                    </option>
                                  ))}
                                </select>
                              </div>
                            )}

                            <div>
                              <label style={{ display: 'block', marginBottom: '0.25rem', fontSize: '0.875rem' }}>Target Amount (Tk)</label>
                              <input
                                type="number"
                                value={targetAmount}
                                onChange={(e) => setTargetAmount(e.target.value)}
                                placeholder="Enter amount"
                                style={{ width: '100%', padding: '0.5rem', borderRadius: '0.375rem', border: '1px solid #e2e8f0' }}
                              />
                              {targetMode === 'half-yearly' && targetAmount && (
                                <p style={{ fontSize: '0.75rem', color: '#64748b', marginTop: '0.25rem' }}>
                                  ~ ৳{Math.round(targetAmount / 6).toLocaleString()} per month
                                </p>
                              )}
                            </div>

                            <button
                              onClick={handleSaveTarget}
                              disabled={savingTarget}
                              style={{
                                padding: '0.75rem', backgroundColor: '#10b981', color: 'white', border: 'none', borderRadius: '0.375rem',
                                marginTop: '0.5rem', cursor: savingTarget ? 'not-allowed' : 'pointer', fontWeight: 600
                              }}
                            >
                              {savingTarget ? 'Saving...' : 'Save Target'}
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    {showManageCommissions && (
                      <div style={{
                        position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                        backgroundColor: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 9999
                      }}>
                        <div style={{ backgroundColor: 'white', padding: '1.5rem', borderRadius: '0.5rem', width: '320px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                            <h3 style={{ margin: 0, color: '#1e293b' }}>{language === 'en' ? 'Manage Rates' : 'রেট পরিচালনা'}</h3>
                            <button onClick={() => setShowManageCommissions(false)} style={{ background: 'none', border: 'none', fontSize: '1.25rem', cursor: 'pointer', color: '#64748b' }}>×</button>
                          </div>

                          <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
                            <input
                              type="text"
                              placeholder="e.g. 12%"
                              value={newCommissionRate}
                              onChange={(e) => setNewCommissionRate(e.target.value)}
                              style={{ flex: 1, padding: '0.5rem', border: '1px solid #cbd5e1', borderRadius: '0.375rem' }}
                            />
                            <button
                              onClick={handleAddCommissionRate}
                              style={{ padding: '0.5rem 1rem', backgroundColor: '#3b82f6', color: 'white', border: 'none', borderRadius: '0.375rem', cursor: 'pointer', fontWeight: 600 }}
                            >
                              {language === 'en' ? 'Add' : 'যোগ'}
                            </button>
                          </div>

                          <div style={{ maxHeight: '250px', overflowY: 'auto', border: '1px solid #e2e8f0', borderRadius: '0.375rem', WebkitOverflowScrolling: 'touch' }}>
                            <ul style={{ listStyle: 'none', padding: 0, margin: 0 }}>
                              {commissionRates.map((rate, index) => (
                                <li key={index} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.75rem', borderBottom: index === commissionRates.length - 1 ? 'none' : '1px solid #f1f5f9' }}>
                                  <span style={{ fontWeight: 500, color: '#334155' }}>{rate}</span>
                                  <button
                                    onClick={() => handleRemoveCommissionRate(rate)}
                                    style={{ color: '#ef4444', background: 'none', border: 'none', cursor: 'pointer', padding: '0.25rem' }}
                                    title="Remove"
                                  >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                  </button>
                                </li>
                              ))}
                            </ul>
                          </div>
                        </div>
                      </div>
                    )}

                    {showManageDiscount && (
                      <div style={{
                        position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                        backgroundColor: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 9999
                      }}>
                        <div style={{ backgroundColor: 'white', padding: '1.5rem', borderRadius: '0.5rem', width: '400px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                            <h3 style={{ margin: 0, color: '#1e293b' }}>{language === 'en' ? 'Manage Discount' : 'ডিসকাউন্ট ব্যবস্থাপনা'}</h3>
                            <button onClick={() => setShowManageDiscount(false)} style={{ background: 'none', border: 'none', fontSize: '1.25rem', cursor: 'pointer', color: '#64748b' }}>×</button>
                          </div>

                          <div style={{ marginBottom: '1rem' }}>
                            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 500, color: '#334155' }}>
                              {language === 'en' ? 'Discount Amount' : 'ডিসকাউন্ট পরিমাণ'}
                            </label>
                            <input
                              type="number"
                              min="0"
                              value={discountAmount}
                              onChange={(e) => setDiscountAmount(e.target.value)}
                              style={{ width: '100%', padding: '0.5rem', border: '1px solid #cbd5e1', borderRadius: '0.375rem' }}
                              placeholder="e.g. 0.8"
                            />
                          </div>

                          <div style={{ marginBottom: '1.5rem', display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                            <input
                              type="checkbox"
                              id="discountEnabled"
                              checked={discountEnabled}
                              onChange={(e) => setDiscountEnabled(e.target.checked)}
                              style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                            />
                            <label htmlFor="discountEnabled" style={{ cursor: 'pointer', fontWeight: 500, color: '#334155' }}>
                              {language === 'en' ? 'Enable Discount' : 'ডিসকাউন্ট সক্রিয় করুন'}
                            </label>
                          </div>

                          <button
                            onClick={handleSaveDiscount}
                            disabled={savingDiscount}
                            style={{
                              width: '100%',
                              padding: '0.75rem',
                              backgroundColor: savingDiscount ? '#94a3b8' : '#dc2626',
                              color: 'white',
                              border: 'none',
                              borderRadius: '0.375rem',
                              cursor: savingDiscount ? 'not-allowed' : 'pointer',
                              fontWeight: 600,
                              fontSize: '0.875rem'
                            }}
                          >
                            {savingDiscount ? (language === 'en' ? 'Saving...' : 'সংরক্ষণ করা হচ্ছে...') : (language === 'en' ? 'Save Discount' : 'ডিসকাউন্ট সংরক্ষণ করুন')}
                          </button>
                        </div>
                      </div>
                    )}


                    <div className="admin-stats-grid">
                      <div className="admin-stat-card">
                        <div className="admin-stat-icon">
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <line x1="12" y1="1" x2="12" y2="23" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          </svg>
                        </div>
                        <div className="admin-stat-info">
                          <h3>{language === 'en' ? 'Total Revenue' : 'মোট রাজস্ব'}</h3>
                          <p>৳{Number(revenueStats.totalRevenue || 0).toLocaleString()}</p>
                        </div>
                      </div>

                      <div className="admin-stat-card">
                        <div className="admin-stat-icon" style={{ backgroundColor: '#f0fdf4', color: '#16a34a' }}>
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">

                            <path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          </svg >
                        </div >
                        <div className="admin-stat-info">
                          <h3>{language === 'en' ? 'Growth Rate' : 'বৃদ্ধির হার'}</h3>
                          <p>0%</p>
                        </div>
                      </div >
                      <div className="admin-stat-card">
                        <div className="admin-stat-icon">
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 12l4 4 12-12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          </svg>
                        </div>
                        <div className="admin-stat-info">
                          <h3>{language === 'en' ? 'Sales Target' : 'বিক্রয় লক্ষ্য'}</h3>
                          <p>
                            ৳{(() => {
                              let target = 0
                              if (revenueFilterType === 'monthly') {
                                const t = (salesTargets || []).find(t => t.year === revenueSelectedYear && t.month === revenueSelectedMonth)
                                target = t ? t.amount : 0
                              } else if (revenueFilterType === 'half-yearly') {
                                // Sum targets for the selected half (6 months)
                                const startMonth = revenueSelectedHalf === 'H1' ? 0 : 6
                                const endMonth = startMonth + 6
                                target = (salesTargets || []).filter(t =>
                                  t.year === revenueSelectedYear &&
                                  t.month >= startMonth &&
                                  t.month < endMonth
                                ).reduce((sum, t) => sum + (t.amount || 0), 0)
                              } else if (revenueFilterType === 'yearly') {
                                target = (salesTargets || []).filter(t => t.year === revenueSelectedYear).reduce((sum, t) => sum + (t.amount || 0), 0)
                              } else {
                                // All Time: Default to current year
                                const currentYear = new Date().getFullYear()
                                target = (salesTargets || []).filter(t => t.year === currentYear).reduce((sum, t) => sum + (t.amount || 0), 0)
                              }
                              return Math.round(target).toLocaleString()
                            })()}
                          </p>
                        </div>
                      </div>

                      <div className="admin-stat-card">
                        <div className="admin-stat-icon">
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                            <polyline points="22 4 12 14.01 9 11.01" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          </svg>
                        </div>
                        <div className="admin-stat-info">
                          <h3>{language === 'en' ? 'Achieve Amount' : 'অর্জিত পরিমাণ'}</h3>
                          <p>
                            ৳{(() => {
                              const achieveAmount = (orders || []).reduce((sum, order) => {
                                // Exclude cancelled/rejected
                                if (order.status === 'Cancelled' || order.approvalStatus === 'Rejected') {
                                  return sum
                                }

                                // Filter based on filter type
                                if (revenueFilterType === 'half-yearly') {
                                  // For half-yearly, check targetHalf and targetYear fields
                                  if (order.targetHalf !== revenueSelectedHalf || order.targetYear !== revenueSelectedYear) {
                                    return sum
                                  }
                                } else if (revenueFilterType === 'monthly') {
                                  // For monthly, check if order's targetYear and targetMonth match
                                  const orderTargetMonth = order.targetMonth !== undefined ? order.targetMonth : new Date(order.createdAt).getMonth()
                                  const orderTargetYear = order.targetYear || new Date(order.createdAt).getFullYear()
                                  if (orderTargetYear !== revenueSelectedYear || orderTargetMonth !== revenueSelectedMonth) {
                                    return sum
                                  }
                                } else if (revenueFilterType === 'yearly') {
                                  // For yearly, check targetYear
                                  const orderYear = order.targetYear || new Date(order.createdAt).getFullYear()
                                  if (orderYear !== revenueSelectedYear) {
                                    return sum
                                  }
                                }
                                // For 'all', no date filtering needed

                                // Count approved orders with discount
                                if (order.approvalStatus === 'Approved') {
                                  const total = parseFloat(order.totalPrice) || 0
                                  const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1
                                  return sum + (total * discount)
                                }
                                return sum
                              }, 0)
                              return Math.round(achieveAmount).toLocaleString()
                            })()}
                          </p>
                        </div>
                      </div>
                      <div className="admin-stat-card">
                        <div className="admin-stat-icon">
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 12c0 1.2-4.03 6-9 6s-9-4.8-9-6 4.03-6 9-6 9 4.8 9 6z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                            <path d="M12 17c-4.97 0-9-4.8-9-6 0-1.2 4.03-6 9-6s9 4.8 9 6c0 1.2-4.03 6-9 6z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                            <circle cx="12" cy="11" r="3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          </svg>
                        </div>
                        <div className="admin-stat-info">
                          <h3>{language === 'en' ? 'Total Collection' : 'মোট সংগ্রহ'}</h3>
                          <p>৳{Number(revenueStats.totalCollection || 0).toLocaleString()}</p>
                        </div>
                      </div>
                      <div className="admin-stat-card">
                        <div className="admin-stat-icon">
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                            <circle cx="12" cy="12" r="3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                          </svg>
                        </div>
                        <div className="admin-stat-info">
                          <h3>{language === 'en' ? 'Total Due' : 'মোট বকেয়া'}</h3>
                          <p>৳{Number(revenueStats.totalDue || 0).toLocaleString()}</p>
                        </div>
                      </div>

                    </div >
                    <div className="revenue-location-filters-section">
                      <div className="revenue-location-filters">
                        <select
                          className="revenue-filter-select"
                          value={revenueSelectedRegion}
                          onChange={(e) => {
                            setRevenueSelectedRegion(e.target.value)
                            setRevenueSelectedArea('')
                            setRevenueSelectedTerritory('')
                          }}
                        >
                          <option value="">{language === 'en' ? 'All Regions' : 'সব অঞ্চল'}</option>
                          {revenueUniqueRegionIds.map(id => (
                            <option key={id} value={id}>{id}</option>
                          ))}
                        </select>

                        <select
                          className="revenue-filter-select"
                          value={revenueSelectedArea}
                          onChange={(e) => {
                            setRevenueSelectedArea(e.target.value)
                            setRevenueSelectedTerritory('')
                          }}
                          disabled={!revenueSelectedRegion}
                        >
                          <option value="">{language === 'en' ? 'All Areas' : 'সব এলাকা'}</option>
                          {revenueAvailableAreaIds.map(id => (
                            <option key={id} value={id}>{id}</option>
                          ))}
                        </select>

                        <select
                          className="revenue-filter-select"
                          value={revenueSelectedTerritory}
                          onChange={(e) => setRevenueSelectedTerritory(e.target.value)}
                          disabled={!revenueSelectedArea}
                        >
                          <option value="">{language === 'en' ? 'All Territories' : 'সব টেরিটরি'}</option>
                          {revenueAvailableTerritoryIds.map(id => {
                            const t = territories.find(tObj => tObj.territoryId === id && tObj.regionId === revenueSelectedRegion && tObj.areaId === revenueSelectedArea);
                            return <option key={id} value={id}>{id}{t?.area ? ` (${t.area})` : ''}</option>;
                          })}
                        </select>

                        {(revenueSelectedRegion || revenueSelectedArea || revenueSelectedTerritory) && (
                          <button
                            onClick={() => {
                              setRevenueSelectedRegion('')
                              setRevenueSelectedArea('')
                              setRevenueSelectedTerritory('')
                            }}
                            className="revenue-clear-btn"
                          >
                            {language === 'en' ? 'Clear' : 'মুছুন'}
                          </button>
                        )}
                      </div>
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(450px, 1fr))', gap: '2rem' }}>

                      {/* Product-wise Sale Summary */}
                      <div className="admin-settings-card">
                        <h3>{language === 'en' ? 'Product Wise Sale Summary' : 'পণ্য অনুযায়ী বিক্রয় সারাংশ'}</h3>
                        <div className="admin-table-container.no-horizontal-scroll" style={{ maxHeight: '500px', overflowY: 'auto' }}>
                          <table className="admin-table">
                            <thead style={{ position: 'sticky', top: 0, zIndex: 10 }}>
                              <tr>
                                <th>{language === 'en' ? 'ID' : 'আইডি'}</th>
                                <th>{language === 'en' ? 'Product Name' : 'পণ্যের নাম'}</th>
                                <th>{language === 'en' ? 'Variant' : 'ভ্যারিয়েন্ট'}</th>
                                <th>{language === 'en' ? 'Sold Qty' : 'বিক্রিত সংখ্যা'}</th>
                                <th>{language === 'en' ? 'Total Value' : 'মোট মূল্য'}</th>
                              </tr>
                            </thead>
                            <tbody>
                              {productSalesSummary.items.length > 0 ? (
                                <>
                                  {productSalesSummary.items.map((item, index) => (
                                    <tr key={index}>
                                      <td>{item.variant?.productCode || '-'}</td>
                                      <td>
                                        <div style={{ fontWeight: 500 }}>{item.productName}</div>
                                      </td>
                                      <td>{item.variantDisplay || '-'}</td>
                                      <td>{item.quantity}</td>
                                      <td>{language === 'en' ? '৳' : '৳'} {Math.round(item.totalValue).toLocaleString()}</td>
                                    </tr>
                                  ))}
                                  {/* Footer for Totals */}
                                  <tr style={{ backgroundColor: '#f8fafc', fontWeight: 800, borderTop: '2px solid #e2e8f0', position: 'sticky', bottom: 0, zIndex: 10 }}>
                                    <td colSpan="3" style={{ textAlign: 'right' }}>{language === 'en' ? 'Grand Total:' : 'সর্বমোট:'}</td>
                                    <td>{productSalesSummary.totals.quantity}</td>
                                    <td>{language === 'en' ? '৳' : '৳'} {Math.round(productSalesSummary.totals.totalValue).toLocaleString()}</td>
                                  </tr>
                                </>
                              ) : (
                                <tr>
                                  <td colSpan="5" style={{ textAlign: 'center', padding: '2rem', color: '#6b7280' }}>
                                    {language === 'en' ? 'No sales data found' : 'কোন বিক্রয় তথ্য পাওয়া যায়নি'}
                                  </td>
                                </tr>
                              )}
                            </tbody>
                          </table>
                        </div>
                      </div>

                      {/* Ledger (formerly Customer Wise Sale Summary) */}
                      <div className="admin-settings-card">
                        <div style={{ marginBottom: '1.5rem' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: ledgerEmployeeInfo ? '1.5rem' : 0, flexWrap: 'wrap', gap: '1rem' }}>
                            <h3 style={{ margin: 0 }}>{language === 'en' ? 'Ledger' : 'লেজার'}</h3>
                          </div>

                          {ledgerEmployeeInfo && (
                            <div style={{ display: 'flex', justifyContent: 'center', width: '100%' }}>
                              <div className="employee-details-box" style={{
                                display: 'flex',
                                flexWrap: 'wrap',
                                justifyContent: 'center',
                                gap: '1.5rem',
                                padding: '0.75rem 1.25rem',
                                backgroundColor: '#f0f9ff',
                                borderRadius: '10px',
                                border: '1px solid #bae6fd',
                                fontSize: '0.9rem',
                                color: '#0369a1',
                                boxShadow: '0 2px 4px rgba(0,0,0,0.02)',
                                width: 'fit-content'
                              }}>
                                <div>
                                  <span style={{ fontWeight: 600, color: '#0284c7' }}>{language === 'en' ? 'Employee:' : 'কর্মকর্তা:'} </span>
                                  {ledgerEmployeeInfo.name}
                                </div>
                                <div>
                                  <span style={{ fontWeight: 600, color: '#0284c7' }}>{language === 'en' ? 'Mobile:' : 'মোবাইল:'} </span>
                                  {ledgerEmployeeInfo.phone}
                                </div>
                                <div>
                                  <span style={{ fontWeight: 600, color: '#0284c7' }}>{language === 'en' ? 'Area:' : 'এলাকা:'} </span>
                                  {ledgerEmployeeInfo.postingArea}
                                </div>
                              </div>
                            </div>
                          )}
                        </div>
                        <div className="admin-table-container.no-horizontal-scroll" style={{ maxHeight: '500px', overflowY: 'auto' }}>
                          <table className="admin-table">
                            <thead style={{ position: 'sticky', top: 0, zIndex: 10 }}>
                              <tr>
                                {customerSalesSummary.viewMode === 'region' && (
                                  <>
                                    <th>{language === 'en' ? 'Region ID' : 'অঞ্চল আইডি'}</th>
                                    <th>{language === 'en' ? 'Zilla' : 'জেলা'}</th>
                                    <th>{language === 'en' ? 'total Amount' : 'মোট পরিমাণ'}</th>
                                    <th>{language === 'en' ? 'Due' : 'বাকি'}</th>
                                  </>
                                )}
                                {customerSalesSummary.viewMode === 'area' && (
                                  <>
                                    <th>{language === 'en' ? 'Area ID' : 'এলাকা আইডি'}</th>
                                    <th>{language === 'en' ? 'Area' : 'এলাকা'}</th>
                                    <th>{language === 'en' ? 'total Amount' : 'মোট পরিমাণ'}</th>
                                    <th>{language === 'en' ? 'Due' : 'বাকি'}</th>
                                  </>
                                )}
                                {customerSalesSummary.viewMode === 'territory' && (
                                  <>
                                    <th>{language === 'en' ? 'Territory ID' : 'টেরিটরি আইডি'}</th>
                                    <th>{language === 'en' ? 'Area' : 'এলাকা'}</th>
                                    <th>{language === 'en' ? 'total Amount' : 'মোট পরিমাণ'}</th>
                                    <th>{language === 'en' ? 'Due' : 'বাকি'}</th>
                                  </>
                                )}
                                {customerSalesSummary.viewMode === 'dealer' && (
                                  <>
                                    <th>{language === 'en' ? 'CID' : 'সিআইডি'}</th>
                                    <th>{language === 'en' ? 'Customer' : 'কাস্টমার'}</th>
                                    <th>{language === 'en' ? 'Grand Total' : 'মোট পরিমাণ'}</th>
                                    <th>{language === 'en' ? 'Due' : 'বাকি'}</th>
                                  </>
                                )}
                              </tr>
                            </thead>
                            <tbody>
                              {customerSalesSummary.items.length > 0 ? (
                                <>
                                  {customerSalesSummary.items.map((item, index) => (
                                    <tr key={index}>
                                      <td>{item.id}</td>
                                      <td>{customerSalesSummary.viewMode === 'dealer' ? item.shopName : item.label}</td>
                                      <td>{language === 'en' ? '৳' : '৳'} {Math.round(item.revenue).toLocaleString()}</td>
                                      <td>{language === 'en' ? '৳' : '৳'} {Math.round(item.due).toLocaleString()}</td>
                                    </tr>
                                  ))}
                                  {/* Footer for Totals */}
                                  <tr style={{ backgroundColor: '#f8fafc', fontWeight: 800, borderTop: '2px solid #e2e8f0', position: 'sticky', bottom: 0, zIndex: 10 }}>
                                    <td colSpan="2" style={{ textAlign: 'right' }}>{language === 'en' ? 'Total:' : 'মোট:'}</td>
                                    <td>{language === 'en' ? '৳' : '৳'} {Math.round(customerSalesSummary.totals.revenue).toLocaleString()}</td>
                                    <td>{language === 'en' ? '৳' : '৳'} {Math.round(customerSalesSummary.totals.due).toLocaleString()}</td>
                                  </tr>
                                </>
                              ) : (
                                <tr>
                                  <td colSpan="4" style={{ textAlign: 'center', padding: '2rem', color: '#6b7280' }}>
                                    {language === 'en' ? 'No data found' : 'কোন তথ্য পাওয়া যায়নি'}
                                  </td>
                                </tr>
                              )}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </>
                )}
              </div>
            )
          }

          {/* Manage Asset Tab */}
          {
            activeTab === 'manageAsset' && (
              <div className="admin-tab-content">
                <div className="admin-tab-header">
                  <h1 className="admin-page-title">{adminContent.manageAsset}</h1>
                  <button className="admin-add-btn">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                      <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
                    </svg>
                    {adminContent.addNew}
                  </button>
                </div>
                <div className="admin-stats-grid">
                  <div className="admin-stat-card">
                    <div className="admin-stat-icon">
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                      </svg>
                    </div>
                    <div className="admin-stat-info">
                      <h3>{language === 'en' ? 'Total Assets' : 'মোট সম্পদ'}</h3>
                      <p>0</p>
                    </div>
                  </div>
                  <div className="admin-stat-card">
                    <div className="admin-stat-icon">
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                      </svg>
                    </div>
                    <div className="admin-stat-info">
                      <h3>{language === 'en' ? 'Asset Value' : 'সম্পদের মূল্য'}</h3>
                      <p>৳0</p>
                    </div>
                  </div>
                  <div className="admin-stat-card">
                    <div className="admin-stat-icon">
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 11l3 3L22 4" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                      </svg>
                    </div>
                    <div className="admin-stat-info">
                      <h3>{language === 'en' ? 'Active Assets' : 'সক্রিয় সম্পদ'}</h3>
                      <p>0</p>
                    </div>
                  </div>
                </div>
                <div className="admin-table-container" style={{ marginTop: '2rem' }}>
                  <table className="admin-table">
                    <thead>
                      <tr>
                        <th>{language === 'en' ? 'Asset Name' : 'সম্পদের নাম'}</th>
                        <th>{language === 'en' ? 'Category' : 'ক্যাটাগরি'}</th>
                        <th>{language === 'en' ? 'Purchase Date' : 'ক্রয়ের তারিখ'}</th>
                        <th>{language === 'en' ? 'Value' : 'মূল্য'}</th>
                        <th>{language === 'en' ? 'Status' : 'স্ট্যাটাস'}</th>
                        <th>{language === 'en' ? 'Actions' : 'কার্যক্রম'}</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colSpan="6" style={{ textAlign: 'center', padding: '2rem' }}>
                          {adminContent.noData}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            )
          }

          {/* Career Management Tab */}
          {
            activeTab === 'career' && (
              <div className="admin-tab-content">
                <div className="admin-tab-header">
                  <h1 className="admin-page-title">{adminContent.careerManagement}</h1>
                </div>
                <div className="admin-settings-section">
                  <div className="admin-settings-card">
                    <h3>{language === 'en' ? 'Manage career postings' : 'ক্যারিয়ার পোস্ট পরিচালনা করুন'}</h3>
                    <p style={{ color: '#6b7280', marginTop: '0.5rem' }}>
                      {language === 'en' ? 'Coming soon. Add and manage job openings here.' : 'শীঘ্রই আসছে। এখানে চাকরির শূন্যপদ যোগ ও পরিচালনা করুন।'}
                    </p>
                  </div>
                </div>
              </div>
            )
          }

          {/* Settings Tab */}
          {
            activeTab === 'settings' && (
              <div className="admin-tab-content">
                <h1 className="admin-page-title">{adminContent.systemSettings}</h1>
                <div className="admin-settings-section">
                  <div className="admin-settings-card">
                    <h3>{language === 'en' ? 'General Settings' : 'সাধারণ সেটিংস'}</h3>
                    <div className="admin-form-group">
                      <label>{language === 'en' ? 'Site Name' : 'সাইটের নাম'}</label>
                      <input type="text" defaultValue="Believers Crop Care Ltd." />
                    </div>
                    <div className="admin-form-group">
                      <label>{language === 'en' ? 'Contact Email' : 'যোগাযোগ ইমেইল'}</label>
                      <input type="email" defaultValue="info@bccl.com" />
                    </div>
                    <div className="admin-form-group">
                      <label>{language === 'en' ? 'Contact Phone' : 'যোগাযোগ ফোন'}</label>
                      <input type="tel" defaultValue="+880 711223344" />
                    </div>
                    <button className="admin-save-btn">{adminContent.save}</button>
                  </div>
                </div>
              </div>
            )
          }
        </div >
        {
          printingOrder && createPortal(
            <OrderInvoice
              order={printingOrder}
              dealers={dealers}
              products={products}
              language={language}
              customOrderId={customOrderIds[printingOrder._id]}
            />,
            document.body
          )
        }

        {/* Inventory Form Modal */}
        {
          showInventoryForm && (
            <div className="admin-employee-view-overlay" style={{
              position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
              backgroundColor: 'rgba(0, 0, 0, 0.5)', display: 'flex',
              alignItems: 'center', justifyContent: 'center', zIndex: 2000
            }}>
              <div className="admin-modal-content" style={{ maxWidth: '600px', width: '90%', position: 'relative', borderRadius: '1rem', padding: '2rem' }}>
                <button
                  onClick={() => setShowInventoryForm(false)}
                  className="close-modal"
                  style={{ position: 'absolute', top: '1rem', right: '1rem', background: 'none', border: 'none', fontSize: '1.5rem', cursor: 'pointer' }}
                >
                  ×
                </button>
                <h2 style={{ marginBottom: '1.5rem', color: '#1e293b' }}>
                  {inventoryForm.id ? (language === 'en' ? 'Edit Inventory' : 'ইনভেন্টরি সম্পাদন') : (language === 'en' ? 'Add Inventory' : 'ইনভেন্টরি যোগ করুন')}
                </h2>
                <form onSubmit={handleSaveInventory} style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                  <div className="admin-form-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem' }}>
                    {/* Product Select */}
                    <div className="admin-form-group">
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>{language === 'en' ? 'Product' : 'পণ্য'}</label>
                      <select
                        value={inventoryForm.product}
                        onChange={(e) => {
                          const prod = products.find(p => p._id === e.target.value);
                          setInventoryForm({ ...inventoryForm, product: e.target.value, variant: prod?.variants?.[0] || null })
                        }}
                        required
                        style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #e2e8f0' }}
                      >
                        <option value="">Select Product</option>
                        {products.map(p => <option key={p._id} value={p._id}>{p.name}</option>)}
                      </select>
                    </div>
                    {/* Variant Select */}
                    <div className="admin-form-group">
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>{language === 'en' ? 'Variant' : 'ভ্যারিয়েন্ট'}</label>
                      <select
                        value={inventoryForm.variant?.productCode || ''}
                        onChange={(e) => {
                          const prod = products.find(p => p._id === inventoryForm.product);
                          const v = prod?.variants?.find(v => v.productCode === e.target.value);
                          setInventoryForm({ ...inventoryForm, variant: v })
                        }}
                        required
                        style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #e2e8f0' }}
                        disabled={!inventoryForm.product}
                      >
                        <option value="">Select Variant</option>
                        {products.find(p => p._id === inventoryForm.product)?.variants?.map(v => (
                          <option key={v.productCode} value={v.productCode}>
                            {v.productCode} ({v.packSize} {v.packUnit || 'ml'}) [{v.cartoonSize || 1} {v.cartoonUnit || 'Pcs'}]
                          </option>
                        ))}
                      </select>
                    </div>
                    <div className="admin-form-group">
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>{language === 'en' ? 'Quantity' : 'পরিমাণ'}</label>
                      <input
                        type="number"
                        value={inventoryForm.quantity}
                        onChange={(e) => setInventoryForm({ ...inventoryForm, quantity: e.target.value })}
                        required
                        style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #e2e8f0' }}
                      />
                    </div>
                    <div className="admin-form-group">
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>{language === 'en' ? 'Min Stock Level' : 'সর্বনিম্ন স্টক স্তর'}</label>
                      <input
                        type="number"
                        value={inventoryForm.minStockLevel}
                        onChange={(e) => setInventoryForm({ ...inventoryForm, minStockLevel: e.target.value })}
                        style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #e2e8f0' }}
                      />
                    </div>
                  </div>
                  <div className="admin-form-group">
                    <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>{language === 'en' ? 'Notes' : 'নোট'}</label>
                    <textarea
                      value={inventoryForm.notes}
                      onChange={(e) => setInventoryForm({ ...inventoryForm, notes: e.target.value })}
                      style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #e2e8f0', minHeight: '100px' }}
                    />
                  </div>
                  {inventoryStatus && (
                    <div style={{
                      padding: '0.75rem',
                      borderRadius: '0.5rem',
                      backgroundColor: inventoryStatus.includes('Error') || inventoryStatus.includes('Failed') ? '#fee2e2' : '#ecfdf5',
                      color: inventoryStatus.includes('Error') || inventoryStatus.includes('Failed') ? '#dc2626' : '#10b981',
                      fontWeight: 600
                    }}>
                      {inventoryStatus}
                    </div>
                  )}
                  <div className="admin-form-actions" style={{ display: 'flex', gap: '1rem', marginTop: '1rem' }}>
                    <button
                      type="submit"
                      className="admin-save-btn"
                      disabled={savingInventory}
                      style={{ flex: 1, padding: '1rem', backgroundColor: '#3b82f6', color: 'white', border: 'none', borderRadius: '0.5rem', fontWeight: 700, cursor: savingInventory ? 'not-allowed' : 'pointer' }}
                    >
                      {savingInventory ? (language === 'en' ? 'Saving...' : 'সংরক্ষণ হচ্ছে...') : (language === 'en' ? 'Save' : 'সংরক্ষণ করুন')}
                    </button>
                    <button
                      type="button"
                      onClick={() => setShowInventoryForm(false)}
                      style={{ flex: 1, padding: '1rem', backgroundColor: '#64748b', color: 'white', border: 'none', borderRadius: '0.5rem', fontWeight: 700, cursor: 'pointer' }}
                    >
                      {language === 'en' ? 'Cancel' : 'বাতিল'}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )
        }

        {/* Territory Form Modal */}
        {
          showTerritoryForm && (
            <div className="admin-employee-view-overlay" style={{
              position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
              backgroundColor: 'rgba(0, 0, 0, 0.5)', display: 'flex',
              alignItems: 'center', justifyContent: 'center', zIndex: 2000
            }}>
              <div className="admin-modal-content" style={{ maxWidth: '600px', width: '90%', position: 'relative', borderRadius: '1rem', padding: '2rem' }}>
                <button
                  onClick={() => setShowTerritoryForm(false)}
                  className="close-modal"
                  style={{ position: 'absolute', top: '1rem', right: '1rem', background: 'none', border: 'none', fontSize: '1.5rem', cursor: 'pointer' }}
                >
                  ×
                </button>
                <h2 style={{ marginBottom: '1.5rem', color: '#1e293b' }}>
                  {territoryForm._id ? (language === 'en' ? 'Edit Territory' : 'টেরিটরি সম্পাদন') : (language === 'en' ? 'Add Territory' : 'টেরিটরি যোগ করুন')}
                </h2>
                <form onSubmit={handleSaveTerritory} style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                  <div className="admin-form-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem' }}>
                    <div className="admin-form-group">
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>{language === 'en' ? 'Region ID' : 'অঞ্চল আইডি'}</label>
                      <input
                        type="text"
                        value={territoryForm.regionId}
                        onChange={(e) => setTerritoryForm({ ...territoryForm, regionId: e.target.value })}
                        required
                        style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #e2e8f0' }}
                      />
                    </div>
                    <div className="admin-form-group">
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>{language === 'en' ? 'Area ID' : 'এলাকা আইডি'}</label>
                      <input
                        type="text"
                        value={territoryForm.areaId}
                        onChange={(e) => setTerritoryForm({ ...territoryForm, areaId: e.target.value })}
                        required
                        style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #e2e8f0' }}
                      />
                    </div>
                    <div className="admin-form-group">
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>{adminContent.territoryId}</label>
                      <input
                        type="text"
                        value={territoryForm.territoryId}
                        onChange={(e) => setTerritoryForm({ ...territoryForm, territoryId: e.target.value })}
                        required
                        style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #e2e8f0' }}
                      />
                    </div>
                    <div className="admin-form-group">
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>{language === 'en' ? 'Division' : 'বিভাগ'}</label>
                      <input
                        type="text"
                        value={territoryForm.division}
                        onChange={(e) => setTerritoryForm({ ...territoryForm, division: e.target.value })}
                        required
                        style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #e2e8f0' }}
                      />
                    </div>
                    <div className="admin-form-group">
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>{language === 'en' ? 'Zilla' : 'জেলা'}</label>
                      <input
                        type="text"
                        value={territoryForm.zilla}
                        onChange={(e) => setTerritoryForm({ ...territoryForm, zilla: e.target.value })}
                        required
                        style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #e2e8f0' }}
                      />
                    </div>
                    <div className="admin-form-group">
                      <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600 }}>{language === 'en' ? 'Area' : 'এলাকা'}</label>
                      <input
                        type="text"
                        value={territoryForm.area}
                        onChange={(e) => setTerritoryForm({ ...territoryForm, area: e.target.value })}
                        required
                        style={{ width: '100%', padding: '0.75rem', borderRadius: '0.5rem', border: '1px solid #e2e8f0' }}
                      />
                    </div>
                  </div>
                  {territoryStatus && (
                    <div style={{
                      padding: '0.75rem',
                      borderRadius: '0.5rem',
                      backgroundColor: territoryStatus.includes('Error') ? '#fee2e2' : '#ecfdf5',
                      color: territoryStatus.includes('Error') ? '#dc2626' : '#10b981',
                      fontWeight: 600
                    }}>
                      {territoryStatus}
                    </div>
                  )}
                  <div className="admin-form-actions" style={{ display: 'flex', gap: '1rem', marginTop: '1rem' }}>
                    <button
                      type="submit"
                      className="admin-save-btn"
                      disabled={savingTerritory}
                      style={{ flex: 1, padding: '1rem', backgroundColor: '#3b82f6', color: 'white', border: 'none', borderRadius: '0.5rem', fontWeight: 700, cursor: savingTerritory ? 'not-allowed' : 'pointer' }}
                    >
                      {savingTerritory ? (language === 'en' ? 'Saving...' : 'সংরক্ষণ হচ্ছে...') : (language === 'en' ? 'Save' : 'সংরক্ষণ করুন')}
                    </button>
                    <button
                      type="button"
                      onClick={() => setShowTerritoryForm(false)}
                      style={{ flex: 1, padding: '1rem', backgroundColor: '#64748b', color: 'white', border: 'none', borderRadius: '0.5rem', fontWeight: 700, cursor: 'pointer' }}
                    >
                      {language === 'en' ? 'Cancel' : 'বাতিল'}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )
        }
      </main >
    </div >
  )
}

const OrderInvoice = ({ order, dealers, products, language, customOrderId }) => {
  if (!order) return null;
  const dealer = dealers.find(d => d._id === (order.dealer?._id || order.dealer)) || order.dealer;

  // Calculate totals
  const totalValue = (order.items || []).reduce((sum, item) => {
    const total = parseFloat(item.totalPrice || 0);
    const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1;
    return sum + (total * discount);
  }, 0);

  const totalCartoons = (order.items || []).reduce((sum, item) => {
    const itemQty = parseFloat(item.quantity) || 0;
    let freeQty = 0;
    const itemProduct = products.find(p => p._id === (item.product?._id || item.product));
    if (itemProduct && itemProduct.hasOffer && itemProduct.buyQuantity && itemProduct.freeQuantity) {
      const buyQty = parseFloat(itemProduct.buyQuantity) || 0;
      const offerFreeQty = parseFloat(itemProduct.freeQuantity) || 0;
      if (buyQty > 0) {
        const eligibleOffers = Math.floor(itemQty / buyQty);
        freeQty = eligibleOffers * offerFreeQty;
      }
    }
    return sum + Math.floor(itemQty + freeQty);
  }, 0);

  const totalItems = (order.items || []).reduce((sum, item) => {
    const itemQty = parseFloat(item.quantity) || 0;
    let freeQty = 0;
    const itemProduct = products.find(p => p._id === (item.product?._id || item.product));
    if (itemProduct && itemProduct.hasOffer && itemProduct.buyQuantity && itemProduct.freeQuantity) {
      const buyQty = parseFloat(itemProduct.buyQuantity) || 0;
      const offerFreeQty = parseFloat(itemProduct.freeQuantity) || 0;
      if (buyQty > 0) {
        const eligibleOffers = Math.floor(itemQty / buyQty);
        freeQty = eligibleOffers * offerFreeQty;
      }
    }
    const cSize = item.variant?.cartoonSize || 1;
    const totalQty = itemQty + freeQty;
    return sum + Math.round((totalQty % 1) * cSize);
  }, 0);

  return (
    <div className="invoice-print-wrapper">
      <div className="invoice-print-container">
        <div className="invoice-top-header">
          <div></div>
          <div>{new Date(order.createdAt).toLocaleDateString()}</div>
        </div>
        <h1 className="invoice-title">INVOICE NO. {customOrderId || order.orderId}</h1>
        <div className="invoice-customer-info">
          <div>
            <div className="info-row">
              <div className="info-label">Customer Name</div>
              <div className="info-value">: {dealer?.shopName ? `${dealer.shopName} (${dealer.name})` : (dealer?.name || order.dealerName)}</div>
            </div>
            <div className="info-row">
              <div className="info-label">Address</div>
              <div className="info-value">: {dealer?.address || ''}</div>
            </div>
          </div>
          <div>
            <div className="info-row">
              <div className="info-label">Mobile No.</div>
              <div className="info-value">: {dealer?.phone || ''}</div>
            </div>
            <div className="info-row">
              <div className="info-label">Customer Code</div>
              <div className="info-value">: {dealer?.dealerId || order.dealerId || ''}</div>
            </div>
          </div>
        </div>
        <table className="invoice-table">
          <thead>
            <tr>
              <th rowSpan="2">CODE</th>
              <th rowSpan="2">Product Name</th>
              <th rowSpan="2">Pack Size</th>
              <th rowSpan="2">Cartoon Size</th>
              <th colSpan="2">Price</th>
              <th colSpan="2">Quantity</th>
              <th rowSpan="2">Value</th>
              <th rowSpan="2">Cartoon No.</th>
            </tr>
            <tr>
              <th>Cartoon</th>
              <th>Bottle/Packet</th>
              <th>Cartoon</th>
              <th>Bottle/Packet</th>
            </tr>
          </thead>
          <tbody>
            {(order.items || []).map((item, idx) => {
              const cSize = item.variant?.cartoonSize || 1;
              const cartoonPrice = parseFloat(item.unitPrice || 0);
              const bottlePrice = cartoonPrice / cSize;

              const itemQty = parseFloat(item.quantity) || 0;
              let freeQty = 0;
              const itemProduct = products.find(p => p._id === (item.product?._id || item.product));
              if (itemProduct && itemProduct.hasOffer && itemProduct.buyQuantity && itemProduct.freeQuantity) {
                const buyQty = parseFloat(itemProduct.buyQuantity) || 0;
                const offerFreeQty = parseFloat(itemProduct.freeQuantity) || 0;
                if (buyQty > 0) {
                  const eligibleOffers = Math.floor(itemQty / buyQty);
                  freeQty = eligibleOffers * offerFreeQty;
                }
              }

              const totalQty = itemQty + freeQty;
              const cartoons = Math.floor(totalQty);
              const looseItems = Math.round((totalQty % 1) * cSize);

              const discount = order.discountEnabled && order.discountAmount > 0 ? order.discountAmount : 1;
              const value = Math.round(((parseFloat(item.totalPrice) || 0) * discount));

              return (
                <tr key={idx}>
                  <td>{item.variant?.productCode}</td>
                  <td>{item.productName}</td>
                  <td>{item.variant?.packSize} {item.variant?.packUnit}</td>
                  <td>{cSize} {item.variant?.cartoonUnit || 'Pcs'}</td>
                  <td>{Math.round(cartoonPrice)}</td>
                  <td>{Math.round(bottlePrice)}</td>
                  <td>{cartoons || '-'}</td>
                  <td>{looseItems || '-'}</td>
                  <td>{Math.round(parseFloat(value))}</td>
                  <td></td>
                </tr>
              );
            })}
          </tbody>
          <tfoot>
            <tr>
              <td colSpan="6" style={{ textAlign: 'center' }}>Total</td>
              <td>{totalCartoons || '-'}</td>
              <td>{totalItems || '-'}</td>
              <td>{Math.round(totalValue)}</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
        <div className="invoice-footer-message">Invoiced Items are Not Returnable</div>
        <div className="invoice-signatures">
          <div className="signature">Signature of Customer</div>
          <div className="signature">Authorized Signature</div>
        </div>
      </div>
    </div>
  );
};

export default AdminPage

